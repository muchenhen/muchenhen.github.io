<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>UE5：基于Zen Server的Unreal Engine构建产物发布机制分析</title>
    <link href="/posts/10849/"/>
    <url>/posts/10849/</url>
    
    <content type="html"><![CDATA[<h2 id="基于zen-server的unreal-engine构建产物发布机制分析"><a class="markdownIt-Anchor" href="#基于zen-server的unreal-engine构建产物发布机制分析"></a> 基于Zen Server的Unreal Engine构建产物发布机制分析</h2><h3 id="摘要"><a class="markdownIt-Anchor" href="#摘要"></a> 摘要</h3><p>本文试图理解nreal Engine自动化构建系统（BuildGraph）中与Zen Server集成的构建产物发布机制。通过对<code>BuildGraph</code>脚本的XML定义及其底层C#实现（<code>ZenExportSnapshotTask</code>）的分析，了解该机制的核心工作流程、技术优势，并明确了其在数据持久化方面的具体行为。</p><h3 id="1-引言"><a class="markdownIt-Anchor" href="#1-引言"></a> 1. 引言</h3><p>本文聚焦于<code>BuildGraph</code>系统中名为<code>ZenExportSnapshot</code>的节点，对其工作原理进行详细解析。</p><h3 id="2-zen-server发布机制的核心组件"><a class="markdownIt-Anchor" href="#2-zen-server发布机制的核心组件"></a> 2. Zen Server发布机制的核心组件</h3><p>该发布机制主要由两部分协同工作：<code>BuildGraph</code>中的XML声明式节点，以及由该节点调用的后端C#任务实现。</p><h4 id="21-buildgraph-xml声明"><a class="markdownIt-Anchor" href="#21-buildgraph-xml声明"></a> 2.1 BuildGraph XML声明</h4><p>在<code>BuildGraph</code>脚本（如 <code>BuildAndTestProject.xml</code>）中，通过<code>&lt;ZenExportSnapshot&gt;</code>节点来调用发布功能。其关键参数配置如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">ZenExportSnapshot</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">Project</span>=<span class="hljs-string">&quot;$(TargetProject)&quot;</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">Platform</span>=<span class="hljs-string">&quot;$(CookPlatform)&quot;</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">DestinationStorageType</span>=<span class="hljs-string">&quot;Zen&quot;</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">DestinationZenHost</span>=<span class="hljs-string">&quot;$(UE-ZenPublishHost)&quot;</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">DestinationIdentifier</span>=<span class="hljs-string">&quot;$(SnapshotIdentifier)&quot;</span> </span><br><span class="hljs-tag">    <span class="hljs-attr">SnapshotDescriptorFile</span>=<span class="hljs-string">&quot;$(SnapshotLocalDir)/$(StagedPlatformFolder)/$(SnapshotFilenamePrefix)-zen.json&quot;</span></span><br><span class="hljs-tag">/&gt;</span><br></code></pre></td></tr></table></figure><ul><li><strong><code>-Set:PublishZenSnapshot=true</code></strong>: 命令行参数，作为激活该功能的主要开关。</li><li><strong><code>UE-ZenPublishHost</code></strong>: 环境变量，用于指定目标Zen Server的地址。</li><li><strong><code>&lt;ZenExportSnapshot&gt;</code>节点属性</strong>:<ul><li><code>Project</code>, <code>Platform</code>: 定义了发布内容的基本信息。</li><li><code>DestinationStorageType=&quot;Zen&quot;</code>: 明确指定存储后端为Zen Server。</li><li><code>DestinationZenHost</code>: 引用<code>UE-ZenPublishHost</code>环境变量，作为数据上传的目标。</li><li><code>DestinationIdentifier</code>: 为本次发布提供一个唯一的标识符，通常结合分支名和变更列表（Changelist）生成。</li><li><code>SnapshotDescriptorFile</code>: 指定生成的快照描述符JSON文件的输出路径。</li></ul></li></ul><h4 id="22-后端实现zenexportsnapshottask"><a class="markdownIt-Anchor" href="#22-后端实现zenexportsnapshottask"></a> 2.2 后端实现：<code>ZenExportSnapshotTask</code></h4><p>该XML节点在执行时会实例化并运行<code>ZenExportSnapshotTask</code>类。此类的核心职责是作为调度器，收集参数并调用外部命令行工具<code>zen.exe</code>来完成实际工作。</p><h3 id="3-工作流程深度解析-结合源码"><a class="markdownIt-Anchor" href="#3-工作流程深度解析-结合源码"></a> 3. 工作流程深度解析 (结合源码)</h3><p><code>ZenExportSnapshotTask</code>的执行流程确保了构建数据的完整上传。</p><h4 id="31-数据源定位"><a class="markdownIt-Anchor" href="#31-数据源定位"></a> 3.1 数据源定位</h4><p>任务首先在本地的烘焙输出目录 (<code>Saved/Cooked/&lt;Platform&gt;</code>) 中查找 <code>ue.projectstore</code> 文件。该JSON文件是在<code>Cook</code>阶段由引擎生成的，记录了本次烘焙操作的数据在<strong>本地Zen Server实例</strong>中的存储信息，包括项目ID (<code>ProjectId</code>) 和操作日志ID (<code>OplogId</code>)。</p><p><strong>源码佐证 (<code>ZenExportSnapshotTask.cs</code>):</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// ... 遍历每个平台 ...</span><br>FileReference projectStoreFile = FileReference.Combine(platformCookedDirectory, <span class="hljs-string">&quot;ue.projectstore&quot;</span>);<br>ProjectStoreData? parsedProjectStore = <span class="hljs-literal">null</span>;<br><br><span class="hljs-comment">// 尝试加载并解析 ue.projectstore 文件</span><br><span class="hljs-keyword">if</span> (TryLoadJson(projectStoreFile, <span class="hljs-keyword">out</span> parsedProjectStore) &amp;&amp; (parsedProjectStore != <span class="hljs-literal">null</span>) &amp;&amp; (parsedProjectStore.ZenServer != <span class="hljs-literal">null</span>))<br>&#123;<br>    ExportSourceData newExportSource = <span class="hljs-keyword">new</span> ExportSourceData();<br>    <span class="hljs-comment">// 从文件中提取本地Zen Server的连接信息和关键ID</span><br>    newExportSource._isLocalHost = parsedProjectStore.ZenServer.IsLocalHost;<br>    newExportSource._hostName = parsedProjectStore.ZenServer.HostName;<br>    newExportSource._hostPort = parsedProjectStore.ZenServer.HostPort;<br>    newExportSource._projectId = parsedProjectStore.ZenServer.ProjectId;<br>    newExportSource._oplogId = parsedProjectStore.ZenServer.OplogId; <span class="hljs-comment">// &lt;-- 定位数据的关键句柄</span><br>    newExportSource._targetPlatform = platform;<br>    <span class="hljs-comment">// ...</span><br>    exportSources.Add(newExportSource);<br>&#125;<br></code></pre></td></tr></table></figure><p>此段代码清晰地展示了任务如何通过解析<code>ue.projectstore</code>文件来获取源数据的确切位置和标识。</p><h4 id="32-构建命令行"><a class="markdownIt-Anchor" href="#32-构建命令行"></a> 3.2 构建命令行</h4><p>任务基于<code>ue.projectstore</code>提供的信息和XML节点传入的参数，构建一个针对<code>zen.exe</code>的命令行调用。其核心命令为 <code>oplog-export</code>。</p><p><strong>源码佐证 (<code>ZenExportSnapshotTask.cs</code>):</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// 初始化核心命令</span><br>StringBuilder oplogExportCommandline = <span class="hljs-keyword">new</span> StringBuilder();<br>oplogExportCommandline.Append(<span class="hljs-string">&quot;oplog-export --embedloosefiles&quot;</span>);<br><br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">case</span> SnapshotStorageType.Zen:<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-comment">// 添加目标Zen Server参数</span><br>    oplogExportCommandline.AppendFormat(<span class="hljs-string">&quot; --zen &#123;0&#125;&quot;</span>, _parameters.DestinationZenHost);<br><br>    <span class="hljs-comment">// ... 遍历每个数据源 ...</span><br>    <span class="hljs-comment">// 定义源Zen Server地址</span><br>    <span class="hljs-built_in">string</span> hostUrlArg = <span class="hljs-built_in">string</span>.Format(<span class="hljs-string">&quot;--hosturl http://&#123;0&#125;:&#123;1&#125;&quot;</span>, exportSource._isLocalHost ? <span class="hljs-string">&quot;localhost&quot;</span> : exportSource._hostName, exportSource._hostPort);<br><br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-comment">// 组装完整的命令行字符串</span><br>    exportSingleSourceCommandline.AppendFormat(<span class="hljs-string">&quot; &#123;0&#125; --target-project &#123;1&#125; --target-oplog &#123;2&#125; &#123;3&#125; &#123;4&#125;&quot;</span>, <br>        hostUrlArg,             <span class="hljs-comment">// --hosturl (源)</span><br>        projectName,            <span class="hljs-comment">// --target-project (目标项目)</span><br>        destinationOplog,       <span class="hljs-comment">// --target-oplog (目标Oplog ID)</span><br>        exportSource._projectId,<span class="hljs-comment">// (源项目ID)</span><br>        exportSource._oplogId); <span class="hljs-comment">// (源Oplog ID)</span><br></code></pre></td></tr></table></figure><p>这段代码展示了如何动态构建一个完整的 <code>oplog-export</code> 命令，它精确地定义了数据同步的源与目标。</p><h4 id="33-执行数据同步"><a class="markdownIt-Anchor" href="#33-执行数据同步"></a> 3.3 执行数据同步</h4><p>通过<code>TryExportOplogCommand</code>函数调用<code>zen.exe</code>执行上一步构建的命令。此过程涉及实际的网络传输。</p><p><strong>源码佐证 (<code>ZenExportSnapshotTask.cs</code>):</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TryExportOplogCommand</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> app, <span class="hljs-built_in">string</span> commandLine</span>)</span><br>&#123;<br>    <span class="hljs-built_in">int</span> attemptLimit = <span class="hljs-number">2</span>; <span class="hljs-comment">// 包含重试机制，表明这是一个可能失败的网络操作</span><br>    <span class="hljs-built_in">int</span> attempt = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (attempt &lt; attemptLimit)<br>    &#123;<br>        <span class="hljs-comment">// TryRunAndLogWithoutSpew 内部调用 CommandUtils.RunAndLog 执行外部进程</span><br>        <span class="hljs-keyword">if</span> (TryRunAndLogWithoutSpew(app, commandLine, <span class="hljs-literal">false</span>))<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 命令成功执行</span><br>        &#125;<br>        Logger.LogWarning(<span class="hljs-string">&quot;Attempt &#123;AttemptNum&#125; of exporting the oplog failed, &#123;Action&#125;...&quot;</span>, <br>            attempt + <span class="hljs-number">1</span>, attempt &lt; (attemptLimit - <span class="hljs-number">1</span>) ? <span class="hljs-string">&quot;retrying&quot;</span> : <span class="hljs-string">&quot;abandoning&quot;</span>);<br>        attempt = attempt + <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 命令最终失败</span><br>&#125;<br><br><span class="hljs-comment">// ... 在主流程中调用</span><br><span class="hljs-keyword">if</span> (_parameters.SkipExport || TryExportOplogCommand(zenExe.FullName, exportSingleSourceCommandline.ToString()))<br>&#123;<br>    successfullyExportedSources.Add(exportSource);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>zen.exe oplog-export</code>进程负责执行实际的数据传输。其内部利用Zen Server的CAS特性：</p><ul><li><strong>数据块化 (Chunking)</strong>: <code>oplog-export</code>首先获取源Oplog引用的所有数据块（Chunks）的哈希列表。</li><li><strong>差异比对 (Diffing)</strong>: 它将这个哈希列表与目标Zen Server进行比对，识别出目标服务器上缺失的数据块。</li><li><strong>增量上传 (Incremental Upload)</strong>: 仅将目标服务器上不存在的数据块从源服务器拉取并上传。<strong>构建的实际二进制数据在此阶段被可靠地传输</strong>。</li></ul><h4 id="34-生成快照描述符-snapshot-descriptor"><a class="markdownIt-Anchor" href="#34-生成快照描述符-snapshot-descriptor"></a> 3.4 生成快照描述符 (Snapshot Descriptor)</h4><p>仅在<code>oplog-export</code>命令成功执行后，任务才会生成JSON格式的快照描述符文件。</p><p><strong>源码佐证 (<code>ZenExportSnapshotTask.cs</code>):</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// 在所有导出尝试完成后</span><br><span class="hljs-keyword">if</span> ((_parameters.SnapshotDescriptorFile != <span class="hljs-literal">null</span>) &amp;&amp; successfullyExportedSources.Any())<br>&#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-comment">// 创建一个JsonWriter来写入文件</span><br>    <span class="hljs-keyword">using</span> (JsonWriter writer = <span class="hljs-keyword">new</span> JsonWriter(_parameters.SnapshotDescriptorFile))<br>    &#123;<br>        writer.WriteObjectStart();<br>        writer.WriteArrayStart(<span class="hljs-string">&quot;snapshots&quot;</span>);<br><br>        <span class="hljs-comment">// 遍历所有成功导出的源，并为其写入描述符条目</span><br>        <span class="hljs-keyword">foreach</span> (ExportSourceData exportSource <span class="hljs-keyword">in</span> successfullyExportedSources)<br>        &#123;<br>            WriteExportSource(writer, destinationStorageType, exportSource, exportNames[exportIndex]);<br>            exportIndex = exportIndex + <span class="hljs-number">1</span>;<br>        &#125;<br><br>        writer.WriteArrayEnd();<br>        writer.WriteObjectEnd();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>此段代码的执行条件是<code>successfullyExportedSources.Any()</code>，即必须至少有一个数据源被成功导出，这再次确认了快照文件的生成是在数据同步<strong>之后</strong>的步骤。</p><h3 id="4-结论"><a class="markdownIt-Anchor" href="#4-结论"></a> 4. 结论</h3><p><code>BuildGraph</code>中的<code>ZenExportSnapshot</code>功能并非一个简单的元数据快照工具，而是一个完整的、基于CAS模型的<strong>数据发布与同步机制</strong>。它的执行流程保证了构建产物的二进制数据被增量、高效地上传至目标Zen Server。生成的快照描述符文件可以被视为数据成功入库的凭证或“提货单”。</p><p>该机制的核心优势在于：</p><ul><li><strong>存储效率</strong>: 通过CAS模型，极大地减少了存储相似构建版本时的空间冗余。</li><li><strong>网络效率</strong>: 增量上传的特性显著降低了CI/CD流程中的网络带宽消耗。</li><li><strong>可靠性</strong>: 流程设计确保了只有在数据完全同步后才会生成可供下游使用的快照文件。</li></ul><p>因此，在Unreal Engine的自动化流程中，Zen Server不仅可作为开发时的派生数据缓存（Derived Data Cache, DDC），更可作为存储和分发构建产物的可靠后端，是实现高效CI/CD流程的关键基础设施。</p>]]></content>
    
    
    
    <tags>
      
      <tag>Unreal Engine</tag>
      
      <tag>Zen Server</tag>
      
      <tag>BuildGraph</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：在编辑器下对材质函数展开的方法</title>
    <link href="/posts/55800/"/>
    <url>/posts/55800/</url>
    
    <content type="html"><![CDATA[<h1 id="需求背景"><a class="markdownIt-Anchor" href="#需求背景"></a> 需求背景</h1><p>TA使用了大量的MaterialFunction，这次是需要在已经封装调用了MaterialFunction的地方当场临时展开方便查看一些问题，想要一个编辑器接口。</p><p><strong>本次功能实现由小伙伴友情提供</strong>，这里学习一个。</p><h2 id="函数概述"><a class="markdownIt-Anchor" href="#函数概述"></a> 函数概述</h2><p>实现了一个<code>ExpandingMaterialFunction</code>函数，其主要功能是将材质中的指定材质函数展开，将材质函数的内部节点复制到材质中，并重新连接输入和输出。函数的签名如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">UEdLibrary::ExpandingMaterialFunction</span><span class="hljs-params">(UMaterial* Material, <span class="hljs-type">const</span> FString FuncName, <span class="hljs-type">const</span> int32 OffsetX, <span class="hljs-type">const</span> int32 OffsetY)</span></span><br></code></pre></td></tr></table></figure><p>参数说明：</p><ul><li><code>Material</code>：要进行展开操作的材质对象。</li><li><code>FuncName</code>：要展开的材质函数的名称。</li><li><code>OffsetX</code>和<code>OffsetY</code>：展开后的节点在材质编辑器中的位置偏移量。</li></ul><h2 id="函数实现步骤"><a class="markdownIt-Anchor" href="#函数实现步骤"></a> 函数实现步骤</h2><h3 id="1-查找材质函数节点"><a class="markdownIt-Anchor" href="#1-查找材质函数节点"></a> 1、查找材质函数节点</h3><p>函数首先遍历材质的所有表达式节点，找到名称与给定的<code>FuncName</code>匹配的材质函数节点。这里使用了<code>UMaterialExpressionMaterialFunctionCall</code>类来判断节点是否为材质函数调用节点。找到的材质函数节点会被存储在<code>MaterialFunctionArray</code>和<code>MaterialExpressionFuncArr</code>数组中，同时记录节点在材质编辑器中的位置。</p><h3 id="2-复制材质函数的内部节点"><a class="markdownIt-Anchor" href="#2-复制材质函数的内部节点"></a> 2、复制材质函数的内部节点</h3><p>对于每个找到的材质函数节点，函数会复制其内部的所有表达式节点到材质中。这里使用了<code>DuplicateObject</code>函数来创建节点的副本，并将副本添加到材质的表达式列表中。在复制节点的过程中，函数会记录材质函数的输入节点和输出节点，分别存储在<code>ExterInputExpressionArr</code>和<code>ExterOutPutExpressionArr</code>数组中。</p><h3 id="3-重新连接节点之间的输入和输出"><a class="markdownIt-Anchor" href="#3-重新连接节点之间的输入和输出"></a> 3、重新连接节点之间的输入和输出</h3><p>在复制节点的过程中，节点之间的连接关系丢失了。因此，函数会遍历复制后的表达式节点，并根据原始节点之间的连接关系，重新连接复制后的节点。这里使用了<code>ExpressionMap</code>来存储原始节点和复制后节点之间的映射关系，以便快速找到对应的节点进行连接。</p><h3 id="4-处理材质函数节点的输出连接"><a class="markdownIt-Anchor" href="#4-处理材质函数节点的输出连接"></a> 4、处理材质函数节点的输出连接</h3><p>函数会遍历材质的所有表达式节点，找到连接到材质函数输出的节点，并将其存储在<code>FuncExpressionOutputMap</code>中。这里需要注意的是，一个材质函数的输出可能连接到多个节点，因此需要使用数组来存储连接的节点。</p><h3 id="5-对材质函数的输出节点进行排序"><a class="markdownIt-Anchor" href="#5-对材质函数的输出节点进行排序"></a> 5、对材质函数的输出节点进行排序</h3><p>为了保证展开后的节点顺序与原始材质函数中的顺序一致，函数会对材质函数的输出节点进行排序。排序的规则是先按照<code>SortPriority</code>属性排序，再按照节点名称的字母顺序排序。这里使用了一个自定义的排序函数<code>SortMaterialFunc</code>来实现排序逻辑。</p><h3 id="6-修改材质属性的连接"><a class="markdownIt-Anchor" href="#6-修改材质属性的连接"></a> 6、修改材质属性的连接</h3><p>在展开材质函数后，原本连接到材质函数输出的节点需要重新连接到展开后的输出节点。函数会遍历材质的所有属性，找到连接到材质函数输出的属性，并将其重新连接到对应的展开后的输出节点。</p><h3 id="7-处理材质函数节点的输入连接"><a class="markdownIt-Anchor" href="#7-处理材质函数节点的输入连接"></a> 7、处理材质函数节点的输入连接</h3><p>类似于输出连接的处理，函数会遍历材质函数节点的输入，并将其存储在<code>FuncExpressionInputMap</code>中。然后，对材质函数的输入节点进行排序，并重新连接输入节点到展开后的输入节点。</p><h3 id="8-清理和更新材质"><a class="markdownIt-Anchor" href="#8-清理和更新材质"></a> 8、清理和更新材质</h3><p>最后，函数会从材质的表达式列表中移除原始的材质函数节点，并标记材质包为脏，触发材质的编辑前后事件。这样，展开后的材质就可以在材质编辑器中正确显示和编辑了。</p><h2 id="涉及"><a class="markdownIt-Anchor" href="#涉及"></a> 涉及</h2><p>在<code>ExpandingMaterialFunction</code>函数中：</p><ol><li><code>UMaterialExpressionMaterialFunctionCall</code>：表示材质函数调用节点，用于在材质中调用材质函数。</li><li><code>UMaterialExpressionFunctionInput</code>和<code>UMaterialExpressionFunctionOutput</code>：表示材质函数的输入节点和输出节点。</li><li><code>UMaterialExpressionNamedRerouteDeclaration</code>和<code>UMaterialExpressionNamedRerouteUsage</code>：表示命名重路由节点的声明和使用，用于在材质函数中重用表达式。</li><li><code>FExpressionInput</code>：表示材质表达式节点的输入，包含了连接的表达式和输出索引等信息。</li><li><code>EMaterialProperty</code>：表示材质的属性枚举，如基础颜色、金属度、粗糙度等。</li></ol><h2 id="具体函数实现"><a class="markdownIt-Anchor" href="#具体函数实现"></a> 具体函数实现</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">UEdLibrary::ExpandingMaterialFunction</span><span class="hljs-params">(UMaterial* Material, <span class="hljs-type">const</span> FString FuncName, <span class="hljs-type">const</span> int32 OffsetX, <span class="hljs-type">const</span> int32 OffsetY)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">if</span> (!Material || FuncName.<span class="hljs-built_in">IsEmpty</span>())<br><span class="hljs-keyword">return</span>;<br><br>TArray&lt;UMaterialFunctionInterface*&gt; MaterialFunctionArray;<br>TArray&lt;UMaterialExpression*&gt; MaterialExpressionFuncArr;<br>TArray&lt;int32&gt; EditYArray;<br>TArray&lt;int32&gt; EditXArray;<br><br><span class="hljs-keyword">for</span> (UMaterialExpression* Expression : Material-&gt;Expressions)<br>&#123;<br><span class="hljs-type">const</span> UMaterialExpressionMaterialFunctionCall* FunctionCall = <span class="hljs-built_in">Cast</span>&lt;UMaterialExpressionMaterialFunctionCall&gt;(Expression);<br><span class="hljs-keyword">if</span> (FunctionCall &amp;&amp; FunctionCall-&gt;MaterialFunction &amp;&amp; FunctionCall-&gt;MaterialFunction-&gt;<span class="hljs-built_in">GetName</span>() == FuncName)<br>&#123;<br>EditYArray.<span class="hljs-built_in">Add</span>(FunctionCall-&gt;MaterialExpressionEditorY);<br>EditXArray.<span class="hljs-built_in">Add</span>(FunctionCall-&gt;MaterialExpressionEditorX);<br>MaterialFunctionArray.<span class="hljs-built_in">Add</span>(FunctionCall-&gt;MaterialFunction);<br>MaterialExpressionFuncArr.<span class="hljs-built_in">Add</span>(Expression);<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (MaterialFunctionArray.<span class="hljs-built_in">Num</span>() == <span class="hljs-number">0</span>)<br>&#123;<br><span class="hljs-built_in">UE_LOG</span>(AurogonEd1, Error, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;ExpandingMaterialFunction ： Not Find Material Function&quot;</span>));<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br>TMap&lt;UMaterialExpression*, TArray&lt;UMaterialExpression*&gt;&gt; ExterInputExpressionMap;<br>TMap&lt;UMaterialExpression*, TArray&lt;UMaterialExpression*&gt;&gt; ExterOutputExpressionMap;<br><br>TArray&lt;int32&gt; ExterOutPutIndexArr;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MaterialFunctionArray.<span class="hljs-built_in">Num</span>(); ++i)<br>&#123;<br><span class="hljs-type">const</span> UMaterialFunctionInterface* MaterialFunction = MaterialFunctionArray[i];<br><span class="hljs-type">const</span> TArray&lt;UMaterialExpression*&gt; *Expressions = MaterialFunction-&gt;<span class="hljs-built_in">GetFunctionExpressions</span>();<br>TMap&lt;UMaterialExpression*, UMaterialExpression*&gt; ExpressionMap; <br><br>int32 AnchorEditorX = <span class="hljs-number">0</span>;<br>int32 AnchorEditorY = <span class="hljs-number">0</span>;<br><br>TArray&lt;UMaterialExpression*&gt; ExterInputExpressionArr;<br>TArray&lt;UMaterialExpression*&gt; ExterOutPutExpressionArr;<br>TMap&lt;UMaterialExpressionNamedRerouteDeclaration*, UMaterialExpressionNamedRerouteDeclaration*&gt; DeclarationMap;  <br><br><span class="hljs-keyword">for</span> (UMaterialExpression* Expression : *Expressions)<br>&#123;<br>UMaterialExpression* CopiedExpression = <span class="hljs-built_in">DuplicateObject</span>&lt;UMaterialExpression&gt;(Expression, Material);<br>FString ClassName = Expression-&gt;<span class="hljs-built_in">GetClass</span>()-&gt;<span class="hljs-built_in">GetName</span>();<br><br><span class="hljs-keyword">for</span> (int32 InputIndex = <span class="hljs-number">0</span>; InputIndex &lt; CopiedExpression-&gt;<span class="hljs-built_in">GetInputs</span>().<span class="hljs-built_in">Num</span>(); ++InputIndex)<br>&#123;<br><span class="hljs-keyword">if</span> (ClassName == <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;MaterialExpressionFunctionInput&quot;</span>)) <br>ExterInputExpressionArr.<span class="hljs-built_in">Add</span>(CopiedExpression);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ClassName == <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;MaterialExpressionFunctionOutput&quot;</span>)) <br>ExterOutPutExpressionArr.<span class="hljs-built_in">Add</span>(CopiedExpression);<br>&#125;<br>&#123;   <br><span class="hljs-keyword">if</span> (AnchorEditorX == <span class="hljs-number">0</span>) AnchorEditorX = Expression-&gt;MaterialExpressionEditorX;<br><span class="hljs-keyword">if</span> (AnchorEditorY == <span class="hljs-number">0</span>) AnchorEditorY = Expression-&gt;MaterialExpressionEditorY;<br><br>CopiedExpression-&gt;MaterialExpressionEditorX = Expression-&gt;MaterialExpressionEditorX - AnchorEditorX + EditXArray[i] - OffsetX;   <br>CopiedExpression-&gt;MaterialExpressionEditorY = Expression-&gt;MaterialExpressionEditorY - AnchorEditorY + EditYArray[i] + OffsetY;   <br>CopiedExpression-&gt;MaterialExpressionGuid = Expression-&gt;MaterialExpressionGuid;<br>CopiedExpression-&gt;Material = Material;<br>CopiedExpression-&gt;Function = <span class="hljs-literal">nullptr</span>;<br><br><span class="hljs-keyword">if</span> (ClassName == <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;MaterialExpressionNamedRerouteDeclaration&quot;</span>))<br>&#123;<br>UMaterialExpressionNamedRerouteDeclaration* FuncDeclaration = <span class="hljs-built_in">Cast</span>&lt;UMaterialExpressionNamedRerouteDeclaration&gt;(Expression);<br>UMaterialExpressionNamedRerouteDeclaration* Declaration = <span class="hljs-built_in">Cast</span>&lt;UMaterialExpressionNamedRerouteDeclaration&gt;(CopiedExpression);<br>DeclarationMap.<span class="hljs-built_in">Add</span>(FuncDeclaration ,Declaration);  <br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ClassName == <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;MaterialExpressionNamedRerouteUsage&quot;</span>))<br>&#123;<br>UMaterialExpressionNamedRerouteUsage* Usage = <span class="hljs-built_in">Cast</span>&lt;UMaterialExpressionNamedRerouteUsage&gt;(CopiedExpression);<br><span class="hljs-keyword">if</span> (DeclarationMap.<span class="hljs-built_in">Contains</span>(Usage-&gt;Declaration))<br>Usage-&gt;Declaration = DeclarationMap[Usage-&gt;Declaration];  <br>&#125;<br><br>ExpressionMap.<span class="hljs-built_in">Add</span>(Expression, CopiedExpression);<br>Material-&gt;Expressions.<span class="hljs-built_in">Add</span>(CopiedExpression);<br>&#125;<br>&#125;<br>ExterInputExpressionMap.<span class="hljs-built_in">Add</span>(MaterialExpressionFuncArr[i] ,ExterInputExpressionArr);<br>ExterOutputExpressionMap.<span class="hljs-built_in">Add</span>(MaterialExpressionFuncArr[i] ,ExterOutPutExpressionArr);<br><br><span class="hljs-keyword">for</span> (UMaterialExpression* MaterialExpression : *Expressions)<br>&#123;<br>UMaterialExpression* CopiedExpression = ExpressionMap[MaterialExpression];<br><span class="hljs-type">const</span> TArray&lt;FExpressionInput*&gt; Inputs = MaterialExpression-&gt;<span class="hljs-built_in">GetInputs</span>();<br><span class="hljs-keyword">for</span> (int32 InputIndex = <span class="hljs-number">0</span>; InputIndex &lt; Inputs.<span class="hljs-built_in">Num</span>(); ++InputIndex)<br>&#123;<br><span class="hljs-type">const</span> FExpressionInput* Input = MaterialExpression-&gt;<span class="hljs-built_in">GetInput</span>(InputIndex);<br><span class="hljs-keyword">if</span> (Input &amp;&amp; Input-&gt;Expression)<br>&#123;<br>UMaterialExpression* InputExpression = ExpressionMap[Input-&gt;Expression];<br><span class="hljs-keyword">if</span> (InputExpression)<br>&#123;<br>FExpressionInput* CopiedInput = CopiedExpression-&gt;<span class="hljs-built_in">GetInput</span>(InputIndex);<br>CopiedInput-&gt;Expression = InputExpression;<br>CopiedInput-&gt;OutputIndex = Input-&gt;OutputIndex; <br>&#125;<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br>TArray&lt;int8&gt; ParentExpressionInputIndexArr;  <br>TArray&lt;int8&gt; ExpressionInputIndexArr;       <br>TMap&lt;UMaterialExpression*, TArray&lt;UMaterialExpression*&gt;&gt; FuncExpressionOutputMap; <br><br><span class="hljs-keyword">for</span> (UMaterialExpression* Expression : Material-&gt;Expressions) <br>&#123;<br><span class="hljs-keyword">for</span> (int8 j = <span class="hljs-number">0</span>; j &lt; MaterialExpressionFuncArr.<span class="hljs-built_in">Num</span>(); j++)<br>&#123;<br><span class="hljs-keyword">for</span> (int8 i = <span class="hljs-number">0</span>; i &lt; Expression-&gt;<span class="hljs-built_in">GetInputs</span>().<span class="hljs-built_in">Num</span>(); i++)<br>&#123;<br><span class="hljs-keyword">if</span> (Expression-&gt;<span class="hljs-built_in">GetInput</span>(i)-&gt;Expression == MaterialExpressionFuncArr[j])  <br>&#123;<br>UMaterialExpression* FuncExpression = MaterialExpressionFuncArr[j];<br><span class="hljs-keyword">if</span> (FuncExpressionOutputMap.<span class="hljs-built_in">Contains</span>(FuncExpression))<br>&#123;<br>FuncExpressionOutputMap[FuncExpression].<span class="hljs-built_in">Add</span>(Expression);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>TArray&lt;UMaterialExpression*&gt; ParentInputExpressionArr;<br>ParentInputExpressionArr.<span class="hljs-built_in">Add</span>(Expression);<br>FuncExpressionOutputMap.<span class="hljs-built_in">Add</span>(FuncExpression, ParentInputExpressionArr);<br>&#125;<br>ParentExpressionInputIndexArr.<span class="hljs-built_in">Add</span>(i);  <br>ExpressionInputIndexArr.<span class="hljs-built_in">Add</span>(j);<br>ExterOutPutIndexArr.<span class="hljs-built_in">Add</span>(Expression-&gt;<span class="hljs-built_in">GetInput</span>(i)-&gt;OutputIndex);<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br>TArray&lt;FExpressionInput*&gt; MaterialExpressInputArr;  <br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; EMaterialProperty::MP_MAX; i++)<br>&#123;<br>FExpressionInput* ExpressionInput = Material-&gt;<span class="hljs-built_in">GetExpressionInputForProperty</span>(<span class="hljs-built_in">static_cast</span>&lt;EMaterialProperty&gt;(i));<br><span class="hljs-keyword">if</span> (!ExpressionInput) <span class="hljs-keyword">continue</span>;<br>UMaterialExpression* MaterialExpression = ExpressionInput-&gt;Expression;<br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsValid</span>(MaterialExpression)) <span class="hljs-keyword">continue</span>;<br><span class="hljs-keyword">if</span> (MaterialExpressionFuncArr.<span class="hljs-built_in">Contains</span>(MaterialExpression))<br>MaterialExpressInputArr.<span class="hljs-built_in">Add</span>(ExpressionInput);<br>&#125;<br><br><span class="hljs-keyword">auto</span> SortMaterialFunc = [](<span class="hljs-type">const</span> UMaterialExpression&amp; A,<span class="hljs-type">const</span> UMaterialExpression&amp; B)<br>&#123;<br>int32 ASortPriority = <span class="hljs-number">0</span>;<br>int32 BSortPriority = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">Cast</span>&lt;UMaterialExpressionFunctionInput&gt;(&amp;A))<br>&#123;<br>ASortPriority = <span class="hljs-built_in">Cast</span>&lt;UMaterialExpressionFunctionInput&gt;(&amp;A)-&gt;SortPriority;<br>BSortPriority = <span class="hljs-built_in">Cast</span>&lt;UMaterialExpressionFunctionInput&gt;(&amp;B)-&gt;SortPriority;<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Cast</span>&lt;UMaterialExpressionFunctionOutput&gt;(&amp;A))<br>&#123;<br>ASortPriority = <span class="hljs-built_in">Cast</span>&lt;UMaterialExpressionFunctionOutput&gt;(&amp;A)-&gt;SortPriority;<br>BSortPriority = <span class="hljs-built_in">Cast</span>&lt;UMaterialExpressionFunctionOutput&gt;(&amp;B)-&gt;SortPriority;<br>&#125;<br><br><span class="hljs-keyword">if</span> (ASortPriority == BSortPriority) <br>&#123;<br>int32 Index = <span class="hljs-number">0</span>;<br>FString Astr = A.<span class="hljs-built_in">GetInputName</span>(<span class="hljs-number">0</span>).<span class="hljs-built_in">ToString</span>();<br>FString Bstr = B.<span class="hljs-built_in">GetInputName</span>(<span class="hljs-number">0</span>).<span class="hljs-built_in">ToString</span>();<br><span class="hljs-keyword">while</span> (Index &lt; Astr.<span class="hljs-built_in">Len</span>() &amp;&amp; Index &lt; Bstr.<span class="hljs-built_in">Len</span>())<br>&#123;<br><span class="hljs-type">const</span> TCHAR Char1 = Astr[Index];<br><span class="hljs-type">const</span> TCHAR Char2 = Bstr[Index];<br><span class="hljs-keyword">if</span> (FChar::<span class="hljs-built_in">ToLower</span>(Char1) &lt; FChar::<span class="hljs-built_in">ToLower</span>(Char2))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (FChar::<span class="hljs-built_in">ToLower</span>(Char1) &gt; FChar::<span class="hljs-built_in">ToLower</span>(Char2))<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>++Index;<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">return</span> ASortPriority &lt; BSortPriority;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;;<br><span class="hljs-keyword">for</span> (int8 j = <span class="hljs-number">0</span>; j &lt; MaterialExpressionFuncArr.<span class="hljs-built_in">Num</span>(); j++)<br>&#123;<br>UMaterialExpression* ExpressionFunc = MaterialExpressionFuncArr[j];<br><span class="hljs-keyword">auto</span> ExterOutPutExpressionArr = ExterOutputExpressionMap[ExpressionFunc];<br><br>ExterOutPutExpressionArr.<span class="hljs-built_in">Sort</span>(SortMaterialFunc);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> Input : MaterialExpressInputArr) <br>&#123;<br>UMaterialExpressionMaterialFunctionCall* MaterialExpressionMaterialFunctionCall = <span class="hljs-built_in">Cast</span>&lt;UMaterialExpressionMaterialFunctionCall&gt;(ExpressionFunc);<br><span class="hljs-keyword">auto</span> Outputs = MaterialExpressionMaterialFunctionCall-&gt;FunctionOutputs;<br>FName MaterialOutPutName = Outputs[Input-&gt;OutputIndex].ExpressionOutput-&gt;OutputName;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> OutPutExpression : ExterOutPutExpressionArr)<br>&#123;<br>UMaterialExpressionFunctionOutput* FunctionOutput = <span class="hljs-built_in">Cast</span>&lt;UMaterialExpressionFunctionOutput&gt;(OutPutExpression);<br>FName OutPutName = FunctionOutput-&gt;OutputName;;  <br><span class="hljs-keyword">if</span> (MaterialOutPutName == OutPutName)<br>Input-&gt;Expression = OutPutExpression; <br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!FuncExpressionOutputMap.<span class="hljs-built_in">Contains</span>(ExpressionFunc)) <br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-keyword">auto</span> ParentInputExpressionArr = FuncExpressionOutputMap[ExpressionFunc];<br><span class="hljs-keyword">for</span> (int8 i = <span class="hljs-number">0</span>; i &lt; ParentInputExpressionArr.<span class="hljs-built_in">Num</span>(); i++) <br>&#123;<br>UMaterialExpression* Expression = ParentInputExpressionArr[i];                    <br>FExpressionInput* Input = Expression-&gt;<span class="hljs-built_in">GetInput</span>(ParentExpressionInputIndexArr[i]); <br><span class="hljs-keyword">if</span> (Input-&gt;Expression)<br>&#123;<br>int8 Index = ExpressionInputIndexArr[i];<br>int8 CIndex = ExterOutPutIndexArr[j + i]; <br>Input-&gt;Expression = ExterOutPutExpressionArr[CIndex];   <br>Input-&gt;OutputIndex = ExterOutPutIndexArr[Index];        <br>&#125;<br>&#125;<br>&#125;<br><br>TArray&lt;int8&gt; ParentExpressionOutputIndexArr;  <br>TMap&lt;UMaterialExpression*, TArray&lt;FExpressionInput*&gt;&gt; FuncExpressionInputMap;  <br><br><span class="hljs-keyword">for</span> (int8 j = <span class="hljs-number">0</span>; j &lt; MaterialExpressionFuncArr.<span class="hljs-built_in">Num</span>(); ++j)<br>&#123;<br>UMaterialExpression* Expression = MaterialExpressionFuncArr[j]; <br>TArray&lt;FExpressionInput*&gt; ParentOutputExpressionArr;<br><br><span class="hljs-keyword">for</span> (int8 i = <span class="hljs-number">0</span>; i &lt; Expression-&gt;<span class="hljs-built_in">GetInputs</span>().<span class="hljs-built_in">Num</span>(); i++)<br>&#123;<br>FExpressionInput* Input = Expression-&gt;<span class="hljs-built_in">GetInput</span>(i);<br>ParentOutputExpressionArr.<span class="hljs-built_in">Add</span>(Input);  <br>&#125;<br>FuncExpressionInputMap.<span class="hljs-built_in">Add</span>(Expression, ParentOutputExpressionArr);<br>&#125;<br><br><span class="hljs-keyword">for</span> (int8 j = <span class="hljs-number">0</span>; j &lt; MaterialExpressionFuncArr.<span class="hljs-built_in">Num</span>(); ++j)<br>&#123;<br>UMaterialExpression* Expression = MaterialExpressionFuncArr[j];<br><span class="hljs-keyword">if</span> (!FuncExpressionInputMap.<span class="hljs-built_in">Contains</span>(Expression)) <br><span class="hljs-keyword">continue</span>;<br><br><span class="hljs-keyword">auto</span> ParentOutputExpressionArr = FuncExpressionInputMap[Expression];<br><span class="hljs-keyword">auto</span> ExpressionArr = ExterInputExpressionMap[Expression];<br>ExpressionArr.<span class="hljs-built_in">Sort</span>(SortMaterialFunc);<br><br><span class="hljs-keyword">for</span> (int8 i = <span class="hljs-number">0</span>; i &lt; ParentOutputExpressionArr.<span class="hljs-built_in">Num</span>(); i++)<br>&#123;<br>FExpressionInput* Input = ExpressionArr[i]-&gt;<span class="hljs-built_in">GetInput</span>(<span class="hljs-number">0</span>); <br>FExpressionInput* OutPutExpression = ParentOutputExpressionArr[i];<br><span class="hljs-keyword">if</span> (Input &amp;&amp; OutPutExpression &amp;&amp; OutPutExpression-&gt;Expression) <br>&#123;<br>Input-&gt;Expression = OutPutExpression-&gt;Expression; <br>Input-&gt;OutputIndex = OutPutExpression-&gt;OutputIndex;<br><br>Input-&gt;Mask = OutPutExpression-&gt;Mask;  <br>Input-&gt;MaskR = OutPutExpression-&gt;MaskR;<br>Input-&gt;MaskG = OutPutExpression-&gt;MaskG;<br>Input-&gt;MaskB = OutPutExpression-&gt;MaskB;<br>Input-&gt;MaskA = OutPutExpression-&gt;MaskA;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">for</span> (UMaterialExpression* Expression : MaterialExpressionFuncArr)<br>&#123;<br>Material-&gt;Expressions.<span class="hljs-built_in">Remove</span>(Expression);<br>&#125;<br>Material-&gt;<span class="hljs-built_in">MarkPackageDirty</span>();<br>Material-&gt;<span class="hljs-built_in">PreEditChange</span>(<span class="hljs-literal">nullptr</span>);<br>Material-&gt;<span class="hljs-built_in">PostEditChange</span>();<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Material</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE：Android文件服务</title>
    <link href="/posts/43993/"/>
    <url>/posts/43993/</url>
    
    <content type="html"><![CDATA[<h1 id="unrealengineandroid文件服务器"><a class="markdownIt-Anchor" href="#unrealengineandroid文件服务器"></a> UnrealEngine：Android文件服务器</h1><p>本文测试了UE5中提供的Android File Server</p><h2 id="原因"><a class="markdownIt-Anchor" href="#原因"></a> 原因</h2><p>随着Android SDK版本的升级(30以上，对应Android 10)，原有的UE4Game文件夹无法再创建到Android根目录。即使Development版本使用外部公共目录，也无法直接通过连接手机或其他方式获取日志文件，除非修改源码并申请全部文件控制权（这个可以看这个<sup>-</sup>！<a href="https://muchenhen.com/posts/26609/">UE4：4.27升级安卓SDK到30后的文件保存问题</a>），将UE4Game目录转移到Android允许的Documents目录。</p><p>Android文件服务器作为UnrealEngine的插件，解决了上述问题的同时提供了一些方便的功能:</p><ol><li>提供了更高层级的命令行工具UnrealAndroidFileTool，简化了文件管理操作。</li><li>支持通过WiFi连接设备</li><li>内置了UnrealEngine项目常用目录的快捷路径，方便访问关键文件。</li><li>在应用程序沙盒内管理文件，不受Android系统的存储限制，无需申请额外权限。</li></ol><h2 id="使用"><a class="markdownIt-Anchor" href="#使用"></a> 使用</h2><h3 id="1-启用afs插件"><a class="markdownIt-Anchor" href="#1-启用afs插件"></a> 1. 启用AFS插件</h3><p>首先需要在UnrealEngine项目的插件设置中启用AFS插件，并配置相关选项:</p><ul><li>打开 Edit &gt; Project Settings，选择Plugins &gt; AndroidFileServer。</li><li>根据需要勾选 “Use AndroidFileServer”、“Allow Network Connection” 等选项。</li><li>可以设置token、日志选项等高级配置。</li></ul><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20240306214616.png" alt="AFS设置" /></p><h3 id="2-打包"><a class="markdownIt-Anchor" href="#2-打包"></a> 2. 打包</h3><p>打包Android应用程序时，如果AFS插件已启用，UnrealEngine会自动将文件服务器嵌入到应用程序包中。</p><p>对于开发/调试版本，默认启用AFS并支持外部工具连接。发布版本需要额外勾选&quot;Include in Shipping&quot;和&quot;Allow External Start in Shipping&quot;才能启用AFS功能。</p><p>当然，部分项目可能因为部分插件也会修改AndroidManifest.xml，导致AFS插件无法正常工作，需要自己手动排除问题……（</p><h3 id="3-使用unrealandroidfiletool管理文件"><a class="markdownIt-Anchor" href="#3-使用unrealandroidfiletool管理文件"></a> 3. 使用UnrealAndroidFileTool管理文件</h3><p>在成功将嵌入AFS的应用程序包安装到Android设备后，就可以使用UnrealAndroidFileTool进行文件管理了。该工具位于UnrealEngine安装目录的Engine/Binaries/DotNET/Android/UnrealAndroidFileTool下。</p><p>UnrealAndroidFileTool支持多种命令，包括:</p><ul><li>上传、下载文件</li><li>列出目录内容</li><li>执行shell命令</li><li>查询设备信息</li><li>SymbolEditor支持</li></ul><p>命令格式为:<code>UnrealAndroidFileTool.exe -s &lt;device_id&gt; -p &lt;package_name&gt; &lt;command&gt;</code></p><p>其中<code>&lt;device_id&gt;</code>为设备序列号，<code>&lt;package_name&gt;</code>为应用程序包名，<code>&lt;command&gt;</code>为具体的文件管理命令。</p><p>例如，列出UnrealEngine项目的Saved目录:<code>UnrealAndroidFileTool.exe -s 123456F -p com.test.unrealandroidtest ls ^saved/</code></p><p>AFS还支持一些便捷的路径快捷方式，如<code>^^</code>表示之前切换到的目录，<code>^-n</code>表示向上跳转n级目录，<code>^[key]</code>表示引用预设的关键路径。</p><h3 id="4-通过蓝图控制afs"><a class="markdownIt-Anchor" href="#4-通过蓝图控制afs"></a> 4. 通过蓝图控制AFS</h3><p>除了使用UnrealAndroidFileTool外，还可以在UnrealEngine应用程序内部通过蓝图节点控制AFS。相关的蓝图节点包括:</p><ul><li>Start File Server:启动文件服务器</li><li>Stop File Server:停止文件服务器</li><li>Is File Server Running:检查服务器运行状态</li></ul><p>在应用程序逻辑中适时调用这些节点，可以实现更安全、可控的AFS管理方式，特别适用于发布版本的部署。</p><h2 id="使用测试与总结"><a class="markdownIt-Anchor" href="#使用测试与总结"></a> 使用测试与总结</h2><h3 id="示例"><a class="markdownIt-Anchor" href="#示例"></a> 示例</h3><p>我做了一个UE5的Android项目，测试了一下：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20240306214831.png" alt="测试案例" /></p><p>从图上可以看到，通过命令行工具，传入对应参数，成功和安卓设备建立连接，可以对设备上的文件进行操作。</p><p>至于具体命令都有什么作用，以及该工具提供的一些快捷路径，可以参考官方文档，在参考部分。</p><h3 id="关于ue4的测试"><a class="markdownIt-Anchor" href="#关于ue4的测试"></a> 关于UE4的测试</h3><p>如果只是想把插件移植到UE4上，只需要解决一点点error就可以了，但是无法完全支持通过命令行启动文件服务的功能，这还涉及到非常多的build相关的C#代码，以及需要把AndroidFileServer项目的代码移植到UE4的项目中。</p><p>不过只是将插件移植到UE4上，是可以正常使用的，只是无法通过命令行启动文件服务，如果愿意在逻辑层控制文件服务，也是可以用的- -</p><h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h2><p><a href="https://docs.unrealengine.com/5.3/zh-CN/android-file-server-for-unreal-engine/">Android文件服务器</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Android</tag>
      
      <tag>UE5</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：自定义iOS文本输入界面的补充说明</title>
    <link href="/posts/47622/"/>
    <url>/posts/47622/</url>
    
    <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>之前修改了iOS端非嵌入式键盘的类型之后遇到了一些问题，这里做一个补充说明。</p><p>详细的修改方法可以参考<a href="https://muchenhen.com/posts/55560/">UE4：自定义iOS文本输入界面</a>。</p><h2 id="问题1ipad表现异常"><a class="markdownIt-Anchor" href="#问题1ipad表现异常"></a> 问题1：iPad表现异常</h2><p>在之前的版本中，发现在iPad设备上输入界面唤起之后不正常，看不到按钮和输入框</p><p>查找资料之后发现是<code>modalPresentationStyle</code>默认值在不同设备上的表现不一致的问题</p><p><a href="https://developer.apple.com/documentation/uikit/uiviewcontroller/1621355-modalpresentationstyle">官方文档</a></p><p><code>modalPresentationStyle</code>是一个枚举值，默认是<code>UIModalPresentationAutomatic</code>，这种情况下，在iPad上这种尺寸较大的设备上，view的大小并不是和整个屏幕相同的</p><ul><li>UIModalPresentationFullScreen：视图控制器会全屏显示，覆盖底层的视图控制器。</li><li>UIModalPresentationPageSheet：视图控制器以页形式显示，部分底层视图控制器可见。在iPad上，如果键盘未显- 示，可以拖动下降。</li><li>UIModalPresentationFormSheet：视图控制器在屏幕中心以表单形式显示，底层视图控制器在视图控制器周围模糊- 可见。只在iPad上有效。</li><li>UIModalPresentationCurrentContext：视图控制器在当前上下文中显示，取决于父视图控制器的定义。</li><li>UIModalPresentationCustom：自定义视图控制器的显示方式，需要使用自定义转场动画。</li><li>UIModalPresentationOverFullScreen：视图控制器全屏显示，但底层视图控制器的内容在转场动画期间可见。</li><li>UIModalPresentationOverCurrentContext：视图控制器在当前上下文的内容上显示，底层内容在转场动画期间可- 见。</li><li>UIModalPresentationPopover：视图控制器在弹出窗口中显示，需要指定一个锚点。只在iPad上有效。</li><li>UIModalPresentationNone：不使用模态呈现样式。</li><li>UIModalPresentationAutomatic：自动选择最适合的呈现样式，通常是UIModalPresentationPageSheet或- UIModalPresentationFormSheet。</li></ul><p>修改办法：</p><p>在这种情况下，显然是希望全屏的，并且不要挡住底层的视图，所以需要修改为<code>UIModalPresentationOverCurrentContext</code>，这样就可以正常获取到实际设备屏幕的大小了</p><h2 id="问题2外接物理键盘的ios或者自带键盘的mac设备无法唤起的问题"><a class="markdownIt-Anchor" href="#问题2外接物理键盘的ios或者自带键盘的mac设备无法唤起的问题"></a> 问题2：外接物理键盘的iOS或者自带键盘的Mac设备无法唤起的问题</h2><p>这个问题就很emmm</p><p>由于我原本选择了在接收到键盘唤起通知的时候修改按钮和输入框的布局，所以在这种情况下就无法唤起了</p><p>因为连接了物理键盘的设备，没有<code>UIKeyboardWillShowNotification</code>或者<code>UIKeyboardDidShowNotification</code>的通知</p><p>并且在连接上物理设备的时候会触发hide的通知，当场又被隐藏掉了</p><p>修改办法：</p><p>简单，只要把修改布局的时机改到<code>viewDidLayoutSubviews</code>就可以了，可以参考上一篇。不过这里是没有键盘高度可以拿的，可以在<code>UIKeyboardWillShowNotification</code>里面再次修改布局即可</p><p>顺便可以考虑在检查是否为Mac设备，直接禁用非嵌入式键盘</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>iOS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：4.27升级安卓SDK到30后的文件保存问题</title>
    <link href="/posts/26609/"/>
    <url>/posts/26609/</url>
    
    <content type="html"><![CDATA[<h2 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题：</h2><p>4.27将targetSDK版本改为30之后，打包之后的dev版本无法在设备写入文件</p><h2 id="sdk升级相关修改"><a class="markdownIt-Anchor" href="#sdk升级相关修改"></a> SDK升级相关修改</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> <span class="hljs-title">GetSdkApiLevel</span>(<span class="hljs-params">AndroidToolChain ToolChain</span>)</span><br></code></pre></td></tr></table></figure><p>在<code>UEDeployAndroid.cs</code>文件中，这个函数会根据<code>TargetSDKVersion</code>来返回对应的SDK版本，如果你的本地环境有多个UE版本或者有通过Android Studio安装过SDK的话，可能会出现返回错误的情况，可以在这里手动指定，比如直接ruturn你需要的版本号</p><p>同理，也有可能会出错的地方是build-tools的版本，可以在<code>GetBuildToolsVersion</code>函数中手动指定版本</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> <span class="hljs-title">GetBuildToolsVersion</span>()</span><br></code></pre></td></tr></table></figure><p>这里我能够成功通过4.27打包TargetSDK 30版本所用的环境如下：</p><ul><li>build-tools: 30.0.3</li><li>NDK: 21.4.7075529</li><li>jdk: 1.8.0_271</li></ul><h2 id="存储空间权限相关"><a class="markdownIt-Anchor" href="#存储空间权限相关"></a> 存储空间权限相关</h2><p>首先捋一下一些概念</p><p>根据安卓文档的说法，数据和文件存储主要分为四类，我们主要关注<code>App-specific storage</code>和<code>Shared storage</code></p><p>其中<code>getFilesDir()</code> or <code>getCacheDir()</code> 返回内部存储空间的路径<br /><code>getExternalFilesDir()</code> 或 <code>getExternalCacheDir()</code>返回外部存储空间</p><p>以上“内部存储路径”和“外部存储路径”都是<code>App-specific storage</code>，在API 19以上都不需要任何权限，其他应用无法访问，卸载时会被删除</p><p>举例，创建了一个API 30的原生安卓应用，包名com.example.test，然后打印一下这几个路径：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20231110001203.png" width="70%"></p><p>尝试在这四个路径下创建test.test文件：</p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20231110001217.png" width="70%"><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20231110001230.png" width="70%"><p>另外两个internal目录是无法看到的</p><p>看一下UE相关的log：</p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20231110001240.png" width="70%"><p>可以定位到AndroidJNI文件中，首先是在JNI_OnLoad<br />这个函数里</p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20231110001248.png" width="70%"><p>可以看到这里是通过Android的<code>Environment</code>的<code>getExternalStorageDirectory</code>函数获取到了External存储空间对应的路径</p><p>然后是在<code>Java_com_epicgames_ue4_GameActivity_nativeSetGlobalActivity</code>  这个函数里面<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20231110001256.png" width="70%"></p><p>根据不同的情况重新修改了<code>GFilePathBase</code><br />这个函数会在GameActivity的onCreate阶段调用</p><p>为了开发调试方便起见，可以考虑修改这两处的位置，将GFilePathBase指向一个可以更加容易访问的位置</p><p>由于安卓的限制，在TargetSDK版本在Android 10及以上已经不能在根目录下创建文件夹，但是可以在<code>Documents</code>或者<code>Download</code>文件夹下进行读写，这里选择直接将GFilePathBase改为Documents下面，其他不做改变</p><p>但是这样会有一个新问题，如果存在了同名文件，是没有权限覆盖文件的，需要应用声明<code>MANAGE_EXTERNAL_STORAGE</code>这个权限，并在启动应用时主动申请，由用户手动授权</p><p>如果没有在AndroidManifest文件中声明需要这个权限的话，在系统的权限授权界面是不会看到该应用的，极其在启动的时候申请也无法授权</p><p>如果只是需要将Project下的某些文件获取到，比如Log文件或者PSO缓存文件等，也可以考虑在dev和shipping模式下都将base目录指向应用的External目录，在Java侧添加接口来将文件复制到Documents目录，只需要注意检查Documents目录下的重名文件即可。安卓30以上经过测试，release版本的应用也不需要权限</p><h2 id="参考实现"><a class="markdownIt-Anchor" href="#参考实现"></a> 参考实现</h2><p>java侧的一些方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 封装一个复制文件的方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">CopyFile</span><span class="hljs-params">(File file, File destFile)</span><br>&#123;<br><span class="hljs-keyword">if</span> (!destFile.exists())<br>&#123;<br><span class="hljs-keyword">try</span><br>&#123;<br>destFile.createNewFile();<br>&#125;<br><span class="hljs-keyword">catch</span> (IOException e)<br>&#123;<br>e.printStackTrace();<br>&#125;<br>&#125;<br><span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">try</span><br>&#123;<br>fis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>fos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(destFile);<br><span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br><span class="hljs-type">int</span> len;<br><span class="hljs-keyword">while</span> ((len = fis.read(buffer)) != -<span class="hljs-number">1</span>)<br>&#123;<br>fos.write(buffer, <span class="hljs-number">0</span>, len);<br>&#125;<br>&#125;<br><span class="hljs-keyword">catch</span> (IOException e)<br>&#123;<br>e.printStackTrace();<br>&#125; <span class="hljs-keyword">finally</span><br>&#123;<br><span class="hljs-keyword">if</span> (fis != <span class="hljs-literal">null</span>)<br>&#123;<br><span class="hljs-keyword">try</span><br>&#123;<br>fis.close();<br>&#125;<br><span class="hljs-keyword">catch</span> (IOException e)<br>&#123;<br>e.printStackTrace();<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (fos != <span class="hljs-literal">null</span>)<br>&#123;<br><span class="hljs-keyword">try</span><br>&#123;<br>fos.close();<br>&#125;<br><span class="hljs-keyword">catch</span> (IOException e)<br>&#123;<br>e.printStackTrace();<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 封装一个复制文件夹的方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">CopyFiles</span><span class="hljs-params">(String SourceDirPath, String DestDirPath)</span><br>&#123;<br>Log.debug(<span class="hljs-string">&quot;CopyFiles: SourceDirPath: &quot;</span> + SourceDirPath + <span class="hljs-string">&quot; DestDirPath: &quot;</span> + DestDirPath);<br><span class="hljs-type">File</span> <span class="hljs-variable">sourceDir</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(SourceDirPath);<br><span class="hljs-type">File</span> <span class="hljs-variable">destDir</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(DestDirPath);<br><span class="hljs-keyword">if</span> (!destDir.exists())<br>&#123;<br>destDir.mkdirs();<br>&#125;<br><span class="hljs-keyword">if</span> (sourceDir.exists() &amp;&amp; sourceDir.isDirectory())<br>&#123;<br>File[] files = sourceDir.listFiles();<br><span class="hljs-keyword">for</span> (File file : files)<br>&#123;<br><span class="hljs-keyword">if</span> (file.isFile())<br>&#123;<br><span class="hljs-type">File</span> <span class="hljs-variable">destFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(destDir, file.getName());<br>CopyFile(file, destFile);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file.isDirectory())<br>&#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">destPath</span> <span class="hljs-operator">=</span> destDir.getAbsolutePath() + <span class="hljs-string">&quot;/&quot;</span> + file.getName();<br>CopyFiles(file.getAbsolutePath(), destPath);<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-keyword">if</span>(!sourceDir.exists())<br>&#123;<br>Log.debug(<span class="hljs-string">&quot;CopyFiles: SourceDirPath does not exist: &quot;</span> + SourceDirPath);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!sourceDir.isDirectory())<br>&#123;<br>Log.debug(<span class="hljs-string">&quot;CopyFiles: SourceDirPath is not a directory: &quot;</span> + SourceDirPath);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 获取项目名的方法，如果在AndroidManifest中声明了ProjectName的话，就直接返回，否则返回包名的最后一段</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">GetProjectName</span><span class="hljs-params">()</span><br>&#123;<br>String projectName;<br><span class="hljs-keyword">if</span> (_bundle.containsKey(<span class="hljs-string">&quot;com.epicgames.ue4.GameActivity.ProjectName&quot;</span>))<br>&#123;<br>projectName = _bundle.getString(<span class="hljs-string">&quot;com.epicgames.ue4.GameActivity.ProjectName&quot;</span>);<br>Log.debug(<span class="hljs-string">&quot;Found ProjectName = &quot;</span> + projectName);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">packageName</span> <span class="hljs-operator">=</span> getPackageName();<br>String[] packageSegments = packageName.split(<span class="hljs-string">&quot;\\.&quot;</span>);<br><span class="hljs-type">String</span> <span class="hljs-variable">lastSegment</span> <span class="hljs-operator">=</span> packageSegments[packageSegments.length - <span class="hljs-number">1</span>];<br>projectName = lastSegment;<br>&#125;<br><span class="hljs-keyword">return</span> projectName;<br>&#125;<br><br><span class="hljs-comment">// 获取项目的Saved目录</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">GetProjectSavedDir</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">projectName</span> <span class="hljs-operator">=</span> GetProjectName();<br><span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> getExternalFilesDir(<span class="hljs-literal">null</span>).getAbsolutePath();<br><span class="hljs-keyword">return</span> path + <span class="hljs-string">&quot;/UE4Game/&quot;</span> + projectName + <span class="hljs-string">&quot;/&quot;</span> + projectName + <span class="hljs-string">&quot;/Saved&quot;</span>;<br>&#125;<br><br><span class="hljs-comment">// 获取Documents目录的绝对路径</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">GetDocumentsProjectDirPath</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">projectName</span> <span class="hljs-operator">=</span> GetProjectName();<br><span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> android.os.Environment.getExternalStoragePublicDirectory(android.os.Environment.DIRECTORY_DOCUMENTS).getAbsolutePath();<br><span class="hljs-keyword">return</span> path + <span class="hljs-string">&quot;/&quot;</span> + projectName;<br>&#125;<br><br><span class="hljs-comment">// 将Saved目录下的文件复制到Documents目录下，避免权限问题，加上时间戳防止出现重名文件夹导致复制失败</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">AndroidThunkJava_CopySavedFilesToDocuments</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">savedDirPath</span> <span class="hljs-operator">=</span> GetProjectSavedDir();<br><span class="hljs-type">String</span> <span class="hljs-variable">timeStamp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyyMMdd_HHmmss&quot;</span>).format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><span class="hljs-type">String</span> <span class="hljs-variable">destDirPath</span> <span class="hljs-operator">=</span> GetDocumentsProjectDirPath() + <span class="hljs-string">&quot;/CopiedSaved_&quot;</span> + timeStamp;<br>CopyFiles(savedDirPath, destDirPath);<br>&#125;<br></code></pre></td></tr></table></figure><p>在C++侧的AndroidJNI中添加对应接口的声明，就可以在安卓版本中使用了</p><h2 id="参考文档"><a class="markdownIt-Anchor" href="#参考文档"></a> 参考文档</h2><p><a href="https://developer.android.google.cn/training/data-storage?hl=zh-cn">https://developer.android.google.cn/training/data-storage?hl=zh-cn</a></p><p><a href="https://developer.android.google.cn/training/data-storage/shared/documents-files?hl=zh-cn">https://developer.android.google.cn/training/data-storage/shared/documents-files?hl=zh-cn</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：C++直接获取STATS相关值的方式</title>
    <link href="/posts/25258/"/>
    <url>/posts/25258/</url>
    
    <content type="html"><![CDATA[<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2><p>本文基于4.27版本</p><p>UE本身提供了很多STAT命令来帮助实时查看游戏运行时的一些数据：</p><p><a href="https://docs.unrealengine.com/4.27/zh-CN/TestingAndOptimization/PerformanceAndProfiling/StatCommands/">【Stat命令表】</a></p><p>在游戏运行时通过控制台输入对应指令即可</p><p>不过直接使用命令，只会在屏幕上实时看到数据，如果使用Insights或者Frondend等工具，则会同时获取到大量的信息，不方便对数据的整理</p><p>比如，需要对游戏内所有的蒙太奇资源进行检查，来排查某些蒙太奇是否在某个性能指标上存在问题，希望可以快速的自动化测试，记录数据方便快速地进行筛选并反馈给美术，就需要自己稍微组织一下逻辑，并且直接借一下STATS的统计数据</p><h2 id="stats统计数据"><a class="markdownIt-Anchor" href="#stats统计数据"></a> STATS统计数据</h2><p>这里使用Cascade Particle来举例</p><p>按照官方文档所示<a href="https://docs.unrealengine.com/4.27/zh-CN/TestingAndOptimization/PerformanceAndProfiling/StatCommands/StatsSystemOverview/">【统计数据系统概述】</a></p><p>比如在<code>Engine/Source/Runtime/Engine/Public/ParticleHelper.h</code>这个文件中定义到的很多STATS：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20230901161409.png" alt="ParticleHelper" /></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">DECLARE_STATS_GROUP</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;ParticlesOverview&quot;</span>), STATGROUP_ParticlesOverview, STATCAT_Advanced);<br><br></code></pre></td></tr></table></figure><p><code>STATGROUP_ParticlesOverview</code>和<code>STATGROUP_Particles</code>是GroupId，直接在控制台上使用的时候是直接输入<code>stat ParticlesOverview</code>或者<code>stat Particles</code>即可</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">DECLARE_DWORD_COUNTER_STAT_EXTERN</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Sprite Particles&quot;</span>),STAT_SpriteParticles,STATGROUP_Particles, );<br></code></pre></td></tr></table></figure><p>其中<code>STAT_SpriteParticles</code>则是一个计数器，声明一个DWORD类型的计数器统计数据。由上面的声明可知，该计数器的名字为<code>Sprite Particles</code>，StatID为STAT_SpriteParticles，GroupId为<code>STATGROUP_Particles</code>，</p><p>全局搜索这个StatID可以找到：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20230901162557.png" alt="STAT_SpriteParticles" /></p><p>在<code>Engine/Source/Runtime/Engine/Private/Particles/ParticleEmitterInstances.cpp</code>中有：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">INC_DWORD_STAT_BY</span>(STAT_SpriteParticles, ActiveParticles);<br></code></pre></td></tr></table></figure><p>给该计数器增加了指定值，指定值为<code>ActiveParticles</code></p><p>同样在这个文件的另一个位置：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">DEC_DWORD_STAT_BY</span>(STAT_SpriteParticles, ActiveParticles);<br></code></pre></td></tr></table></figure><p>给该计数器减少了指定值，指定值为<code>ActiveParticles</code></p><p>如果开启了STAT，这两个宏就会在对应的逻辑位置被执行，从而改变了计数器的值</p><h2 id="通过c直接获取stats数据"><a class="markdownIt-Anchor" href="#通过c直接获取stats数据"></a> 通过C++直接获取STATS数据</h2><p>在<code>Engine/Source/Developer/FunctionalTesting/Public/AutomationBlueprintFunctionLibrary.h</code>提供了一些方法</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;Automation&quot;</span>, meta = (HidePin = <span class="hljs-string">&quot;WorldContextObject&quot;</span>, DefaultToSelf = <span class="hljs-string">&quot;WorldContextObject&quot;</span>))<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">EnableStatGroup</span><span class="hljs-params">(UObject* WorldContextObject, FName GroupName)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;Automation&quot;</span>, meta = (HidePin = <span class="hljs-string">&quot;WorldContextObject&quot;</span>, DefaultToSelf = <span class="hljs-string">&quot;WorldContextObject&quot;</span>))<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">DisableStatGroup</span><span class="hljs-params">(UObject* WorldContextObject, FName GroupName)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;Automation&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">float</span> <span class="hljs-title">GetStatIncAverage</span><span class="hljs-params">(FName StatName)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;Automation&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">float</span> <span class="hljs-title">GetStatIncMax</span><span class="hljs-params">(FName StatName)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;Automation&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">float</span> <span class="hljs-title">GetStatExcAverage</span><span class="hljs-params">(FName StatName)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;Automation&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">float</span> <span class="hljs-title">GetStatExcMax</span><span class="hljs-params">(FName StatName)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;Automation&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">float</span> <span class="hljs-title">GetStatCallCount</span><span class="hljs-params">(FName StatName)</span></span>;<br></code></pre></td></tr></table></figure><p>按照前文的例子，这里函数中的<code>GroupName</code>指的就是<code>STATGROUP_Particles</code>，<code>StatName</code>指的就是<code>STAT_SpriteParticles</code></p><p>但是看一下函数的具体实现：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">UAutomationBlueprintFunctionLibrary::EnableStatGroup</span><span class="hljs-params">(UObject* WorldContextObject, FName GroupName)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> STATS</span><br><span class="hljs-keyword">if</span> (FGameThreadStatsData* StatsData = FLatestGameThreadStatsData::<span class="hljs-built_in">Get</span>().Latest)<br>&#123;<br><span class="hljs-type">const</span> FString GroupNameString = <span class="hljs-built_in">FString</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;STATGROUP_&quot;</span>)) + GroupName.<span class="hljs-built_in">ToString</span>();<br><span class="hljs-type">const</span> FName GroupNameFull = <span class="hljs-built_in">FName</span>(*GroupNameString, EFindName::FNAME_Find);<br><span class="hljs-keyword">if</span>(StatsData-&gt;GroupNames.<span class="hljs-built_in">Contains</span>(GroupNameFull))<br>&#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (APlayerController* TargetPC = UGameplayStatics::<span class="hljs-built_in">GetPlayerController</span>(WorldContextObject, <span class="hljs-number">0</span>))<br>&#123;<br>TargetPC-&gt;<span class="hljs-built_in">ConsoleCommand</span>( <span class="hljs-built_in">FString</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;stat &quot;</span>)) + GroupName.<span class="hljs-built_in">ToString</span>() + <span class="hljs-built_in">FString</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot; -nodisplay&quot;</span>)), <span class="hljs-comment">/*bWriteToLog=*/</span><span class="hljs-literal">false</span>);<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure><p>这里能看到其实就是执行了一下命令行，并且实际要传进来的GroupName应该是去掉了<code>STATGROUP_</code>的</p><p>而几个获取数据的函数，最后实际上是：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">if</span> STATS</span><br><span class="hljs-keyword">template</span> &lt;EComplexStatField::Type ValueType, <span class="hljs-type">bool</span> bCallCount = <span class="hljs-literal">false</span>&gt;<br><span class="hljs-type">float</span> <span class="hljs-built_in">HelperGetStat</span>(FName StatName)<br>&#123;<br><span class="hljs-keyword">if</span> (FGameThreadStatsData* StatsData = FLatestGameThreadStatsData::<span class="hljs-built_in">Get</span>().Latest)<br>&#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-type">const</span> FComplexStatMessage* StatMessage = StatsData-&gt;<span class="hljs-built_in">GetStatData</span>(StatName))<br>&#123;<br><span class="hljs-keyword">if</span>(bCallCount)<br>&#123;<br><span class="hljs-keyword">return</span> StatMessage-&gt;<span class="hljs-built_in">GetValue_CallCount</span>(ValueType);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-keyword">return</span> FPlatformTime::<span class="hljs-built_in">ToMilliseconds</span>(StatMessage-&gt;<span class="hljs-built_in">GetValue_Duration</span>(ValueType));<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> WITH_EDITOR</span><br>FText WarningOut = FText::<span class="hljs-built_in">Format</span>(<span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;StatNotFound&quot;</span>, <span class="hljs-string">&quot;Could not find stat data for &#123;0&#125;, did you call ToggleStatGroup with enough time to capture data?&quot;</span>), FText::<span class="hljs-built_in">FromName</span>(StatName));<br><span class="hljs-built_in">FMessageLog</span>(<span class="hljs-string">&quot;PIE&quot;</span>).<span class="hljs-built_in">Warning</span>(WarningOut);<br><span class="hljs-built_in">UE_LOG</span>(AutomationFunctionLibrary, Warning, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;%s&quot;</span>), *WarningOut.<span class="hljs-built_in">ToString</span>());<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0.f</span>;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>这里要传递进来的StatName应该是<code>STAT_SpriteParticles</code>这样的完整名字</p><p>但是在这里发现一个问题，比如，在<code>ParticleHelper.h</code>中定义了非常多的计数器，其中有一部分是没有办法通过这种方式获取到的</p><p>经过调试有发现：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20230901173311.png" alt="StatsData" /></p><p>这里的数量确实没有所有的该Group下的计数器，也就是说并不是所有被定义过的计数器都可通过该接口来获取。</p><p>其中额外发现对于类似于<code>STAT_SpriteParticles</code>这种<code>COUNT</code>类型的计数器，实机的位置是在<code>StatsData-&gt;ActiveStatGroups</code>的<code>CountersAggregate</code></p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20230901175713.png" alt="20230901175713" /></p><p>如果要获取这一类的计数器，可以通过这种方式来获取，下面的代码是获取<code>STAT_SpriteParticles</code>的例子：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">if</span> STATS</span><br>    <span class="hljs-keyword">if</span> (FGameThreadStatsData* StatsData = FLatestGameThreadStatsData::<span class="hljs-built_in">Get</span>().Latest)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (FActiveStatGroupInfo ActiveStatGroup : StatsData-&gt;ActiveStatGroups)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (FComplexStatMessage CountersAggregate : ActiveStatGroup.CountersAggregate)<br>            &#123;<br>                <span class="hljs-type">const</span> <span class="hljs-type">double</span> IncAveValueDouble = CountersAggregate.<span class="hljs-built_in">GetValue_double</span>(EComplexStatField::IncAve);<br>                <span class="hljs-type">const</span> <span class="hljs-type">double</span> IncMaxValueDouble = CountersAggregate.<span class="hljs-built_in">GetValue_double</span>(EComplexStatField::IncMax);<br>                FName Name = CountersAggregate.<span class="hljs-built_in">GetShortName</span>();<br><span class="hljs-keyword">if</span> (Name == <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;STAT_SpriteParticles&quot;</span>))<br>                &#123;<br>                    PeakCascadeSpriteParticleCount = FMath::<span class="hljs-built_in">Max</span>(PeakCascadeSpriteParticleCount, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(IncMaxValueDouble));<br>                    AverageCascadeSpriteParticleCount = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(IncAveValueDouble);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：iOS自定义文本输入框</title>
    <link href="/posts/55560/"/>
    <url>/posts/55560/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>版本4.27</p><p>发现在打包后在iOS端，使用iOS自带的中文输入法输入文本之后，如果使用的是嵌入式虚拟键盘</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20230627193632.png" alt="Use Integrated Keyboard" /></p><p>如上图所示，勾选上之后不会出现带有ok和cancel的弹窗，直接在虚拟键盘上方有一个长方形的输入框</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20230627200412.png" alt="嵌入式软键盘" /></p><p>在这种情况下，无论是点击右下角的确认完成输入，还是点击任何非键盘区域隐藏软键盘之后，touch事件都会出现问题，后面的按钮可点击间隔时间会变的很长</p><p>取消勾选相面的选项之后，会变成如下图这样：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20230627201406.png" alt="弹窗输入" /></p><p>在这种情况下，只有点击ok或者是cancel才可以收起键盘，这种情况不会造成点击事件出现问题。但是这种模式也存在缺点，布局在部分情况下是完全不够用的，输入框太短，并且收起键盘只能使用按钮</p><p>在确认了嵌入式软键盘确实有问题之后，决定首先想办法在有弹窗的模式下对布局进行自定义</p><h1 id="427原始代码"><a class="markdownIt-Anchor" href="#427原始代码"></a> 4.27原始代码</h1><p><a href="https://github.com/EpicGames/UnrealEngine/blob/3abfe77d0b24a6d8bacebd27766912e5a5fa6f02/Engine/Source/Runtime/Slate/Public/Framework/Text/IOS/IOSPlatformTextField.h#L33-L45">UE4.27 IOSPlatformTextField.h</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c++">@interface SlateTextField : UIAlertController<br>&#123;<br>TWeakPtr&lt;IVirtualKeyboardEntry&gt; TextWidget;<br>FText TextEntry;<br>    <br>    <span class="hljs-type">bool</span> bTransitioning;<br>    <span class="hljs-type">bool</span> bWantsToShow;<br>    NSString* CachedTextContents;<br>    NSString* CachedPlaceholderContents;<br>    FKeyboardConfig CachedKeyboardConfig;<br>    <br>    UIAlertController* AlertController;<br>&#125;<br></code></pre></td></tr></table></figure><p>上面这段代码的最后一个变量AlertController，就是iOS原生的弹窗:<a href="https://developer.apple.com/documentation/uikit/uialertcontroller">UIAlertController</a></p><p>他提供了一些基本的方法，比如设置标题，设置内容，设置按钮等等，比如UE4中的代码<a href="https://github.com/EpicGames/UnrealEngine/blob/4.27/Engine/Source/Runtime/Slate/Private/Framework/Text/IOS/IOSPlatformTextField.cpp">IOSPlatform.cpp</a>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// 下面这一行初始化了一个UIAlertController，这个弹窗的标题是空的，内容也是空的，弹窗的样式是UIAlertControllerStyleAlert</span><br>AlertController = [UIAlertController alertControllerWithTitle : @<span class="hljs-string">&quot;&quot;</span> message:@<span class="hljs-string">&quot;&quot;</span> preferredStyle:UIAlertControllerStyleAlert];<br><span class="hljs-comment">// 下面这一行添加了点击ok之后的方法，okaction是一个UIAlertAction，</span><br>[AlertController addAction: okAction];<br><span class="hljs-comment">// 下面这一行添加了点击cancel之后的方法，cancelAction是一个UIAlertAction，</span><br>[AlertController addAction: cancelAction];  <br><span class="hljs-comment">// 下面这段代码添加了文本输入框，这里的文本输入框是一个UITextField，这个文本输入框的样式是UIAlertControllerStyleAlert</span><br>[AlertController<br>    addTextFieldWithConfigurationHandler:^(UITextField* AlertTextField)<br>    &#123;<br>        <span class="hljs-comment">// 是否在开始编辑的时候清空文本，这里是不清空</span><br>        AlertTextField.clearsOnBeginEditing = NO;<br>        <span class="hljs-comment">// 是否在插入的时候清空文本，这里是不清空</span><br>        AlertTextField.clearsOnInsertion = NO;<br>        <span class="hljs-keyword">if</span> (TextWidget.<span class="hljs-built_in">IsValid</span>())<br>        &#123;<br>            <span class="hljs-comment">// 设置文本输入框的内容，比如游戏UI中的输入框已经有内容了，这里获取一下显示出来，在原有的基础上修改</span><br>            AlertTextField.text = TextContents;<br>            <span class="hljs-comment">// 文本字段显示的占位符文本</span><br>            AlertTextField.placeholder = PlaceholderContents;<br>            <span class="hljs-comment">// 键盘样式，默认、数字、URL等等</span><br>            AlertTextField.keyboardType = KeyboardConfig.KeyboardType;<br>            <span class="hljs-comment">// 自动更正类型</span><br>            AlertTextField.autocorrectionType = KeyboardConfig.AutocorrectionType;<br>            <span class="hljs-comment">// 自动大写类型</span><br>            AlertTextField.autocapitalizationType = KeyboardConfig.AutocapitalizationType;<br>            <span class="hljs-comment">// 是否隐藏输入的内容，比如密码输入框</span><br>            AlertTextField.secureTextEntry = KeyboardConfig.bSecureTextEntry;<br>        &#125;<br>    &#125;<br>];<br></code></pre></td></tr></table></figure><p>以上就是UE4.27中iOS键盘相关部分的代码，原本想着是稍微改一下，经过搜索（毕竟没有接触过iOS开发）后发现，作为基本的UIAlertController，他并不能支持随意的自定义布局，比如按钮位置、输入框尺寸和位置等。</p><h1 id="修改代码"><a class="markdownIt-Anchor" href="#修改代码"></a> 修改代码</h1><p>经过查找资料，发现其实自定义一个类似的UIAlertController并不难，只需要继承UIViewController：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">/**<br> * @brief 自定义文本框视图控制器<br> */<br>@interface CustomTextFieldViewController : UIViewController<br><br>// 文本框<br>@property (strong, nonatomic) UITextField *textField;<br>// 文本框宽度<br>@property (assign, nonatomic) CGFloat textWidth;<br>// 文本框高度<br>@property (assign, nonatomic) CGFloat textHeight;<br>// clearsOnBeginEditing<br>@property (assign, nonatomic) BOOL clearsOnBeginEditing;<br>// clearsOnInsertion<br>@property (assign, nonatomic) BOOL clearsOnInsertion;<br>// 文本内容<br>@property (strong, nonatomic) NSString *text;<br>// placeholder<br>@property (strong, nonatomic) NSString *placeholder;<br>// keyboardType<br>@property (assign, nonatomic) UIKeyboardType keyboardType;<br>// autocorrectionType<br>@property (assign, nonatomic) UITextAutocorrectionType autocorrectionType;<br>// autocapitalizationType<br>@property (assign, nonatomic) UITextAutocapitalizationType autocapitalizationType;<br>// secureTextEntry<br>@property (assign, nonatomic) BOOL secureTextEntry;<br><br>// okAction 点击ok按钮之后的回调<br>@property (nonatomic, copy) void (^okAction)(void);<br>// cancelAction 点击cancel按钮之后的回调<br>@property (nonatomic, copy) void (^cancelAction)(void);<br>// okButton ok按钮<br>@property (strong, nonatomic) UIButton *okButton;<br>// cancelButton cancel按钮<br>@property (strong, nonatomic) UIButton *cancelButton;<br>// backgroundButton 背景按钮，用于点击背景收起键盘<br>@property (strong, nonatomic) UIButton *backgroundButton;<br>@end<br></code></pre></td></tr></table></figure><p>上面的代码是自定义文本字段视图控制器的Objective-C接口。定义了许多属性，可以用来自定义文本字段的行为和外观。</p><p>textField属性是对实际文本字段对象的引用，该对象将显示在屏幕上。textWidth和textHeight属性允许设置文本字段的大小。</p><p>后面的那些是UE原本都要设置的，这里就不多说了。</p><p>定义了回调块，可用于响应用户操作。当用户点击“OK”按钮时，将调用okAction，而当用户点击“Cancel”按钮时，将调用cancelAction。</p><p>加了一个背景按钮，用于点击背景收起键盘。</p><p>下面是实现部分：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">- (void)viewDidLoad <br>&#123;<br>[super viewDidLoad];<br><br>// 获取屏幕的大小<br>CGRect screenRect = [[UIScreen mainScreen] bounds];<br><br>// 创建textField<br>self.textField = [[UITextField alloc] initWithFrame:CGRectMake(10, 10, self.textWidth, self.textHeight)];<br>self.textField.clearsOnBeginEditing = self.clearsOnBeginEditing;<br>self.textField.clearsOnInsertion = self.clearsOnInsertion;<br>self.textField.text = self.text;<br>self.textField.placeholder = self.placeholder;<br>    self.textField.keyboardType = self.keyboardType;<br>    self.textField.autocorrectionType = self.autocorrectionType;<br>    self.textField.autocapitalizationType = self.autocapitalizationType;<br>    self.textField.secureTextEntry = self.secureTextEntry;<br>self.textField.borderStyle = UITextBorderStyleRoundedRect;<br>self.textField.layer.zPosition = 1;<br>[self.textField becomeFirstResponder];<br><br>[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(keyboardWillShow:) name:UIKeyboardWillShowNotification object:nil];<br><br>// 创建okButton<br>self.okButton = [UIButton buttonWithType:UIButtonTypeSystem];<br>[self.okButton setTitle:@&quot;完成&quot; forState:UIControlStateNormal];<br>[self.okButton setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];<br>[self.okButton setBackgroundColor:[UIColor whiteColor]];<br>[self.okButton addTarget:self action:@selector(okButtonTapped:) forControlEvents:UIControlEventTouchUpInside];<br>[self.view addSubview:self.okButton];<br><br>    // 创建cancelButton<br>self.cancelButton = [UIButton buttonWithType:UIButtonTypeSystem];<br>[self.cancelButton setTitle:@&quot;取消&quot; forState:UIControlStateNormal];<br>[self.cancelButton setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];<br>[self.cancelButton setBackgroundColor:[UIColor whiteColor]];<br>[self.cancelButton addTarget:self action:@selector(cancelButtonTapped:) forControlEvents:UIControlEventTouchUpInside];<br>[self.view addSubview:self.cancelButton];<br><br>// 创建背景按钮<br>self.backgroundButton = [UIButton buttonWithType:UIButtonTypeCustom];<br>self.backgroundButton.backgroundColor = [UIColor clearColor];<br>[self.backgroundButton addTarget:self action:@selector(cancelButtonTapped:) forControlEvents:UIControlEventTouchUpInside];<br>[self.view addSubview:self.backgroundButton];<br><br>// 将textField添加到视图中显示<br>[self.view addSubview:self.textField];<br>&#125;<br></code></pre></td></tr></table></figure><p>viewDidLoad在视图控制器将其视图层次结构加载到内存中后调用。此方法通常用于执行视图加载后所需的任何附加设置，例如设置用户界面元素或初始化数据。</p><p>viewDidLoad方法在视图控制器的生存期内只调用一次，并且在调用视图控制器的loadView方法后调用。这意味着在调用viewDidLoad时，视图控制器的视图层次结构已经加载到内存中。</p><p>上面这段代码把该有的元素都创建出来了，下面就是布局。</p><p>由于希望是紧挨着键盘的，所以需要监听键盘的弹出事件，这里使用了NSNotificationCenter来监听键盘弹出事件。不然的话可以考虑<br /><code>- (void)viewDidLayoutSubviews</code>来布局：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">- (void)keyboardWillShow:(NSNotification *)notification <br>&#123;<br>// Extract the keyboard height from the notification&#x27;s userInfo dictionary<br>CGRect keyboardFrame = [notification.userInfo[UIKeyboardFrameEndUserInfoKey] CGRectValue];<br>CGFloat keyboardHeight = keyboardFrame.size.height;<br>    CGFloat safeLeft = 0;<br>CGFloat safeRight = 0;<br>UIDeviceOrientation orientation = [[UIDevice currentDevice] orientation];<br>if (orientation == UIDeviceOrientationLandscapeLeft) <br>&#123;<br>if (@available(iOS 11.0, *)) <br>&#123;<br>UIEdgeInsets safeAreaInsets = UIApplication.sharedApplication.keyWindow.safeAreaInsets;<br>NSLog(@&quot;safeAreaInsets: %@&quot;, NSStringFromUIEdgeInsets(safeAreaInsets));<br>// Bangs are on the left<br>safeLeft = safeAreaInsets.left;<br>&#125; <br>&#125;<br>else if (orientation == UIDeviceOrientationLandscapeRight)<br>&#123;<br>if (@available(iOS 11.0, *)) <br>&#123;<br>UIEdgeInsets safeAreaInsets = UIApplication.sharedApplication.keyWindow.safeAreaInsets;<br>NSLog(@&quot;safeAreaInsets: %@&quot;, NSStringFromUIEdgeInsets(safeAreaInsets));<br>// Bangs are on the right<br>safeRight = safeAreaInsets.right;<br>&#125; <br>&#125;<br><br>CGRect screenRect = [[UIScreen mainScreen] bounds];<br>CGFloat screenWidth = screenRect.size.width;<br>CGFloat screenHeight = screenRect.size.height;<br><br>CGFloat marginY = 20;<br>CGFloat marginX = 20;<br>CGFloat marginOfItem = 5;<br>CGFloat buttonWidth = 60;<br>CGFloat itemMarginY = 5;<br><br>// Position text field<br>CGFloat textFieldX = marginX;<br>CGFloat textFieldY = screenHeight - keyboardHeight - self.textHeight - itemMarginY;<br>CGFloat textFieldWidth = screenWidth - marginX - marginOfItem - buttonWidth - marginOfItem - buttonWidth - marginX;<br><br>NSLog(@&quot;safeLeft: %f&quot;, safeLeft);<br>NSLog(@&quot;safeRight: %f&quot;, safeRight);<br><br>if (safeLeft &gt; 0 &amp;&amp; safeRight == 0)<br>&#123;<br>// Bangs are on the left<br>textFieldX = marginX + safeLeft;<br>textFieldWidth = screenWidth - marginX - marginOfItem - buttonWidth - marginOfItem - buttonWidth - marginX - safeLeft;<br>&#125;<br>else if (safeLeft == 0 &amp;&amp; safeRight &gt; 0)<br>&#123;<br>// Bangs are on the right<br>textFieldWidth = screenWidth - marginX - marginOfItem - buttonWidth - marginOfItem - buttonWidth - marginX - safeRight;<br>&#125;<br><br>self.textField.frame = CGRectMake(textFieldX, textFieldY, textFieldWidth, self.textHeight);<br><br>// Position OK button<br>CGFloat okButtonX = CGRectGetMaxX(self.textField.frame) + marginOfItem;<br>self.okButton.frame = CGRectMake(okButtonX, textFieldY, buttonWidth, self.textHeight);<br><br>// Position Cancel button<br>CGFloat cancelButtonX = CGRectGetMaxX(self.okButton.frame) + marginOfItem;<br>self.cancelButton.frame = CGRectMake(cancelButtonX, textFieldY, buttonWidth, self.textHeight);<br><br>// Position background button<br>CGFloat backgroundButtonHeight = screenHeight - keyboardHeight - self.textHeight - itemMarginY;<br>self.backgroundButton.frame = CGRectMake(0, 0, screenWidth, backgroundButtonHeight);<br>&#125;<br></code></pre></td></tr></table></figure><p>当键盘即将在iOS设备上显示时调用该方法。从通知的用户信息字典中提取键盘的高度，并使用它在屏幕上定位自定义文本字段视图和两个按钮。</p><p>该方法首先检查设备的方向，并确定刘海是在屏幕的左侧还是右侧。如果刘海在左边，该方法会调整文本字段的位置和宽度，以考虑屏幕左侧的安全区域。如果刘海在右边，该方法会调整文本字段的宽度，以考虑屏幕右侧的安全区域。</p><p>然后根据屏幕的大小、键盘的高度以及各种边距和项目大小来计算文本字段和按钮的位置。相应地设置文本字段的框架和按钮。</p><p>上面就完成了一个简单的自定义的文本输入框类。</p><p>然后在原本的UE的创建弹窗的地方进行修改。</p><p>头文件中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">@interface SlateTextField : UIAlertController<br>&#123;<br>TWeakPtr&lt;IVirtualKeyboardEntry&gt; TextWidget;<br>FText TextEntry;<br>    <br>    bool bTransitioning;<br>    bool bWantsToShow;<br>    NSString* CachedTextContents;<br>    NSString* CachedPlaceholderContents;<br>    FKeyboardConfig CachedKeyboardConfig;<br><br>#pragma region (ios keyboard input)<br>    CustomTextFieldViewController* AlertController;<br>#pragma endregion<br>&#125;<br></code></pre></td></tr></table></figure><p>源文件中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">if(AlertController == nil &amp;&amp; !bTransitioning &amp;&amp; TextWidget.IsValid())<br>&#123;<br>    AlertController = [[CustomTextFieldViewController  alloc] init];<br>    // ... 省略部分代码<br><br>    // 原本的okAction和cancelAction是UIAlertAction类型，这里无法直接使用，直接绑定到了自定义的方法上<br>    AlertController.okAction = <br>    ^&#123;<br>        if ([AlertController respondsToSelector:@selector(dismissViewControllerAnimated: completion:)])<br>        &#123;<br>            bTransitioning = true;<br>            [AlertController dismissViewControllerAnimated : YES completion : ^()&#123;<br>                bTransitioning = false;<br>                [self updateToDesiredState];<br>            &#125;];<br><br>            UITextField* AlertTextField = AlertController.textField;<br>            TextEntry = FText::FromString(AlertTextField.text);<br>            AlertController = nil;<br>                                        <br>            FIOSAsyncTask* AsyncTask = [[FIOSAsyncTask alloc] init];<br>            AsyncTask.GameThreadCallback = ^ bool(void)<br>            &#123;<br>                if(TextWidget.IsValid())<br>                &#123;<br>                    TSharedPtr&lt;IVirtualKeyboardEntry&gt; TextEntryWidgetPin = TextWidget.Pin();<br>                    TextEntryWidgetPin-&gt;SetTextFromVirtualKeyboard(TextEntry, ETextEntryType::TextEntryAccepted);<br>                &#125;<br><br>                // clear the TextWidget<br>                TextWidget = nullptr;<br>                return true;<br>            &#125;;<br>            [AsyncTask FinishedTask];<br>        &#125;<br>        else<br>        &#123;<br>            TextWidget = nullptr;<br>            UE_LOG(LogTemp, Log, TEXT(&quot;AlertController didn&#x27;t support needed selector&quot;));<br>        &#125;<br>    &#125;;<br><br>    // ... cancelAction同上<br>&#125;<br></code></pre></td></tr></table></figure><p>这样就完成了修改，可以在iOS设备上使用自定义的文本输入框了。</p><p>其实github上有很多关于iOS的alert的自定义开源项目，不过objective-c的.m文件不能在UE4中直接使用，并且狠毒哦项目原本是用来进行直接的iOS的应用开发的，会写的比较完善和复杂，有需要的话可以参考，这里就简单实现了一下。</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>iOS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：NiagaraSystem批量删除modules</title>
    <link href="/posts/29435/"/>
    <url>/posts/29435/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202320230401162109.png" alt="NiagaraSystem" /></p><p>如上图，NiagaraSystem中存在一些disabled的modules，TA大佬需要删除这些modules，但是一个一个删除太麻烦了，希望可以有一个批量删除的方法。</p><p>但是众所周知NiagaraSystem面向数据，在UNiagaraEmitter中根本没有modules相关的信息。</p><p>最后是通过编辑器界面Slate的数据获取方式找到了如何获取NiagaraSystem中的modules信息。</p><h1 id="相关源码"><a class="markdownIt-Anchor" href="#相关源码"></a> 相关源码</h1><p>通过SlateWidgetReflector定位到了module的数据来源：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20230401163527.png" alt="SlateWidgetReflector" /></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++">ChildSlot<br>[<br><span class="hljs-built_in">SAssignNew</span>(EntryListView, SListView&lt;UNiagaraStackEntry*&gt;)<br>.<span class="hljs-built_in">ListItemsSource</span>(&amp;FlattenedEntryList)<br>.<span class="hljs-built_in">OnGenerateRow</span>(<span class="hljs-keyword">this</span>, &amp;SNiagaraOverviewStack::OnGenerateRowForEntry)<br>.<span class="hljs-built_in">OnSelectionChanged</span>(<span class="hljs-keyword">this</span>, &amp;SNiagaraOverviewStack::OnSelectionChanged)<br>.<span class="hljs-built_in">SelectionMode</span>(ESelectionMode::Multi)<br>.<span class="hljs-built_in">OnItemToString_Debug_Static</span>(&amp;FNiagaraStackEditorWidgetsUtilities::StackEntryToStringForListDebug)<br>];<br></code></pre></td></tr></table></figure><p><code>StackItem</code>的数据来源于<code>FlattenedEntryList</code></p><p>那么<code>FlattenedEntryList</code>的数据来源于哪里？</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SNiagaraOverviewStack::RefreshEntryList</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">if</span> (bRefreshEntryListPending)<br>&#123;<br>FlattenedEntryList.<span class="hljs-built_in">Empty</span>();<br>EntryObjectKeyToParentChain.<span class="hljs-built_in">Empty</span>();<br>TArray&lt;UClass*&gt; AcceptableClasses;<br>AcceptableClasses.<span class="hljs-built_in">Add</span>(UNiagaraStackItemGroup::<span class="hljs-built_in">StaticClass</span>());<br>AcceptableClasses.<span class="hljs-built_in">Add</span>(UNiagaraStackItem::<span class="hljs-built_in">StaticClass</span>());<br><br>UNiagaraStackEntry* RootEntry = StackViewModel-&gt;<span class="hljs-built_in">GetRootEntry</span>();<br><span class="hljs-built_in">checkf</span>(RootEntry != <span class="hljs-literal">nullptr</span>, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Root entry was null.&quot;</span>));<br>TArray&lt;UNiagaraStackEntry*&gt; RootChildren;<br>RootEntry-&gt;<span class="hljs-built_in">GetFilteredChildren</span>(RootChildren);<br><span class="hljs-keyword">for</span> (UNiagaraStackEntry* RootChild : RootChildren)<br>&#123;<br><span class="hljs-built_in">checkf</span>(RootEntry != <span class="hljs-literal">nullptr</span>, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Root entry child was null.&quot;</span>));<br>TArray&lt;UNiagaraStackEntry*&gt; ParentChain;<br><span class="hljs-built_in">AddEntriesRecursive</span>(*RootChild, FlattenedEntryList, AcceptableClasses, ParentChain);<br>&#125;<br><br>bRefreshEntryListPending = <span class="hljs-literal">false</span>;<br>EntryListView-&gt;<span class="hljs-built_in">RequestListRefresh</span>();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>从上面这段代码可以看出来，<code>StackViewModel-&gt;GetRootEntry()</code>获得了<code>UNiagaraStackEntry</code>类型的<code>RootEntry</code>，然后通过<code>RootEntry-&gt;GetFilteredChildren(RootChildren)</code>获得了<code>RootChildren</code>，最后通过<code>AddEntriesRecursive</code>将<code>RootChildren</code>中的数据添加到了<code>FlattenedEntryList</code>中。</p><p>而<code>StackViewModel</code>则是在Construct函数中传递过来的，那么继续往上一层寻找，发现是在<code>SNiagaraOverviewStackNode.cpp</code>中的<code>CreateNodeContentArea()</code>函数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">TSharedRef&lt;SWidget&gt; <span class="hljs-title">SNiagaraOverviewStackNode::CreateNodeContentArea</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>TSharedPtr&lt;SWidget&gt; ContentWidget;<br><span class="hljs-keyword">if</span> (StackViewModel != <span class="hljs-literal">nullptr</span> &amp;&amp; OverviewSelectionViewModel != <span class="hljs-literal">nullptr</span>)<br>&#123;<br>ContentWidget = <span class="hljs-built_in">SNew</span>(SBox)<br>.<span class="hljs-built_in">MaxDesiredWidth</span>(<span class="hljs-number">300</span>)<br>[<br><span class="hljs-built_in">SNew</span>(SNiagaraOverviewStack, *StackViewModel, *OverviewSelectionViewModel)<br>];<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>ContentWidget = SNullWidget::NullWidget;<br>&#125;<br><br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>最后找到</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C++">FNiagaraEditorModule&amp; NiagaraEditorModule = FModuleManager::<span class="hljs-built_in">Get</span>().<span class="hljs-built_in">LoadModuleChecked</span>&lt;FNiagaraEditorModule&gt;(<span class="hljs-string">&quot;NiagaraEditor&quot;</span>);<br>TSharedPtr&lt;FNiagaraSystemViewModel&gt; OwningSystemViewModel = NiagaraEditorModule.<span class="hljs-built_in">GetExistingViewModelForSystem</span>(OverviewStackNode-&gt;<span class="hljs-built_in">GetOwningSystem</span>());<br><span class="hljs-keyword">if</span> (OwningSystemViewModel.<span class="hljs-built_in">IsValid</span>())<br>&#123;<br>    <span class="hljs-keyword">if</span> (OverviewStackNode-&gt;<span class="hljs-built_in">GetEmitterHandleGuid</span>().<span class="hljs-built_in">IsValid</span>() == <span class="hljs-literal">false</span>)<br>    &#123;<br>        StackViewModel = OwningSystemViewModel-&gt;<span class="hljs-built_in">GetSystemStackViewModel</span>();<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        EmitterHandleViewModelWeak = OwningSystemViewModel-&gt;<span class="hljs-built_in">GetEmitterHandleViewModelById</span>(OverviewStackNode-&gt;<span class="hljs-built_in">GetEmitterHandleGuid</span>());<br>        <span class="hljs-keyword">if</span> (EmitterHandleViewModelWeak.<span class="hljs-built_in">IsValid</span>())<br>        &#123;<br>            StackViewModel = EmitterHandleViewModelWeak.<span class="hljs-built_in">Pin</span>()-&gt;<span class="hljs-built_in">GetEmitterStackViewModel</span>();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这个OverviewStackNode-&gt;GetOwningSystem()就是我们要找的NiagaraSystem，然后通过<code>NiagaraEditorModule.GetExistingViewModelForSystem</code>获得了<code>OwningSystemViewModel</code>，最后通过<code>OwningSystemViewModel-&gt;GetSystemStackViewModel()</code>获得了<code>StackViewModel</code>。</p><p>然鹅，我惊讶的发现，直接将UNiagaraSystem传进去，通过<code>NiagaraEditorModule.GetExistingViewModelForSystem</code>获得的<code>OwningSystemViewModel</code>是空的，除非我手动打开了当前的NiagaraSystem的Editor。</p><p>毕竟是面向数据，得想办法绕绕路。</p><p>于是我又通过断点调试等方式，发现需要手动初始化一个<code>FNiagaraSystemViewModel</code>才可以，该类型的Initialize函数中处理了相关的数据初始化。</p><h1 id="最终实现"><a class="markdownIt-Anchor" href="#最终实现"></a> 最终实现</h1><p>由于<code>FNiagaraSystemViewModel</code>类型并没有从编辑器方法中导出，无法直接在外部使用，但是幸好FNiagaraEditorModule是处于同一个模块下的，于是在这里扩展出一个方法即可：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">TSharedPtr&lt;FNiagaraSystemViewModel&gt; <span class="hljs-title">FNiagaraEditorModule::GetSystemExistingViewModel</span><span class="hljs-params">(UNiagaraSystem* InSystem)</span></span><br><span class="hljs-function"></span>&#123;<br>TSharedPtr&lt;FNiagaraSystemViewModel&gt; SystemViewModel = <span class="hljs-built_in">MakeShared</span>&lt;FNiagaraSystemViewModel&gt;();<br>FNiagaraSystemViewModelOptions SystemViewModelOptions = <span class="hljs-built_in">FNiagaraSystemViewModelOptions</span>();<br>SystemViewModelOptions.EditMode = ENiagaraSystemViewModelEditMode::SystemAsset;<br>SystemViewModelOptions.MessageLogGuid = InSystem-&gt;<span class="hljs-built_in">GetAssetGuid</span>();<br>SystemViewModelOptions.bCanAutoCompile = <span class="hljs-literal">false</span>;<br>SystemViewModelOptions.bCanSimulate = <span class="hljs-literal">false</span>;<br>SystemViewModelOptions.bIsForDataProcessingOnly = <span class="hljs-literal">true</span>;<br>SystemViewModel-&gt;<span class="hljs-built_in">Initialize</span>(*InSystem, SystemViewModelOptions);<br>TSharedPtr&lt;FNiagaraSystemViewModel&gt; ExistingViewModel = SystemViewModel-&gt;<span class="hljs-built_in">GetExistingViewModelForObject</span>(InSystem);<br><span class="hljs-keyword">return</span> ExistingViewModel;<br>&#125;<br></code></pre></td></tr></table></figure><p>通过以上方法就可以直接对UNiagaraSystem进行操作了，可以获取到FNiagaraSystemViewModel，并且不需要打开编辑器</p><p>在获取到<code>FNiagaraSystemViewModel</code>之后，可以通过EmitterHandleID获取到<code>FNiagaraEmitterHandleViewModel</code>，再进一步获取到<code>UNiagaraStackViewModel</code>，然后就可以通过UNiagaraStackViewModel获取到<code>UNiagaraStackEntry</code>，最后可以获取到<code>UNiagaraStackModuleItem</code>，</p><p>而<code>UNiagaraStackModuleItem</code>可以通过函数<code>GetIsEnabled</code>获取到其是否启用，如果没有启用并且需要删除的话，只需要调用<code>Delete()</code><br />函数即可。</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Niagara</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：将指定Widget保存为PNG</title>
    <link href="/posts/52037/"/>
    <url>/posts/52037/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>UE本身是提供截图功能的，但是部分情况下策划不想要当前玩家实际整个屏幕的显示，只想要UI的一部分</p><h1 id="实现"><a class="markdownIt-Anchor" href="#实现"></a> 实现</h1><p>思路就是手动创建RT，然后Draw，然后保存……（？</p><p>具体代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">UTestLibrary::SaveWidgetToPNG</span><span class="hljs-params">(<span class="hljs-type">const</span> FString&amp; FileName, UWidget* Widget, <span class="hljs-type">const</span> FVector2D&amp; DrawSize)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsValid</span>(Widget))<br>    &#123;<br>        <span class="hljs-built_in">UE_LOG</span>(LogTemp, Error, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Widget is not valid&quot;</span>));<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    TSharedPtr&lt;SWidget&gt; SWidgetPtr = Widget-&gt;<span class="hljs-built_in">GetCachedWidget</span>();<br><br>    <span class="hljs-keyword">if</span> (DrawSize == FVector2D::ZeroVector)<br>    &#123;<br>        <span class="hljs-built_in">UE_LOG</span>(LogTemp, Error, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;DrawSize is not valid&quot;</span>));<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-type">const</span> FString FilePath = FPaths::<span class="hljs-built_in">ProjectSavedDir</span>() / <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Screenshots&quot;</span>);<br>    FString FullFileName = FilePath / FileName;<br>    <span class="hljs-keyword">if</span> (!FullFileName.<span class="hljs-built_in">EndsWith</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;.png&quot;</span>), ESearchCase::IgnoreCase))<br>    &#123;<br>        FullFileName = FullFileName + (<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;.png&quot;</span>));<br>    &#125;<br><br>    FWidgetRenderer* WidgetRenderer = <span class="hljs-keyword">new</span> FWidgetRenderer;<br>    WidgetRenderer-&gt;<span class="hljs-built_in">SetIsPrepassNeeded</span>(<span class="hljs-literal">false</span>);<br><br>    <span class="hljs-type">const</span> TSharedRef&lt;SWidget&gt; WidgetRef = SWidgetPtr.<span class="hljs-built_in">ToSharedRef</span>();<br>    UTextureRenderTarget2D* RenderTarget2D = <span class="hljs-built_in">NewObject</span>&lt;UTextureRenderTarget2D&gt;();<br>    <span class="hljs-type">const</span> EPixelFormat RequestedFormat = FSlateApplication::<span class="hljs-built_in">Get</span>().<span class="hljs-built_in">GetRenderer</span>()-&gt;<span class="hljs-built_in">GetSlateRecommendedColorFormat</span>();<br>    RenderTarget2D-&gt;Filter = TF_Bilinear;<br>    RenderTarget2D-&gt;ClearColor = FLinearColor::Red;<br>    RenderTarget2D-&gt;SRGB = <span class="hljs-literal">true</span>;<br>    RenderTarget2D-&gt;TargetGamma = <span class="hljs-number">1</span>;<br>    RenderTarget2D-&gt;RenderTargetFormat = RTF_RGBA8;<br>    RenderTarget2D-&gt;<span class="hljs-built_in">InitCustomFormat</span>(DrawSize.X, DrawSize.Y, RequestedFormat, <span class="hljs-literal">false</span>);<br>    RenderTarget2D-&gt;<span class="hljs-built_in">UpdateResourceImmediate</span>(<span class="hljs-literal">true</span>);<br>    WidgetRenderer-&gt;<span class="hljs-built_in">DrawWidget</span>(RenderTarget2D, SWidgetPtr.<span class="hljs-built_in">ToSharedRef</span>(), DrawSize, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);<br>    <span class="hljs-type">const</span> FString SavePath = FPaths::<span class="hljs-built_in">ProjectSavedDir</span>() / <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Screenshots&quot;</span>);<br>    <span class="hljs-type">const</span> FString File = SavePath / FileName;<br>    UKismetRenderingLibrary::<span class="hljs-built_in">ExportRenderTarget</span>(<span class="hljs-literal">nullptr</span>, RenderTarget2D, FilePath, FileName);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="简单解释"><a class="markdownIt-Anchor" href="#简单解释"></a> 简单解释</h1><h2 id="1-创建rendertarget"><a class="markdownIt-Anchor" href="#1-创建rendertarget"></a> 1. 创建RenderTarget</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++">UTextureRenderTarget2D* RenderTarget2D = <span class="hljs-built_in">NewObject</span>&lt;UTextureRenderTarget2D&gt;();<br><span class="hljs-type">const</span> EPixelFormat RequestedFormat = FSlateApplication::<span class="hljs-built_in">Get</span>().<span class="hljs-built_in">GetRenderer</span>()-&gt;<span class="hljs-built_in">GetSlateRecommendedColorFormat</span>();<br>RenderTarget2D-&gt;Filter = TF_Bilinear;<br>RenderTarget2D-&gt;ClearColor = FLinearColor::Red;<br>RenderTarget2D-&gt;SRGB = <span class="hljs-literal">true</span>;<br>RenderTarget2D-&gt;TargetGamma = <span class="hljs-number">1</span>;<br>RenderTarget2D-&gt;RenderTargetFormat = RTF_RGBA8;<br>RenderTarget2D-&gt;<span class="hljs-built_in">InitCustomFormat</span>(DrawSize.X, DrawSize.Y, RequestedFormat, <span class="hljs-literal">false</span>);<br>RenderTarget2D-&gt;<span class="hljs-built_in">UpdateResourceImmediate</span>(<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><p>上面的代码是创建一个<code>UTextureRenderTarget2D</code>对象，然后设置一些参数，最后调用<code>UpdateResourceImmediate()</code>方法立即更新资源</p><h3 id="相关参数与方法解释"><a class="markdownIt-Anchor" href="#相关参数与方法解释"></a> 相关参数与方法解释</h3><ul><li><code>GetSlateRecommendedColorFormat()</code> 获取Slate推荐的颜色格式, 一般是<code>PF_B8G8R8A8</code></li><li><code>Filter</code> 采样此纹理时要使用的纹理过滤模式，一般是<code>TF_Bilinear</code></li><li><code>ClearColor</code> 清除纹理时要使用的颜色，大部分情况下很多用的是透明色，我这里用红色是为了方便调试</li><li><code>SRGB</code> 是否使用sRGB颜色空间</li><li><code>TargetGamma</code> 用于渲染到纹理的gamma值，如果&gt;0，将覆盖FTextureRenderTarget2DResource::GetDisplayGamma</li><li><code>RenderTargetFormat</code> 纹理的格式，一般是<code>RTF_RGBA8</code></li><li><code>InitCustomFormat()</code> 初始化自定义格式的纹理，第四个参数是<code>bInForceLinearGame</code>，如果为true，则使用线性颜色空间，否则使用sRGB颜色空间</li><li><code>UpdateResourceImmediate()</code> 立即更新资源，参数是<code>bClearRenderTarget</code>，如果为true，则清除纹理</li></ul><p>需要注意色彩管理相关的参数，如果和游戏本身的色彩管理不一致，可能会导致截图的颜色不正确。<br />在UE4中，为了获得更好的暗部精度，线性伽马空间是指所有颜色的数学运算都发生在线性空间中的渲染管道。输入颜色纹理（漫反射，镜面反射等）存储在伽马空间中以获得更好的暗部精度。这些纹理采用sRGB读取进行采样，这样可以进行转换<sup id="fnref:1" class="footnote-ref"><a href="#fn:1" rel="footnote"><span class="hint--top hint--rounded" aria-label="UE4 搞的有点头痛的SRGB和线性空间 - 知乎.">[1]</span></a></sup>。</p><h2 id="2-draw"><a class="markdownIt-Anchor" href="#2-draw"></a> 2. Draw</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++">WidgetRenderer-&gt;<span class="hljs-built_in">DrawWidget</span>(RenderTarget2D, SWidgetPtr.<span class="hljs-built_in">ToSharedRef</span>(), DrawSize, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><p>调用<code>DrawWidget()</code>方法，将Widget绘制到RenderTarget上</p><h3 id="相关参数与方法解释-2"><a class="markdownIt-Anchor" href="#相关参数与方法解释-2"></a> 相关参数与方法解释</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawWidget</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">UTextureRenderTarget2D* RenderTarget,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">const</span> TSharedRef&lt;SWidget&gt;&amp; Widget,</span></span><br><span class="hljs-params"><span class="hljs-function">FVector2D DrawSize,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">float</span> DeltaTime,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">bool</span> bDeferRenderTargetUpdate = <span class="hljs-literal">false</span>)</span></span>;<br></code></pre></td></tr></table></figure><ul><li><code>DrawWidget()</code> 方法的参数解释<ul><li><code>RenderTarget</code> 要绘制到的RenderTarget</li><li><code>Widget</code> 要绘制的Widget</li><li><code>DrawSize</code> 绘制的大小</li><li><code>DeltaTime</code> 绘制的时间</li><li><code>bDeferRenderTargetUpdate</code> 是否延迟更新RenderTarget，如果为true，则需要手动调用<code>UpdateResourceImmediate()</code>方法更新RenderTarget</li></ul></li></ul><h2 id="3-保存"><a class="markdownIt-Anchor" href="#3-保存"></a> 3. 保存</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-type">const</span> FString SavePath = FPaths::<span class="hljs-built_in">ProjectSavedDir</span>() / <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Screenshots&quot;</span>);<br><span class="hljs-type">const</span> FString File = SavePath / FileName;<br>UKismetRenderingLibrary::<span class="hljs-built_in">ExportRenderTarget</span>(<span class="hljs-literal">nullptr</span>, RenderTarget2D, FilePath, FileName);<br></code></pre></td></tr></table></figure><p>调用<code>UKismetRenderingLibrary::ExportRenderTarget()</code>方法，将RenderTarget保存为PNG</p><p>这里需要注意，<code>ExportRenderTarget</code>的内部首先是根据<code>RenderTarget</code>的<code>RenderTargetFormat</code>来判断要保存的格式，如果是<code>RTF_RGBA16f</code>，则会直接进入HDR格式的流程，所以前面选择手动创建RenderTarget并且设置<code>RenderTargetFormat</code>为<code>RTF_RGBA8</code>，这样就可以保证保存的是PNG格式</p><h1 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h1><section class="footnotes"><div class="footnote-list"><ol><li><span id="fn:1" class="footnote-text"><span><a href="https://zhuanlan.zhihu.com/p/373171825">UE4 搞的有点头痛的SRGB和线性空间 - 知乎.</a><a href="#fnref:1" rev="footnote" class="footnote-backref"> ↩</a></span></span></li></ol></div></section>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>UMG</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BinkVideo视频转换的命令行参数</title>
    <link href="/posts/10561/"/>
    <url>/posts/10561/</url>
    
    <content type="html"><![CDATA[<p>以下是通过命令行转换其他视频文件到bink的相关命令行参数的解释</p><p>在使用时大小写通用，和数字不需要空格</p><h2 id="d"><a class="markdownIt-Anchor" href="#d"></a> /D</h2><p>Specify the overall data rate to compress to.<br />1000 and up: Data rate to compress to (in bytes per second)<br />1 to 200: Compress to this % of the original file size.</p><p>/D# 参数指定了要压缩到的总数据率。如果值为1000或更高，则数据率将被压缩到（以每秒字节为单位）。如果值为1到200，则将压缩到原始文件大小的此百分比。</p><h2 id="m"><a class="markdownIt-Anchor" href="#m"></a> /M</h2><p>/M#.# - Specify the peak data rate to limit to.<br />1.0 to 10.0: Keep the peak data rate to under this many times the overall rate.<br />1000 and up. Peak data rate to stay under (in bytes per second).</p><p>/M#.# 参数指定了要限制的峰值数据率。如果值介于1.0到10.0之间，则将峰值数据率保持在总数据率的此多倍以下。如果值为1000或更高，则应保持在此以下的峰值数据率（以每秒字节为单位）。</p><h2 id="j"><a class="markdownIt-Anchor" href="#j"></a> /J</h2><p>/J# - Automatically promote to a key frame at what percentage change.</p><p>/J# 参数指定在多大百分比的变化时自动升级为关键帧。关键帧是视频流中重要的帧，包含了一个完整的视频图像，其他帧仅包含图像的差异。更改百分比较大时自动升级为关键帧可以提高图像质量。</p><p>这里的percentage change指的是图像中每个像素与上一帧像素之间的变化百分比。Bink在视频编码过程中使用关键帧来记录图像的每个像素的全部信息，以便更准确地进行解码。如果图像中的某些像素与上一帧像素的变化百分比超过了用户指定的阈值，那么Bink将自动把当前帧升级为关键帧，以便更精确地进行编码。</p><h2 id="k"><a class="markdownIt-Anchor" href="#k"></a> /K</h2><p>/K# - Specify key frame frequency (key every x frames).</p><p>/K# 参数指定关键帧频率（每 x 帧关键帧）。频繁的关键帧可以提高图像质量，但也会增加文件大小。指定的频率决定了关键帧的数量，因此可以控制文件大小和图像质量之间的平衡。</p><h2 id="p"><a class="markdownIt-Anchor" href="#p"></a> /P</h2><p>/P# - Number of frames to preview (for bandwidth allocation).</p><p>/P# 参数指定预览帧数（用于带宽分配）。该值决定了在压缩视频时使用多少帧来预测带宽需求。预测的带宽需求决定了压缩视频所需的码率，因此影响了文件大小和图像质量。较高的预览帧数可以提高图像质量，但也会增加文件大小。</p><h2 id="s"><a class="markdownIt-Anchor" href="#s"></a> /S</h2><p>/S# - Specifies the starting frame.</p><p>指定开始的帧</p><h2 id="e"><a class="markdownIt-Anchor" href="#e"></a> /E</h2><p>/E# - Specifies the ending frame.</p><p>指定结束的帧</p><h2 id="f"><a class="markdownIt-Anchor" href="#f"></a> /F</h2><p>/F#.# - Override the output frame rate (force the change).</p><p>/F#.# 参数覆盖输出帧速率（强制更改）。该值决定了输出视频的帧速率<br />/F30.0 将强制将帧速率设置为30帧每秒，/F24.0 将强制将帧速率设置为24帧每秒。</p><h2 id="a"><a class="markdownIt-Anchor" href="#a"></a> /A</h2><p>/A#.# - Adjust the input frame rate to this output frame rate (add/remove frames).</p><p>/A#.# 参数表示调整输入帧速率到该输出帧速率（添加/删除帧）。</p><p>例如：/A24.0 将调整输入帧速率为24帧每秒，/A30.0 将调整输入帧速率为30帧每秒。</p><p>请注意，如果您同时使用 /F 和 /A 参数，则仅使用 /F 参数。</p><h2 id="t"><a class="markdownIt-Anchor" href="#t"></a> /T</h2><p>T# - Bink track ID to place the sound into (0 by default).</p><p>/T# 参数表示要将声音放入的 Bink 轨道 ID（默认为0）。</p><h2 id="g"><a class="markdownIt-Anchor" href="#g"></a> /G</h2><p>/G# - Input track to read from (0 by default - first stereo or mono audio track).</p><h2 id="l"><a class="markdownIt-Anchor" href="#l"></a> /L</h2><p>/L# - Sound compression level: 0=lossless, 4=perceptibly lossless, 99=very lossy<br />Use -1 to not process the sound data in the input file.</p><p>声音压缩级别：0=无损，4=感知无损，99=非常有损<br />使用-1不处理输入文件中的声音数据。</p><h2 id="r"><a class="markdownIt-Anchor" href="#r"></a> /R</h2><p>/R# - Force the output data rate (11025, 22050, 44100, etc.).</p><p>/R# 参数表示强制输出数据率（11025，22050，44100等）。</p><h2 id="b"><a class="markdownIt-Anchor" href="#b"></a> /B</h2><p>/B# - Force the output bits (8 or 16).</p><p>/B# 参数表示强制输出位（8或16）。</p><h2 id="c"><a class="markdownIt-Anchor" href="#c"></a> /C</h2><p>/C# - Force the output channels (1=mono, 2=stereo).</p><p>/C# 参数表示强制输出声道（1=单声道，2=立体声）。</p><h2 id="l-2"><a class="markdownIt-Anchor" href="#l-2"></a> /L</h2><p>/L - Use grayscale (Bink 1 only).</p><p>/L 参数表示仅使用灰度色（仅适用于 Bink 1）。</p><p>这意味着将把视频编码为黑白图像而不是彩色图像。</p><h2 id="n"><a class="markdownIt-Anchor" href="#n"></a> /N</h2><p>/N# - Specify the rate to use for keyframes (and switch to no-data-rate-borrowing)</p><p>/N# 参数表示用于关键帧的速率（并切换到不使用数据率借用）。</p><p>这意味着将指定关键帧的码率，并不再从非关键帧中借用码率。</p><p>例如：/N3000 指定关键帧的码率为3000字节每秒。</p><p>关键帧是视频编码的重要概念。它是存储完整图像的帧，其他非关键帧仅存储图像的更改。</p><p>因此，对于关键帧的码率，您可以设置更高的码率以保证关键帧的图像质量，而对于非关键帧，您可以设置较低的码率以减小文件大小。</p><p>例如，如果您将关键帧的码率设置为5000字节每秒，则在编码过程中保证关键帧的图像质量，并且可以为非关键帧分配较低的码率以减小文件大小。</p><p>“不使用数据率借用” 指的是在压缩视频文件时，不再将额外的码率分配给非关键帧。关键帧是指存储整个视频图像的帧，非关键帧仅存储与上一帧的差异。在压缩视频文件时，通常会将额外的码率分配给非关键帧，以使压缩效果更好。然而，选择不使用数据率借用意味着仅将额外的码率分配给关键帧，因此非关键帧的质量可能会降低。</p><h2 id="z"><a class="markdownIt-Anchor" href="#z"></a> /Z</h2><p>/Z# - Graphics processing options:</p><ul><li>Bi-cubic scaling is the default and usually give the best quality.</li><li>Add 100 for bi-linear scaling instead.</li><li>Add 200 for box scaling instead.</li><li>By default, no alpha is processed.</li><li>Add 1000 to process the alpha plane.</li><li>Add 2000 to process the alpha plane (as pre-multiplied).</li><li>Add 3000 to process the alpha plane (and filter as pre-multiplied).</li><li>Add 10000 to suppress warning about missing alpha plane.</li><li>Add 20000 turn off zero alpha block weighting.</li></ul><p>Z#参数控制图形处理选项：</p><ul><li>默认情况下使用双三次缩放，通常会给出最佳质量。</li><li>加上100以使用双线性缩放。</li><li>加上200以使用箱式缩放。</li><li>默认情况下不处理alpha。</li><li>加上1000以处理alpha平面。</li><li>加上2000以将alpha平面预先处理。</li><li>加上3000以处理alpha平面（并将其过滤为预先乘积）。</li><li>加上10000以阻止警告缺失alpha平面。</li><li>加上20000以关闭零alpha块加权。</li></ul><p>Alpha Plane 是指图像中的透明度通道。在计算机图形学中，颜色通道和透明度通道组合起来构成一张图像。透明度通道存储了每个像素的不透明度，以便在图像合成期间对它们进行混合。在某些情况下，对 alpha 通道的处理可能会影响图像的质量和效果。</p><h2 id=""><a class="markdownIt-Anchor" href="#"></a> /.</h2><p>/.# - Use the denoising filter (0=no filter, 1=full denoising).</p><p>是使用降噪过滤器的参数，“0=无过滤器，1=完整降噪”。</p><h2 id="-2"><a class="markdownIt-Anchor" href="#-2"></a> /:</h2><p>/:# - Set the smoothness percentage (0=no smooth, 100=maximum smooth).</p><p>/:# 参数用于设置平滑百分比（0=不平滑，100=最大平滑）。</p><p>在这里，平滑是指视频图像的抗锯齿处理。它通过使用抗锯齿滤波器来平滑图像，从而减少图像的锯齿效应和提高图像质量。/:#参数用于设置平滑的百分比，0表示不平滑，100表示最大平滑。</p><h2 id="-3"><a class="markdownIt-Anchor" href="#-3"></a> /;</h2><p>/;# - Video de-interlacing (0=none, 1=even, 2=odd, add 8 for blending).</p><p>/;# 选项控制视频去交错的方式。<br />0=不进行去交错处理<br />1=处理偶数行<br />2=处理奇数行<br />加上 8 可以启用混合模式。</p><p>Video de-interlacing是视频图像去交错的过程。电视机通常使用交错扫描技术来把动态图像显示在屏幕上，但是这种扫描技术会导致图像中出现模糊和闪烁。De-interlacing就是通过把每一帧的交错图像转换成非交错图像来消除这种问题的过程。</p><h2 id="-4"><a class="markdownIt-Anchor" href="#-4"></a> /{</h2><p>/{ # - Set the contrast increase (0=none, 8=default, 127=max).</p><p>对比度增加指的是在视频压缩时，通过调整亮度差异来使图像更加鲜明对比。其中，数字0代表不增加对比度，8代表默认对比度增加，127代表最大对比度增加。</p><h2 id="-5"><a class="markdownIt-Anchor" href="#-5"></a> /}</h2><p>/}# - Set the clamp to black level (0=no clamp, 255=everything black).</p><p>/}# 参数用于设置黑色限制，即将视频的黑色值限制在一个最大值。如果设置为 “0”，则不会对黑色值进行限制。如果设置为 “255”，则所有的黑色值都会被限制在最大值，这可能会导致图像变得非常黑。</p><h2 id="-6"><a class="markdownIt-Anchor" href="#-6"></a> /[</h2><p>/[# - Set the brightness percentage (0=fully darken, 100=don’t change, 200=twice as bright).</p><p>视频亮度相关</p><h2 id="-7"><a class="markdownIt-Anchor" href="#-7"></a> /]</h2><p>/]#.# - Set the gamma correction (less than 1.0=darken, 1.0=don’t change, greater than 1.0=brighten)</p><p>伽马矫正值</p><h2 id="-8"><a class="markdownIt-Anchor" href="#-8"></a> /(</h2><p>/(# - Specifies the scale to width (shrinks or zooms).</p><p>视频宽度缩放</p><h2 id="-9"><a class="markdownIt-Anchor" href="#-9"></a> /)</h2><p>/)# - Specifies the scale to height (shrinks or zooms).</p><p>高度缩放</p><h2 id="x"><a class="markdownIt-Anchor" href="#x"></a> /X</h2><p>/X# - Specifies the cropping left coordinate.</p><p>左侧裁剪坐标</p><h2 id="y"><a class="markdownIt-Anchor" href="#y"></a> /Y</h2><p>/Y# - Specifies the cropping top coordinate.</p><p>顶部裁剪坐标</p><h2 id="w"><a class="markdownIt-Anchor" href="#w"></a> /W</h2><p>/W# - Specifies the cropping width.</p><p>裁剪宽度</p><h2 id="h"><a class="markdownIt-Anchor" href="#h"></a> /H</h2><p>/H# - Specifies the cropping height.</p><p>裁剪高度</p><h2 id="u"><a class="markdownIt-Anchor" href="#u"></a> /U</h2><p>/U# - Specifies the maximum number of CPUs to use.</p><p>指定最多使用多少CPU</p><h2 id="v"><a class="markdownIt-Anchor" href="#v"></a> /V</h2><p>/V# - Version of Bink file to create.<br />100 = Bink 1, 200 = Bink 2, 270 = Bink 2 HDR</p><p>指定Bink文件的版本</p>]]></content>
    
    
    
    <tags>
      
      <tag>Bink</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：Material的一些属性的获取</title>
    <link href="/posts/23315/"/>
    <url>/posts/23315/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>本文基于4.27版本<br />大概总结了一些最近工作中遇到的，很大几率记不住的，日后可能还需要的用到的一些用于编辑器下获取材质<code>（UMaterial）</code>的某些属性的接口，适合做工具用</p><h1 id="材质编辑器界面"><a class="markdownIt-Anchor" href="#材质编辑器界面"></a> 材质编辑器界面</h1><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20230204142955.png" alt="材质编辑器" /></p><p>上图中左侧三个节点是<code>UMaterialExpression</code>类及其子类</p><p>右侧的比如<code>BaseColor</code>叫做Material的属性，<code>M_Basic_Floor</code>是材质的名字</p><h1 id="一些相关方法"><a class="markdownIt-Anchor" href="#一些相关方法"></a> 一些相关方法</h1><h2 id="获取材质中的表达式"><a class="markdownIt-Anchor" href="#获取材质中的表达式"></a> 获取材质中的表达式</h2><p>对于一个UMaterial，如果想在编辑器模式下在C++中获取所有的表达式，可以使用这个方法<code>GetAllExpressionsInMaterialAndFunctionsOfType</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C++">UMaterial* Material;<br>TArray&lt;UMaterialExpression*&gt; Expressions;<br>Material-&gt;<span class="hljs-built_in">GetAllExpressionsInMaterialAndFunctionsOfType</span>(Expressions);<br></code></pre></td></tr></table></figure><p><code>GetAllExpressionsInMaterialAndFunctionsOfType</code>这个函数可以获取到当前的UMaterial中所有的指定类型的表达式，并且会获取使用到的UMaterialFunction（下文可能会简写成MF）中的对应类型的表达式。<br />上面的函数会获取到指定的Material中全部的表达式，因为定义的数组<code>Expressions</code>的类型是<code>UMaterialExpression</code>，是表达式的基类。<br />如果是下面这样：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C++">TArray&lt;UMaterialExpressionMaterialFunctionCall*&gt; ExpressionMaterialFunctionCalls;<br>Material-&gt;<span class="hljs-built_in">GetAllExpressionsInMaterialAndFunctionsOfType</span>(ExpressionMaterialFunctionCalls);<br></code></pre></td></tr></table></figure><p>获取到的将只有材质中的<code>UMaterialExpressionMaterialFunctionCall</code>类型的表达式。</p><p>如果只想获取到当前的材质中的表达式，并不需要获取所使用的MF中的表达式，可以使用下面这个方法<code>GetAllExpressionsOfType</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C++">TArray&lt;<span class="hljs-type">const</span> UMaterialExpression*&gt; Expressions;<br>Material-&gt;<span class="hljs-built_in">GetAllExpressionsOfType</span>(Expressions);<br></code></pre></td></tr></table></figure><h2 id="获取输入到材质某一个属性的表达式节点"><a class="markdownIt-Anchor" href="#获取输入到材质某一个属性的表达式节点"></a> 获取输入到材质某一个属性的表达式节点</h2><p>还是上面的那张图，如果需要获取到输入到<code>BaseColor</code>这个材质属性的表达式，可以用下面的方法：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C++">FExpressionInput* ExpressionInput = Material-&gt;<span class="hljs-built_in">GetExpressionInputForProperty</span>(EMaterialProperty::MP_BaseColor);<br>UMaterialExpression* MaterialExpression = ExpressionInput-&gt;Expression;<br></code></pre></td></tr></table></figure><p>其中<code>EMaterialProperty</code>是定义在<code>Engine\Source\Runtime\Engine\Public\SceneTypes.h</code>中的枚举</p><h2 id="获取材质中mf调用时的输入的表达式"><a class="markdownIt-Anchor" href="#获取材质中mf调用时的输入的表达式"></a> 获取材质中MF调用时的输入的表达式</h2><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20230204150213.png" alt="MaterialFunctionCall" /></p><p>如图，<code>1Dto2DIndex</code>是一个<code>UMaterialExpressionMaterialFunctionCall</code>，是UMaterialExpression的子类，定义在<code>MaterialExpressionMaterialFunctionCall.h</code>中</p><p>如果我要获取它的某一个Input前面的表达式的话，可以用下面的方法：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C++">UMaterialExpressionMaterialFunctionCall* MaterialExpressionMaterialFunctionCall;<br>TArray&lt;FExpressionInput*&gt; Inputs = MaterialExpressionMaterialFunctionCall-&gt;<span class="hljs-built_in">GetInputs</span>();<br><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> FExpressionInput* Input : Inputs)<br>&#123;<br>UMaterialExpression* Expression = Input-&gt;Expression;<br>&#125;<br></code></pre></td></tr></table></figure><p>以上代码是可以获取到在当前材质的层级里，MF作为一个表达式的输入，获取到的是图上的两个0的Expression。</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023/20230204155110.png" alt="UMaterialFunction" /></p><p>如果要获取这个MF在自己的UMaterialFunction中的对应的input节点的输入的表达式（如上图）的话，需要的是如下的方法：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C++"> TArray&lt;FFunctionExpressionInput&gt; FunctionInputs = MaterialExpressionMaterialFunctionCall-&gt;FunctionInputs;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> FFunctionExpressionInput FunctionInput : FunctionInputs)<br>&#123;<br>    UMaterialExpressionFunctionInput* MaterialExpressionFunctionInput = FunctionInput.ExpressionInput;<br>    TArray&lt;FExpressionInput*&gt; Inputs = MaterialExpressionFunctionInput-&gt;<span class="hljs-built_in">GetInputs</span>();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> FExpressionInput* Input : Inputs)<br>    &#123;<br>        UMaterialExpression* Expression = Input-&gt;Expression;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以获取到UMaterialFunction中对应的Input节点的输入表达式。</p><h1 id="一些tips"><a class="markdownIt-Anchor" href="#一些tips"></a> 一些Tips</h1><h2 id="umaterialexpression"><a class="markdownIt-Anchor" href="#umaterialexpression"></a> UMaterialExpression</h2><p>位置：<code>MaterialExpression.h</code></p><p>指的注意的是，通过UMaterialExpression是可以获取他属于的材质或者材质函数的</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * The material that this expression is currently being compiled in.  </span><br><span class="hljs-comment"> * This is not necessarily the object which owns this expression, for example a preview material compiling a material function&#x27;s expressions.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">UPROPERTY</span>()<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">UMaterial</span>* Material;<br><br><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * The material function that this expression is being used with, if any.</span><br><span class="hljs-comment"> * This will be NULL if the expression belongs to a function that is currently being edited, </span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">UPROPERTY</span>()<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">UMaterialFunction</span>* Function;<br></code></pre></td></tr></table></figure><h2 id="fexpressioninput"><a class="markdownIt-Anchor" href="#fexpressioninput"></a> FExpressionInput</h2><p>对于FExpressionInput这个类型，有成员变量<code>Expression</code>可以获得<code>UMaterialExpression*</code>，进一步可以通过UMaterialExpression获得表达式的Name等属性，但是在WITH_EDITOR里发现成员变量<code>ExpressionName</code>是None</p><h2 id="umaterialexpressionmaterialfunctioncall"><a class="markdownIt-Anchor" href="#umaterialexpressionmaterialfunctioncall"></a> UMaterialExpressionMaterialFunctionCall</h2><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2023//20230204162725.png" alt="FunctionCallInputName" /></p><p>如果想要获取如图上红框内的这个名字，可以这样：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C++">UMaterialExpressionMaterialFunctionCall* ExpressionMaterialFunctionCall;<br><span class="hljs-keyword">for</span> (FFunctionExpressionInput FunctionInput : ExpressionMaterialFunctionCall-&gt;FunctionInputs)<br>&#123;<br><span class="hljs-type">const</span> FString InputExpressionName = FunctionInput.Input.Expression-&gt;<span class="hljs-built_in">GetName</span>();<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Material</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：获取材质表达式的信息和值</title>
    <link href="/posts/40430/"/>
    <url>/posts/40430/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>本文基于4.27</p><p>本文记录最近工作中遇到的与材质系统相关的内容</p><h1 id="umaterial"><a class="markdownIt-Anchor" href="#umaterial"></a> UMaterial</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UMaterial</span> : <span class="hljs-keyword">public</span> UMaterialInterface<br></code></pre></td></tr></table></figure><img src = https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20221127222952.png width = 30%><p>图上这些是材质的输入节点，类型有FScalarMaterialInput、FColorMaterialInput、FVectorMaterialInput等，都继承自FMaterialInput。</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20221127224030.png" alt="20221127224030" /></p><p>这些是材质表达式。</p><h2 id="获取输入到材质的某一个materialproperty的表达式"><a class="markdownIt-Anchor" href="#获取输入到材质的某一个materialproperty的表达式"></a> 获取输入到材质的某一个MaterialProperty的表达式</h2><p>方法：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">FExpressionInput* <span class="hljs-title">GetExpressionInputForProperty</span><span class="hljs-params">(EMaterialProperty InProperty)</span></span>;<br></code></pre></td></tr></table></figure><p>参数：<br />枚举类型，表示材质的某一个属性，比如BaseColor、Metallic、Roughness等，定义在SceneTypes.h中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">EMaterialProperty</span><br></code></pre></td></tr></table></figure><p>返回值：<br />返回一个ExpressionInput的指针，表示的是输入到这个材质属性的一个表达式。如果没有的话会返回一个空指针。<br />比如前面的图里的Engine自带的材质M_Basic_Floor来讲，其中BaseColor的输入是Color，那么通过如下调用：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++">FExpressionInput* BaseColorInput = Material-&gt;<span class="hljs-built_in">GetExpressionInputForProperty</span>(EMaterialProperty::MP_BaseColor);<br></code></pre></td></tr></table></figure><p>就可以得到BaseColor的ExpressionInput，在通过类型转换可以确认具体的表达式类型并进行进一步的操作。</p><h2 id="获取材质实例的某种类型的参数"><a class="markdownIt-Anchor" href="#获取材质实例的某种类型的参数"></a> 获取材质实例的某种类型的参数</h2><p>方法：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GetAllParametersOfType</span><span class="hljs-params">(EMaterialParameterType Type, TArray&lt;FMaterialParameterInfo&gt;&amp; OutParameterInfo, TArray&lt;FGuid&gt;&amp; OutParameterIds)</span> <span class="hljs-type">const</span></span>;<br><br><span class="hljs-function">ENGINE_API <span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">GetAllScalarParameterInfo</span><span class="hljs-params">(TArray&lt;FMaterialParameterInfo&gt;&amp; OutParameterInfo, TArray&lt;FGuid&gt;&amp; OutParameterIds)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;<br><span class="hljs-function">ENGINE_API <span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">GetAllVectorParameterInfo</span><span class="hljs-params">(TArray&lt;FMaterialParameterInfo&gt;&amp; OutParameterInfo, TArray&lt;FGuid&gt;&amp; OutParameterIds)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;<br><span class="hljs-function">ENGINE_API <span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">GetAllTextureParameterInfo</span><span class="hljs-params">(TArray&lt;FMaterialParameterInfo&gt;&amp; OutParameterInfo, TArray&lt;FGuid&gt;&amp; OutParameterIds)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;<br><span class="hljs-function">ENGINE_API <span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">GetAllRuntimeVirtualTextureParameterInfo</span><span class="hljs-params">(TArray&lt;FMaterialParameterInfo&gt;&amp; OutParameterInfo, TArray&lt;FGuid&gt;&amp; OutParameterIds)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;<br><span class="hljs-function">ENGINE_API <span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">GetAllFontParameterInfo</span><span class="hljs-params">(TArray&lt;FMaterialParameterInfo&gt;&amp; OutParameterInfo, TArray&lt;FGuid&gt;&amp; OutParameterIds)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> WITH_EDITORONLY_DATA</span><br><span class="hljs-function">ENGINE_API <span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">GetAllMaterialLayersParameterInfo</span><span class="hljs-params">(TArray&lt;FMaterialParameterInfo&gt;&amp; OutParameterInfo, TArray&lt;FGuid&gt;&amp; OutParameterIds)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;<br><span class="hljs-function">ENGINE_API <span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">GetAllStaticSwitchParameterInfo</span><span class="hljs-params">(TArray&lt;FMaterialParameterInfo&gt;&amp; OutParameterInfo, TArray&lt;FGuid&gt;&amp; OutParameterIds)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;<br><span class="hljs-function">ENGINE_API <span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">GetAllStaticComponentMaskParameterInfo</span><span class="hljs-params">(TArray&lt;FMaterialParameterInfo&gt;&amp; OutParameterInfo, TArray&lt;FGuid&gt;&amp; OutParameterIds)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// WITH_EDITORONLY_DATA</span></span><br></code></pre></td></tr></table></figure><p>使用方式，用GetAllScalarParameterInfo举例</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// 获取ScalarParameterInfos</span><br>TArray&lt;FMaterialParameterInfo&gt; ScalarParameterInfos;<br>TArray&lt;FGuid&gt; ScalarParameterIds;<br>MaterialInstance-&gt;<span class="hljs-built_in">GetAllScalarParameterInfo</span>(ScalarParameterInfos, ScalarParameterIds);<br><span class="hljs-comment">// 遍历ScalarParameterInfos获取每一个参数的值</span><br><span class="hljs-keyword">for</span> (FMaterialParameterInfo ParameterInfo : ScalarParameterInfos)<br>&#123;<br>    FString ParameterName = ParameterInfo.Name.<span class="hljs-built_in">ToString</span>();<br>    <span class="hljs-type">float</span> ParameterValue;<br>    MaterialInstance-&gt;<span class="hljs-built_in">GetScalarParameterValue</span>(ParameterInfo, ParameterValue);<br><br>&#125;<br></code></pre></td></tr></table></figure><p>实际上GetAllScalarParameterInfo内部调用的是GetAllParametersOfType，然后第一个参数传了EMaterialParameterType::Scalar</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">UMaterialInstance::GetAllScalarParameterInfo</span><span class="hljs-params">(TArray&lt;FMaterialParameterInfo&gt;&amp; OutParameterInfo, TArray&lt;FGuid&gt;&amp; OutParameterIds)</span> <span class="hljs-type">const</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">GetAllParametersOfType</span>(EMaterialParameterType::Scalar, OutParameterInfo, OutParameterIds);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="获取staticswitchparameter节点的输入"><a class="markdownIt-Anchor" href="#获取staticswitchparameter节点的输入"></a> 获取StaticSwitchParameter节点的输入</h2><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20221130131029.png" alt="20221130131029" /></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C++">TArray&lt;UMaterialExpressionStaticSwitchParameter*&gt; MaterialExpressionStaticSwitchParameters;<br>Material-&gt;<span class="hljs-built_in">GetAllExpressionsInMaterialAndFunctionsOfType</span>(MaterialExpressionStaticSwitchParameters);<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; ExpressionStaticSwitchParameter : MaterialExpressionStaticSwitchParameters)<br>&#123;<br>    FExpressionInput* SwitchTrueInput = ExpressionStaticSwitchParameter-&gt;<span class="hljs-built_in">GetInput</span>(<span class="hljs-number">0</span>);<br>    FExpressionInput* SwitchFalseInput = ExpressionStaticSwitchParameter-&gt;<span class="hljs-built_in">GetInput</span>(<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Material</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：安卓弹出窗口模式背景Splash显示问题</title>
    <link href="/posts/61295/"/>
    <url>/posts/61295/</url>
    
    <content type="html"><![CDATA[<h1 id="问题描述"><a class="markdownIt-Anchor" href="#问题描述"></a> 问题描述</h1><p>在之前<br /><a href="https://muchenhen.com/posts/64190/">解决安卓分屏模式下分辨率异常</a>的问题时，发现了在弹出窗口模式下背景Splash比游戏的窗口大的问题，如图：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20221026111745.png" alt="背景Splash突出" /></p><p>希望可以关闭或者隐藏背景板</p><h1 id="尝试思路"><a class="markdownIt-Anchor" href="#尝试思路"></a> 尝试思路</h1><p><strong>以下是探索过程不是解决办法可以跳过</strong><br /><strong>以下是探索过程不是解决办法可以跳过</strong><br /><strong>以下是探索过程不是解决办法可以跳过</strong></p><p>由于只能看出来这是splash，换图测试一下确认是splash，所以就按照弹出窗口没有关闭splash去寻找解决方案，于是找到了这个</p><p><a href="https://stackoverflow.com/questions/17493947/enable-disable-an-activity-programmatically">stackoverflow的一个相关问题</a></p><p>然后看了一眼<code>AndroidManifest.xml</code>，发现:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">application</span> <span class="hljs-attr">android:label</span>=<span class="hljs-string">&quot;@string/app_name&quot;</span> <span class="hljs-attr">android:icon</span>=<span class="hljs-string">&quot;@drawable/icon&quot;</span> <span class="hljs-attr">android:resizeableActivity</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">android:isGame</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">android:hardwareAccelerated</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">android:extractNativeLibs</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.epicgames.ue4.GameApplication&quot;</span> <span class="hljs-attr">android:requestLegacyExternalStorage</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">android:hasCode</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.epicgames.ue4.SplashActivity&quot;</span> <span class="hljs-attr">android:label</span>=<span class="hljs-string">&quot;@string/app_name&quot;</span> <span class="hljs-attr">android:theme</span>=<span class="hljs-string">&quot;@style/UE4SplashTheme&quot;</span> <span class="hljs-attr">android:launchMode</span>=<span class="hljs-string">&quot;singleTask&quot;</span> <span class="hljs-attr">android:screenOrientation</span>=<span class="hljs-string">&quot;sensorLandscape&quot;</span> <span class="hljs-attr">android:debuggable</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;com.epicgames.ue4.GameActivity&quot;</span> <span class="hljs-attr">android:label</span>=<span class="hljs-string">&quot;@string/app_name&quot;</span> <span class="hljs-attr">android:theme</span>=<span class="hljs-string">&quot;@style/UE4SplashTheme&quot;</span> <span class="hljs-attr">android:configChanges</span>=<span class="hljs-string">&quot;mcc|mnc|uiMode|density|screenSize|smallestScreenSize|screenLayout|orientation|keyboardHidden|keyboard&quot;</span> <span class="hljs-attr">android:resizeableActivity</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">android:launchMode</span>=<span class="hljs-string">&quot;singleTask&quot;</span> <span class="hljs-attr">android:screenOrientation</span>=<span class="hljs-string">&quot;sensorLandscape&quot;</span> <span class="hljs-attr">android:debuggable</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.app.lib_name&quot;</span> <span class="hljs-attr">android:value</span>=<span class="hljs-string">&quot;UE4&quot;</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span><br></code></pre></td></tr></table></figure><p>哎嘿，这不就是两个Activity嘛，想想办法关了它</p><p>于是尝试在GameActivity.Java.template的各种地方按照Stack Overflow那个问题里的方案尝试，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMultiWindowModeChanged</span> <span class="hljs-params">(<span class="hljs-type">boolean</span> isInMultiWindowMode)</span><br>&#123;<br>    <span class="hljs-built_in">super</span>.onMultiWindowModeChanged(isInMultiWindowMode);<br>    Log.debug(<span class="hljs-string">&quot;onMultiWindowModeChanged : isInMultiWindowMode: &quot;</span> + String.valueOf(isInMultiWindowMode));<br>    <span class="hljs-type">PackageManager</span> <span class="hljs-variable">pm</span> <span class="hljs-operator">=</span> getPackageManager(); <br>    <span class="hljs-type">ComponentName</span> <span class="hljs-variable">componentName</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(<span class="hljs-built_in">this</span>, SplashActivity.class);<br>    Log.debug(componentName.getClassName());<br>    Log.debug(componentName.getPackageName());<br>    Log.debug(String.valueOf(pm.getComponentEnabledSetting(componentName)));<br>    pm.setComponentEnabledSetting(componentName, PackageManager.COMPONENT_ENABLED_STATE_DISABLED, PackageManager.DONT_KILL_APP);<br>&#125;<br></code></pre></td></tr></table></figure><p>打包测试发现<code>pm.setComponentEnabledSetting</code>会导致崩溃，于是又用Android Studio调试了一下，确认ComponentName的创建是没有问题的，问题就是setComponentEnabledSetting这一步，但是由于本人完全没接触过安卓开发相关，只能试图从搜索引擎查找一下可能的问题</p><p>然后就陷入了僵局，但是有看到一个地方说要在Activity的地方加一个<code>android:exported</code>，加上之后还是没有用，但是在看XML中的SplashActivity定义的时候发现：<strong><code>android:theme=&quot;@style/UE4SplashTheme&quot;</code></strong></p><p>由于我在看这个文件的时候，是用的Android Studio，并打开了我build的gradle，我试图按了一下F12，他就跳转过去了= =</p><p>到了Engine\Build\Android\Java\res\values-land\styles.xml这个文件（因为我们只改了landscape的splash）并看到了如下代码</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs XML"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;UE4BaseTheme&quot;</span> <span class="hljs-attr">parent</span> = <span class="hljs-string">&quot;@android:style/Theme.Black.NoTitleBar.Fullscreen&quot;</span> /&gt;</span><span class="language-xml"></span><br><span class="language-xml"></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;UE4SplashTheme&quot;</span> <span class="hljs-attr">parent</span> = <span class="hljs-string">&quot;UE4BaseTheme&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="language-xml"><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;android:windowBackground&quot;</span>&gt;</span>@drawable/splashscreen_l<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span></span></span><br><span class="language-xml"><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;android:windowNoTitle&quot;</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span></span></span><br><span class="language-xml"><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;android:windowFullscreen&quot;</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span></span></span><br><span class="language-xml"><span class="language-xml">    </span></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br></code></pre></td></tr></table></figure><p>长得好像html啊- -然后看看这几个单词，好像就是splash的相关配置啊！<code>windowNoTitle</code>就是不要标题，<code>windowFullscreen</code>就是全屏</p><p>我试着在IDE里敲window，就跟出来了一个<code>windowClipToOutline</code></p><p>= =啊这，Clip，裁剪，是不是就是把SplashActivity给裁减了呢</p><p>加上去试了一下-=-真的可以耶……</p><h1 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案"></a> 解决方案</h1><p>在<code>Engine\Build\Android\Java\res</code>目录下的<code>values-land</code>和<code>values-port</code>里面的<code>styles.xml</code>文件中给UE4SplashTheme的style加上</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;android:windowClipToOutline&quot;</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">item</span>&gt;</span><br></code></pre></td></tr></table></figure><p>就可以解决问题了</p><h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1><p>遇到安卓问题就快去西天（划掉）请一位安卓开发的带佬！不要浪费自己的头发（泪</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：MaterialFunctionInstance Editor的一个崩溃问题</title>
    <link href="/posts/13087/"/>
    <url>/posts/13087/</url>
    
    <content type="html"><![CDATA[<h1 id="问题场景"><a class="markdownIt-Anchor" href="#问题场景"></a> 问题场景</h1><p>版本：4.27 release</p><p>TA大佬最近在优化材质的时候，会把一些常用的公共的材质内的方法做成一个MaterialFunction，但是其中有些SwitchParameter，于是从MaterialFunction创建MaterialFunctionInstance然后更改不同的SwitchParameter的值，但是在打开材质函数实例的时候编辑器崩掉了</p><p>具体的例子是这样的：</p><p>如下图，创建一个MaterialFunction，分别有三个颜色节点分别是R，G，B<br />其中还有一个SwitchParameter和一个StaticSwitch节点<br />其中Swith节点的Value由一个Input节点传入值</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20221024134220.png" alt="材质函数" /></p><p>我们先将SwitchParameter的值设为false，在一个Material中调用这个Function：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20221024134245.png" alt="材质函数输入" /></p><p>当Material中的StaticBool为true的时候，此时MaterialFunction中的StaticSwitch也为true，最后输出的是绿色<br />改为false的时候输出的是蓝色</p><p>以上流程都没有问题。</p><p>但是，目前情况下这个NewMaterialFunction1中的SwitchParameter的节点值都是false</p><p>我们希望有true也有false，所以从NewMaterialFunction1创建了NewMaterialFunction1_Inst_True和NewMaterialFunction1_Inst_False两个MaterialFunctionInstance</p><p>然后分别打开和关闭SwitchParameter的值</p><p>就像这样：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20221024134338.png" alt="打开SwitchParameter" /></p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20221024134344.png" alt="关闭SwitchParameter" /></p><p>然而，在打开NewMaterialFunction1_Inst_True和NewMaterialFunction1_Inst_False的时候，编辑器崩溃了</p><h1 id="解决方式"><a class="markdownIt-Anchor" href="#解决方式"></a> 解决方式</h1><p>通过debug发现是在<code>MaterialEditorUtilities.cpp</code>的<font color=lightskyblue>FMaterialEditorUtilities::GetStaticSwitchExpressionValue</font>中，在判断InputExpression的InputType是<code>FunctionInput_StaticBool</code>的时候会进行一些处理，但是此时的FunctionStack里面的指针本来在前面塞进来的时候就是nullptr，这里简直百分百是空指针，<font color=lightskyblue>check(TopmostFunctionState-&gt;FunctionCall);</font>一定会崩掉的,那就把这里跳过就好了（？？？</p><p>在UDN老哥的帮助下确认确实是bug，并且官方已经于2021年7月份在UE5中修复，具体的release分支如下</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20221024135257.png" alt="修复提交记录" /></p><p>具体的修改也很直接……判断一下是不是空指针……空指针不处理……</p><p><font size=5><u><a href="https://github.com/EpicGames/UnrealEngine/blob/d9d435c9c280b99a6c679b517adedd3f4b02cfd7/Engine/Source/Editor/MaterialEditor/Private/MaterialEditorUtilities.cpp#L278-L298">具体代码链接</a></u></font></p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Material</tag>
      
      <tag>Editor</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：修改Shader压缩格式减小包体</title>
    <link href="/posts/11838/"/>
    <url>/posts/11838/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>在今年三月份的时候为了减少安卓更新包的大小，尝试了将ShaderArchive文件进行拆分，仅更新有变动的文件的方案。</p><p><font size = 3><a href="https://muchenhen.com/posts/60086/"><strong>UE4：ShadecodeLibrary拆分</strong></a></font></p><p>随着项目铺开，原有的方案中，我们使用最多的一个母材质所拆出来的文件的大小越来越大，希望还是能减少一下文件的大小，于是考虑到修改Shader压缩格式来实现这一目标。</p><p><strong>本文仅适用于4.27版本</strong></p><h1 id="压缩格式"><a class="markdownIt-Anchor" href="#压缩格式"></a> 压缩格式</h1><p>在ShaderResource.cpp文件中：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-type">static</span> <span class="hljs-type">const</span> FName ShaderCompressionFormat = NAME_LZ4;<br></code></pre></td></tr></table></figure><p>在ShaderCodeArchive.cpp文件中：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-type">static</span> <span class="hljs-type">const</span> FName ShaderCompressionFormat = NAME_LZ4;<br></code></pre></td></tr></table></figure><p>这里原本使用的压缩格式是LZ4，是UE4原生使用的对Shader的压缩格式</p><p>而在4.27版本中，UE4新增了一个压缩格式：Oodle</p><p><a href="https://www.unrealengine.com/zh-CN/blog/oodle-now-free-to-use-in-unreal-engine-via-github"><strong>Oodle现可通过GitHub在虚幻引擎中免费使用</strong></a></p><p>位于：UE_4.27\Engine\Plugins\Compression\OodleData</p><p>按照官方的说法，该压缩格式可以为游戏数据提供更快和更高比率的压缩功能。</p><p>Oodle压缩格式提供了不同的压缩器和压缩等级，其压缩率和解压缩速度会有差异，可以根据需要进行选择。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">switch</span> (Compressor)<br>&#123;<br>    <span class="hljs-keyword">case</span> OodleLZ_Compressor_Selkie:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Selkie&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_Compressor_Mermaid:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Mermaid&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_Compressor_Kraken: <br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Kraken&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_Compressor_Leviathan:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Leviathan&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_Compressor_Hydra:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Hydra&quot;</span>);<br>    <span class="hljs-keyword">default</span>: <br>        <span class="hljs-keyword">break</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">switch</span> (CompressionLevel)<br>&#123;<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_HyperFast4:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;HyperFast4&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_HyperFast3:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;HyperFast3&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_HyperFast2:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;HyperFast2&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_HyperFast1:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;HyperFast1&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_None:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;None&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_SuperFast:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;SuperFast&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_VeryFast:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;VeryFast&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_Fast:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Fast&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_Normal:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Normal&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_Optimal1:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Optimal1&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_Optimal2:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Optimal2&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_Optimal3:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Optimal3&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_Optimal4:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Optimal4&quot;</span>);<br>    <span class="hljs-keyword">case</span> OodleLZ_CompressionLevel_Optimal5:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Optimal5&quot;</span>);<br>    <span class="hljs-keyword">default</span>: <span class="hljs-keyword">break</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到压缩等级越低，解压缩速度越快，但是相对的压缩率也会越低。</p><p>经过简单测试，使用Selkie压缩器，压缩率和LZ4相比也有优势，且解压缩速度也大于LZ4。</p><p>这里我没有做详细的测试，但是经过在网上搜索发现早在16年就有相关数据比对：</p><p><a href="https://cbloomrants.blogspot.com/2016/05/ps4-battle-lz4-vs-lzsse-vs-oodle.html">LZ4 vs LZSSE vs Oodle</a></p><h1 id="在ue4-shader中使用oodle"><a class="markdownIt-Anchor" href="#在ue4-shader中使用oodle"></a> 在UE4 Shader中使用Oodle</h1><p>可以简单看一下ShaderCodeArchive.cpp</p><p>在定义了ShaderLibraryCompressionFormat之后，FSerializedShaderArchive::DecompressShader函数中调用FCompression::UncompressMemory函数，会根据ShaderLibraryCompressionFormat来进行解压缩。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FSerializedShaderArchive::DecompressShader</span><span class="hljs-params">(int32 Index, <span class="hljs-type">const</span> TArray&lt;TArray&lt;uint8&gt;&gt;&amp; ShaderCode, TArray&lt;uint8&gt;&amp; OutDecompressedShader)</span> <span class="hljs-type">const</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">const</span> FShaderCodeEntry&amp; Entry = ShaderEntries[Index];<br>OutDecompressedShader.<span class="hljs-built_in">SetNum</span>(Entry.UncompressedSize, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">if</span> (Entry.Size == Entry.UncompressedSize)<br>&#123;<br>FMemory::<span class="hljs-built_in">Memcpy</span>(OutDecompressedShader.<span class="hljs-built_in">GetData</span>(), ShaderCode[Index].<span class="hljs-built_in">GetData</span>(), Entry.UncompressedSize);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-type">bool</span> bSucceed = FCompression::<span class="hljs-built_in">UncompressMemory</span>(ShaderLibraryCompressionFormat, OutDecompressedShader.<span class="hljs-built_in">GetData</span>(), Entry.UncompressedSize, ShaderCode[Index].<span class="hljs-built_in">GetData</span>(), Entry.Size);<br><span class="hljs-built_in">check</span>(bSucceed);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-type">bool</span> bUncompressSucceeded = <span class="hljs-literal">false</span>;<br><br><span class="hljs-keyword">if</span> (FormatName == NAME_Zlib)<br>&#123;<br>    <span class="hljs-comment">// hardcoded zlib</span><br>    bUncompressSucceeded = <span class="hljs-built_in">appUncompressMemoryZLIB</span>(UncompressedBuffer, UncompressedSize, CompressedBuffer, CompressedSize, CompressionData);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (FormatName == NAME_Gzip)<br>&#123;<br>    <span class="hljs-comment">// hardcoded gzip</span><br>    bUncompressSucceeded = <span class="hljs-built_in">appUncompressMemoryGZIP</span>(UncompressedBuffer, UncompressedSize, CompressedBuffer, CompressedSize);<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (FormatName == NAME_LZ4)<br>&#123;<br>    <span class="hljs-comment">// hardcoded lz4</span><br>    bUncompressSucceeded = <span class="hljs-built_in">LZ4_decompress_safe</span>((<span class="hljs-type">const</span> <span class="hljs-type">char</span>*)CompressedBuffer, (<span class="hljs-type">char</span>*)UncompressedBuffer, CompressedSize, UncompressedSize) &gt; <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    <span class="hljs-comment">// let the format module compress it</span><br>    ICompressionFormat* Format = <span class="hljs-built_in">GetCompressionFormat</span>(FormatName);<br>    <span class="hljs-keyword">if</span> (Format)<br>    &#123;<br>        bUncompressSucceeded = Format-&gt;<span class="hljs-built_in">Uncompress</span>(UncompressedBuffer, UncompressedSize, CompressedBuffer, CompressedSize, CompressionData);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看出其实只要修改一下ShaderLibraryCompressionFormat就可以了，但是原有的Material就会因为压缩格式不同而无法解压缩，所以需要进行一下简单的修改，简单的if-else，比如：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FSerializedShaderArchive::DecompressShader</span><span class="hljs-params">(int32 Index, <span class="hljs-type">const</span> TArray&lt;TArray&lt;uint8&gt;&gt;&amp; ShaderCode, TArray&lt;uint8&gt;&amp; OutDecompressedShader)</span> <span class="hljs-type">const</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">const</span> FShaderCodeEntry&amp; Entry = ShaderEntries[Index];<br>OutDecompressedShader.<span class="hljs-built_in">SetNum</span>(Entry.UncompressedSize, <span class="hljs-literal">false</span>);<br><span class="hljs-keyword">if</span> (Entry.Size == Entry.UncompressedSize)<br>&#123;<br>FMemory::<span class="hljs-built_in">Memcpy</span>(OutDecompressedShader.<span class="hljs-built_in">GetData</span>(), ShaderCode[Index].<span class="hljs-built_in">GetData</span>(), Entry.UncompressedSize);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-type">bool</span> bSucceed = FCompression::<span class="hljs-built_in">UncompressMemory</span>(ShaderLibraryCompressionFormat, OutDecompressedShader.<span class="hljs-built_in">GetData</span>(), Entry.UncompressedSize, ShaderCode[Index].<span class="hljs-built_in">GetData</span>(), Entry.Size);<br><span class="hljs-comment">// 原压缩格式不是Oodle会失败</span><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> region Muchenhen (Oodle uncompress failed)</span><br><span class="hljs-keyword">if</span> (!bSucceed)<br>&#123;<br>bSucceed = FCompression::<span class="hljs-built_in">UncompressMemory</span>(NAME_LZ4, OutDecompressedShader.<span class="hljs-built_in">GetData</span>(), Entry.UncompressedSize, ShaderCode[Index].<span class="hljs-built_in">GetData</span>(), Entry.Size);<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> endregion</span><br><span class="hljs-comment">// </span><br><span class="hljs-built_in">check</span>(bSucceed);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在ShaderResource和ShaderCodeArchive中的三处解压缩函数都需要修改。</p>]]></content>
    
    
    <categories>
      
      <category>UE4</category>
      
    </categories>
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Material</tag>
      
      <tag>Shader</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：NiagaraMeshRenderer的两个bug临时修复</title>
    <link href="/posts/693/"/>
    <url>/posts/693/</url>
    
    <content type="html"><![CDATA[<p>版本 4.27 release</p><h1 id="问题一"><a class="markdownIt-Anchor" href="#问题一"></a> 问题一：</h1><p>在MeshRenderer的SourceMode为Emitter的时候，在EmitterAttributes的命名空间里的VisibilityTag是不生效的，但是SpriteRenderer的SourceMode为Emitter的时候是可以生效的。</p><h2 id="问题描述和复现方式"><a class="markdownIt-Anchor" href="#问题描述和复现方式"></a> 问题描述和复现方式：</h2><p>新建一个NiagaraSystem，从模板添加一个NiagaraEmitter，使用的是SpriteRenderer​</p><p>将​SpriteRenderer的SourceMode改为了Emitter</p><p>在EmitterAttributes中添加一个新的int32，重命名为VisibilityTag（因为默认EmitterAttributes的Library中是没有VisibilityTag的，所以试图用这种方式……）</p><p>在EmitterSpawn中Set上一步添加的​VisibilityTag为0</p><p>在EmitterUpdate中添加Set ​VisibilityTag改为1</p><p>此时粒子不显示，因为EmitterUpdate里的VisibilityTag改为了1，这也符合期望表现​</p><p>​</p><p>但是将Renderer的类型换成MeshRenderer之后，上述的做法就无效了</p><p>即，添加一个MeshRenderer，将SourceMode改为Emitter，在EmitterAttrbutes中添加int32改名为Visibility​Tag然后在EmitterUpdate中Set为1之后，粒子还是可视的</p><p>经过UDN老哥确认，此为Niagara的一个bug，预计将于5.2版本修复。</p><p>临时修改方案见后文的源码部分</p><p>同时，为了方便美术使用，可以考虑在Niagara constant中直接添加一个EmitterAttributes的变量</p><h1 id="问题二"><a class="markdownIt-Anchor" href="#问题二"></a> 问题二：</h1><p>MeshRenderer的SourceMode切换为Emitter的时候，DynamicMaterialParameter绑定的参数无法正常输出，但是SpriteMeshRenderer切换为Emitter的时候是正常的</p><h2 id="问题描述和复现方式-2"><a class="markdownIt-Anchor" href="#问题描述和复现方式-2"></a> 问题描述和复现方式：</h2><p>新建一个NiagaraSystem</p><p>添加一个任意模板的Emitter</p><p>在Render里添加一个MeshRenderer，此时应该有一个SpriteRenderer和一个MeshRenderer</p><p>将两个Renderer的SourceMode都改成Emitter</p><p>将SpriteRenderer的​Material改为一个Debug材质，比如下图这样的</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220925185505.png" alt="20220925185505" /></p><p>将MeshRenderer的Enable Material​ Override打开，并添加材质</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220925185741.png" alt="20220925185741" /></p><p>​在Emitter Attributes中添加一个Vector4类型的变量</p><p>新建一个NiagaraDynamicInputScript</p><p>大致连线如下：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220925185808.png" alt="20220925185808" /></p><p>再将两个Renderer的Bindings里的DynamicMaterialParameter改为上面新增的Vector4</p><p>​此时会发现，SpriteRenderer渲染出来的粒子显示的值是正确的，但是MeshRenderer渲染出的粒子显示的值是错误的：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220925185828.png" alt="20220925185828" /></p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220925185835.png" alt="20220925185835" /></p><h1 id="相关修改源码"><a class="markdownIt-Anchor" href="#相关修改源码"></a> 相关修改源码：</h1><p>由于涉及改动的文件较多，懒癌患者决定直接放文件……：</p><p><font size = 5> <a href="https://github.com/muchenhen/MuUETools/tree/main/MeshRendererBUGFixFor427">源文件</a></font></p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Niagara</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：安卓版本分屏模式分辨率异常问题</title>
    <link href="/posts/64190/"/>
    <url>/posts/64190/</url>
    
    <content type="html"><![CDATA[<h1 id="问题描述"><a class="markdownIt-Anchor" href="#问题描述"></a> 问题描述</h1><p>安卓7.0版本中增加了分屏显示的功能，UE4的Android平台的设置中可以设置关闭该项功能的支持，但是在安卓一些较新版本中，如果玩家打开了安卓的开发者选项并且开启了强制将Active设置为可调整大小（不同厂商定制可能名字不同），那么系统依然回允许将应用程序进行分屏显示</p><p>但是在这种情况下，分辨率会出现异常：</p><p>全屏时，分辨率正常<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220922210919.png" alt="全屏时，分辨率正常" /></p><p>切换到分屏模式，显示不完全<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220922210935.png" alt="切换到分屏模式，显示不完全" /></p><p>在这个时候修改分屏的宽度，分辨率异常<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220922210948.png" alt="修改分屏的宽度，分辨率异常" /></p><p>最后拉到最宽退出分屏模式，分辨率异常<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220922211049.png" alt="拉到最宽退出分屏模式，分辨率异常" /></p><p>以上是在4.27 release构建的一个空项目。</p><h1 id="探寻过程"><a class="markdownIt-Anchor" href="#探寻过程"></a> 探寻过程</h1><p>通过在进行分屏的时候输出的Log，找到了LaunchAndroid.cpp中，添加新的log发现OnAppCommandCB(struct android_app* app, int32_t cmd)里面的cmd只有APP_CMD_CONFIG_CHANGED，但是这个case被注释掉了：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220922211531.png" alt="20220922211531" /></p><p>注释写的是因为AConfiguration_getOrientation的一个NDK bug所以注释掉</p><p>将这部分解开注释，发现这里在拉回最大的时候if是进不去的，再把if临时取消掉，发现里面添加的Event是APP_EVENT_STATE_WINDOW_CHANGED</p><p>然后顺着去看了一下响应APP_EVENT_STATE_WINDOW_CHANGED的地方，在AndroidEventManager.cpp中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">case</span> APP_EVENT_STATE_WINDOW_CHANGED:<br><span class="hljs-comment">// React on device orientation/windowSize changes only when application has window</span><br><span class="hljs-comment">// In case window was created this tick it should already has correct size</span><br><span class="hljs-comment">// see &#x27;Java_com_epicgames_ue4_GameActivity_nativeOnConfigurationChanged&#x27; for event thread/game thread mismatches.</span><br><span class="hljs-built_in">ExecWindowResized</span>();<br><span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>原本看到这个ExecWindowResized以为找到地方了，进去看了一下这个函数并没有获取或者设置分辨率</p><p>发现此处还有一个APP_EVENT_STATE_WINDOW_RESIZED，看名字就很像窗口修改大小需要的，于是又将APP_CMD_CONFIG_CHANGED的函数体里原本的APP_EVENT_STATE_WINDOW_CHANGED改成了APP_EVENT_STATE_WINDOW_RESIZED</p><p>但是问题又来了，APP_EVENT_STATE_WINDOW_RESIZED需要一个参数FAppEventData，要么有宽高，要么有app的window，这里都没有</p><p>又去看了一下EventManagerUpdateWindowDimensions的具体函数，试图在直接这里修改了一下：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220922212446.png" alt="20220922212446" /></p><p>这是一个不稳定的实现，可能会crash，但是帮助找到了真正的问题：</p><p>如果忽视掉图中的Sleep函数，在这里通过ANativeWindow_getWidth拿到的宽度值是错误的。比如我把宽度从500拉到1000，这里拿到的是500。加上Sleep之后<br />成功拿到了正确的值。</p><p><strong>由于本人并不是专业的安卓开发，并不知道这是为什么，是否是一个Bug，但是对于UE4的安卓端的表现来讲，视为一个Bug……</strong></p><h1 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案"></a> 解决方案</h1><p>通过在搜索引擎中各种查找和翻阅安卓开发文档，一共经历了以下几个阶段：</p><p>在GameActivity.java.template中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">DisplayMetrics</span> <span class="hljs-variable">displayMetrics</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getResources().getDisplayMetrics();<br>Log.debug(<span class="hljs-string">&quot;onConfigurationChanged, DisplayMetrics widthPixels :&quot;</span> + String.valueOf(displayMetrics.widthPixels));<br>Log.debug(<span class="hljs-string">&quot;onConfigurationChanged, DisplayMetrics widthPixels :&quot;</span> + String.valueOf(displayMetrics.heightPixels));<br></code></pre></td></tr></table></figure><p>发现上面的这个方式是可以动态的成功拿到当时的屏幕宽度，本来以为是正确的值，结果拉到最大的时候发现width短了一截子，查了一下说是减掉了通知栏……最后确认，不仅是退出分屏的时候，而是所有时候都会剪掉通知栏，其实在分屏模式改变窗口大小的时候是能通过动画表现发现这点的</p><p>于是又找到了这个：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">WindowMetrics</span> <span class="hljs-variable">windowMetrics</span> <span class="hljs-operator">=</span> activity.getWindowManager().getCurrentWindowMetrics();<br></code></pre></td></tr></table></figure><p>这个需要添加依赖android.view.WindowMetrics</p><p>上面这个方式倒是可以在退出分屏模式的时候拿到一个正确的width了，但是发现在分屏的状态中他拿到的依然是最宽的宽度</p><p>最后终于找到了<a href="https://stackoverflow.com/questions/45430338/how-to-get-window-width-in-multiple-window-mode-android-7">how-to-get-window-width-in-multiple-window-mode-android-7</a></p><p>于是按照里面的说法，成功的在java层拿到了及时准确的width值，美中不足的是这个会触发多次……但问题不大</p><p>最后的做法是，在C++侧添加函数，接收Java侧传递过来的准确的值，构造一个FAppEventData，然后去FAppEventManager::GetInstance()-&gt;EnqueueAppEvent(APP_EVENT_STATE_WINDOW_RESIZED, FAppEventData)，最后Trigger一下就可以了</p><p>解决！</p><h1 id="感谢和参考"><a class="markdownIt-Anchor" href="#感谢和参考"></a> 感谢和参考</h1><ul><li><a href="https://zhuanlan.zhihu.com/p/432065728">UE4和安卓交互</a></li><li><a href="https://stackoverflow.com/questions/45430338/how-to-get-window-width-in-multiple-window-mode-android-7">how-to-get-window-width-in-multiple-window-mode-android-7</a></li><li>UDN老哥</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：材质实例有关的编辑器方法</title>
    <link href="/posts/54813/"/>
    <url>/posts/54813/</url>
    
    <content type="html"><![CDATA[<ol><li><a href="#%E7%A1%AE%E8%AE%A4%E6%9D%90%E8%B4%A8%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%8A%A8%E6%80%81%E5%8F%82%E6%95%B0%E6%98%AF%E5%90%A6%E8%A2%AB%E5%BC%95%E7%94%A8%E5%92%8C%E8%A6%86%E7%9B%96">确认材质实例的动态参数是否被引用和覆盖</a><ol><li><a href="#%E9%97%AE%E9%A2%98">问题</a></li><li><a href="#%E5%AE%9E%E7%8E%B0">实现</a><ol><li><a href="#%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E">函数声明</a></li><li><a href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF">实现思路</a></li></ol></li></ol></li><li><a href="#%E8%8E%B7%E5%8F%96%E6%9D%90%E8%B4%A8%E5%AE%9E%E4%BE%8B%E7%BC%96%E8%BE%91%E9%9D%A2%E6%9D%BF%E6%98%BE%E7%A4%BA%E7%9A%84%E5%8F%82%E6%95%B0%E5%90%8D%E7%A7%B0">获取材质实例编辑面板显示的参数名称</a><ol><li><a href="#%E9%97%AE%E9%A2%98-1">问题</a></li><li><a href="#%E5%AE%9E%E7%8E%B0-1">实现</a><ol><li><a href="#%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-1">函数声明</a></li><li><a href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF-1">实现思路</a></li></ol></li></ol></li><li><a href="#%E6%9D%90%E8%B4%A8%E5%AE%9E%E4%BE%8B%E7%9A%84%E5%BC%95%E7%94%A8%E5%85%B3%E7%B3%BB%E4%B8%AD%E6%9C%89%E6%AF%8D%E6%9D%90%E8%B4%A8%E5%B7%B2%E7%BB%8F%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E6%9D%90%E8%B4%A8%E5%8F%82%E6%95%B0">材质实例的引用关系中有母材质已经不存在的材质参数</a><ol><li><a href="#%E9%97%AE%E9%A2%98-2">问题</a></li><li><a href="#%E5%AE%9E%E7%8E%B0-2">实现</a><ol><li><a href="#%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E-2">函数声明</a></li><li><a href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF-2">实现思路</a></li></ol></li></ol></li><li><a href="#%E6%BA%90%E7%A0%81">源码</a></li></ol><h1 id="确认材质实例的动态参数是否被引用和覆盖"><a class="markdownIt-Anchor" href="#确认材质实例的动态参数是否被引用和覆盖"></a> 确认材质实例的动态参数是否被引用和覆盖</h1><h2 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h2><p>在材质中使用了DynamicParameter节点，通过该节点获得的值参与了部分计算</p><p>在级联粒子中，给发射器添加了Dynamic Parameter，引用了材质，并输出动态参数的值给材质</p><p>或者是在Niagara粒子中覆盖了引用的材质的动态参数，两者存在实际的引用关系</p><p>TA大佬有发现可能部分材质中的某些动态参数节点其实已经在多次修改后完全没有被任何粒子或特效输入，已经退化成一个默认值，此处的计算可以被优化，删除DynamicParameter节点</p><p>所以，需要一个工具来确认，给定一个材质实例，确认是否有存在动态参数节点，该节点有没有被任何一个其他资产使用，如果有的话需要返回每个参数对应的值</p><h2 id="实现"><a class="markdownIt-Anchor" href="#实现"></a> 实现</h2><h3 id="函数声明"><a class="markdownIt-Anchor" href="#函数声明"></a> 函数声明</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* @brief 获取指定材质实例有被特效等覆盖的动态参数的列表，如果是级联粒子可以获取到对应的值</span><br><span class="hljs-comment">* @param MaterialInstance 材质实例</span><br><span class="hljs-comment">* @param UseDynamicParameters key为参数名， value是该参数的index和值</span><br><span class="hljs-comment">*/</span><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;Editor Scripting | MaterialInstance&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">GetFxInvolvedDynamicParameter</span><span class="hljs-params">(<span class="hljs-type">const</span> UMaterialInstance* MaterialInstance, TMap&lt;FName, FMTIDynamicParamFloatValueSet&gt;&amp; UseDynamicParameters)</span></span>;<br></code></pre></td></tr></table></figure><h3 id="实现思路"><a class="markdownIt-Anchor" href="#实现思路"></a> 实现思路</h3><p>通过MaterialInstance-&gt;GetMaterial()可以获取到母材质，Material-&gt;GetCachedExpressionData().DynamicParameterNames可以获取到母材质的所有动态参数名。</p><p>MaterialInstance-&gt;GetPackage()-&gt;GetName()可以获取到材质实例的Package的名字，在通过IAssetRegistry的GetReferencers可以获取到所有的ReferencerPackages的名字。</p><p>对所有的有引用关系的Package遍历，IsChildOf<UParticleSystem>()和IsChildOf<UNiagaraSystem>()分别获取他们的发射器进行保存。</p><p>接下来分别对两种粒子的发射器进行遍历，级联粒子的UParticleModuleParameterDynamic中有DynamicParams，Niagara略微麻烦一点，这里具体的可以去看源码，不多赘述。</p><h1 id="获取材质实例编辑面板显示的参数名称"><a class="markdownIt-Anchor" href="#获取材质实例编辑面板显示的参数名称"></a> 获取材质实例编辑面板显示的参数名称</h1><h2 id="问题-2"><a class="markdownIt-Anchor" href="#问题-2"></a> 问题</h2><p>TA大佬希望能够获取到某一个材质或材质实例中没有被使用到的参数节点，针对情况进行一些优化。</p><p>设想是使用UE本身的接口获取了某种类型的所有Parameter，然后和默认值对比，如果一直说明该Parameter可能是没有用到的。</p><p>但是，在材质实例的使用过程中存在这样一种情况：<br />假设我们有材质M_A，从它创建了一个材质实例MI_A，材质有一个Switch节点，默认值是false，美术同学在开发过程中覆盖了这个材质节点，改成了true，那么材质实例就是true那个分支了，如果在true的这个分支里有别的参数，比如贴图什么的，美术同学又在MI_A中覆盖掉了这个参数，没有用M_A中的默认值，然后看了一下效果感觉不太行，又把Switch改回了false使用原来的节点，这个时候，仅通过参数默认值对比这个方式，就无法确认这个材质是不是可能没有被使用。</p><p>之后TA大佬发现，材质实例的编辑器面板显示的材质参数，和通过MaterialInstance的接口获取到的参数列表是不一致的。材质面板显示出来的能确定是有在使用，没有显示的就可能是没有使用的（针对Switch节点）。TA通过接口拿到了没有在编辑器面板上显示的参数名，TA大佬不想要这个美术其实没用到的参数名，希望可以有一个蓝图接口直接拿到和编辑器面板显示相同的参数名。</p><h2 id="实现-2"><a class="markdownIt-Anchor" href="#实现-2"></a> 实现</h2><h3 id="函数声明-2"><a class="markdownIt-Anchor" href="#函数声明-2"></a> 函数声明</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* @brief 获取指定材质实例的一个参数名的列表，该列表和编辑器下打开材质实例编辑器显示的参数名相同，与是否启用和是否override不相同</span><br><span class="hljs-comment">* @param MaterialInstance 材质实例</span><br><span class="hljs-comment">* @param ParameterName 参数名的列表</span><br><span class="hljs-comment">*/</span><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;Editor Scripting | MaterialInstance&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">GetMaterialInstanceParametersEditorDisplayed</span><span class="hljs-params">(UMaterialInstance* MaterialInstance, TArray&lt;FString&gt;&amp; ParameterName)</span></span>;<br></code></pre></td></tr></table></figure><h3 id="实现思路-2"><a class="markdownIt-Anchor" href="#实现思路-2"></a> 实现思路</h3><p>直接创建了一个UMaterialEditorInstanceConstant对象，并将UMaterialInstance的对象Cast为一个UMaterialInstanceConstant，然后对创建的UMaterialEditorInstanceConstant对象进行SetSourceInstance，这样就相当于创建了一个编辑器面板的C++对象。</p><p>MaterialEditorInstance-&gt;VisibleExpressions之中是所有的面板上会看到的参数名。</p><h1 id="材质实例的引用关系中有母材质已经不存在的材质参数"><a class="markdownIt-Anchor" href="#材质实例的引用关系中有母材质已经不存在的材质参数"></a> 材质实例的引用关系中有母材质已经不存在的材质参数</h1><h2 id="问题-3"><a class="markdownIt-Anchor" href="#问题-3"></a> 问题</h2><p>TA大佬有发现存在如下情况：<br />有一个母材质MA，该母材质有一个材质实例MIA，又从MIA创建了一个材质实例MIAA<br />MA中之前有一个Texture的参数，引用了一个贴图TexA，后来删掉了这个节点<br />保存并应用MA之后，发现MIA的引用关系里没有TexA，但是在MIAA的引用关系中有TexA，十分奇怪。</p><p>这里写了一个方法去对比材质实例和母材质的参数列表来进行清理。</p><h2 id="实现-3"><a class="markdownIt-Anchor" href="#实现-3"></a> 实现</h2><h3 id="函数声明-3"><a class="markdownIt-Anchor" href="#函数声明-3"></a> 函数声明</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* @brief 对指定的材质实例进行参数检查，检查指定的参数类型，如果存在该材质实例拥有但是母材质不存在的参数，则会remove掉</span><br><span class="hljs-comment">* @param MaterialInstance 材质实例</span><br><span class="hljs-comment">* @param MIParameterType 材质实例的参数类型</span><br><span class="hljs-comment">*/</span><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;Editor Scripting | MaterialInstance&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ClearMaterialInstanceNonexistentParameters</span><span class="hljs-params">(UMaterialInstance* MaterialInstance, EMaterialInstanceParameterType MIParameterType)</span></span>;<br></code></pre></td></tr></table></figure><h3 id="实现思路-3"><a class="markdownIt-Anchor" href="#实现思路-3"></a> 实现思路</h3><p>从材质实例获取到母材质之后，可以分别通过GetAllScalarParameterInfo，GetAllTextureParameterInfo等函数获取到对应类型的材质参数。</p><p>材质实例的参数直接是成员变量，直接访问，比如MaterialInstance-&gt;TextureParameterValues</p><p>将两者进行对比，视情况Remove即可。</p><h1 id="源码"><a class="markdownIt-Anchor" href="#源码"></a> 源码</h1><p><font size = 5><a href="https://github.com/muchenhen/MuUETools/tree/main/MuBlueprintLibrary/UE5/MuBlueprintLibrary">MuBlueprintLibrary</a></font></p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Material</tag>
      
      <tag>Tools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：SkeletalMesh的Material Slot和LOD Section</title>
    <link href="/posts/36616/"/>
    <url>/posts/36616/</url>
    
    <content type="html"><![CDATA[<h1 id="需求"><a class="markdownIt-Anchor" href="#需求"></a> 需求</h1><p>需要检查每一层LOD的所有Section用到的材质<br />如果材质是消耗比较大的并且LOD大的情况下，直接关闭消耗较大的section</p><p>需要注意的是这里的一个机制<br />在SkeletalMesh中有MaterialSlots，每一级LOD的每一个Section可以使用Slots中的某一个材质</p><p>在默认的情况下，材质Slot的数量是等于Section的数量的，为了方便在不同的LOD层级切换材质，UE是允许在编辑器中给SkeletalMesh增加材质Slot的。<br />默认情况下，section和材质Slot一一对应，索引一致。如果某一级LOD用到了非默认的材质，会在该级LODInfo中产生一个remapping的数组，叫做LODMaterialMap，大小等于Section数量，如果使用的还是默认的MaterialSlot对应的材质则index为-1，否则就是指定的MaterialSlot的index</p><p>举个例子</p><p>这里有一个默认三个Section的SkeletalMesh，在编辑器中的默认情况如下：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220831174453.png" alt="MaterialSlot" /></p><p>其中MaterialSlot长这样：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220831174612.png" alt="MaterialSlot" /></p><p>注意这个加号按钮，说明他是可以自定义添加新的材质的。</p><p>再说会上面那个图，每个Section的MaterialSlot中显示的分别是【索引+SlotName】</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220831174626.png" alt="Index" /></p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220831174632.png" alt="Name" /></p><p>如果我换一个，他后面就标注上了Modified</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220831174657.png" alt="Modified" /></p><p>但是只有在LOD Auto的情况下会是这样，切换成某一个LOD级别之后就没有default和modify的标记了。<br />这里我把该变量改为在Editor中可见，修改了LOD0的三个Section的MaterialSlot，如下图：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220831174716.png" alt="LODMaterialMap" /></p><h1 id="尝试一"><a class="markdownIt-Anchor" href="#尝试一"></a> 尝试一</h1><p>回到需求，需要对LOD的指定级的每一个Section检查，确认其真正使用的材质是否是消耗较大的材质，是的话直接关闭该Section</p><p>最后从游戏的逻辑层调用时，仅会传递LOD层级和是否显示两个参数。</p><p>从LOD的层级，获取到该层级对应的LODInfo中的LODMaterialMap，<br />如果该Map是空的，说明每一个Section是顺序对应所有的MaterialSlot的，直接遍历MaterialSlot</p><p>如果有值，则确认LODMaterialMap每一个对应的Slot，应该是这样的：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++">LODMaterialMap[SectionIndex] = MaterialSlotIndex<br></code></pre></td></tr></table></figure><p>如果MaterialSlotIndex是-1，则说明这个Section对应的实际上的MaterialSlotIndex其实是等于SectionIndex的，也就是说如果MaterialSlotIndex不是-1，就去检查MaterialSlotIndex对应的那个材质，如果是-1，就去检查这个MaterialSlotIndex的SectionIndex的值对应的MaterialSlot的那个材质。</p><p>为什么不直接就写上呢，re-mapping不累吗……(划掉)</p><p>考虑直接把映射关系一步到位：</p><p>SkeletalMesh</p><ul><li>LODs<ul><li>LOD0<ul><li>Section0 - RealMaterialIndexOfSection0</li><li>Section1 - RealMaterialIndexOfSection1</li><li>Section2 - RealMaterialIndexOfSection2</li><li>…</li></ul></li><li>LOD1<ul><li>……</li></ul></li></ul></li></ul><p>由于最后的使用只需要SectionIndex，因为是根据材质的消耗情况开关Section，所以最后只记录了SectionIndex。</p><p>第一个版本的代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs C++">CostlyLODSectionMap.<span class="hljs-built_in">Empty</span>();<br><span class="hljs-keyword">for</span> (USkinnedMeshComponent* SkinnedMeshComp : SkinnedMeshComps)<br>&#123;<br>TMap&lt;int32, TArray&lt;int32&gt;&gt; LODIndexToCostlySectionIndex;<br><span class="hljs-type">int</span> LODInfoNum = SkinnedMeshComp-&gt;SkeletalMesh-&gt;<span class="hljs-built_in">GetLODInfoArray</span>().<span class="hljs-built_in">Num</span>();<br><span class="hljs-comment">// 检查每一级的LOD</span><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> LODIndex = <span class="hljs-number">0</span>; LODIndex &lt; LODInfoNum; LODIndex++)<br>&#123;<br>TArray&lt;int32&gt; CostlySectionIndices;<br><span class="hljs-type">const</span> TArray&lt;FSkelMeshSection&gt;&amp; LODSections = SkinnedMeshComp-&gt;SkeletalMesh-&gt;<span class="hljs-built_in">GetImportedModel</span>()-&gt;LODModels[LODIndex].Sections;<br>FSkeletalMeshLODInfo* LODInfoPtr = SkinnedMeshComp-&gt;SkeletalMesh-&gt;<span class="hljs-built_in">GetLODInfo</span>(LODIndex);<br><span class="hljs-type">const</span> TArray&lt;int32&gt;&amp; LODMaterialMap = LODInfoPtr-&gt;LODMaterialMap;<br><span class="hljs-comment">// 检查该层级的所有Section</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> LODSectionIndex = <span class="hljs-number">0</span>; LODSectionIndex &lt; LODSections.<span class="hljs-built_in">Num</span>(); LODSectionIndex++)<br>&#123;<br>UMaterialInterface* Material = <span class="hljs-literal">nullptr</span>;<br><br>int32 index = <span class="hljs-number">0</span>;<br><span class="hljs-comment">// 如果LODMaterialMap不是空的，并且这一个Section的对应的值是-1，说明该Section对应的真正的MaterialSlot的索引等于SectionIndex</span><br><span class="hljs-keyword">if</span> (LODMaterialMap.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span> &amp;&amp; LODMaterialMap[LODSectionIndex] != <span class="hljs-number">-1</span>)<br>&#123;<br>Material = SkinnedMeshComp-&gt;<span class="hljs-built_in">GetMaterial</span>(LODMaterialMap[LODSectionIndex]);<br>index = LODMaterialMap[LODSectionIndex];<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>Material = SkinnedMeshComp-&gt;<span class="hljs-built_in">GetMaterial</span>(LODSectionIndex);<br>index = LODSectionIndex;<br>&#125;<br><span class="hljs-comment">// 检查这个材质是不是高消耗</span><br>UMaterialInterface* MaterialInterface = Material ? Material-&gt;<span class="hljs-built_in">GetBaseMaterial</span>() : Material;<br><span class="hljs-keyword">if</span> (MaterialInterface &amp;&amp; Settings-&gt;CostlySKMaterialFNameSet.<span class="hljs-built_in">Contains</span>(MaterialInterface-&gt;<span class="hljs-built_in">GetFName</span>()))<br>&#123;<br><span class="hljs-comment">// 最后记录的是Section的index，因为要关闭显示的是Section，而且可以重新通过Section的索引获取对应的材质的slot索引</span><br>CostlySectionIndices.<span class="hljs-built_in">Add</span>(LODSectionIndex);<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (CostlySectionIndices.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br>LODIndexToCostlySectionIndex.<span class="hljs-built_in">Add</span>(LODIndex, CostlySectionIndices);<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (LODIndexToCostlySectionIndex.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br>CostlyLODSectionMap.<span class="hljs-built_in">Emplace</span>(SkinnedMeshComp, LODIndexToCostlySectionIndex);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="尝试二"><a class="markdownIt-Anchor" href="#尝试二"></a> 尝试二</h1><p>在完成第一个版本之后，遇到一个SkeletalMesh之后崩掉了……问题是数组越界，在LODMaterialMap[LODSectionIndex]这里数组越界了。</p><p>检查后发现，存在以下使用情况，在第一个版本中没有考虑到。</p><p>在我们将资源导入到编辑器中的时候，Section的数量和MaterialSlot的数量是一致的，Slot可以点加号来增加，增加的Slot后面有X号可以点击删除。</p><p>但如果我们Add的这个Slot被某一个Section引用了，那么删除按钮就会隐藏。</p><p>如果Section的材质不是默认的顺序的index，在这种情况下，虽然有LODMaterialMap数组，但是数组大小并不等于Section的数量。</p><p>比如现在这个情况：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220831175234.png" alt="LOD1" /></p><p>可以看到，这是LOD1，并且Section0的材质修改掉了，按照之前的想法我应该有一个[1,-1]的LODMaterialMap，但是事实上是这样的：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220831175225.png" alt="LODMaterialMap" /></p><p>他只有一个元素。</p><p>具体为什么会有这样的情况，还没有细究……<br />总之目前可以知道的是，LODMaterialMap的数组大小并不一定等于Section的数量</p><p>版本2：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs C++">CostlyLODSectionMap.<span class="hljs-built_in">Empty</span>();<br><span class="hljs-keyword">for</span> (USkinnedMeshComponent* SkinnedMeshComp : SkinnedMeshComps)<br>&#123;<br><span class="hljs-keyword">if</span> (! <span class="hljs-built_in">IsValid</span>(SkinnedMeshComp-&gt;SkeletalMesh))<br>&#123;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>TMap&lt;int32, TArray&lt;int32&gt;&gt; LODIndexToCostlySectionIndex;<br><span class="hljs-type">int</span> LODInfoNum = SkinnedMeshComp-&gt;SkeletalMesh-&gt;<span class="hljs-built_in">GetLODInfoArray</span>().<span class="hljs-built_in">Num</span>();<br><span class="hljs-comment">// 检查每一级的LOD</span><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> LODIndex = <span class="hljs-number">0</span>; LODIndex &lt; LODInfoNum; LODIndex++)<br>&#123;<br>TArray&lt;int32&gt; CostlySectionIndices;<br><span class="hljs-type">const</span> TArray&lt;FSkelMeshSection&gt;&amp; LODSections = SkinnedMeshComp-&gt;SkeletalMesh-&gt;<span class="hljs-built_in">GetImportedModel</span>()-&gt;LODModels[LODIndex].Sections;<br>FSkeletalMeshLODInfo* LODInfoPtr = SkinnedMeshComp-&gt;SkeletalMesh-&gt;<span class="hljs-built_in">GetLODInfo</span>(LODIndex);<br><span class="hljs-type">const</span> TArray&lt;int32&gt;&amp; LODMaterialMap = LODInfoPtr-&gt;LODMaterialMap;<br><span class="hljs-comment">// 检查该层级的所有Section</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> LODSectionIndex = <span class="hljs-number">0</span>; LODSectionIndex &lt; LODSections.<span class="hljs-built_in">Num</span>(); LODSectionIndex++)<br>&#123;<br>int32 MaterialIndex = <span class="hljs-built_in">GetMaterialIndexByLODSection</span>(LODMaterialMap, LODSectionIndex);<br>UMaterialInterface* Material = SkinnedMeshComp-&gt;<span class="hljs-built_in">GetMaterial</span>(MaterialIndex);<br><br><span class="hljs-comment">// 检查这个材质是不是高消耗</span><br>UMaterialInterface* MaterialInterface = Material ? Material-&gt;<span class="hljs-built_in">GetBaseMaterial</span>() : Material;<br><span class="hljs-keyword">if</span> (MaterialInterface &amp;&amp; Settings-&gt;CostlySKMaterialFNameSet.<span class="hljs-built_in">Contains</span>(MaterialInterface-&gt;<span class="hljs-built_in">GetFName</span>()))<br>&#123;<br><span class="hljs-comment">// 最后记录的是Section的index，因为要关闭显示的是Section，而且可以重新通过Section的索引获取对应的材质的slot索引</span><br>CostlySectionIndices.<span class="hljs-built_in">Add</span>(LODSectionIndex);<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (CostlySectionIndices.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br>LODIndexToCostlySectionIndex.<span class="hljs-built_in">Add</span>(LODIndex, CostlySectionIndices);<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (LODIndexToCostlySectionIndex.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br>CostlyLODSectionMap.<span class="hljs-built_in">Emplace</span>(SkinnedMeshComp, LODIndexToCostlySectionIndex);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>其中抽出来的方法：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">int32 <span class="hljs-title">GetMaterialIndexByLODSection</span><span class="hljs-params">(<span class="hljs-type">const</span> TArray&lt;int32&gt;&amp; LODMaterialMap, <span class="hljs-type">const</span> int32&amp; LODSectionIndex)</span></span><br><span class="hljs-function"></span>&#123;<br>int32 MaterialIndex = <span class="hljs-number">0</span>;<br><span class="hljs-comment">// 如果LODMaterialMap不是空的，并且这一个Section的对应的值是-1，说明该Section对应的真正的MaterialSlot的索引等于SectionIndex</span><br><span class="hljs-keyword">if</span> (LODMaterialMap.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span> &amp;&amp; LODMaterialMap.<span class="hljs-built_in">IsValidIndex</span>(LODSectionIndex))<br>&#123;<br><span class="hljs-keyword">if</span>(LODMaterialMap[LODSectionIndex] != <span class="hljs-number">-1</span>)<br>&#123;<br>MaterialIndex = LODMaterialMap[LODSectionIndex];<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>MaterialIndex = LODSectionIndex;<br>&#125;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>MaterialIndex = LODSectionIndex;<br>&#125;<br><span class="hljs-keyword">return</span> MaterialIndex;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="尝试三"><a class="markdownIt-Anchor" href="#尝试三"></a> 尝试三</h1><p>然后打包编译的时候又出问题了……</p><p>在获取Section数量的时候，使用到了</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-type">const</span> TArray&lt;FSkelMeshSection&gt;&amp; LODSections = SkinnedMeshComp-&gt;SkeletalMesh-&gt;<span class="hljs-built_in">GetImportedModel</span>()-&gt;LODModels[LODIndex].Sections;<br></code></pre></td></tr></table></figure><p>这个方法和获取到的结构体都是WITH_EDITOR的，打包的时候就报错了。</p><p>那么意味着上面的思路就得改掉了，因为我没发现有在别的地方可以获取到Section的数量等相关信息了，于是换了个思路：</p><p>由于发现了LODMaterialMap不是等长的，就不能直接按照它的长度来遍历Section，可能会有遗漏，那目前能确认的是Materials的数量，而且能够确保，它的数量一定大于等于Section的数量，这样就不会在检查的时候出现遗漏，但是会有获取的Index大于Section数量造成数组越界的情况。</p><p>于是检查了一下在开关Section的地方的具体实现：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220831175353.png" alt="SectionShow" /></p><p>发现这里有检查索引有效与否，那就没有问题了。</p><p>最后的版本中，遍历一遍所有的材质，确认哪些是高消耗材质，再去确认LODMaterialMap，如果该等级的LOD的LODMaterialMap是空的，说明每一个Section用的都是Default的索引，那直接Append获取到的高消耗的材质的数组。</p><p>如果有的话，那就对LODMaterialMap遍历，-1去获得默认值，但是遍历的长度必须要是Materials的长度，不然可能会有遗漏。</p><p>至于超出的部分，会在使用的时候检查有效性，完毕。</p><p>版本3的代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs C++">CostlyLODSectionMap.<span class="hljs-built_in">Empty</span>();<br><span class="hljs-keyword">for</span> (USkinnedMeshComponent* SkinnedMeshComp : SkinnedMeshComps)<br>&#123;<br>USkeletalMesh* SkeletalMesh = SkinnedMeshComp-&gt;SkeletalMesh;<br><span class="hljs-keyword">if</span> (! <span class="hljs-built_in">IsValid</span>(SkeletalMesh))<br>&#123;<br><span class="hljs-keyword">continue</span>;<br>&#125;<br>TMap&lt;int32, TArray&lt;int32&gt;&gt; LODIndexToCostlySectionIndex;<br><span class="hljs-comment">// 遍历一遍所有的材质，确认哪些是高消耗材质</span><br>int32 MaterialNum = SkeletalMesh-&gt;<span class="hljs-built_in">GetMaterials</span>().<span class="hljs-built_in">Num</span>();<br>TArray&lt;int32&gt; CostlyMaterialIndex;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MaterialNum; i++)<br>&#123;<br>UMaterialInterface* Material = SkinnedMeshComp-&gt;<span class="hljs-built_in">GetMaterial</span>(i);<br>UMaterialInterface* MaterialInterface = Material ? Material-&gt;<span class="hljs-built_in">GetBaseMaterial</span>() : Material;<br><span class="hljs-keyword">if</span> (MaterialInterface &amp;&amp; Settings-&gt;CostlySKMaterialFNameSet.<span class="hljs-built_in">Contains</span>(MaterialInterface-&gt;<span class="hljs-built_in">GetFName</span>()))<br>&#123;<br>CostlyMaterialIndex.<span class="hljs-built_in">Add</span>(i);<br>&#125;<br>&#125;<br><span class="hljs-comment">// 检查每一级的LOD</span><br><span class="hljs-type">int</span> LODInfoNum = SkeletalMesh-&gt;<span class="hljs-built_in">GetLODInfoArray</span>().<span class="hljs-built_in">Num</span>();<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> LODIndex = <span class="hljs-number">0</span>; LODIndex &lt; LODInfoNum; LODIndex++)<br>&#123;<br>TArray&lt;int32&gt; CostlySectionIndices;<br><span class="hljs-comment">// 运行时无法获得Section数量等信息</span><br>FSkeletalMeshLODInfo* LODInfoPtr = SkinnedMeshComp-&gt;SkeletalMesh-&gt;<span class="hljs-built_in">GetLODInfo</span>(LODIndex);<br><span class="hljs-type">const</span> TArray&lt;int32&gt;&amp; LODMaterialMap = LODInfoPtr-&gt;LODMaterialMap;<br><span class="hljs-keyword">if</span> (LODMaterialMap.<span class="hljs-built_in">Num</span>() == <span class="hljs-number">0</span>)<br>&#123;<br>CostlySectionIndices.<span class="hljs-built_in">Append</span>(CostlyMaterialIndex);<br>&#125;<br><span class="hljs-comment">// LODMaterialMap的Num可能既不等于Section数量也不等于Materials的数量</span><br><span class="hljs-comment">// 需要注意LODMaterialMap的Num比Section数量小的情况</span><br><span class="hljs-comment">// 这里记录的SectionIndex可能会比实际的Section数量大，造成越界，但是没关系，使用到的时候有valid检查</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MaterialNum; i++)<br>&#123;<br>int32 LODSectionIndex = i;<br>int32 MaterialIndex = <span class="hljs-built_in">GetMaterialIndexByLODSection</span>(LODMaterialMap, LODSectionIndex);<br><span class="hljs-keyword">if</span>(CostlyMaterialIndex.<span class="hljs-built_in">Contains</span>(MaterialIndex))<br>&#123;<br>CostlySectionIndices.<span class="hljs-built_in">Add</span>(LODSectionIndex);<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (CostlySectionIndices.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br>LODIndexToCostlySectionIndex.<span class="hljs-built_in">Add</span>(LODIndex, CostlySectionIndices);<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (LODIndexToCostlySectionIndex.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br>CostlyLODSectionMap.<span class="hljs-built_in">Emplace</span>(SkinnedMeshComp, LODIndexToCostlySectionIndex);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1><p>对于SkeletalMesh：</p><ol><li>导入时，Material Slot和Section一一对应</li><li>Material Slot可以添加，但是被引用后不能删除，需要先解除引用</li><li>如果Section使用的Material不是默认的索引，会产生LODMaterialMap数组作为Re-Mapping</li><li>LODMaterialMap数组中，-1表示和Default相同</li><li>LODMaterialMap数组的长度可能小于Section的数量</li><li>即使该等级的LOD的Section使用的都是Default的索引，依然会有可能出现一个全是-1的LODMaterialMap</li><li>获取Sections的方法和相关结构体是WITH_EDITOR的</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>SkeletalMesh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：Niagara添加获取FeatureLevel的方法</title>
    <link href="/posts/60677/"/>
    <url>/posts/60677/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>TA大佬希望在NiagaraScript中可以有一个类似于材质的FeatureLevelSwitch的节点，让我帮忙看看能不能搞</p><p>我很费解啊这个事情.jpg</p><p>咨询了leader之后，决定扩展一个Niagara的DataInterface来支持CPU粒子获取FeatureLevel的信息</p><h1 id="具体需求"><a class="markdownIt-Anchor" href="#具体需求"></a> 具体需求</h1><p>在NiagaraScript中可以通过添加FeatureLevel引脚，引出两个Get方法，获取当前的特征等级是否为ES31或者SM5，如下图：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220822183537.png" alt="FeatureLevel" /></p><h1 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案"></a> 解决方案</h1><p>这里参考了原生的一些DataInterface，继承UNiagaraDataInterface实现一个新的DataInterface</p><p>首先我参考了DataInterfaceCamera（因为前两天刚改了这个（参考之前水的文章）），准备重载PerInstanceTick，在这里进行DataInstace的赋值操作，但是考虑到Camera确实是需要tick的，但是FeatureLevel除非在编辑器情况下更改了预览，正常情况下的游戏时决定好了平台的，不会去改FeatureLevel这种东西，于是改为在InitPerInstanceData中进行数据填充。原本考虑到这里可能会影响编辑器模式下切换预览能不能及时生效，但是当尝试完成第一个版本之后发现没有问题，在编辑器模式下修改FeatureLevel之后会重新执行Init操作</p><h2 id="ffeatureleveldatainterface_instancedata"><a class="markdownIt-Anchor" href="#ffeatureleveldatainterface_instancedata"></a> FFeatureLevelDataInterface_InstanceData</h2><p>新建结构体，作为DataInstance</p><h2 id="initperinstancedata"><a class="markdownIt-Anchor" href="#initperinstancedata"></a> InitPerInstanceData</h2><p>重载该函数用于初始化DataInstance</p><h2 id="getfunctions"><a class="markdownIt-Anchor" href="#getfunctions"></a> GetFunctions</h2><p>该函数用来添加FNiagaraFunctionSignature，包括但不限于真正使用到的函数的Name、支持的粒子类型、添加输入输出等</p><h2 id="getvmexternalfunction"><a class="markdownIt-Anchor" href="#getvmexternalfunction"></a> GetVMExternalFunction</h2><p>重载来Bind函数用</p><h2 id="getifes31forcpu"><a class="markdownIt-Anchor" href="#getifes31forcpu"></a> GetIfES31ForCPU</h2><p>具体的函数实现，填充上下文</p><h2 id="getifsm5forcpu"><a class="markdownIt-Anchor" href="#getifsm5forcpu"></a> GetIfSM5ForCPU</h2><p>具体的函数实现，填充上下文</p><h1 id="效果"><a class="markdownIt-Anchor" href="#效果"></a> 效果</h1><p>这里创建了一个Debug材质，红色是ES31，绿色是SM5，在编辑器模式下切换FeatureLevel可以获取正确的效果</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220822183646.png" alt="ES31" /></p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220822183700.png" alt="SM5" /></p><h1 id="源码"><a class="markdownIt-Anchor" href="#源码"></a> 源码</h1><h2 id="源文件"><a class="markdownIt-Anchor" href="#源文件"></a> <a href="https://github.com/muchenhen/MuUETools/tree/main/NiagaraExtend/UE4/DataInterface">源文件</a></h2>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Tools</tag>
      
      <tag>Niagara</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：Niagara扩展CameraQuery支持CPU获取ViewSize</title>
    <link href="/posts/59534/"/>
    <url>/posts/59534/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>TA大佬在niagara里需要做一个CPU粒子，需要用到ViewSize这个参数，从CameraQuery里只有一个GPU方法可以获取，只能考虑GPU粒子，希望能有一个CPU获取ViewSize的方法</p><h1 id="具体问题"><a class="markdownIt-Anchor" href="#具体问题"></a> 具体问题</h1><p>新建一个NiagaraScript，默认长这样：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220819181150.png" alt="NiagaraScript" /></p><p>在MapGet里新增一个CameraQuery节点<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220819181214.png" alt="CameraQuery" /></p><p>从这个Pin拉出来Get方法<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220819181236.png" alt="Get方法" /></p><p>可以看到这个是CameraQuery的Get方法，有标注支持CPU还是GPU<br />主义这里GetViewSizeCPU是我新加上的，4.27本身不提供这个方法<br />如果用了不支持的方法，编译的时候会报错，比如CPU粒子非要调用仅支持GPU粒子的方法，直接编译就会报错<br />在添加新方法之前，只有GetViewPropertiesGPU里有ViewSize这个参数<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220819181320.png" alt="GetViewPropertiesGPU" /></p><p>希望得到的结果是这样：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220819181337.png" alt="GetViewSize" /></p><p>可以在CPU粒子使用的获取ViewSize的方法</p><h1 id="解决过程"><a class="markdownIt-Anchor" href="#解决过程"></a> 解决过程</h1><p>下面这堆是摸索的过程，并不是清晰的有条理的具体的解决的方法，具体的清晰的整理过的解决过程会在后文，这里可以不看(/▽╲)但是我想水！</p><p>查看CameraQuery的源码，找到这几个已有的函数：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CalculateParticleDistances</span><span class="hljs-params">(FVectorVMContext&amp; Context)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GetClosestParticles</span><span class="hljs-params">(FVectorVMContext&amp; Context)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GetCameraFOV</span><span class="hljs-params">(FVectorVMContext&amp; Context)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GetCameraProperties</span><span class="hljs-params">(FVectorVMContext&amp; Context)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GetViewPropertiesGPU</span><span class="hljs-params">(FVectorVMContext&amp; Context)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GetClipSpaceTransformsGPU</span><span class="hljs-params">(FVectorVMContext&amp; Context)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GetViewSpaceTransformsGPU</span><span class="hljs-params">(FVectorVMContext&amp; Context)</span></span>;<br></code></pre></td></tr></table></figure><p>先看一下GetViewPropertiesGPU，试图从这里看到他是怎么获取的ViewSize</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// ------- Dummy implementations for CPU execution ------------</span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">UNiagaraDataInterfaceCamera::GetViewPropertiesGPU</span><span class="hljs-params">(FVectorVMContext&amp; Context)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-function">VectorVM::FUserPtrHandler&lt;FCameraDataInterface_InstanceData&gt; <span class="hljs-title">InstData</span><span class="hljs-params">(Context)</span></span>;<br>TArray&lt;VectorVM::FExternalFuncRegisterHandler&lt;<span class="hljs-type">float</span>&gt;&gt; OutParams;<br>OutParams.<span class="hljs-built_in">Reserve</span>(<span class="hljs-number">24</span>);<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">24</span>; i++)<br>&#123;<br>OutParams.<span class="hljs-built_in">Emplace</span>(Context);<br>&#125;<br><br><span class="hljs-keyword">for</span> (int32 k = <span class="hljs-number">0</span>; k &lt; Context.NumInstances; ++k)<br>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">24</span>; i++)<br>&#123;<br>*OutParams[i].<span class="hljs-built_in">GetDestAndAdvance</span>() = <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>发现这里注释写了，这是CPU的模拟实现，只是在Context里塞了占位，世界上没有数据</p><p>再看一下其他的CPU函数的函数体</p><p>找一个短一点的</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">UNiagaraDataInterfaceCamera::GetCameraFOV</span><span class="hljs-params">(FVectorVMContext&amp; Context)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-function">VectorVM::FUserPtrHandler&lt;FCameraDataInterface_InstanceData&gt; <span class="hljs-title">InstData</span><span class="hljs-params">(Context)</span></span>;<br><span class="hljs-function">VectorVM::FExternalFuncRegisterHandler&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">OutFov</span><span class="hljs-params">(Context)</span></span>;<br><br><span class="hljs-type">float</span> Fov = InstData.<span class="hljs-built_in">Get</span>()-&gt;CameraFOV;<br><br><span class="hljs-keyword">for</span> (int32 i = <span class="hljs-number">0</span>; i &lt; Context.NumInstances; ++i)<br>&#123;<br>*OutFov.<span class="hljs-built_in">GetDestAndAdvance</span>() = Fov;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到其实通过context构造了一个FCameraDataInterface_InstanceData，再从InstData中获取了具体的参数的值</p><p>通过VectorVM::FExternalFuncRegisterHandler&lt;数据类型&gt;的方式为Context添加输出，将输出的值赋值为刚才Get到的值，就完成了从InstData到输出pin的传递</p><p>UNiagaraDataInterfaceCamera::GetCameraProperties这个函数更长，里面可以看到更整齐的添加输出、获取值、赋值的操作</p><p>那么FCameraDataInterface_InstanceData里的值是从哪里来的呢</p><p>发现在InitPerInstanceData中虽然有new一个，但是并没有进行任何的赋值，而是在PerInstanceTick中进行的复制操作。因为是Camera参数，需要tick获取十分合理</p><p>在PerInstanceTick这个函数里，确认了其实是从World和PlayerController确认了摄像机，从而获取了各项参数。world的获取也是通过SystemInstance-&gt;GetWorldManager()-&gt;GetWorld(); Niagara系统自身提供的方法确认获得的。另外该函数还对编辑器模式进行了支持，可以在编辑器模式下正常获取View的Camera</p><p>GetFunctions函数里是对该DataInterface的Out添加方法的地方，主要是需要填充一个FNiagaraFunctionSignature然后加到OutFunctions中<br />其中需要注意的有：</p><ul><li><strong>Name</strong>，这个不是实际的函数的名字</li><li><strong>bSupportsCPU</strong>，是否支持CPU粒子使用，编译时会检查</li><li><strong>bSupportsGPU</strong>，是否支持GPU粒子</li><li><strong>bMemberFunction</strong>，是不是DataInterface的成员函数</li></ul><p>然后是调用AddInput和AddOutput来添加输入和输出</p><p>GetFunctionHLSL里如果只是CPU方法就不必了，可以大概看一下</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">if</span> (FunctionInfo.DefinitionName == GetFieldOfViewName)<br>&#123;<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> TCHAR *FormatSample = <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">R&quot;(</span><br><span class="hljs-string">void &#123;FunctionName&#125;(out float Out_FieldOfViewAngle)</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">Out_FieldOfViewAngle = degrees(View.FieldOfViewWideAngles.x);</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">)&quot;</span>);<br>OutHLSL += FString::<span class="hljs-built_in">Format</span>(FormatSample, ArgsSample);<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>其实就是自己写一下HLSL，通过函数的DefinitionName 确认到之后返回HLSL代码</p><p>那么现在要给CameraQuery增加一个方法，就是要在对应的DataInterface的结构体中增加对应的参数，在tick获取值的地方赋值，然后增加对应的function和GetFunctions的部分就可以了</p><h1 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案"></a> 解决方案</h1><p>这里只描述具体应用，没有相关源码的分析</p><h2 id="头文件中"><a class="markdownIt-Anchor" href="#头文件中"></a> 头文件中：</h2><h3 id="fcameradatainterface_instancedata"><a class="markdownIt-Anchor" href="#fcameradatainterface_instancedata"></a> FCameraDataInterface_InstanceData</h3><p>增加结构体的成员</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FCameraDataInterface_InstanceData</span><br>&#123;<br>FVector CameraLocation = FVector::ZeroVector;<br>FRotator CameraRotation = FRotator::ZeroRotator;<br><span class="hljs-type">float</span> CameraFOV = <span class="hljs-number">0.0f</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> region CPUViewSize</span><br>FIntPoint ViewSize = FIntPoint::ZeroValue;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> endregion</span><br>TQueue&lt;FDistanceData, EQueueMode::Mpsc&gt; DistanceSortQueue;<br>TArray&lt;FDistanceData&gt; ParticlesSortedByDistance;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="声明函数"><a class="markdownIt-Anchor" href="#声明函数"></a> 声明函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">GetViewSizeCPU</span><span class="hljs-params">(FVectorVMContext&amp; Context)</span></span>;<br></code></pre></td></tr></table></figure><h3 id="声明fname"><a class="markdownIt-Anchor" href="#声明fname"></a> 声明FName</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-type">static</span> <span class="hljs-type">const</span> FName GetViewSizeName;<br></code></pre></td></tr></table></figure><h2 id="源文件中"><a class="markdownIt-Anchor" href="#源文件中"></a> 源文件中</h2><h3 id="函数实现"><a class="markdownIt-Anchor" href="#函数实现"></a> 函数实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">UNiagaraDataInterfaceCamera::GetViewSizeCPU</span><span class="hljs-params">(FVectorVMContext&amp; Context)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-function">VectorVM::FUserPtrHandler&lt;FCameraDataInterface_InstanceData&gt; <span class="hljs-title">InstData</span><span class="hljs-params">(Context)</span></span>;<br><br><span class="hljs-function">VectorVM::FExternalFuncRegisterHandler&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">ViewSizeX</span><span class="hljs-params">(Context)</span></span>;<br><span class="hljs-function">VectorVM::FExternalFuncRegisterHandler&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">ViewSizeY</span><span class="hljs-params">(Context)</span></span>;<br><br><span class="hljs-function">FIntPoint <span class="hljs-title">ViewportSize</span><span class="hljs-params">(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</span></span>;<br>ViewportSize = InstData-&gt;ViewSize;<br><br><span class="hljs-keyword">for</span> (int32 i = <span class="hljs-number">0</span>; i &lt; Context.NumInstances; ++i)<br>&#123;<br>*ViewSizeX.<span class="hljs-built_in">GetDestAndAdvance</span>() = ViewportSize.X;<br>*ViewSizeY.<span class="hljs-built_in">GetDestAndAdvance</span>() = ViewportSize.Y;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="初始化成员变量"><a class="markdownIt-Anchor" href="#初始化成员变量"></a> 初始化成员变量</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">const</span> FName <span class="hljs-title">UNiagaraDataInterfaceCamera::GetViewSizeName</span><span class="hljs-params">(TEXT(<span class="hljs-string">&quot;GetViewSizeCPU&quot;</span>))</span></span>;<br></code></pre></td></tr></table></figure><h3 id="perinstancetick添加对应部分"><a class="markdownIt-Anchor" href="#perinstancetick添加对应部分"></a> PerInstanceTick添加对应部分</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">UNiagaraDataInterfaceCamera::PerInstanceTick</span><span class="hljs-params">(<span class="hljs-type">void</span>* PerInstanceData, FNiagaraSystemInstance* SystemInstance, <span class="hljs-type">float</span> DeltaSeconds)</span></span><br><span class="hljs-function"></span>&#123;<br>FCameraDataInterface_InstanceData* PIData = (FCameraDataInterface_InstanceData*)PerInstanceData;<br><span class="hljs-keyword">if</span> (!PIData)<br>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">// calculate the distance for each particle and sort by distance (if required)</span><br>PIData-&gt;ParticlesSortedByDistance.<span class="hljs-built_in">Empty</span>();<br>FDistanceData DistanceData;<br><span class="hljs-keyword">while</span> (PIData-&gt;DistanceSortQueue.<span class="hljs-built_in">Dequeue</span>(DistanceData))<br>&#123;<br>PIData-&gt;ParticlesSortedByDistance.<span class="hljs-built_in">Add</span>(DistanceData);<br>&#125;<br>PIData-&gt;ParticlesSortedByDistance.<span class="hljs-built_in">StableSort</span>([](<span class="hljs-type">const</span> FDistanceData&amp; A, <span class="hljs-type">const</span> FDistanceData&amp; B) &#123; <span class="hljs-keyword">return</span> A.DistanceSquared &lt; B.DistanceSquared; &#125;);<br><br><span class="hljs-comment">// grab the current camera data</span><br>UWorld* World = SystemInstance-&gt;<span class="hljs-built_in">GetWorldManager</span>()-&gt;<span class="hljs-built_in">GetWorld</span>();<br><span class="hljs-keyword">if</span> (World &amp;&amp; PlayerControllerIndex &lt; World-&gt;<span class="hljs-built_in">GetNumPlayerControllers</span>())<br>&#123;<br>int32 i = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span> (FConstPlayerControllerIterator Iterator = World-&gt;<span class="hljs-built_in">GetPlayerControllerIterator</span>(); Iterator; ++Iterator)<br>&#123;<br>APlayerController* PlayerController = Iterator-&gt;<span class="hljs-built_in">Get</span>();<br><span class="hljs-keyword">if</span> (i == PlayerControllerIndex &amp;&amp; PlayerController)<br>&#123;<br>PIData-&gt;CameraLocation = PlayerController-&gt;PlayerCameraManager-&gt;<span class="hljs-built_in">GetCameraLocation</span>();<br>PIData-&gt;CameraRotation = PlayerController-&gt;PlayerCameraManager-&gt;<span class="hljs-built_in">GetCameraRotation</span>();<br>PIData-&gt;CameraFOV = PlayerController-&gt;PlayerCameraManager-&gt;<span class="hljs-built_in">GetFOVAngle</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> region CPUViewSize</span><br>int32 ViewSizeX = <span class="hljs-number">0</span>;<br>int32 ViewSizeY = <span class="hljs-number">0</span>;<br>PlayerController-&gt;<span class="hljs-built_in">GetViewportSize</span>(ViewSizeX, ViewSizeY);<br>PIData-&gt;ViewSize = <span class="hljs-built_in">FIntPoint</span>(ViewSizeY, ViewSizeY);<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> endregion </span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br>i++;<br>&#125;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> WITH_EDITORONLY_DATA</span><br><span class="hljs-keyword">if</span> (GCurrentLevelEditingViewportClient)<br>&#123;<br><span class="hljs-type">const</span> FViewportCameraTransform&amp; ViewTransform = GCurrentLevelEditingViewportClient-&gt;<span class="hljs-built_in">GetViewTransform</span>();<br>PIData-&gt;CameraLocation = ViewTransform.<span class="hljs-built_in">GetLocation</span>();<br>PIData-&gt;CameraRotation = ViewTransform.<span class="hljs-built_in">GetRotation</span>();<br>PIData-&gt;CameraFOV = GCurrentLevelEditingViewportClient-&gt;ViewFOV;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> region CPUViewSize</span><br>PIData-&gt;ViewSize = GCurrentLevelEditingViewportClient-&gt;Viewport-&gt;<span class="hljs-built_in">GetSizeXY</span>();<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> endregion </span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>PIData-&gt;CameraLocation = FVector::ZeroVector;<br>PIData-&gt;CameraRotation = <span class="hljs-built_in">FRotator</span>(<span class="hljs-number">0</span>);<br>PIData-&gt;CameraFOV = <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> region CPUViewSize</span><br>PIData-&gt;ViewSize = FIntPoint::ZeroValue;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> endregion </span><br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="getfunctions添加对应部分"><a class="markdownIt-Anchor" href="#getfunctions添加对应部分"></a> GetFunctions添加对应部分</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C++">Sig = <span class="hljs-built_in">FNiagaraFunctionSignature</span>();<br>Sig.Name = GetViewSizeName;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> WITH_EDITORONLY_DATA</span><br>Sig.Description = <span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;GetViewSize&quot;</span>, <span class="hljs-string">&quot;GetViewSize&quot;</span>);<br>Sig.FunctionVersion = FNiagaraCameraDIFunctionVersion::LatestVersion;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>Sig.bMemberFunction = <span class="hljs-literal">true</span>;<br>Sig.bRequiresContext = <span class="hljs-literal">false</span>;<br>Sig.<span class="hljs-built_in">AddInput</span>(<span class="hljs-built_in">FNiagaraVariable</span>(<span class="hljs-built_in">FNiagaraTypeDefinition</span>(<span class="hljs-built_in">GetClass</span>()), <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Camera interface&quot;</span>)));<br>Sig.<span class="hljs-built_in">AddOutput</span>(<span class="hljs-built_in">FNiagaraVariable</span>(FNiagaraTypeDefinition::<span class="hljs-built_in">GetVec2Def</span>(), <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;View Size&quot;</span>)), <span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;ViewSize&quot;</span>, <span class="hljs-string">&quot;View Size&quot;</span>));<br>OutFunctions.<span class="hljs-built_in">Add</span>(Sig);<br></code></pre></td></tr></table></figure><h3 id="getfunctionhlsl"><a class="markdownIt-Anchor" href="#getfunctionhlsl"></a> GetFunctionHLSL</h3><p>也可以添加来支持GPU使用但是既然有GPU的GetViewProperties方法就不必了</p><h3 id="绑定"><a class="markdownIt-Anchor" href="#绑定"></a> 绑定</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">DEFINE_NDI_DIRECT_FUNC_BINDER</span>(UNiagaraDataInterfaceCamera, GetViewSizeCPU);<br></code></pre></td></tr></table></figure><h3 id="getvmexternalfunction添加对应部分"><a class="markdownIt-Anchor" href="#getvmexternalfunction添加对应部分"></a> GetVMExternalFunction添加对应部分</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> region CPUViewSize</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (BindingInfo.Name == GetViewSizeName)<br>&#123;<br><span class="hljs-built_in">NDI_FUNC_BINDER</span>(UNiagaraDataInterfaceCamera, GetViewSizeCPU)::<span class="hljs-built_in">Bind</span>(<span class="hljs-keyword">this</span>, OutFunc);<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> endregion </span><br></code></pre></td></tr></table></figure><h1 id="结果"><a class="markdownIt-Anchor" href="#结果"></a> 结果</h1><p>随便拉一个debug的Material</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220819183817.png" alt="GetViewSize" /></p><p>然后在编辑器里看一下</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220819183855.png" alt="DebugMaterial" /></p><p>搞定！</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Tools</tag>
      
      <tag>Niagara</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：FSequencer的BakeTransform封装到蓝图</title>
    <link href="/posts/61655/"/>
    <url>/posts/61655/</url>
    
    <content type="html"><![CDATA[<h1 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h1><p>美术有需要将Level Sequence进行BakeTransform然后导出fbx到其他软件中工作的需求，在这中间TA大佬还需要用Python脚本或者蓝图脚本来进行一些流水线处理，但是</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/** Bake transform */</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BakeTransform</span><span class="hljs-params">()</span></span>;<br></code></pre></td></tr></table></figure><p>是FSequencer的成员函数，非UFUNCTION，需要想办法再包一层给到蓝图的Library中</p><p>那么问题来了，我们获取到的ULevelSequence和FSequencer还有相当长的距离……</p><h1 id="解决办法"><a class="markdownIt-Anchor" href="#解决办法"></a> 解决办法</h1><p>由于这个问题已经有一段时间了，具体的解决过程就是翻源码看看，具体的过程也不必要赘述，这里直接写最后的解决方案</p><p>和TA大佬约定，我提供一个蓝图方法，传入参数为ULevelSequence*，我对这个对象执行BakeTransform</p><p>在我各种查看源码后，发现有这个东西FLevelEditorSequencerIntegration，该类定义的时候有SEQUENCER_API，是一个纯c++类，但是可以导出<br />并且其有成员方法：AddSequencer；RemoveSequencer；GetSequencers</p><p>通过这个GetSequencers可以获取TArray&lt;TWeakPtr<ISequencer>&gt; ISequencers</p><p>再对ISequencer进行StaticCast可以获取到FSequence</p><p>拿到FSequencer之后可以通过GetFocusedMovieSceneSequence()方法获取 UMovieSceneSequence</p><p>最后通过 UMovieSceneSequence的GetMovieScene方法可以获取一个UMovieScene</p><p>而通过参数传进来的ULevelSequence可以直接GetMovieScene获取一个UMovieScene</p><p>如果这两个UMovieScene相同，则能从FLevelEditorSequencerIntegration的GetSequencers获取的一堆ISequencer中确定我们需要的那个FSequencer，然后调用一下BakeTransform即可</p><p>将以上过程封装为FLevelEditorSequencerIntegration的一个成员函数，最后在蓝图Library再封装一层给到蓝图就完成啦</p><p>源码贴到这里</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FLevelEditorSequencerIntegration::BakeLevelSequencerTransform</span><span class="hljs-params">(ULevelSequence* LevelSequence)</span></span><br><span class="hljs-function"></span>&#123;<br>UMovieScene* MovieScene = LevelSequence-&gt;<span class="hljs-built_in">GetMovieScene</span>();<br><span class="hljs-keyword">if</span>(MovieScene == <span class="hljs-literal">nullptr</span>)<br>&#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">auto</span> ISequencers = <span class="hljs-built_in">GetSequencers</span>();<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; Sequencer : ISequencers)<br>&#123;<br><span class="hljs-keyword">auto</span> SharedRefISequence = Sequencer.<span class="hljs-built_in">Pin</span>().<span class="hljs-built_in">ToSharedRef</span>();<br><span class="hljs-keyword">auto</span> DerivedSequencerPtr = <span class="hljs-built_in">StaticCastSharedRef</span>&lt;FSequencer&gt;(SharedRefISequence);<br>UMovieScene* FocusedMovieScene = DerivedSequencerPtr.<span class="hljs-built_in">Get</span>().<span class="hljs-built_in">GetFocusedMovieSceneSequence</span>()-&gt;<span class="hljs-built_in">GetMovieScene</span>();<br><span class="hljs-keyword">if</span> (MovieScene == FocusedMovieScene)<br>&#123;<br>DerivedSequencerPtr.<span class="hljs-built_in">Get</span>().<span class="hljs-built_in">BakeTransform</span>();<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Tools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：扩展Sequencer的BakeTransform有关Camera的参数</title>
    <link href="/posts/50458/"/>
    <url>/posts/50458/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>这是之前帮忙做的一点东西，拿来水一下</p><p>TA大佬在使用LevelSequence的时候需要Bake一些轨道来导出，其中Camera有部分参数UE本身没有支持Bake，需要进行扩充</p><h1 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h1><p>FSequencer::BakeTransform()函数中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FBakeData</span><br>&#123;<br>    TArray&lt;FVector&gt; Locations;<br>    TArray&lt;FRotator&gt; Rotations;<br>    TArray&lt;FVector&gt; Scales;<br>    TArray&lt;FFrameNumber&gt; KeyTimes;<br>&#125;;<br></code></pre></td></tr></table></figure><p>以上结构体就是Bake的数据，可以看到是Actor通用的数据，但是需要FOV等摄像机用的数据，需要扩充</p><h1 id="解决方法"><a class="markdownIt-Anchor" href="#解决方法"></a> 解决方法</h1><p>由于这是编辑器方法，那么就直接往里塞啊！简单高效（指解决问题）</p><p>首先修改结构体</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FBakeData</span><br>&#123;<br>TArray&lt;FVector&gt; Locations;<br>TArray&lt;FRotator&gt; Rotations;<br>TArray&lt;FVector&gt; Scales;<br>        <span class="hljs-comment">// 增加需要的摄像机参数</span><br>TArray&lt;<span class="hljs-type">float</span>&gt;  Fovs;<br>TArray&lt;<span class="hljs-type">float</span>&gt;  FocusDistances;<br>TArray&lt;<span class="hljs-type">float</span>&gt;  CurrentAperture;<br>TArray&lt;<span class="hljs-type">float</span>&gt;  CurrentFocalLength;<br>        <span class="hljs-comment">// ......</span><br>TArray&lt;FFrameNumber&gt; KeyTimes;<br>&#125;;<br></code></pre></td></tr></table></figure><p>紧接着上面这个struct，有一行</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++">TMap&lt;FGuid, FBakeData&gt; BakeDataMap;<br></code></pre></td></tr></table></figure><p>后面在判断了CameraComponent是否有效之后，会根据情况来向TMap添加数据</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">if</span> (CameraComponent)<br>&#123;<br>    FTransform AdditiveOffset;<br>    <span class="hljs-type">float</span> AdditiveFOVOffset;<br>    CameraComponent-&gt;<span class="hljs-built_in">GetAdditiveOffset</span>(AdditiveOffset, AdditiveFOVOffset);<br><br>    <span class="hljs-function">FTransform <span class="hljs-title">Transform</span><span class="hljs-params">(Actor-&gt;GetActorRotation(), Actor-&gt;GetActorLocation())</span></span>;<br>    FTransform TransformWithAdditiveOffset = AdditiveOffset * Transform;<br>    FVector LocalTranslation = TransformWithAdditiveOffset.<span class="hljs-built_in">GetTranslation</span>();<br>    FRotator LocalRotation = TransformWithAdditiveOffset.<span class="hljs-built_in">GetRotation</span>().<span class="hljs-built_in">Rotator</span>();<br><br>    BakeDataMap[Guid].Locations.<span class="hljs-built_in">Add</span>(LocalTranslation);<br>    BakeDataMap[Guid].Rotations.<span class="hljs-built_in">Add</span>(LocalRotation);<br>    BakeDataMap[Guid].Scales.<span class="hljs-built_in">Add</span>(FVector::OneVector);<br>    <span class="hljs-comment">// 在这里，首先确认CameraComponent存在，然后就可以去获取UCineCameraComponent进而拿到摄像机的属性</span><br>    <span class="hljs-keyword">if</span> (UCineCameraComponent* CineCamera = <span class="hljs-built_in">Cast</span>&lt;UCineCameraComponent&gt;(CameraComponent))<br>    &#123;<br>        BakeDataMap[Guid].Fovs.<span class="hljs-built_in">Add</span>(CineCamera-&gt;<span class="hljs-built_in">GetHorizontalFieldOfView</span>());<br>        BakeDataMap[Guid].FocusDistances.<span class="hljs-built_in">Add</span>(CineCamera-&gt;FocusSettings.ManualFocusDistance);<br>        BakeDataMap[Guid].CurrentAperture.<span class="hljs-built_in">Add</span>(CineCamera-&gt;CurrentAperture);<br>        BakeDataMap[Guid].CurrentFocalLength.<span class="hljs-built_in">Add</span>(CineCamera-&gt;CurrentFocalLength);<br>    &#125;<br>    <span class="hljs-comment">// ......</span><br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    BakeDataMap[Guid].Locations.<span class="hljs-built_in">Add</span>(Actor-&gt;<span class="hljs-built_in">GetActorLocation</span>());<br>    BakeDataMap[Guid].Rotations.<span class="hljs-built_in">Add</span>(Actor-&gt;<span class="hljs-built_in">GetActorRotation</span>());<br>    BakeDataMap[Guid].Scales.<span class="hljs-built_in">Add</span>(Actor-&gt;<span class="hljs-built_in">GetActorScale</span>());<br>    <span class="hljs-comment">// 这里是没有摄像机Component的，给默认值</span><br>    BakeDataMap[Guid].Fovs.<span class="hljs-built_in">Add</span>(<span class="hljs-number">0.f</span>);<br>    BakeDataMap[Guid].FocusDistances.<span class="hljs-built_in">Add</span>(<span class="hljs-number">0.f</span>);<br>    BakeDataMap[Guid].CurrentAperture.<span class="hljs-built_in">Add</span>(<span class="hljs-number">0.f</span>);<br>    BakeDataMap[Guid].CurrentFocalLength.<span class="hljs-built_in">Add</span>(<span class="hljs-number">0.f</span>);<br>    <span class="hljs-comment">// ......</span><br>&#125;<br></code></pre></td></tr></table></figure><p>在上面这一步给TMap填充完数据之后，就执行转换逻辑，生成float track</p><p>这里太长了就不直接放源码了……</p><p>主要思路：</p><ol><li>通过FocusedMovieScene获取FMovieSceneBinding，再通过FMovieSceneBinding的GetTracks获取TArray&lt;UMovieSceneTrack*&gt;</li><li>对获取到的Tracks遍历，判断能否Cast为UMovieSceneFloatTrack，且Track不为空</li><li>通过转换得到的UMovieSceneFloatTrack的UniqueTrackName确认是摄像机的哪一个属性</li><li>创建一个新的UMovieSceneFloatTrack，因为可能需要保留原来的Track</li><li>对新创建的NewFloatTrack，调用SetPropertyNameAndPath设置属性</li><li>创建一个UMovieSceneFloatSection，将其添加到NewFloatTrack</li><li>对UMovieSceneFloatSection进行SetRange，对Section的Channels进行SetDefault，这里一般只会用到Channels[0]</li><li>最后对BakeData.Value.KeyTimes遍历，对FloatChannels进行AddLinearKey</li></ol><p>搞定！</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Tools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：材质节点VertexNormalWS输入的一个小问题</title>
    <link href="/posts/49950/"/>
    <url>/posts/49950/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>我们的TA大佬手上任务比较多，抛给我一个小问题希望我帮忙查一下。</p><p>有一个材质在我们某次修改引擎后不正常了，但是不知道是什么时候开始不正常的。将这个材质用到公版4.27的项目上又没有问题，需要定位一下问题并解决。</p><p>遗憾的是本人在这次问题定位中几乎并没有干任何事-=-最后都是靠leader和别的大佬解决的……</p><p>菜的哭出声QWQ</p><h1 id="具体问题"><a class="markdownIt-Anchor" href="#具体问题"></a> 具体问题</h1><p>TA大佬给了我一个简化后的由来查问题的材质</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220801093353.png" alt="问题材质" /></p><p>ShadingModel为unlit，ES3.1下长这个样子</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220801093734.png" alt="材质预览" /></p><p>问题是，在我们的引擎版本里，边缘部分在某些情况下会有闪烁的亮点，如下图</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220801093800.png" alt="问题" /></p><h1 id="解决过程"><a class="markdownIt-Anchor" href="#解决过程"></a> 解决过程</h1><p>因为大佬说在4.27的release版本是正常的，不确定是改什么坏掉了</p><p>首先我怀疑是Shader相关的改动造成的问题，我将我们的引擎源码的Shaders文件夹和4.27的Shaders文件夹进行了Diff，幸好差异也就三十多个文件……= =</p><p>凭借之前看过一些Shader和材质的东西，简单判断了一下哪些大概可能是相关的，将这部分回退release版本，对shader进行了重新编译，再次打开引擎后发现</p><p><strong>完全没有用</strong>，问题依然存在</p><p>在我疯狂Diff折腾了一下午未果的情况下，我求助了另一位被我抓住他有空的TA大佬- -</p><p>然后大佬教我RenderDoc Debug一下坏点，看看值</p><p>最后惊讶的发现，在power节点前的值是一个大于1的数，取了5次方之后值大得离谱以至于Emissive Color收到的值巨大，最后在Bloom之后就形成了这个亮光闪烁的样子</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220801093903.png" alt="RenderDoc截取" /></p><p>图为RenderDoc截图发现在后处理之前明显有问题的坏点</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220801093929.png" alt="Debug" /></p><p>power后的值非常大</p><p>再往前看</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220801094117.png" alt="材质节点" /></p><p>这里大佬跟我说，理论上两个向量都应该是单位向量，dot结果应该在-1到1区间</p><p>两个节点都是FMaterialPixelParameters的成员</p><p>其中CameraVector是 Normalized world space camera vector, which is the vector from the point being shaded to the camera position.</p><p>是单位化的</p><p>而WorldVertexNormal其实是TangentToWorld[2]，在HLSL代码中也能直观看到<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220801094153.png" alt="WorldVertexNormal" /></p><p>TangentToWorld是Orthonormal rotation-only transform from tangent space to world space<br />正交矩阵，那么WorldVertexNormal也是单位向量才对<br />但是，这个坏点debug信息看到的是这样的</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220801094602.png" alt="Debug" /></p><p>这个v1就是TangentToWorld[2]，这不是单位向量啊</p><p>这样的话dot值就不在理想区间内了，后面power爆炸就出现了</p><p>那么问题定位到了为什么TangentToWorld不是个正交矩阵了</p><p>到这里又去看顶点工厂的usf已经基本没有什么思路了……唯一能把握的只有原生4.27没问题，但是我们项目并没有改过插值这部分……</p><p>然后发现虽然basepass里面顶点值已经错了，但是坏点是在resolve之后出现的</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220801094650.png" alt="resolve前" /></p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220801094656.png" alt="resolve后" /></p><p>= =于是大佬一拍桌子，想起来在桌面端的ES模式下依然是打开了MSAA的</p><p>但4.27默认不是，于是在4.27下打开了MSAA后，奇妙的坏点也出现啦</p><p>最后leader说，为了能在PC上预览到接近PC的效果，哪怕是ES模式也打开了MSAA，但手机上是不会开的，PC端不使用ES模式也不会有问题，所以可以当做没问题……</p><p>最后的解决方案就是不用管-=-</p><p><strong>以上我全程在打酱油，我键盘的参与度都比我本人高……（菜鸡落泪</strong></p><h1 id="遗留问题"><a class="markdownIt-Anchor" href="#遗留问题"></a> 遗留问题</h1><ol><li>插值计算错误是确定MSAA导致的吗？</li><li>如果不是MSAA导致的差值错误，那么是为什么错误的？</li><li>UE4 MSAA的应用阶段？</li></ol><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220620222820.png" width="30%"><h1 id="总结收获"><a class="markdownIt-Anchor" href="#总结收获"></a> 总结收获</h1><p>当然还是有所收获的</p><ol><li>翻到了大部分usf和ush，之前完全没看过Shaders这部分的源码</li><li>能自己去看HLSL了（大概吧</li><li>知道RenderDoc的debug了，并了解了几个汇编指令</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>CG</tag>
      
      <tag>Material</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：自定义材质属性节点规避材质编译问题</title>
    <link href="/posts/7908/"/>
    <url>/posts/7908/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>本文是一次问题和解决的记录，其中相关的具体细节有部分我并不完全理解，无法作出有效总结……</p><h1 id="问题"><a class="markdownIt-Anchor" href="#问题"></a> 问题</h1><p>新增ShaderingModel之后，使用了原本的CustomData0和CustomData1材质属性，结果发现在编译后的metal文件中，存在相同的局部变量，进行了重复采样，导致在ios上相关的材质GPU消耗直接翻倍</p><p>拿一段生成的metal来做例子，如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++">float4 _197 = Material_Texture2D_1.<span class="hljs-built_in">sample</span>(Material_Texture2D_1Sampler, <span class="hljs-built_in">float2</span>(in_var_TEXCOORD0[<span class="hljs-number">0</span>].x, in_var_TEXCOORD0[<span class="hljs-number">0</span>].y));<br>half4 _198 = <span class="hljs-built_in">half4</span>(_197);<br>float4 _214 = Material_Texture2D_2.<span class="hljs-built_in">sample</span>(Material_Texture2D_2Sampler, <span class="hljs-built_in">float2</span>(<span class="hljs-built_in">half2</span>(<span class="hljs-built_in">min</span>(<span class="hljs-built_in">max</span>(_193 - (<span class="hljs-built_in">half</span>(<span class="hljs-number">1.0</span>) - <span class="hljs-built_in">half</span>(Material.Material_ScalarExpressions[<span class="hljs-number">0</span>].x * <span class="hljs-built_in">float</span>(_198.x))), <span class="hljs-built_in">half</span>(<span class="hljs-number">0.0</span>)), <span class="hljs-built_in">half</span>(<span class="hljs-number">1.0</span>)), <span class="hljs-built_in">half</span>(<span class="hljs-number">0.5</span>))));<br>float4 _280 = Material_Texture2D_1.<span class="hljs-built_in">sample</span>(Material_Texture2D_1Sampler, <span class="hljs-built_in">float2</span>(in_var_TEXCOORD0[<span class="hljs-number">0</span>].x, in_var_TEXCOORD0[<span class="hljs-number">0</span>].y));<br>float4 _293 = Material_Texture2D_2.<span class="hljs-built_in">sample</span>(Material_Texture2D_2Sampler, <span class="hljs-built_in">float2</span>(<span class="hljs-built_in">half2</span>(<span class="hljs-built_in">min</span>(<span class="hljs-built_in">max</span>(_193 - (<span class="hljs-built_in">half</span>(<span class="hljs-number">1.0</span>) - <span class="hljs-built_in">half</span>(Material.Material_ScalarExpressions[<span class="hljs-number">0</span>].x * <span class="hljs-built_in">float</span>(<span class="hljs-built_in">half4</span>(_280).x))), <span class="hljs-built_in">half</span>(<span class="hljs-number">0.0</span>)), <span class="hljs-built_in">half</span>(<span class="hljs-number">1.0</span>)), <span class="hljs-built_in">half</span>(<span class="hljs-number">0.5</span>))));<br></code></pre></td></tr></table></figure><p>仔细看一下就会发现<br />把_198替换成half4(_197)</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++">float4 _214 = Material_Texture2D_2.<span class="hljs-built_in">sample</span>(Material_Texture2D_2Sampler, <span class="hljs-built_in">float2</span>(<span class="hljs-built_in">half2</span>(<span class="hljs-built_in">min</span>(<span class="hljs-built_in">max</span>(_193 - (<span class="hljs-built_in">half</span>(<span class="hljs-number">1.0</span>) - <span class="hljs-built_in">half</span>(Material.Material_ScalarExpressions[<span class="hljs-number">0</span>].x * <span class="hljs-built_in">float</span>(<span class="hljs-built_in">half4</span>(_197).x))), <span class="hljs-built_in">half</span>(<span class="hljs-number">0.0</span>)), <span class="hljs-built_in">half</span>(<span class="hljs-number">1.0</span>)), <span class="hljs-built_in">half</span>(<span class="hljs-number">0.5</span>))));<br>float4 _293 = Material_Texture2D_2.<span class="hljs-built_in">sample</span>(Material_Texture2D_2Sampler, <span class="hljs-built_in">float2</span>(<span class="hljs-built_in">half2</span>(<span class="hljs-built_in">min</span>(<span class="hljs-built_in">max</span>(_193 - (<span class="hljs-built_in">half</span>(<span class="hljs-number">1.0</span>) - <span class="hljs-built_in">half</span>(Material.Material_ScalarExpressions[<span class="hljs-number">0</span>].x * <span class="hljs-built_in">float</span>(<span class="hljs-built_in">half4</span>(_280).x))), <span class="hljs-built_in">half</span>(<span class="hljs-number">0.0</span>)), <span class="hljs-built_in">half</span>(<span class="hljs-number">1.0</span>)), <span class="hljs-built_in">half</span>(<span class="hljs-number">0.5</span>))));<br></code></pre></td></tr></table></figure><p>此时214和293只有197和280这俩不一样<br />再看一下197和280</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++">float4 _197 = Material_Texture2D_1.<span class="hljs-built_in">sample</span>(Material_Texture2D_1Sampler, <span class="hljs-built_in">float2</span>(in_var_TEXCOORD0[<span class="hljs-number">0</span>].x, in_var_TEXCOORD0[<span class="hljs-number">0</span>].y));<br>float4 _280 = Material_Texture2D_1.<span class="hljs-built_in">sample</span>(Material_Texture2D_1Sampler, <span class="hljs-built_in">float2</span>(in_var_TEXCOORD0[<span class="hljs-number">0</span>].x, in_var_TEXCOORD0[<span class="hljs-number">0</span>].y));<br></code></pre></td></tr></table></figure><p>一模一样啊……<br />_280与_197一样……<br />也就是说_293与_214一模一样……<br />sample直接重复了一次，没有合并优化掉…</p><p>据leader和大佬们分析，是因为我们在自定义ShadingModel的时候使用了原本EMaterialProperty的MP_CustomData0和MP_CustomData1，所以最后在metal文件中这两个相关的值没有成功的被优化合并。</p><h1 id="尝试策略"><a class="markdownIt-Anchor" href="#尝试策略"></a> 尝试策略</h1><p>leader让我添加新的自定义的材质属性，但是要注意不要和customData0和customData1一致，参考一下基础的几个材质属性，看一下这样能不能成功在metal里优化掉这个问题</p><p>打开引擎的r.DumpShaderDebugInfo选项后在材质编译生成的.rewritten.hlsl里看到</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">half3 <span class="hljs-title">GetMaterialCustomData0</span><span class="hljs-params">(FMaterialPixelParameters Parameters)</span></span><br></code></pre></td></tr></table></figure><p>CustomData0是在<strong>FMaterialPixelParameters</strong>结构体里面的</p><p>这个结构体在MaterialTemplate.ush</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * Parameters needed by pixel shader material inputs, related to Geometry.</span><br><span class="hljs-comment"> * These are independent of vertex factory.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FMaterialPixelParameters</span><br>&#123;<br>    <span class="hljs-comment">// 太长了......</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>但是有些属性比如透明度是这样的：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">half <span class="hljs-title">GetMaterialOpacity</span><span class="hljs-params">(FPixelMaterialInputs PixelMaterialInputs)</span></span><br></code></pre></td></tr></table></figure><p>是在结构体<strong>FPixelMaterialInputs</strong>里的</p><p>这个结构体也在aterialTemplate.ush</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * Parameters calculated from the pixel material inputs.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FPixelMaterialInputs</span><br>&#123;<br>%s<br>&#125;;<br></code></pre></td></tr></table></figure><p>那么如果我们自定义一个材质属性用来给自定义的ShadingModel输入值的话，将这个材质属性和透明度保持近似，也放在FPixelMaterialInputs结构体里面，应该可以成功优化掉，而不是像customData一样。</p><p><strong>FDeferredShadingSceneRenderer::Render()<strong>中会调用</strong>RenderBasePass()</strong>，之后在BasePassPixelShader.usf中会计算GBuffer</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C++">FGBufferData GBuffer = (FGBufferData)<span class="hljs-number">0</span>;<br><br>GBuffer.GBufferAO = MaterialAO;<br>GBuffer.PerObjectGBufferData = <span class="hljs-built_in">GetPrimitiveData</span>(MaterialParameters.PrimitiveId).PerObjectGBufferData;<br>GBuffer.Depth = MaterialParameters.ScreenPosition.w;<br>GBuffer.PrecomputedShadowFactors = <span class="hljs-built_in">GetPrecomputedShadowMasks</span>(LightmapVTPageTableResult, Interpolants, MaterialParameters.PrimitiveId, MaterialParameters.AbsoluteWorldPosition, VolumetricLightmapBrickTextureUVs);<br><br><span class="hljs-type">const</span> <span class="hljs-type">float</span> GBufferDither = <span class="hljs-built_in">InterleavedGradientNoise</span>(MaterialParameters.SvPosition.xy, View.StateFrameIndexMod8);<br><span class="hljs-comment">// Use GBuffer.ShadingModelID after SetGBufferForShadingModel(..) because the ShadingModel input might not be the same as the output</span><br><span class="hljs-built_in">SetGBufferForShadingModel</span>(<br>    GBuffer,<br>    MaterialParameters,<br>    Opacity,<br>    BaseColor,<br>    Metallic,<br>    Specular,<br>    Roughness,<br>    Anisotropy,<br>    SubsurfaceColor,<br>    SubsurfaceProfile,<br>    GBufferDither,<br>    ShadingModel<br>    );<br></code></pre></td></tr></table></figure><p>SetGBufferForShadingModel函数位于ShadingModelsMaterial.ush中</p><p>在SetGBufferForShadingModel的函数体中可以看到部分参数是直接赋值的，但是GBuffer.CustomData要根据不同的ShaderModel进行赋值。</p><p>在UE4本身原有的ShaderModel中，SHADINGMODELID_CLEAR_COAT有使用CustomData0和CustomData1，代码是这样的：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ShadingModel == SHADINGMODELID_CLEAR_COAT)<br>&#123;<br><span class="hljs-type">float</span> ClearCoat= <span class="hljs-built_in">saturate</span>( <span class="hljs-built_in">GetMaterialCustomData0</span>(MaterialParameters) );<br><span class="hljs-type">float</span> ClearCoatRoughness= <span class="hljs-built_in">saturate</span>( <span class="hljs-built_in">GetMaterialCustomData1</span>(MaterialParameters) );<br>GBuffer.CustomData.x = ClearCoat;<br>GBuffer.CustomData.y = ClearCoatRoughness;<br><br><span class="hljs-comment">// ……省略部分代码</span><br>    &#125;<br></code></pre></td></tr></table></figure><p>而里面调用到的GetMaterialCustomData0和GetMaterialCustomData1来自MaterialTemplate.ush</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">half <span class="hljs-title">GetMaterialCustomData0</span><span class="hljs-params">(FMaterialPixelParameters Parameters)</span></span><br><span class="hljs-function"></span>&#123;<br>%s;<br>&#125;<br><br><span class="hljs-function">half <span class="hljs-title">GetMaterialCustomData1</span><span class="hljs-params">(FMaterialPixelParameters Parameters)</span></span><br><span class="hljs-function"></span>&#123;<br>%s;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看出这里参数是从<strong>FMaterialPixelParameters</strong>获取的</p><p>而像透明度之类的参数是这样的：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">half <span class="hljs-title">GetMaterialOpacityRaw</span><span class="hljs-params">(FPixelMaterialInputs PixelMaterialInputs)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> PixelMaterialInputs.Opacity;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里参数是<strong>FPixelMaterialInputs</strong></p><p>那么把自定义参数也加到这个里面去，并提供类似的Get函数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">half3 <span class="hljs-title">GetMaterialCustomData3</span><span class="hljs-params">(FPixelMaterialInputs PixelMaterialInputs)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> PixelMaterialInputs.CustomData3;<br>&#125;<br><br><span class="hljs-function">half <span class="hljs-title">GetMaterialCustomData4</span><span class="hljs-params">(FPixelMaterialInputs PixelMaterialInputs)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> PixelMaterialInputs.CustomData4;<br>&#125;<br></code></pre></td></tr></table></figure><p>在BasePassPixelShader.usf中，调用SetGBufferForShadingModel的时候将新增加的变量也传过去</p><p>在ShadingModelsMaterial.ush中</p><p>void SetGBufferForShadingModel函数</p><p>根据不同的ShadingModel，GBuffer需要有不同的赋值操作，对于我们新增的着色模型，之前是通过CustomData0和customData1获得的，在这里改成直接传进来的两个新增的自定义参数</p><p>完成以上步骤之后，再次检查了编译后的debug信息以及对metal平台进行测试，原本没有被优化掉的sample成功优化掉了</p><h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1><p>在自定义ShadingModel的时候，如果使用CustomData0和CustomData1两个材质属性，可能，有可能会在部分平台（比如metal）存在shader编译的优化问题，导致性能表现较差，可以考虑使用自定义材质属性节点来使材质编译能够正确优化。</p><h1 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h1><p>关于如果自定义ShadingModel和新增材质属性，这篇大佬写的很仔细，手把手教学型：<br /><a href="https://zhuanlan.zhihu.com/p/446587397">UE4 shadingmodel终极版之如何新增材质接口(4.27)</a></p>]]></content>
    
    
    <categories>
      
      <category>UE4</category>
      
    </categories>
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Rendering</tag>
      
      <tag>Material</tag>
      
      <tag>Shader</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：使用Python导出LevelSequence轨道的Actor名字获取问题</title>
    <link href="/posts/52092/"/>
    <url>/posts/52092/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>UE4 提供了不少Python接口来帮助TA快速执行一些程序化的脚本，提高一些工作的效率</p><p>这天我们TA大佬跟我反映，他发现用Python脚本导出bake过的LevelSequence的tracks到fbx文件后，有些Actor的名字多了后缀，但是在编辑器下使用UI菜单的导出按钮导出到fbx文件的时候这几个Actor名字并没有多后缀，和Sequence编辑器里的一模一样，让我帮忙看看怎么回事</p><h1 id="具体问题"><a class="markdownIt-Anchor" href="#具体问题"></a> 具体问题</h1><p>这次没有那么费解了，因为老早就知道了Level的Outline里面显示的Name不一定和GetName一致，而且WorldOutline里面的标题明明白白的写了，这个是Label</p><p>而GetName获取的这个FName在这个Actor被创建的时候会检查唯一性，不唯一则加后缀</p><p>在使用SpawnActor的时候，如果传进去的Setting的Name不为空，且多次Spawn的时候Name相同，那一定会直接fetal error</p><p>所以问题其实很明显，在没有看具体代码之前，我合理怀疑点击UI的地方拿的是Label，脚本的逻辑估计因为各种原因不方便直接调用原有的地方的逻辑，重载的方法调用的是GetName。当然这是初步猜测，还是要具体看一下代码</p><h1 id="相关代码"><a class="markdownIt-Anchor" href="#相关代码"></a> 相关代码</h1><p>首先去看了一下UI这边是怎么弄的，一层层往里看最后找到这个：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">FbxNode* <span class="hljs-title">FFbxExporter::ExportActor</span><span class="hljs-params">(AActor* Actor, <span class="hljs-type">bool</span> bExportComponents, INodeNameAdapter&amp; NodeNameAdapter, <span class="hljs-type">bool</span> bSaveAnimSeq )</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">//省略大量代码</span><br>FbxNode* ActorNode = <span class="hljs-built_in">FindActor</span>(Actor, &amp;NodeNameAdapter);<br><span class="hljs-keyword">if</span> (ActorNode == <span class="hljs-literal">NULL</span>)<br>&#123;<br>        <span class="hljs-comment">// 拿名字的在这里</span><br>FString FbxNodeName = NodeNameAdapter.<span class="hljs-built_in">GetActorNodeName</span>(Actor);<br><br>        <span class="hljs-comment">//省略大量代码</span><br>    &#125;<br>    <span class="hljs-comment">//省略大量代码</span><br>&#125;<br></code></pre></td></tr></table></figure><p>按一下F12去看看这个GetActorNodeName，发现是个虚函数，类是INodeNameAdapter</p><p>我接着去看了一下脚本入口，发现最后依然是到了ExportActor，同样是INodeNameAdapter的GetActorNodeName方法，那么基本可以确定是子类重写了父类函数</p><p>倒回去看从脚本调进来的函数传递的参数的数据类型（好几层，烦= =）：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// SequencerTools.cpp</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ExportFBXInternal</span><span class="hljs-params">(UWorld* World, UMovieSceneSequence* Sequence, <span class="hljs-type">const</span> TArray&lt;FSequencerBindingProxy&gt;&amp; InBindings, UFbxExportOption* OverrideOptions, <span class="hljs-type">const</span> FString&amp; InFBXFileName, UMovieSceneSequencePlayer* Player)</span></span><br><span class="hljs-function"></span>&#123;<br>UnFbx::FFbxExporter* Exporter = UnFbx::FFbxExporter::<span class="hljs-built_in">GetInstance</span>();<br><span class="hljs-comment">//Show the fbx export dialog options</span><br>Exporter-&gt;<span class="hljs-built_in">SetExportOptionsOverride</span>(OverrideOptions);<br><br>UMovieScene* MovieScene = Sequence-&gt;<span class="hljs-built_in">GetMovieScene</span>();<br>TArray&lt;FGuid&gt; Bindings;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> FSequencerBindingProxy&amp; Proxy : InBindings)<br>&#123;<br><span class="hljs-keyword">if</span> (Proxy.Sequence == Sequence)<br>&#123;<br>Bindings.<span class="hljs-built_in">Add</span>(Proxy.BindingID);<br>&#125;<br>&#125;<br><br>    <span class="hljs-comment">// 重点在这里</span><br>    <span class="hljs-comment">//////////////////////////////////////////////////////</span><br>    <span class="hljs-comment">//////////////////////////////////////////////////////</span><br>INodeNameAdapter NodeNameAdapter;<br>    <span class="hljs-comment">//////////////////////////////////////////////////////</span><br>    <span class="hljs-comment">//////////////////////////////////////////////////////</span><br><br>    Player-&gt;State.<span class="hljs-built_in">AssignSequence</span>(MovieSceneSequenceID::Root, *Sequence, *Player);<br>FMovieSceneSequenceIDRef Template = MovieSceneSequenceID::Root;<br><span class="hljs-type">bool</span> bDidExport = <span class="hljs-literal">false</span>;<br>FMovieSceneSequenceTransform RootToLocalTransform;<br><br>&#123;<br><span class="hljs-function">FSpawnableRestoreState <span class="hljs-title">SpawnableRestoreState</span><span class="hljs-params">(MovieScene)</span></span>;<br><br><span class="hljs-keyword">if</span> (SpawnableRestoreState.bWasChanged)<br>&#123;<br><span class="hljs-comment">// Evaluate at the beginning of the subscene time to ensure that spawnables are created before export</span><br>Player-&gt;<span class="hljs-built_in">SetPlaybackPosition</span>(<span class="hljs-built_in">FMovieSceneSequencePlaybackParams</span>(UE::MovieScene::<span class="hljs-built_in">DiscreteInclusiveLower</span>(MovieScene-&gt;<span class="hljs-built_in">GetPlaybackRange</span>()).Value, EUpdatePositionMethod::Play));<br>&#125;<br><br>bDidExport = MovieSceneToolHelpers::<span class="hljs-built_in">ExportFBX</span>(World, MovieScene, Player, Bindings, NodeNameAdapter, Template, InFBXFileName, RootToLocalTransform);<br>&#125;<br><br>Player-&gt;<span class="hljs-built_in">Stop</span>();<br>Exporter-&gt;<span class="hljs-built_in">SetExportOptionsOverride</span>(<span class="hljs-literal">nullptr</span>);<br><br><span class="hljs-keyword">return</span> bDidExport;<br>&#125;<br></code></pre></td></tr></table></figure><p>好吧这里直接创建的是基类，拿的是GetName</p><p>另一个地方也看一下</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// Sequencer.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FSequencer::ExportFBXInternal</span><span class="hljs-params">(<span class="hljs-type">const</span> FString&amp; ExportFilename, TArray&lt;FGuid&gt;&amp; Bindings)</span></span><br><span class="hljs-function"></span>&#123;<br>&#123;<br>UnFbx::FFbxExporter* Exporter = UnFbx::FFbxExporter::<span class="hljs-built_in">GetInstance</span>();<br><span class="hljs-comment">//Show the fbx export dialog options</span><br><span class="hljs-type">bool</span> ExportCancel = <span class="hljs-literal">false</span>;<br><span class="hljs-type">bool</span> ExportAll = <span class="hljs-literal">false</span>;<br>Exporter-&gt;<span class="hljs-built_in">FillExportOptions</span>(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, ExportFilename, ExportCancel, ExportAll);<br><span class="hljs-keyword">if</span> (!ExportCancel)<br>&#123;<br>UMovieScene* MovieScene = <span class="hljs-built_in">GetFocusedMovieSceneSequence</span>()-&gt;<span class="hljs-built_in">GetMovieScene</span>();<br>UWorld* World = <span class="hljs-built_in">Cast</span>&lt;UWorld&gt;(<span class="hljs-built_in">GetPlaybackContext</span>());<br>FMovieSceneSequenceIDRef Template = <span class="hljs-built_in">GetFocusedTemplateID</span>();<br><br>            <span class="hljs-comment">// 重点在这里</span><br>            <span class="hljs-comment">//////////////////////////////////////////////////////</span><br>            <span class="hljs-comment">//////////////////////////////////////////////////////</span><br>UnFbx::<span class="hljs-function">FFbxExporter::FLevelSequenceNodeNameAdapter <span class="hljs-title">NodeNameAdapter</span><span class="hljs-params">(MovieScene, <span class="hljs-keyword">this</span>, Template)</span></span>;<br>            <span class="hljs-comment">//////////////////////////////////////////////////////</span><br>            <span class="hljs-comment">//////////////////////////////////////////////////////</span><br><br>&#123;<br><span class="hljs-function">FSpawnableRestoreState <span class="hljs-title">SpawnableRestoreState</span><span class="hljs-params">(MovieScene)</span></span>;<br><span class="hljs-keyword">if</span> (SpawnableRestoreState.bWasChanged)<br>&#123;<br><span class="hljs-comment">// Evaluate at the beginning of the subscene time to ensure that spawnables are created before export</span><br><span class="hljs-built_in">SetLocalTimeDirectly</span>(UE::MovieScene::<span class="hljs-built_in">DiscreteInclusiveLower</span>(<span class="hljs-built_in">GetTimeBounds</span>()));<br>&#125;<br><br><span class="hljs-keyword">if</span> (MovieSceneToolHelpers::<span class="hljs-built_in">ExportFBX</span>(World, MovieScene, <span class="hljs-keyword">this</span>, Bindings, NodeNameAdapter, Template, ExportFilename, RootToLocalTransform))<br>&#123;<br><span class="hljs-function">FNotificationInfo <span class="hljs-title">Info</span><span class="hljs-params">(NSLOCTEXT(<span class="hljs-string">&quot;Sequencer&quot;</span>, <span class="hljs-string">&quot;ExportFBXSucceeded&quot;</span>, <span class="hljs-string">&quot;FBX Export Succeeded.&quot;</span>))</span></span>;<br>Info.Hyperlink = FSimpleDelegate::<span class="hljs-built_in">CreateStatic</span>([](FString InFilename) &#123; FPlatformProcess::<span class="hljs-built_in">ExploreFolder</span>(*InFilename); &#125;, ExportFilename);<br>Info.HyperlinkText = FText::<span class="hljs-built_in">FromString</span>(ExportFilename);<br>Info.ExpireDuration = <span class="hljs-number">5.0f</span>;<br>FSlateNotificationManager::<span class="hljs-built_in">Get</span>().<span class="hljs-built_in">AddNotification</span>(Info)-&gt;<span class="hljs-built_in">SetCompletionState</span>(SNotificationItem::CS_Success);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>FNotificationInfo <span class="hljs-built_in">Info</span>(<span class="hljs-built_in">NSLOCTEXT</span>(<span class="hljs-string">&quot;Sequencer&quot;</span>, <span class="hljs-string">&quot;ExportFBXFailed&quot;</span>, <span class="hljs-string">&quot;FBX Export Failed.&quot;</span>));<br>Info.ExpireDuration = <span class="hljs-number">5.0f</span>;<br>FSlateNotificationManager::<span class="hljs-built_in">Get</span>().<span class="hljs-built_in">AddNotification</span>(Info)-&gt;<span class="hljs-built_in">SetCompletionState</span>(SNotificationItem::CS_Fail);<br>&#125;<br>&#125;<br><br><span class="hljs-built_in">ForceEvaluate</span>();<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>看一下这个子类的方法的具体实现：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C++">FString FFbxExporter::FLevelSequenceNodeNameAdapter::<span class="hljs-built_in">GetActorNodeName</span>(<span class="hljs-type">const</span> AActor* Actor)<br>&#123;<br>FString NodeName = Actor-&gt;<span class="hljs-built_in">GetName</span>();<br><br><span class="hljs-keyword">for</span> ( <span class="hljs-type">const</span> FMovieSceneBinding&amp; MovieSceneBinding : MovieScene-&gt;<span class="hljs-built_in">GetBindings</span>() )<br>&#123;<br><span class="hljs-keyword">for</span> ( TWeakObjectPtr&lt;UObject&gt; RuntimeObject : MovieScenePlayer-&gt;<span class="hljs-built_in">FindBoundObjects</span>(MovieSceneBinding.<span class="hljs-built_in">GetObjectGuid</span>(), SequenceID) )<br>&#123;<br><span class="hljs-keyword">if</span> (RuntimeObject.<span class="hljs-built_in">Get</span>() == Actor)<br>&#123;<br>NodeName = MovieScene-&gt;<span class="hljs-built_in">GetObjectDisplayName</span>(MovieSceneBinding.<span class="hljs-built_in">GetObjectGuid</span>()).<span class="hljs-built_in">ToString</span>();<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Maya does not support dashes.  Change all dashes to underscores</span><br>NodeName = NodeName.<span class="hljs-built_in">Replace</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;-&quot;</span>), <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;_&quot;</span>) );<br><br><span class="hljs-comment">// Maya does not support spaces.  Change all spaces to underscores</span><br>NodeName = NodeName.<span class="hljs-built_in">Replace</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot; &quot;</span>), <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;_&quot;</span>) );<br><br><span class="hljs-keyword">return</span> NodeName;<br>&#125;<br></code></pre></td></tr></table></figure><p>好啊好啊，DisplayName……</p><h1 id="解决方案"><a class="markdownIt-Anchor" href="#解决方案"></a> 解决方案</h1><p>这个看具体需求，我们TA大佬希望是和LevelSequence的编辑器的名字一致，这个是Label</p><p>那么就是要把脚本的调用里面的NodeNameAdapter改成FLevelSequenceNodeNameAdapter类型</p><p>这个类型的话需要传递参数来完成构造</p><p>看一下构造函数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">FLevelSequenceNodeNameAdapter</span>( UMovieScene* InMovieScene, IMovieScenePlayer* InMovieScenePlayer, FMovieSceneSequenceIDRef InSequenceID);<br></code></pre></td></tr></table></figure><p>非常不错的是，在这个函数里我们都能拿到这些</p><p>改完之后是这样：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">- INodeNameAdapter NodeNameAdapter;</span><br><span class="hljs-addition">+ UnFbx::FFbxExporter::FLevelSequenceNodeNameAdapter NodeNameAdapter( Sequence-&gt;GetMovieScene(),Player,MovieSceneSequenceID::Root);</span><br></code></pre></td></tr></table></figure><h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1><ol><li>世界大纲显示的是Actor的Label不是类设计的Name这个属性</li><li>Sequence的脚本导出工具看上去是基于原本的Sequence的方法重写的</li><li>重命名一个不相同的名字可以解决Label和Name不一致的问题</li></ol>]]></content>
    
    
    <categories>
      
      <category>UE4</category>
      
    </categories>
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Tools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：MergeActors修改</title>
    <link href="/posts/7750/"/>
    <url>/posts/7750/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>这次是给TA大佬打打杂~</p><p>针对使用需要修改了一下UE的MergeActors方法，方便美术使用，提高美术制作效率。</p><p>主要问题有：</p><ol><li>工具Merge之后的Actor的中心轴点是(0,0,0)，场景中分批合并后所有的Actor的中心轴点全都在中间，有的距离会非常远，不方便使用</li><li>Merge后的Actor的名字是类类型+数字，和原本的不好对上，不直观</li><li>没有返回值，希望批量化处理的时候能拿到Merge的Actors进行其他的处理</li><li>按照我们的设置，只会Merge出一个Actor，但是由于StaticMeshComponents的不相同，每个合并出的Actor上会有不同的UInstancedStaticMeshComponent实例，不如直接合并成不相同的Actors，更方便一点</li></ol><p><strong>版本 4.27</strong></p><h1 id="相关结构体"><a class="markdownIt-Anchor" href="#相关结构体"></a> 相关结构体</h1><h2 id="fmeshinstancingsettings"><a class="markdownIt-Anchor" href="#fmeshinstancingsettings"></a> FMeshInstancingSettings</h2><p>一个参数结构体，用来方便传递参数，具体参数意义可以看下面的源码部分的注释</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/** Mesh instance-replacement settings */</span><br><span class="hljs-built_in">USTRUCT</span>(Blueprintable)<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FMeshInstancingSettings</span><br>&#123;<br><span class="hljs-built_in">GENERATED_BODY</span>()<br><br><span class="hljs-built_in">FMeshInstancingSettings</span>()<br>: <span class="hljs-built_in">ActorClassToUse</span>(AActor::<span class="hljs-built_in">StaticClass</span>())<br>, <span class="hljs-built_in">InstanceReplacementThreshold</span>(<span class="hljs-number">2</span>)<br>, <span class="hljs-built_in">MeshReplacementMethod</span>(EMeshInstancingReplacementMethod::KeepOriginalActorsAsEditorOnly)<br>, <span class="hljs-built_in">bSkipMeshesWithVertexColors</span>(<span class="hljs-literal">true</span>)<br>, <span class="hljs-built_in">bUseHLODVolumes</span>(<span class="hljs-literal">true</span>)<br>, <span class="hljs-built_in">ISMComponentToUse</span>(UInstancedStaticMeshComponent::<span class="hljs-built_in">StaticClass</span>())<br>&#123;&#125;<br><br>    <span class="hljs-comment">// 要将合并后的instance static mesh components附加到的actor的类</span><br><span class="hljs-built_in">UPROPERTY</span>(BlueprintReadWrite, EditAnywhere, NoClear, Category=<span class="hljs-string">&quot;Instancing&quot;</span>)<br>TSubclassOf&lt;AActor&gt; ActorClassToUse;<br><br>    <span class="hljs-comment">// 如果static mesh数量小于这个值不会执行合并</span><br><span class="hljs-built_in">UPROPERTY</span>(BlueprintReadWrite, EditAnywhere, Category=<span class="hljs-string">&quot;Instancing&quot;</span>, meta=(ClampMin=<span class="hljs-number">1</span>))<br>int32 InstanceReplacementThreshold;<br><br><span class="hljs-comment">// 是删掉原来的static mesh actor还是留在原地 这个枚举只有两个值</span><br><span class="hljs-built_in">UPROPERTY</span>(BlueprintReadWrite, EditAnywhere, Category=<span class="hljs-string">&quot;Instancing&quot;</span>)<br>EMeshInstancingReplacementMethod MeshReplacementMethod;<br><br>    <span class="hljs-comment">// 是否跳过有定点颜色的static mesh，实例静态网格不支持每个实例的顶点颜色，合并的话将丢失此数据</span><br><span class="hljs-built_in">UPROPERTY</span>(BlueprintReadWrite, EditAnywhere, Category=<span class="hljs-string">&quot;Instancing&quot;</span>)<br><span class="hljs-type">bool</span> bSkipMeshesWithVertexColors;<br><br>    <span class="hljs-comment">// 是否根据实instanced static mesh components与HLOD体积的交点拆分instanced static mesh components</span><br><span class="hljs-built_in">UPROPERTY</span>(BlueprintReadWrite, EditAnywhere, Category=<span class="hljs-string">&quot;Instancing&quot;</span>, meta=(DisplayName=<span class="hljs-string">&quot;Use HLOD Volumes&quot;</span>))<br><span class="hljs-type">bool</span> bUseHLODVolumes;<br><br>    <span class="hljs-comment">// 指定一下要用的InstancedStaticMeshComponent的类</span><br><span class="hljs-built_in">UPROPERTY</span>(BlueprintReadWrite, EditAnywhere, Category = <span class="hljs-string">&quot;Instancing&quot;</span>, meta = (DisplayName = <span class="hljs-string">&quot;Select the type of Instanced Component&quot;</span>, DisallowedClasses = <span class="hljs-string">&quot;FoliageInstancedStaticMeshComponent&quot;</span>))<br>TSubclassOf&lt;UInstancedStaticMeshComponent&gt; ISMComponentToUse;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="fcomponententry"><a class="markdownIt-Anchor" href="#fcomponententry"></a> FComponentEntry</h2><p>一个局部定义的结构体，主要目的是存储UStaticMeshComponent的一些数据，方便合并出的新的Component使用<br />没什么好说的，变量名都很直观</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/** Helper struct representing a spawned ISMC */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FComponentEntry</span><br>&#123;<br>    <span class="hljs-built_in">FComponentEntry</span>(UStaticMeshComponent* InComponent)<br>    &#123;<br>        StaticMesh = InComponent-&gt;<span class="hljs-built_in">GetStaticMesh</span>();<br>        InComponent-&gt;<span class="hljs-built_in">GetUsedMaterials</span>(Materials);<br>        bReverseCulling = InComponent-&gt;<span class="hljs-built_in">GetComponentTransform</span>().<span class="hljs-built_in">ToMatrixWithScale</span>().<span class="hljs-built_in">Determinant</span>() &lt; <span class="hljs-number">0.0f</span>;<br>        CollisionProfileName = InComponent-&gt;<span class="hljs-built_in">GetCollisionProfileName</span>();<br>        CollisionEnabled = InComponent-&gt;<span class="hljs-built_in">GetCollisionEnabled</span>();<br>        OriginalComponents.<span class="hljs-built_in">Add</span>(InComponent);<br>    &#125;<br><br>    <span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span>==(<span class="hljs-type">const</span> FComponentEntry&amp; InOther) <span class="hljs-type">const</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> <br>            StaticMesh == InOther.StaticMesh &amp;&amp;<br>            Materials == InOther.Materials &amp;&amp;<br>            bReverseCulling == InOther.bReverseCulling &amp;&amp; <br>            CollisionProfileName == InOther.CollisionProfileName &amp;&amp;<br>            CollisionEnabled == InOther.CollisionEnabled;<br>    &#125;<br><br>    UStaticMesh* StaticMesh;<br><br>    TArray&lt;UMaterialInterface*&gt; Materials;<br><br>    TArray&lt;UStaticMeshComponent*&gt; OriginalComponents;<br><br>    FName CollisionProfileName;<br><br>    <span class="hljs-type">bool</span> bReverseCulling;<br><br>    ECollisionEnabled::Type CollisionEnabled;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="factorentry"><a class="markdownIt-Anchor" href="#factorentry"></a> FActorEntry</h2><p>一个局部结构体，要保存StaticMeshComponents生成的FComponentEntry，有一个MergedActor成员</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/** Helper struct representing a spawned ISMC-containing actor */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FActorEntry</span><br>&#123;<br>    <span class="hljs-built_in">FActorEntry</span>(UStaticMeshComponent* InComponent, ULevel* InLevel)<br>        : <span class="hljs-built_in">MergedActor</span>(<span class="hljs-literal">nullptr</span>)<br>    &#123;<br>        <span class="hljs-comment">// intersect with HLOD volumes if we have a level</span><br>        <span class="hljs-keyword">if</span>(InLevel)<br>        &#123;<br>            <span class="hljs-keyword">for</span> (AActor* Actor : InLevel-&gt;Actors)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (AHierarchicalLODVolume* HierarchicalLODVolume = <span class="hljs-built_in">Cast</span>&lt;AHierarchicalLODVolume&gt;(Actor))<br>                &#123;<br>                    FBox BoundingBox = InComponent-&gt;Bounds.<span class="hljs-built_in">GetBox</span>();<br>                    FBox VolumeBox = HierarchicalLODVolume-&gt;<span class="hljs-built_in">GetComponentsBoundingBox</span>(<span class="hljs-literal">true</span>);<br><br>                    <span class="hljs-keyword">if</span> (VolumeBox.<span class="hljs-built_in">IsInside</span>(BoundingBox) || (HierarchicalLODVolume-&gt;bIncludeOverlappingActors &amp;&amp; VolumeBox.<span class="hljs-built_in">Intersect</span>(BoundingBox)))<br>                    &#123;<br>                        HLODVolume = HierarchicalLODVolume;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span>==(<span class="hljs-type">const</span> FActorEntry&amp; InOther) <span class="hljs-type">const</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> HLODVolume == InOther.HLODVolume;<br>    &#125;<br><br>    AActor* MergedActor;<br>    AHierarchicalLODVolume* HLODVolume;<br>    TArray&lt;FComponentEntry&gt; ComponentEntries;<br>&#125;;<br></code></pre></td></tr></table></figure><h1 id="原处理流程"><a class="markdownIt-Anchor" href="#原处理流程"></a> 原处理流程</h1><h2 id="处理static-mesh-components"><a class="markdownIt-Anchor" href="#处理static-mesh-components"></a> 处理Static Mesh Components</h2><ol><li>收集有效的Static Mesh Components，根据需要选择是否跳过有顶点颜色的Component</li><li>生成StaticMeshComponent的FActorEntry</li><li>对所有有效的Components生成对应FComponentEntry</li><li>将ComponentEntry添加到ActorEntry的ComponentEntries中</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// 收集有效的Components</span><br><span class="hljs-comment">// 确认是否有顶点颜色</span><br><span class="hljs-keyword">auto</span> HasInstanceVertexColors = [](UStaticMeshComponent* StaticMeshComponent)<br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> FStaticMeshComponentLODInfo&amp; CurrentLODInfo : StaticMeshComponent-&gt;LODData)<br>    &#123;<br>        <span class="hljs-keyword">if</span>(CurrentLODInfo.OverrideVertexColors != <span class="hljs-literal">nullptr</span> || CurrentLODInfo.PaintedVertices.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;;<br><span class="hljs-comment">// 存放Components</span><br>TArray&lt;UStaticMeshComponent*&gt; ValidComponents;<br><span class="hljs-comment">// </span><br><span class="hljs-keyword">for</span>(UPrimitiveComponent* ComponentToMerge : ComponentsToMerge)<br>&#123;<br>    <span class="hljs-keyword">if</span>(UStaticMeshComponent* StaticMeshComponent = <span class="hljs-built_in">Cast</span>&lt;UStaticMeshComponent&gt;(ComponentToMerge))<br>    &#123;<br>        <span class="hljs-comment">// 如果Components的父类类型和我们要用来挂InstanceMesh的类类型一样的话就不合并</span><br>        <span class="hljs-comment">// 不太明白为什么要有这一步处理，但是避免选了一堆StaticMeshActors然后要合并成一个StaticMeshActor的这种操作= =</span><br>        <span class="hljs-comment">// 毕竟，理论上来讲</span><br>        <span class="hljs-comment">// 要是用MergeActors这个功能就是为了把static mesh actors都合并成instances</span><br>        <span class="hljs-keyword">if</span>(StaticMeshComponent-&gt;<span class="hljs-built_in">GetOwner</span>()-&gt;<span class="hljs-built_in">GetClass</span>() != MeshInstancingSettings.ActorClassToUse.<span class="hljs-built_in">Get</span>())<br>        &#123;<br>            <span class="hljs-comment">// 这个检查是不是要跳过有顶点颜色的Actor</span><br>            <span class="hljs-keyword">if</span>( !MeshInstancingSettings.bSkipMeshesWithVertexColors || !<span class="hljs-built_in">HasInstanceVertexColors</span>(StaticMeshComponent))<br>            &#123;<br>                ValidComponents.<span class="hljs-built_in">Add</span>(StaticMeshComponent);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>生成ActorEntries，这里如果bUseHLODVolumes是false的情况，那就只会有一个ActorEntry</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// FActorEntry的容器</span><br>TArray&lt;FActorEntry&gt; ActorEntries;<br><span class="hljs-keyword">for</span>(UStaticMeshComponent* StaticMeshComponent : ValidComponents)<br>&#123;<br>int32 ActorEntryIndex = ActorEntries.<span class="hljs-built_in">AddUnique</span>(<span class="hljs-built_in">FActorEntry</span>(StaticMeshComponent, InSettings.bUseHLODVolumes ? Level : <span class="hljs-literal">nullptr</span>));<br>FActorEntry&amp; ActorEntry = ActorEntries[ActorEntryIndex];<br><br>       <span class="hljs-comment">// FComponentEntry构造的时候StaticMeshComponent就会add到OriginalComponents中</span><br><span class="hljs-function">FComponentEntry <span class="hljs-title">ComponentEntry</span><span class="hljs-params">(StaticMeshComponent)</span></span>;<br><br>       <span class="hljs-comment">// 如果ActorEntry中已经有了一样的FComponentEntry，就直接添加对应的FComponentEntry中就可以</span><br>       <span class="hljs-comment">// 不然的话就是一个新的FComponentEntry</span><br><span class="hljs-keyword">if</span>(FComponentEntry* ExistingComponentEntry = ActorEntry.ComponentEntries.<span class="hljs-built_in">FindByKey</span>(ComponentEntry))<br>&#123;<br>ExistingComponentEntry-&gt;OriginalComponents.<span class="hljs-built_in">Add</span>(StaticMeshComponent);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>ActorEntry.ComponentEntries.<span class="hljs-built_in">Add</span>(ComponentEntry);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="筛选actorentries"><a class="markdownIt-Anchor" href="#筛选actorentries"></a> 筛选ActorEntries</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// 返回OriginalComponents数量大于设置中要求的阈值的ActorEntry的ComponentEntry</span><br><span class="hljs-keyword">for</span>(FActorEntry&amp; ActorEntry : ActorEntries)<br>&#123;<br>    ActorEntry.ComponentEntries = ActorEntry.ComponentEntries.<span class="hljs-built_in">FilterByPredicate</span>([&amp;InSettings](<span class="hljs-type">const</span> FComponentEntry&amp; InEntry)<br>    &#123;<br>        <span class="hljs-keyword">return</span> InEntry.OriginalComponents.<span class="hljs-built_in">Num</span>() &gt;= InSettings.InstanceReplacementThreshold;<br>    &#125;);<br>&#125;<br><br><span class="hljs-comment">// 如果ActorEntry的ComponentEntries是空的就去掉</span><br>ActorEntries.<span class="hljs-built_in">RemoveAll</span>([](<span class="hljs-type">const</span> FActorEntry&amp; ActorEntry)&#123; <span class="hljs-keyword">return</span> ActorEntry.ComponentEntries.<span class="hljs-built_in">Num</span>() == <span class="hljs-number">0</span>; &#125;);<br></code></pre></td></tr></table></figure><h2 id="保存原始staticmeshactors"><a class="markdownIt-Anchor" href="#保存原始staticmeshactors"></a> 保存原始StaticMeshActors</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// 通过OriginalComponents获取到原本的Static Mesh Actor</span><br><span class="hljs-comment">// 后面会根据Setting的参数决定这些是否要删除掉</span><br>TArray&lt;AActor*&gt; ActorsToCleanUp;<br><span class="hljs-keyword">for</span>(FActorEntry&amp; ActorEntry : ActorEntries)<br>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">const</span> FComponentEntry&amp; ComponentEntry : ActorEntry.ComponentEntries)<br>    &#123;<br>        <span class="hljs-keyword">for</span>(UStaticMeshComponent* OriginalComponent : ComponentEntry.OriginalComponents)<br>        &#123;<br>            <span class="hljs-keyword">if</span>(AActor* OriginalActor = OriginalComponent-&gt;<span class="hljs-built_in">GetOwner</span>())<br>            &#123;<br>                ActorsToCleanUp.<span class="hljs-built_in">AddUnique</span>(OriginalActor);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="合并staticmeshcomponents"><a class="markdownIt-Anchor" href="#合并staticmeshcomponents"></a> 合并StaticMeshComponents</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs C++">Level-&gt;<span class="hljs-built_in">Modify</span>();<br><br>FActorSpawnParameters Params;<br>Params.OverrideLevel = Level;<br><br><span class="hljs-comment">// We now have the set of component data we want to apply</span><br><span class="hljs-keyword">for</span>(FActorEntry&amp; ActorEntry : ActorEntries)<br>&#123;<br>    <span class="hljs-comment">// 创建新的Actor，这各Actor类类型默认是AActor</span><br>    ActorEntry.MergedActor = World-&gt;<span class="hljs-built_in">SpawnActor</span>&lt;AActor&gt;(InSettings.ActorClassToUse.<span class="hljs-built_in">Get</span>(), Params);<br>    <span class="hljs-comment">// 遍历ComponentEntries</span><br>    <span class="hljs-comment">// 若果合并的Actors不完全相同，那么ComponentEntries就不会只有一个</span><br>    <span class="hljs-comment">// 最后的结果是一个Actor上会有多个UInstancedStaticMeshComponent</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">const</span> FComponentEntry&amp; ComponentEntry : ActorEntry.ComponentEntries)<br>    &#123;<br>        UInstancedStaticMeshComponent* NewComponent = <span class="hljs-literal">nullptr</span>;<br><br>        <span class="hljs-comment">// ISMComponentToUse的默认值是UInstancedStaticMeshComponent</span><br>        <span class="hljs-comment">// 这里先从Actor身上试图获取一个UInstancedStaticMeshComponent</span><br>        NewComponent = (UInstancedStaticMeshComponent*)ActorEntry.MergedActor-&gt;<span class="hljs-built_in">FindComponentByClass</span>(InSettings.ISMComponentToUse.<span class="hljs-built_in">Get</span>());<br>        <span class="hljs-comment">// 如果发现确实存在UInstancedStaticMeshComponent但是数据不是空的，还是回选择去新建一个</span><br>        <span class="hljs-keyword">if</span> (NewComponent &amp;&amp; NewComponent-&gt;PerInstanceSMData.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>            NewComponent = <span class="hljs-literal">nullptr</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (NewComponent == <span class="hljs-literal">nullptr</span>)<br>        &#123;<br>            <span class="hljs-comment">// 创建一个新的Component</span><br>            NewComponent = <span class="hljs-built_in">NewObject</span>&lt;UInstancedStaticMeshComponent&gt;(ActorEntry.MergedActor, InSettings.ISMComponentToUse.<span class="hljs-built_in">Get</span>());<br>        <br>            <span class="hljs-keyword">if</span> (ActorEntry.MergedActor-&gt;<span class="hljs-built_in">GetRootComponent</span>())<br>            &#123;<br>                <span class="hljs-comment">// 有root的话可以直接Attach</span><br>                NewComponent-&gt;<span class="hljs-built_in">AttachToComponent</span>(ActorEntry.MergedActor-&gt;<span class="hljs-built_in">GetRootComponent</span>(), FAttachmentTransformRules::KeepRelativeTransform);<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-comment">// 没有root那么你就是root！</span><br>                ActorEntry.MergedActor-&gt;<span class="hljs-built_in">SetRootComponent</span>(NewComponent);<br>            &#125;<br><br>            <span class="hljs-comment">// Take &#x27;instanced&#x27; ownership so it persists with this actor</span><br>            ActorEntry.MergedActor-&gt;<span class="hljs-built_in">RemoveOwnedComponent</span>(NewComponent);<br>            NewComponent-&gt;CreationMethod = EComponentCreationMethod::Instance;<br>            ActorEntry.MergedActor-&gt;<span class="hljs-built_in">AddOwnedComponent</span>(NewComponent);<br><br>        &#125;<br><br>        <span class="hljs-comment">// 把原先的属性赋值给新的Component</span><br>        NewComponent-&gt;<span class="hljs-built_in">SetStaticMesh</span>(ComponentEntry.StaticMesh);<br>        <span class="hljs-keyword">for</span>(int32 MaterialIndex = <span class="hljs-number">0</span>; MaterialIndex &lt; ComponentEntry.Materials.<span class="hljs-built_in">Num</span>(); ++MaterialIndex)<br>        &#123;<br>            NewComponent-&gt;<span class="hljs-built_in">SetMaterial</span>(MaterialIndex, ComponentEntry.Materials[MaterialIndex]);<br>        &#125;<br>        NewComponent-&gt;<span class="hljs-built_in">SetReverseCulling</span>(ComponentEntry.bReverseCulling);<br>        NewComponent-&gt;<span class="hljs-built_in">SetCollisionProfileName</span>(ComponentEntry.CollisionProfileName);<br>        NewComponent-&gt;<span class="hljs-built_in">SetCollisionEnabled</span>(ComponentEntry.CollisionEnabled);<br>        NewComponent-&gt;<span class="hljs-built_in">SetMobility</span>(EComponentMobility::Static);<br>        <span class="hljs-comment">// 这里，就是把多个相同的原来的StaticMeshComponents合并成了一个UInstancedStaticMeshComponent，AddInstance</span><br>        <span class="hljs-keyword">for</span>(UStaticMeshComponent* OriginalComponent : ComponentEntry.OriginalComponents)<br>        &#123;<br>            NewComponent-&gt;<span class="hljs-built_in">AddInstance</span>(OriginalComponent-&gt;<span class="hljs-built_in">GetComponentTransform</span>());<br>        &#125;<br><br>        NewComponent-&gt;<span class="hljs-built_in">RegisterComponent</span>();<br>    &#125;<br><br>    World-&gt;<span class="hljs-built_in">UpdateCullDistanceVolumes</span>(ActorEntry.MergedActor);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="清理原始actors"><a class="markdownIt-Anchor" href="#清理原始actors"></a> 清理原始Actors</h2><p>就是很简单的根据设置看看需不需要把被合并的那些Actors删掉</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">for</span>(AActor* ActorToCleanUp : ActorsToCleanUp)<br>&#123;<br>    <span class="hljs-keyword">if</span>(InSettings.MeshReplacementMethod == EMeshInstancingReplacementMethod::RemoveOriginalActors)<br>    &#123;<br>        ActorToCleanUp-&gt;<span class="hljs-built_in">Destroy</span>();<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(InSettings.MeshReplacementMethod == EMeshInstancingReplacementMethod::KeepOriginalActorsAsEditorOnly)<br>    &#123;<br>        ActorToCleanUp-&gt;<span class="hljs-built_in">Modify</span>();<br>        ActorToCleanUp-&gt;bIsEditorOnlyActor = <span class="hljs-literal">true</span>;<br>        ActorToCleanUp-&gt;<span class="hljs-built_in">SetHidden</span>(<span class="hljs-literal">true</span>);<br>        ActorToCleanUp-&gt;bHiddenEd = <span class="hljs-literal">true</span>;<br>        ActorToCleanUp-&gt;<span class="hljs-built_in">SetIsTemporarilyHiddenInEditor</span>(<span class="hljs-literal">true</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="针对问题做出的改动"><a class="markdownIt-Anchor" href="#针对问题做出的改动"></a> 针对问题做出的改动</h1><p><strong>根据需求这里没有直接修改源码哦</strong></p><h2 id="actor名字问题"><a class="markdownIt-Anchor" href="#actor名字问题"></a> Actor名字问题</h2><p>这个容易，但是美术需要的其实是outline里面显示的那个名字，SpawnActor的Params的Name是Name不是显示出来的这个名字<br />这里直接取会被合并的一堆里面的第一个名字直接加后缀</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">if</span> (ActorEntry.ComponentEntry.OriginalComponents.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br>    <span class="hljs-comment">// 省略部分代码</span><br>    MergedActorName = ActorEntry.ComponentEntry.OriginalComponents[<span class="hljs-number">0</span>]-&gt;<span class="hljs-built_in">GetOuter</span>()-&gt;<span class="hljs-built_in">GetName</span>() + <span class="hljs-built_in">FString</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;_merged&quot;</span>));<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    <span class="hljs-comment">// 省略部分代码</span><br>    MergedActorName = ActorsToCleanUp[<span class="hljs-number">0</span>]-&gt;<span class="hljs-built_in">GetName</span>() + <span class="hljs-built_in">FString</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;_merged&quot;</span>));<br>&#125;<br>ActorEntry.MergedActor-&gt;<span class="hljs-built_in">SetActorLabel</span>(MergedActorName);<br><br></code></pre></td></tr></table></figure><h2 id="分成多个actor"><a class="markdownIt-Anchor" href="#分成多个actor"></a> 分成多个Actor</h2><p>如果要分成多个Actor，那就说明每个Actor只有一个Component<br />先把结构体给改掉：<br />把之前的Array改为了一个对象，因为只需要一个</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs diff">// 省略部分源码<br>struct FComponentEntry<br>&#123;<br>    AActor* MergedActor;<br>    AHierarchicalLODVolume* HLODVolume;<br><span class="hljs-deletion">-   TArray&lt;FComponentEntry&gt; ComponentEntries;</span><br><span class="hljs-addition">+   FComponentEntry ComponentEntry;</span><br>&#125;;<br><br></code></pre></td></tr></table></figure><p>然后还是生成ActorEntries<br />只有当Component生成的ComponentEntry完全相同的时候才会合并到一个Actor上<br />否则就会创建一个新的Actor</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// Gather a list of components to merge</span><br>TArray&lt;FActorEntry&gt; ActorEntries;<br><br><span class="hljs-keyword">auto</span> GenActorEntry = [](FComponentEntry&amp; ComponentEntry, TArray&lt;FActorEntry&gt;&amp; ActorEntries, UStaticMeshComponent* StaticMeshComponent)<br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; ActorEntry : ActorEntries)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ActorEntry.ComponentEntry == ComponentEntry)<br>        &#123;<br>            ActorEntry.ComponentEntry.OriginalComponents.<span class="hljs-built_in">Add</span>(StaticMeshComponent);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    FActorEntry ActorEntry = <span class="hljs-built_in">FActorEntry</span>(StaticMeshComponent, <span class="hljs-literal">nullptr</span>);<br>    ActorEntry.ComponentEntry = ComponentEntry;<br>    ActorEntries.<span class="hljs-built_in">Add</span>(ActorEntry);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;;<br><br><span class="hljs-keyword">for</span>(UStaticMeshComponent* StaticMeshComponent : ValidComponents)<br>&#123;<br>    <span class="hljs-function">FComponentEntry <span class="hljs-title">ComponentEntry</span><span class="hljs-params">(StaticMeshComponent)</span></span>;<br>    <span class="hljs-built_in">GenActorEntry</span>(ComponentEntry, ActorEntries, StaticMeshComponent);<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="生成的actor轴心点位置问题"><a class="markdownIt-Anchor" href="#生成的actor轴心点位置问题"></a> 生成的Actor轴心点位置问题</h2><p>不出意外的情况下，理论上OriginalComponents不可能是空的<br />对所有的OriginalComponents的位置去一个平均值，然后取整方便后续的计算使用</p> <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">if</span> (ActorEntry.ComponentEntry.OriginalComponents.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; OriginalComponent:ActorEntry.ComponentEntry.OriginalComponents)<br>    &#123;<br>        <span class="hljs-keyword">auto</span> Actor = <span class="hljs-built_in">Cast</span>&lt;AActor&gt;(OriginalComponent-&gt;<span class="hljs-built_in">GetOuter</span>());<br>        Position += Actor-&gt;<span class="hljs-built_in">GetActorLocation</span>();<br>    &#125;<br>    Position = Position / ActorEntry.ComponentEntry.OriginalComponents.<span class="hljs-built_in">Num</span>();<br>    Position = <span class="hljs-built_in">FVector</span>(<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(Position.X), <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(Position.Y), <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(Position.Z));<br>    Position.Z = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-built_in">Cast</span>&lt;AActor&gt;(ActorEntry.ComponentEntry.OriginalComponents[<span class="hljs-number">0</span>]-&gt;<span class="hljs-built_in">GetOuter</span>())-&gt;<span class="hljs-built_in">GetActorLocation</span>().Z);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; Actor: ActorsToCleanUp)<br>    &#123;<br>        Position += Actor-&gt;<span class="hljs-built_in">GetActorLocation</span>();<br>    &#125;<br>    Position = Position / ActorsToCleanUp.<span class="hljs-built_in">Num</span>();<br>    Position = <span class="hljs-built_in">FVector</span>(<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(Position.X), <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(Position.Y), <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(Position.Z));<br>    Position.Z = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(ActorsToCleanUp[<span class="hljs-number">0</span>]-&gt;<span class="hljs-built_in">GetActorLocation</span>().Z);<br>&#125;<br></code></pre></td></tr></table></figure><p>之后在MergedActor确认存在RootComponent后就可以设置位置了</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++">ActorEntry.MergedActor-&gt;<span class="hljs-built_in">GetRootComponent</span>()-&gt;<span class="hljs-built_in">SetWorldLocation</span>(Position);<br></code></pre></td></tr></table></figure><p>设置Actor位置后，原本按照KeepRelativeTransform方式添加的其他Component就会偏离原本在世界中的位置，需要处理一下</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">for</span>(UStaticMeshComponent* OriginalComponent : ComponentEntry.OriginalComponents)<br>&#123;<br>    FTransform OriginalComponentTransform = OriginalComponent-&gt;<span class="hljs-built_in">GetComponentTransform</span>();<br>    FVector OriginalComponentLocation = OriginalComponentTransform.<span class="hljs-built_in">GetLocation</span>() - Position;<br>    OriginalComponentTransform.<span class="hljs-built_in">SetLocation</span>(OriginalComponentLocation);<br>    NewComponent-&gt;<span class="hljs-built_in">AddInstance</span>(OriginalComponentTransform);<br>&#125;<br></code></pre></td></tr></table></figure><p>这样就可以了</p><h2 id="返回值问题"><a class="markdownIt-Anchor" href="#返回值问题"></a> 返回值问题</h2><p>这个不用多说，简单</p><h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1><p>原本引擎提供的MergeActor并没有办法通过蓝图调用到函数，也没有返回值，在需要批量化处理场景的时候会不太方便，但是其中具体的实现相对简单，稍微修改就可以满足需求</p><p>源码位置：MeshMergeUtilities.cpp</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Tools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TinyRenderer 3：ZBuffer</title>
    <link href="/posts/54742/"/>
    <url>/posts/54742/</url>
    
    <content type="html"><![CDATA[<p>这一节是为了解决上一节课里简单的计算平面法向量和光照夹角后绘制造成的错误，引入ZBuffer来计算每个像素实际上在屏幕空间的可见性</p><p>这里由于这个渲染器还没有进行投影等相关操作，所以ZBuffer的计算比较取巧，原文的解释也并不是很充分，暂时没有去深究具体的推倒</p><p>并且wiki给出的源码版本似乎是对不上的</p><p>这里简单实现了一下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// 初始化ZBuffer</span><br><span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">ZBuffer</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">float</span>[WIDTH * HEIGHT], std::default_delete&lt;<span class="hljs-type">float</span>[]&gt;())</span></span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (WIDTH * HEIGHT); i++)<br>&#123;<br>    ZBuffer.<span class="hljs-built_in">get</span>()[i] = std::numeric_limits&lt;<span class="hljs-type">float</span>&gt;::<span class="hljs-built_in">min</span>();<br>&#125;<br><br><span class="hljs-comment">// 定义光照方向</span><br><span class="hljs-function"><span class="hljs-type">const</span> Vec3f <span class="hljs-title">LightDir</span><span class="hljs-params">(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>)</span></span>;<br><br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ModelInstance-&gt;<span class="hljs-built_in">GetFacesNumber</span>(); i++)<br>&#123;<br>    Face Face = ModelInstance-&gt;<span class="hljs-built_in">GetFace</span>(i);<br>    Vec3f Pts[<span class="hljs-number">3</span>];<br>    Vec3f WorldCoords[<span class="hljs-number">3</span>];<br>    <span class="hljs-comment">// 处理每个面的三个点的空间变换</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">3</span>; j++)<br>    &#123;<br>        <span class="hljs-type">const</span> Vec3f V = ModelInstance-&gt;<span class="hljs-built_in">GetVertex</span>(Face[j]);<br>        Pts[j] = <span class="hljs-built_in">WorldToScreen</span>(V);<br>        WorldCoords[j] = V;<br>    &#125;<br>    Vec3f N = (WorldCoords[<span class="hljs-number">2</span>] - WorldCoords[<span class="hljs-number">0</span>]) ^ (WorldCoords[<span class="hljs-number">1</span>] - WorldCoords[<span class="hljs-number">0</span>]);<br>    N.<span class="hljs-built_in">normalize</span>();<br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> Intensity = N * LightDir;<br>    <span class="hljs-built_in">DrawTriangleEdgeFunc</span>(Pts, Image, <span class="hljs-built_in">TGAColor</span>(Intensity * <span class="hljs-number">255</span>, Intensity * <span class="hljs-number">255</span>, Intensity * <span class="hljs-number">255</span>, <span class="hljs-number">255</span>), ZBuffer.<span class="hljs-built_in">get</span>());<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\r %f [%.2lf%%]&quot;</span>, Intensity, i * <span class="hljs-number">100.0f</span> / ModelInstance-&gt;<span class="hljs-built_in">GetFacesNumber</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>其中画三角的函数也进行了对应的修改</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawTriangleEdgeFunc</span><span class="hljs-params">(Vec3f Pts[<span class="hljs-number">3</span>], TGAImage&amp; Image, <span class="hljs-type">const</span> TGAColor Color, <span class="hljs-type">float</span>* ZBuffer)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-function">Vec2f <span class="hljs-title">BboxMin</span><span class="hljs-params">(Image.get_width() - <span class="hljs-number">1</span>, Image.get_height() - <span class="hljs-number">1</span>)</span></span>;<br>    <span class="hljs-function">Vec2f <span class="hljs-title">BboxMax</span><span class="hljs-params">(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">const</span> Vec2f <span class="hljs-title">Clamp</span><span class="hljs-params">(Image.get_width() - <span class="hljs-number">1</span>, Image.get_height() - <span class="hljs-number">1</span>)</span></span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>    &#123;<br>        BboxMin.x = std::<span class="hljs-built_in">max</span>(<span class="hljs-number">0.0f</span>, std::<span class="hljs-built_in">min</span>(BboxMin.x, Pts[i].x));<br>        BboxMin.y = std::<span class="hljs-built_in">max</span>(<span class="hljs-number">0.0f</span>, std::<span class="hljs-built_in">min</span>(BboxMin.y, Pts[i].y));<br><br>        BboxMax.x = std::<span class="hljs-built_in">min</span>(Clamp.x, std::<span class="hljs-built_in">max</span>(BboxMax.x, Pts[i].x));<br>        BboxMax.y = std::<span class="hljs-built_in">min</span>(Clamp.y, std::<span class="hljs-built_in">max</span>(BboxMax.y, Pts[i].y));<br>    &#125;<br>    Vec3f P;<br>    <span class="hljs-keyword">for</span> (P.x = BboxMin.x; P.x &lt;= BboxMax.x; P.x++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (P.y = BboxMin.y; P.y &lt;= BboxMax.y; P.y++)<br>        &#123;<br>            Vec3&lt;<span class="hljs-type">float</span>&gt; BcScreen = <span class="hljs-built_in">Barycentric</span>(Pts, P);<br>            <span class="hljs-keyword">if</span> (BcScreen.x &lt; <span class="hljs-number">0</span> || BcScreen.y &lt; <span class="hljs-number">0</span> || BcScreen.z &lt; <span class="hljs-number">0</span>) <br>                <span class="hljs-keyword">continue</span>;<br>            P.z = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">3</span>; i++)<br>            &#123;<br>                P.z += Pts[i][<span class="hljs-number">2</span>] * BcScreen[i];<br>            &#125;<br>            <span class="hljs-keyword">if</span> (ZBuffer[<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(P.x + P.y * WIDTH)] &lt; P.z)<br>            &#123;<br>                ZBuffer[<span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(P.x + P.y * WIDTH)] = P.z;<br>                Image.<span class="hljs-built_in">set</span>(P.x, P.y, Color);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>后面布置了关于贴图的映射的相关内容</p><p>从Obj里读取所有的vt，对应的是0-1映射的纹理的x和y值，分别乘上宽度和高度就是对应的三角形顶点在贴图上对应的点的坐标，三角形内其他点通过对应的插值来采样</p><p>但是上面的重心法我不知道怎么去插值，改回了扫描法</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// 读取贴图</span><br><span class="hljs-built_in">main</span>()<br>&#123;<br>    <span class="hljs-comment">// ......</span><br><br>    <span class="hljs-function">TGAImage <span class="hljs-title">Texture</span><span class="hljs-params">(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>, TGAImage::RGB)</span></span>;<br>    Texture.<span class="hljs-built_in">read_tga_file</span>(<span class="hljs-string">&quot;african_head_diffuse.tga&quot;</span>);<br>    Texture.<span class="hljs-built_in">flip_vertically</span>();<br><br><br>    <span class="hljs-comment">// 初始化ZBuffer</span><br>    <span class="hljs-function">std::shared_ptr&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">ZBuffer</span><span class="hljs-params">(<span class="hljs-keyword">new</span> <span class="hljs-type">float</span>[WIDTH * HEIGHT], std::default_delete&lt;<span class="hljs-type">float</span>[]&gt;())</span></span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; (WIDTH * HEIGHT); i++)<br>    &#123;<br>        ZBuffer.<span class="hljs-built_in">get</span>()[i] = std::numeric_limits&lt;<span class="hljs-type">int</span>&gt;::<span class="hljs-built_in">min</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 定义光照方向</span><br>    <span class="hljs-function"><span class="hljs-type">const</span> Vec3f <span class="hljs-title">LightDir</span><span class="hljs-params">(<span class="hljs-number">0.f</span>, <span class="hljs-number">0.f</span>, <span class="hljs-number">-1.f</span>)</span></span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ModelInstance-&gt;<span class="hljs-built_in">GetFacesNumber</span>(); i++)<br>    &#123;<br>        Face Face = ModelInstance-&gt;<span class="hljs-built_in">GetFace</span>(i);<br>        Vec3f Pts[<span class="hljs-number">3</span>];<br>        Vec3f UVs[<span class="hljs-number">3</span>];<br>        Vec3f WorldCoords[<span class="hljs-number">3</span>];<br>        <span class="hljs-comment">// 处理每个面的三个点的空间变换</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">3</span>; j++)<br>        &#123;<br>            <span class="hljs-type">const</span> Vec3f V = ModelInstance-&gt;<span class="hljs-built_in">GetVertex</span>(Face[j]);<br>            <span class="hljs-comment">//Pts[j] = (WorldToScreen(V));</span><br>            Pts[j] = <span class="hljs-built_in">WorldToScreen</span>(V);<br><br>            UVs[j] = <span class="hljs-built_in">Vec3f</span>(ModelInstance-&gt;<span class="hljs-built_in">GetUV</span>(Face.VTIndex[j]).x * <span class="hljs-number">1024</span>, <br>                ModelInstance-&gt;<span class="hljs-built_in">GetUV</span>(Face.VTIndex[j]).y * <span class="hljs-number">1024</span>, <br>                <span class="hljs-number">0</span>);<br>            WorldCoords[j] = V;<br>        &#125;<br>        Vec3f N = (WorldCoords[<span class="hljs-number">2</span>] - WorldCoords[<span class="hljs-number">0</span>]) ^ (WorldCoords[<span class="hljs-number">1</span>] - WorldCoords[<span class="hljs-number">0</span>]);<br>        N.<span class="hljs-built_in">normalize</span>();<br>        <span class="hljs-type">const</span> <span class="hljs-type">float</span> Intensity = N * LightDir;<br>        <span class="hljs-built_in">DrawTriangleEdgeFunc</span>(Pts, UVs, Image, Texture, ZBuffer.<span class="hljs-built_in">get</span>(), Intensity);<br>        <span class="hljs-comment">//DrawTriangleEdgeFunc(Pts, Image, TGAColor(Intensity * 255, Intensity * 255, Intensity * 255, 255), ZBuffer.get());</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\r %f [%.2lf%%]&quot;</span>, Intensity, i * <span class="hljs-number">100.0f</span> / ModelInstance-&gt;<span class="hljs-built_in">GetFacesNumber</span>());<br>    &#125;<br>&#125;<br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// ......</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// 从贴图采样颜色</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawTriangleEdgeFunc</span><span class="hljs-params">(Vec3f Pts[<span class="hljs-number">3</span>], Vec3f UVs[<span class="hljs-number">3</span>], TGAImage&amp; Image, TGAImage&amp; TextureImage, <span class="hljs-type">float</span>* ZBuffer, <span class="hljs-type">const</span> <span class="hljs-type">float</span>&amp; Intensity)</span></span><br><span class="hljs-function"></span>&#123;<br>    Vec3f t0, t1, t2, uv0, uv1, uv2;<br>    t0 = (Pts[<span class="hljs-number">0</span>]);<br>    t1 = (Pts[<span class="hljs-number">1</span>]);<br>    t2 = (Pts[<span class="hljs-number">2</span>]);<br>    uv0 = (UVs[<span class="hljs-number">0</span>]);<br>    uv1 = (UVs[<span class="hljs-number">1</span>]);<br>    uv2 = (UVs[<span class="hljs-number">2</span>]);<br><br>    <span class="hljs-keyword">if</span> (t0.y == t1.y &amp;&amp; t0.y == t2.y) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// i dont care about degenerate triangles</span><br>    <span class="hljs-keyword">if</span> (t0.y &gt; t1.y)<br>    &#123;<br>        std::<span class="hljs-built_in">swap</span>(t0, t1);<br>        std::<span class="hljs-built_in">swap</span>(uv0, uv1);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (t0.y &gt; t2.y)<br>    &#123;<br>        std::<span class="hljs-built_in">swap</span>(t0, t2);<br>        std::<span class="hljs-built_in">swap</span>(uv0, uv2);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (t1.y &gt; t2.y)<br>    &#123;<br>        std::<span class="hljs-built_in">swap</span>(t1, t2);<br>        std::<span class="hljs-built_in">swap</span>(uv1, uv2);<br>    &#125;<br><br>    <span class="hljs-type">int</span> total_height = t2.y - t0.y;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; total_height; i++)<br>    &#123;<br>        <span class="hljs-type">bool</span> second_half = i &gt; t1.y - t0.y || t1.y == t0.y;<br>        <span class="hljs-type">int</span> segment_height = second_half ? t2.y - t1.y : t1.y - t0.y;<br>        <span class="hljs-type">float</span> alpha = (<span class="hljs-type">float</span>)i / total_height;<br>        <span class="hljs-type">float</span> beta = (<span class="hljs-type">float</span>)(i - (second_half ? t1.y - t0.y : <span class="hljs-number">0</span>)) / segment_height; <br>        Vec3f A = t0 + <span class="hljs-built_in">Vec3f</span>(t2 - t0) * alpha;<br>        Vec3f B = second_half ? t1 + <span class="hljs-built_in">Vec3f</span>(t2 - t1) * beta : t0 + <span class="hljs-built_in">Vec3f</span>(t1 - t0) * beta;<br>        <span class="hljs-comment">// 通过插值计算每个点的uv</span><br>        Vec3f uvA = uv0 + (uv2 - uv0) * alpha;<br>        Vec3f uvB = second_half ? uv1 + (uv2 - uv1) * beta : uv0 + (uv1 - uv0) * beta;<br>        <span class="hljs-keyword">if</span> (A.x &gt; B.x)<br>        &#123;<br>            std::<span class="hljs-built_in">swap</span>(A, B);<br>            std::<span class="hljs-built_in">swap</span>(uvA, uvB);<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = A.x; j &lt;= B.x; j++)<br>        &#123;<br>            <span class="hljs-type">float</span> phi = B.x == A.x ? <span class="hljs-number">1.</span> : (<span class="hljs-type">float</span>)(j - A.x) / (<span class="hljs-type">float</span>)(B.x - A.x);<br>            Vec3f P = <span class="hljs-built_in">Vec3f</span>(A) + <span class="hljs-built_in">Vec3f</span>(B - A) * phi;<br>            Vec3f uvP = uvA + (uvB - uvA) * phi;<br>            <span class="hljs-type">int</span> idx = P.x + P.y * WIDTH;<br>            <span class="hljs-keyword">if</span> (ZBuffer[idx] &lt; P.z)<br>            &#123;<br>                ZBuffer[idx] = P.z;<br>                TGAColor color = TextureImage.<span class="hljs-built_in">get</span>(uvP.x, uvP.y) * Intensity;<br>                Image.<span class="hljs-built_in">set</span>(P.x, P.y, color);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220703194051.png" alt="diffuse" /></p>]]></content>
    
    
    <categories>
      
      <category>CG</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Renderer</tag>
      
      <tag>CG</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TinyRenderer 2：三角形光栅化和背面剔除</title>
    <link href="/posts/7931/"/>
    <url>/posts/7931/</url>
    
    <content type="html"><![CDATA[<h1 id="画三角形"><a class="markdownIt-Anchor" href="#画三角形"></a> 画三角形</h1><p>上节已经会画线了，三角形还能不简单吗<br />假设我有ABC三个点组成三角形，我AB画一条线，BC画一条线，AC画一条线，结束！</p><p>= =目前写C<ins>处于UE和之前C</ins>风格的混沌叠加态了，能跑就行（不是</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawTriangle</span><span class="hljs-params">(Point&lt;<span class="hljs-type">float</span>&gt; A, Point&lt;<span class="hljs-type">float</span>&gt; B, Point&lt;<span class="hljs-type">float</span>&gt; C, TGAImage&amp; Image, <span class="hljs-type">const</span> TGAColor&amp; Color)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">DrawLineBresenham</span>(A, B, Image, Color);<br><span class="hljs-built_in">DrawLineBresenham</span>(A, C, Image, Color);<br><span class="hljs-built_in">DrawLineBresenham</span>(B, C, Image, Color);<br>&#125;<br></code></pre></td></tr></table></figure><p>本节完！（不是</p><p>下一个问题是填充三角形</p><h1 id="fill三角形"><a class="markdownIt-Anchor" href="#fill三角形"></a> Fill三角形</h1><p>那当然是先来一个最经典的从上到下或者从下到上的水平逐行扫描啦，简单直接=W=</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawFilledTriangle</span><span class="hljs-params">(Vec2i T0, Vec2i T1, Vec2i T2, TGAImage&amp; Image, <span class="hljs-type">const</span> TGAColor Color)</span> </span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">if</span> (T0.y == T1.y &amp;&amp; T0.y == T2.y) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 这能叫三角形啊（暴言</span><br><span class="hljs-comment">// 给点按照y排序可以方便的确认高度</span><br><span class="hljs-keyword">if</span> (T0.y &gt; T1.y) std::<span class="hljs-built_in">swap</span>(T0, T1);<br><span class="hljs-keyword">if</span> (T0.y &gt; T2.y) std::<span class="hljs-built_in">swap</span>(T0, T2);<br><span class="hljs-keyword">if</span> (T1.y &gt; T2.y) std::<span class="hljs-built_in">swap</span>(T1, T2);<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> TotalHeight = T2.y - T0.y;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; TotalHeight; i++) <br>    &#123;<br><span class="hljs-type">const</span> <span class="hljs-type">bool</span> SecondHalf = i &gt; T1.y - T0.y || T1.y == T0.y;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> SegmentHeight = SecondHalf ? T2.y - T1.y : T1.y - T0.y;<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> Alpha = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">float</span>&gt;(i) / TotalHeight;<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> Beta = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">float</span>&gt;(i - (SecondHalf ? T1.y - T0.y : <span class="hljs-number">0</span>)) / SegmentHeight;<br>Vec2i A = T0 + (T2 - T0) * Alpha;<br>Vec2i B = SecondHalf ? T1 + (T2 - T1) * Beta : T0 + (T1 - T0) * Beta;<br><span class="hljs-keyword">if</span> (A.x &gt; B.x) <br>            std::<span class="hljs-built_in">swap</span>(A, B);<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = A.x; j &lt;= B.x; j++) <br>        &#123;<br>Image.<span class="hljs-built_in">set</span>(j, T0.y + i, Color); <span class="hljs-comment">// 需要注意int型可能导致的 t0.y+i != A.y </span><br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在这节课里大佬给出了一个想法：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">triangle</span>(vec2 points[<span class="hljs-number">3</span>]) <br>&#123; <br>    vec2 bbox[<span class="hljs-number">2</span>] = <span class="hljs-built_in">find_bounding_box</span>(points); <br>    <span class="hljs-keyword">for</span> (each pixel in the bounding box) &#123; <br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">inside</span>(points, pixel)) &#123; <br>            <span class="hljs-built_in">put_pixel</span>(pixel); <br>        &#125; <br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure><p>先找到三角形的包围盒，然后在对包围盒的每一个点判断是否在三角形之内，是的话就着色，最后画出一个三角形</p><p>这个被称为边界函数算法（Edge-Function）</p><p>在计算点是否在三角形内的时候使用了重心坐标系</p><p>这个算法猛地一看感觉很奇怪，这不是有很多像素根本不在三角形里，要去做判断不是一种浪费嘛，逐行扫描划出来的就是在三角形里的</p><p>主要原因是，扫描线画法通过插值生成两个边界点，插值的精度损失导致的多个三角形间存在接缝的问题。而绘制边界点之间部分，每次只画了一条线，操作的单位是一条线，现在基本都是高精度模型，这样画起来是很慢的，需要寻求一种可以并行的方法</p><p>对边界函数算法的实现如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">Vec3f <span class="hljs-title">Barycentric</span><span class="hljs-params">(<span class="hljs-type">const</span> Vec2i Pts[<span class="hljs-number">3</span>], Vec2i P)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">const</span> Vec3f U =<br>        <span class="hljs-built_in">Vec3f</span>(Pts[<span class="hljs-number">2</span>].x - Pts[<span class="hljs-number">0</span>].x, Pts[<span class="hljs-number">1</span>].x - Pts[<span class="hljs-number">0</span>].x, Pts[<span class="hljs-number">0</span>].x - P.x) ^ <span class="hljs-built_in">Vec3f</span>(Pts[<span class="hljs-number">2</span>].y - Pts[<span class="hljs-number">0</span>].y, Pts[<span class="hljs-number">1</span>].y - Pts[<span class="hljs-number">0</span>].y, Pts[<span class="hljs-number">0</span>].y - P.y);<br>    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">abs</span>(U.z) &lt; <span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>&#125;;<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-number">1.f</span> - (U.x + U.y) / U.z, U.y / U.z, U.x / U.z&#125;;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawTriangleEdgeFunc</span><span class="hljs-params">(Vec2i Pts[<span class="hljs-number">3</span>], TGAImage&amp; Image, <span class="hljs-type">const</span> TGAColor Color)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-function">Vec2i <span class="hljs-title">BboxMin</span><span class="hljs-params">(Image.get_width() - <span class="hljs-number">1</span>, Image.get_height() - <span class="hljs-number">1</span>)</span></span>;<br>    <span class="hljs-function">Vec2i <span class="hljs-title">BboxMax</span><span class="hljs-params">(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span></span>;<br>    <span class="hljs-function"><span class="hljs-type">const</span> Vec2i <span class="hljs-title">Clamp</span><span class="hljs-params">(Image.get_width() - <span class="hljs-number">1</span>, Image.get_height() - <span class="hljs-number">1</span>)</span></span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>    &#123;<br>        BboxMin.x = std::<span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, std::<span class="hljs-built_in">min</span>(BboxMin.x, Pts[i].x));<br>        BboxMin.y = std::<span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, std::<span class="hljs-built_in">min</span>(BboxMin.y, Pts[i].y));<br><br>        BboxMax.x = std::<span class="hljs-built_in">min</span>(Clamp.x, std::<span class="hljs-built_in">max</span>(BboxMax.x, Pts[i].x));<br>        BboxMax.y = std::<span class="hljs-built_in">min</span>(Clamp.y, std::<span class="hljs-built_in">max</span>(BboxMax.y, Pts[i].y));<br>    &#125;<br>    Vec2i P;<br>    <span class="hljs-keyword">for</span> (P.x = BboxMin.x; P.x &lt;= BboxMax.x; P.x++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (P.y = BboxMin.y; P.y &lt;= BboxMax.y; P.y++)<br>        &#123;<br>            Vec3f BcScreen = <span class="hljs-built_in">Barycentric</span>(Pts, P);<br>            <span class="hljs-keyword">if</span> (BcScreen.x &lt; <span class="hljs-number">0</span> || BcScreen.y &lt; <span class="hljs-number">0</span> || BcScreen.z &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;<br>            Image.<span class="hljs-built_in">set</span>(P.x, P.y, Color);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="背面剔除"><a class="markdownIt-Anchor" href="#背面剔除"></a> 背面剔除</h1><p>通过定义一个光照方向（其实是视线方向），与每个平面的法向量求点积，点击结果意味着两个方向的夹角关系，可以得知是平行还是反方向，就可以完成背面剔除的工作了~</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// 定义光照方向</span><br><span class="hljs-function">Vec3f <span class="hljs-title">LightDir</span><span class="hljs-params">(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>)</span></span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; ModelInstance-&gt;<span class="hljs-built_in">GetFacesNumber</span>(); i++)<br>&#123;<br>    Face Face = ModelInstance-&gt;<span class="hljs-built_in">GetFace</span>(i);<br>    Vec2i ScreenCoords[<span class="hljs-number">3</span>];<br>    Vec3f WorldCoords[<span class="hljs-number">3</span>];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">3</span>; j++)<br>    &#123;<br>        <span class="hljs-type">const</span> Vec3f V = ModelInstance-&gt;<span class="hljs-built_in">GetVertex</span>(Face[j]);<br>        ScreenCoords[j] = <span class="hljs-built_in">Vec2i</span>((V.x + <span class="hljs-number">1.</span>) * WIDTH / <span class="hljs-number">2.</span>, (V.y + <span class="hljs-number">1.</span>) * HEIGHT / <span class="hljs-number">2.</span>);<br>        WorldCoords[j] = V;<br>    &#125;<br>    <span class="hljs-comment">// 这里三角形的法线可以简单地计算为其两侧的叉积</span><br>    <span class="hljs-comment">// 两个向量的叉积与这两个向量组成的坐标平面垂直</span><br>    Vec3f N = (WorldCoords[<span class="hljs-number">2</span>] - WorldCoords[<span class="hljs-number">0</span>]) ^ (WorldCoords[<span class="hljs-number">1</span>] - WorldCoords[<span class="hljs-number">0</span>]);<br>    N.<span class="hljs-built_in">normalize</span>();<br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> Intensity = N * LightDir;<br>    <span class="hljs-comment">// 如果Intensity是0说明光照和法向量平行，就照不到光，小于0就意味着光是从平面法向量背面照射的</span><br>    <span class="hljs-keyword">if</span> (Intensity &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        Vec2i Pts[<span class="hljs-number">3</span>] = &#123;ScreenCoords[<span class="hljs-number">0</span>], ScreenCoords[<span class="hljs-number">1</span>], ScreenCoords[<span class="hljs-number">2</span>]&#125;;<br>        <span class="hljs-built_in">DrawTriangleEdgeFunc</span>(Pts, Image, <span class="hljs-built_in">TGAColor</span>(Intensity * <span class="hljs-number">255</span>, Intensity * <span class="hljs-number">255</span>, Intensity * <span class="hljs-number">255</span>, <span class="hljs-number">255</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>本节课结束之后会得到这样一张图：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220702145057.png" alt="第二节完毕" /></p><p>可以看到嘴部是有点奇怪的，这个就是我们前面用的粗暴的剔除的方式导致的，嘴唇的一部分的法向量计算出来的结果并不是我们实际想要的“正面”的法向量方向，导致和光照方向点乘的结果是小于0的，认为是不可见的部分</p><p>这节到这里就结束了</p>]]></content>
    
    
    <categories>
      
      <category>CG</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Renderer</tag>
      
      <tag>CG</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：关于Texture Streaming的一部分总结</title>
    <link href="/posts/21321/"/>
    <url>/posts/21321/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>Leader告诉我可以看下Texture Streaming相关，这里总结一下下</p><p>日常费解.jpg</p><div align=center> <img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220620222820.png" width="40%"></div><h1 id="ue4的texture-streaming"><a class="markdownIt-Anchor" href="#ue4的texture-streaming"></a> UE4的Texture Streaming</h1><p>纹理流送系统或流送器是引擎的一部分，负责增大和减小每个纹理的分辨率。该系统使您可以拥有良好的视觉质量， 同时有效地管理可用内存。（来自UE4官方文档机翻）<br />看完这句话我的脑子里冒出来的问题大概有：</p><ol><li>为什么要有流送系统？</li><li>它流送的是啥？</li><li>流送系统怎么管理内存了？</li><li>流送系统如何影响画质了？</li></ol><p>大概是这样的：</p><p>依然是LOD的思想，在绘制远距离物体的时候，最终在屏幕上该物体占据的像素数量极小的情况下，如果依然使用较大的贴图（比如在屏幕上占了32<em>32像素但是用了一个1024</em>1024大小的贴图），采样会产生锯齿或者摩尔纹，显示质量是有问题的，而且显然很浪费显存。再考虑到硬件算理有限，不能当场进行卷积来消除这些画面问题，最好的办法就是在这种情况下直接用小点的接近屏幕上显示大小的贴图。</p><p>于是多级渐进纹理Mipmap出现了，这样可以在远处的时候直接用小尺寸贴图，解决掉画面的锯齿之类的问题，但是他消耗的显存就更大了，多出来几份Mips占用了更多的显存。</p><p>解决了一个问题使显存问题稍微严重了一点，那么再去想办法解决内存的问题，这种过程算是开发的常见情况了……- -</p><p>为了解决内存占用过大的问题，UE4这里做了一个纹理流送系统，通过一些计算获取当前最合适的Mips，将其加载，可以节约很多内存</p><p>这样基本就解决了两个问题，只不多最后是多带来了一点点的CPU开销罢了……</p><p>其余的相关概述可以看<a href="https://docs.unrealengine.com/4.27/zh-CN/RenderingAndGraphics/Textures/Streaming/Overview/">官方文档</a></p><p>比较需要注意的是，小于等于Mip7也就是64*64的Mip是会常驻内存的</p><h1 id="stat-streaming"><a class="markdownIt-Anchor" href="#stat-streaming"></a> Stat Streaming</h1><p>UE4提供了一个关于Streaming的控制台调试命令，可以分析内存使用状况</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220701230324.png" alt="官网偷的图" /></p><p>按照官方的解释，Pool指的是理想情况预计使用的内存，并不是当前实际占用的内存，Mips则是当前已经占用的内存</p><p>逐个解释一下图上的Memory Counters参数：</p><p><strong>Safety Pool</strong></p><p>这个值是在Engine的配置文件中指定的，比如BaseEngine.ini，属于TextureStreaming模块，是一个预留内存，主要是用在AsyncTextureStreaming计算可分配内存</p><p><strong>Temporary Pool</strong></p><p>这个值可以通过r.Streaming.MaxTempMemoryAllowed控制，PrepareAsyncTask中会使用这个值，在处理所有纹理时让纹理都处于其所需的Mips</p><p><strong>Streaming Pool</strong></p><p>流送池大小，在移动端是PoolSize - Safety Pool - Temporary Pool - NonStreaming Mips剩余的空间</p><p>在PC端是PoolSize给定的大小</p><p>其中存放了Visible Mips，Hidden Mips， Forced Mips， Cached Mips</p><p>这个值在移动端会因为NonStreaming Mips的增或减少而进行波动</p><p><strong>Required Pool</strong></p><p>计算出来的理想状态下需要的池子的大小，详细的后面一起说</p><p><strong>Visible Mips</strong></p><p>可见纹理当前占用的所需内存，不包括Forced Mips</p><p><strong>Hidden Mips</strong></p><p>非可见纹理，不包括Forced Mips</p><p><strong>Forced Mips</strong></p><p>强制流入纹理当前占据的所需内存，不包括被明确指定为不可流送的纹理</p><p><strong>Cached Mips</strong></p><p>不再需要的纹理所占据的内存，只要有空间，不会立即从内存中释放</p><p><strong>Wanted Mips</strong></p><p>Visible Mips + Hidden Mips + Forced Mips</p><p>上面这些值，假设PoolSize给了一个足够的值，Required Pool会等于Wanted Mips，符合理论，预计需要的和实际需要的相同，因为有足够大的空间</p><p>并且在这种情况下，会有一部分暂时不再需要的纹理被缓存在Pool里，实际目前占用的内存是Wanted+Cached</p><p>如果我们减小PoolSize，向Required Pool的值逼近，Streaming Pool的大小越来越小的时候，Cached Mips就会逐渐从内存里释放，给其他的腾地方</p><p>如果继续减小PoolSize，导致Streaming Pool的大小小于Required Pool的大小，会发现画面中的贴图质量随着Pool的变小慢慢下降，为了实际占用的内存不超过我们给的限制，引擎会降低自己对纹理大小的要求，降低1级、2级、3级……</p><p>直到给了一个1M的大小，所有的流送的贴图都变成了最小的，没有可以下降的余地了，这个时候Wanted Mips会明显小于Required Pool，但是会大于Streaming Pool（给的可用太小了）</p><p>这里懒的去截图了，写得也已经很清楚了，几个参数的关系就如上所说</p><h1 id="相关控制台指令"><a class="markdownIt-Anchor" href="#相关控制台指令"></a> 相关控制台指令</h1><p><strong>r.Streaming.PoolSize</strong></p><p>运行时可以动态修改流送池大小</p><p>0 表示不受任何限制<br />100 设置为100M大小</p><p><strong>r.Streaming.FramesForFullUpdate</strong></p><p>重新计算Texture需求的Mip等级的时间间隔，单位是帧</p><p><strong>r.Streaming.HLODStrategy</strong></p><p>0 流送所有Mip<br />1 仅流送最后一级Mip，其他等级的始终加载到内存里</p><p><strong>r.Streaming.DropMips</strong></p><p>会立即清理内存<br />0 不清理任何Mips<br />1 只会清理Cached Mip<br />2 会清理掉Cached Mips和Hidden Mips，使用后可以看到Stat上关于这两个所占内存的变化，程序所占用的RAM也会发生变化</p><p><strong>r.Streaming.UseAllMips</strong></p><p>1 会使用所有的可用Mips，在FStreamingRenderAsset::UpdateDynamicData函数里，会计算LODBias，如果是1则会跳过计算直接为0，没有偏移</p><p><strong>r.MobileMaxLoadedMips</strong> 和 <strong>r.MobileReduceLoadedMips</strong></p><p>简称为Max和Reduce</p><p>这两个在同一个函数中被调用，</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">static</span> int32 <span class="hljs-title">MobileReduceLoadedMips</span><span class="hljs-params">(int32 NumTotalMips)</span></span><br><span class="hljs-function"></span>&#123;<br>int32 NumReduceMips = FMath::<span class="hljs-built_in">Max</span>(<span class="hljs-number">0</span>, CVarMobileReduceLoadedMips.<span class="hljs-built_in">GetValueOnAnyThread</span>());<br>int32 MaxLoadedMips = FMath::<span class="hljs-built_in">Clamp</span>(CVarMobileMaxLoadedMips.<span class="hljs-built_in">GetValueOnAnyThread</span>(), <span class="hljs-number">1</span>, GMaxTextureMipCount);<br><br>int32 NumMips = NumTotalMips;<br><span class="hljs-comment">// Reduce number of mips as requested</span><br>NumMips = FMath::<span class="hljs-built_in">Max</span>(NumMips - NumReduceMips, <span class="hljs-number">1</span>);<br><span class="hljs-comment">// Clamp number of mips as requested</span><br>NumMips = FMath::<span class="hljs-built_in">Min</span>(NumMips, MaxLoadedMips);<br><br><span class="hljs-keyword">return</span> NumMips;<br>&#125;<br></code></pre></td></tr></table></figure><p>其中Max会被Clamp到1和GMaxTextureMipCount之间（默认值15）<br />Reduce最低只能是0<br />函数参数Num，先减去NumReduceMips，最小取到1，然后和Max之间取较大的一个<br />该函数只有一个地方调用，就是</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">if</span> !PLATFORM_SUPPORTS_TEXTURE_STREAMING <span class="hljs-comment">// eg, Android</span></span><br>NumMips = <span class="hljs-built_in">MobileReduceLoadedMips</span>(NumMips);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>平台不支持Streaming<br />NumMips在Texture2D的CreateResource函数中用来检查MipLevel<br />目前不会还有不支持的吧！= =不必在考虑这个了吧</p><p><strong>r.Streaming.MipBias</strong></p><p>调试时非常有用的一个指令，在r.Streaming.UsePerTextureBias设置为0的情况下，MipBias会作为全局的Mips向下偏移的参数，比如等于1的时候，最后使用的Mip会是计算出的理想Mip的向下一级，可以用来调试确认合适的Mip</p><p>这个指令不仅是贴图，静态模型也会受影响</p><h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1><p>学习了一下UE4纹理流送相关的知识，debug用的相关参数的意义，有助于排查游戏中的Texture使用和打包相关的问题</p><p>可以通过<strong>r.Streaming.PoolSize</strong>进行调试，结合Stat Streaming信息来寻找游戏比较合适的一个Pool的大小</p>]]></content>
    
    
    <categories>
      
      <category>UE4</category>
      
    </categories>
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Optimization</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：移动端俯视角远距离摄像机的级联阴影优化</title>
    <link href="/posts/34123/"/>
    <url>/posts/34123/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>项目中使用了方向光级联阴影，但是leader跟我说这个级联阴影的ShadowMap的利用率很低，让我去看看能不能搞一搞，然鹅本人光照和阴影啥都没看过（甚至第一次听说CSM）当时真的是：</p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220620222820.png" width="30%"><p>于是抓紧时间看了一下相关的知识和UE4的源码部分，算是一定程度解决了问题，本文作为这次任务的小总结。</p><h1 id="级联阴影简介"><a class="markdownIt-Anchor" href="#级联阴影简介"></a> 级联阴影简介</h1><p>级联阴影是对ShadowMap的一种优化，理想情况下，空间中的每一个阴影的像素都对应到阴影贴图的每一个像素就能获得最高质量的阴影。但这是基本办不到的，考虑到性能的问题，尤其是在移动端，一般情况下贴图用4096已经挺奢侈了。<br />如果在视野中的是一个超大场景，场景里有很多产生动态阴影的物体的话，即时贴图很大，也会是多个物体的阴影可能会对应到同一个像素，但在这种情况下，距离摄像机很远的地方的物体的阴影是没有必要做很高精度，于是就有了奇妙的想法，级联阴影<br />希望阴影和物体模型精度一样，距离摄像机远的地方的阴影精度降低，假设使用相同大小的ShadowMap，那么我们将摄像机的视锥从近到远分块，距离摄像机越近的地方，分块后视锥的体积越小，那么单位物体阴影对应的阴影贴图的面积就越大，阴影质量越高<br />在合适的分级和阴影贴图的情况下，我们可以获得近处质量高，整体效率也不错的阴影贴图</p><p><strong>总之就是非常好用的东西！</strong></p><p>这里贴上两个链接：</p><p>微软DX级联阴影：<br /><a href="https://docs.microsoft.com/en-us/windows/win32/dxtecharts/cascaded-shadow-maps"><strong>级联阴影</strong></a><br />UE官方文档：<br /><a href="https://docs.unrealengine.com/4.27/zh-CN/SharingAndReleasing/Mobile/Lighting/HowTo/CascadedShadow/"><strong>使用级联阴影</strong></a></p><h1 id="俯视角远距离摄像机使用情况"><a class="markdownIt-Anchor" href="#俯视角远距离摄像机使用情况"></a> 俯视角远距离摄像机使用情况</h1><p>我们有如下场景：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220621210951.png" alt="场景" /><br />地板的坐标是000，摄像机的坐标如下图：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220621211256.png" alt="摄像机" /><br />这里给到了一个很小的FOV和比较大的长宽比<br />摄像机第一视角如下：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220621211341.png" alt="摄像机视角" /></p><p>首先我们可以直观的了解一下情况，先来一张RenderDoc截图的状况：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220621211547.png" alt="CSM ShadowMap" /></p><p>上图是CSM阴影使用的ShadowMap，大小是2048，那两个小黑点分别是场景中球和方块的阴影贴图（这里只用了1级级联）。</p><p><strong>看，摄像机视角下那么大的俩影子！咋就这么点儿呢！</strong></p><p>前文DX的那个链接里面有说过，级联阴影计算的时候有Fit to View和Fit to Scene，看过UE的实现之后知道，UE是Fit to view，<strong>具体的可以看我<s>水的</s>写的这篇</strong>：</p><p><a href="https://muchenhen.com/posts/46173/"><font size=4> <strong>UE4：移动端级联阴影简要分析</strong> </font></a></p><p>问题就是在这种摄像机很远，FOV小，俯视角的情况下，这个视锥的包围球极其的巨大，也就意味着单位ShadowMap的像素需要承载更多场景中的阴影，那么相当于用了一个2048大小的贴图，画了一个128左右大小的阴影，阴影质量差而且内存浪费，所以需要想办法将这个ShadowMap的空白面积减少，尽量用较小的贴图画出更高质量的阴影</p><h1 id="解决思路"><a class="markdownIt-Anchor" href="#解决思路"></a> 解决思路</h1><p>在看了UE实现的源码之后，定位到了级联视锥生成的部分，接下来想办法减小视锥包围体，<strong>那么接下来本文仅针对标题情况来想办法，其他情况还不清楚都有啥问题</strong>，毕竟</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220621215052.png" alt="啊这" /><br />在我们面对的具体的问题中，摄像机视锥构建的Volume已经差不多和整个场景一样大了，但是并不是整个场景都存在动态物体需要计算阴影，更重要的是我们场景很大但是摄像机只能看到较小的一部分，当然是想看到什么画什么，总之就要是试图减小Volume<br />下面的思路为了简化问题，假设为1级级联，就是整个视锥只有一个级联<br />下面是灵魂画手时间：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220621215715.png" alt="SphereVolume" /></p><h2 id="减小级联阴影视锥"><a class="markdownIt-Anchor" href="#减小级联阴影视锥"></a> 减小级联阴影视锥</h2><p>大概是这么个意思，红色的是相机的视锥（但不完全是，红色最远端其实是CSM设置的最远距离），因为只有一级级联，所以这个Sphere直接就是摄像机视锥的包围球。<br />那么首先，从这张图上可以看出，CSM最远距离设置的太远了，浪费，那么就设置的小一点<br />我们再把摄像机近平面向前推，那么我们的级联视锥就更小了，相应的包围球也会变小<br />这是一种比较简单的做法，略有效果，但是需要多测试合适的参数，但是比较方便，直接在计算级联Volume的地方给一个沿着摄像机方向的偏移，并保持级联范围的最远距离不变就可以了<br />这各方法在实际测试后最终没有采用，因为在我们的实际使用中，仅有一级CSM的时候，虽然相机很远，但是由于FOV很小，我们的相机向下偏移的幅度有限，聊胜于无，提升不大，而启用多级CSM后发现了更加尴尬的事情，我们的场景在最远端，前几级的CSM完全没用</p><h2 id="直接构建投影矩阵"><a class="markdownIt-Anchor" href="#直接构建投影矩阵"></a> 直接构建投影矩阵</h2><p>UE这里其实就是通过视锥构建了投影矩阵，那我们直接给他一个就可以了，UE算的太大了，我们给个小一点的<br />比如，直接将当前视锥内的所有产生阴影的物体找到一个包围了他们的盒子，用这个盒子计算Volume，在只有一级级联的时候直接就可以忽略掉CSM最大距离，可以达到最高效的利用<br />在我们具体的实现中，因为我们的游戏视角几乎固定，摄像机不会转，这样让解决问题的办法容易了很多，我们直接在沿摄像机方向找到与场景地面的焦点，构建出一个刚好包裹目前能看到场景Volume，直接使用这个Volume去进行后续相关的计算。<br />但这样依然会有一个新问题，如果开启了多级CSM，由于强行使用了自定义的Volume，那么CSM的多级ShadowMap会完全一致，很浪费内存。而我们的具体情况又是物体完全落在了最后一级，前几级完全没用，最后决定在移动端只使用一级级联，直接使用自定义Volume，在PC端开启多级级联的时候，将前几级使用UE的Fit to view，最后一级改为自定义Volume，这样能解决在我们的摄像机最远的时候能有一个很高质量的阴影，而摄像机拉到很近（实际游戏过程几乎不存在这种情况）的时候，Fit to view本身在前几级级联也能提供比较不错的阴影了</p><h1 id="效果比较"><a class="markdownIt-Anchor" href="#效果比较"></a> 效果比较</h1><p>这里是我新建了一个空白项目来模拟我们遇到的情况和解决办法<br />在我们远距离小FOV俯视角的情况下：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220624214132.png" alt="原始方法" /></p><p>对应的ShadowMap：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220624214217.png" alt="原始ShadowMap" /></p><p>自定义构建Volume后：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220624214256.png" alt="自定义构建" /></p><p>对应的ShadowMap：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220624214314.png" alt="自定义ShadowMap" /></p><p>效果提升还是很明显的</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220624214931.png" alt="好呀好呀" /></p><h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1><h2 id="遇到的问题"><a class="markdownIt-Anchor" href="#遇到的问题"></a> 遇到的问题</h2><p>CSM是对大范围场景大量动态物体投射动态阴影的非常有效的应用LOD思想的一个方法，非常好用，UE实现的Fit to view方式也是现在很多主流游戏需要的<br />但是对我们的项目摄像机不合适，阴影质量差，内存和带宽占用大，4096甚至画不出1024应有的效果</p><h2 id="解决办法"><a class="markdownIt-Anchor" href="#解决办法"></a> 解决办法</h2><p>最后根据项目是积极情况选择自定义CSM Volume，大幅提升ShadowMap利用率，提高阴影质量<br /><strong>当然以上情况是针对性的，对我们的项目来讲这种方式是最简单最有效的办法，直接复用性不高，毕竟这种情况的摄像机比较少见而且CSM原本的目的是减少大场景多动态物体的开销，但可以提供一个有效的思路</strong></p><h2 id="直接相关的源码"><a class="markdownIt-Anchor" href="#直接相关的源码"></a> 直接相关的源码</h2><p>4.27版本</p><ul><li>DirectionalLightComponent.cpp<ul><li>GetShadowSplitBounds</li><li>GetShadowSplitBoundsDepthRange</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>UE4</category>
      
    </categories>
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Rendering</tag>
      
      <tag>Mobile</tag>
      
      <tag>Shadow</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：移动端级联阴影简要分析</title>
    <link href="/posts/46173/"/>
    <url>/posts/46173/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>假装过一下移动端渲染管线的源码，其实是看一下移动端的固定方向光源对移动物体生成阴影的部分。<br />本文重点在UE4 关于CSM阴影的这部分源码，其他的略过<br />之前从来没有看过这部分源码，本人基础也很薄弱，rendering方面能力不足，本文仅仅是给我的脑子梳理一下，避免稀里糊涂的看完不出三天就忘记了……<br />学而不思则罔~</p><hr /><p>目录：</p><ul><li><a href="#%E5%89%8D%E8%A8%80">前言</a></li><li><a href="#%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86">流程梳理</a><ul><li><a href="#%E7%AE%80%E5%8D%95%E6%8F%8F%E8%BF%B0">简单描述</a></li><li><a href="#%E8%AF%A6%E7%BB%86%E6%B5%81%E7%A8%8B">详细流程</a></li></ul></li><li><a href="#%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0">源码学习</a><ul><li><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E6%B8%B2%E6%9F%93%E4%B8%BB%E5%87%BD%E6%95%B0">移动端渲染主函数</a></li><li><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AFinitviews">移动端InitViews</a></li><li><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8A%A8%E6%80%81%E9%98%B4%E5%BD%B1">移动端初始化动态阴影</a><ul><li><a href="#%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8A%A8%E6%80%81%E9%98%B4%E5%BD%B1%E7%9A%84%E5%87%BD%E6%95%B0">移动端初始化动态阴影的函数</a></li><li><a href="#%E4%B8%8D%E5%90%8Cscene%E5%8F%AF%E4%BB%A5%E5%85%B1%E7%94%A8%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8A%A8%E6%80%81%E9%98%B4%E5%BD%B1%E7%9A%84%E9%83%A8%E5%88%86">不同Scene可以共用的初始化动态阴影的部分</a></li><li><a href="#%E4%B8%BA%E5%BD%93%E5%89%8Dview%E6%B7%BB%E5%8A%A0%E5%85%A8%E5%9C%BA%E6%99%AF%E9%98%B4%E5%BD%B1%E4%BF%A1%E6%81%AF">为当前View添加全场景阴影信息</a><ul><li><a href="#%E8%AE%BE%E7%BD%AE%E6%8A%95%E5%BD%B1%E9%98%B4%E5%BD%B1%E5%88%9D%E5%A7%8B%E5%8C%96%E5%99%A8">设置投影阴影初始化器</a></li><li><a href="#%E7%94%9F%E6%88%90%E6%8A%95%E5%BD%B1%E9%98%B4%E5%BD%B1%E7%9A%84%E4%BF%A1%E6%81%AF">生成投影阴影的信息</a></li></ul></li></ul></li><li><a href="#%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84%E4%BD%93">相关结构体</a><ul><li><a href="#fwholesceneprojectedshadowinitializer">FWholeSceneProjectedShadowInitializer</a></li><li><a href="#fprojectedshadowinitializer">FProjectedShadowInitializer</a></li><li><a href="#fboxspherebounds">FBoxSphereBounds</a></li></ul></li></ul></li></ul><hr /><h1 id="流程梳理"><a class="markdownIt-Anchor" href="#流程梳理"></a> 流程梳理</h1><p><font color = #5555FF>函数</font><br /><font color = #FFFF00>类或结构体</font><br /><font color = #FF0000>变量</font></p><h2 id="简单描述"><a class="markdownIt-Anchor" href="#简单描述"></a> 简单描述</h2><p>简单的文字描述一下UE4 CSM实现大概的流程，防止本文作者出现猪脑过载迹象……</p><font size=3><ol><li>移动端的主渲染流程开始</li><li>渲染进入初始化View阶段</li><li>初始化View中有一个阶段是生成动态阴影</li><li>生成动态阴影的其中一步是创建全场景投影阴影，就是生成CSM阴影</li></ol><p>生成CSM的流程：</p><ol><li>确认级联的数量</li><li>对每一个级联生成投影阴影信息</li><li>据阴影数据构造灯光视锥体和灯光变换矩阵</li><li>确认物体是否在灯光视锥中产生阴影，并确认阴影落在了第几级的级联</li><li>分配CSM深度Target，但是在移动端会延迟分配的时机以便确认是否可以将聚光灯阴影与之结合</li></ol></font><h2 id="详细流程"><a class="markdownIt-Anchor" href="#详细流程"></a> 详细流程</h2><font size=3><ul><li><strong>1、</strong> <font color = #FFFF00>FMobileSceneRenderer</font>的<font color = #5555FF>Render</font>函数，是移动端渲染的主流程函数</li><li><strong>2、</strong> <font color = #5555FF>Render</font>函数中调用了<font color = #5555FF>InitViews</font>函数</li><li><strong>3、</strong> <font color = #5555FF>InitViews</font>函数调用了<font color = #5555FF>FMobileSceneRenderer::InitDynamicShadows</font>函数，为每一个View寻找可见的动态阴影，该函数又调用了<font color = #5555FF>FSceneRenderer::InitDynamicShadows</font></li><li><strong>4、</strong> <font color = #5555FF>InitDynamicShadows</font> 函数中<font color = #5555FF>AddViewDependentWholeSceneShadowsForView</font> 处理了CSM相关数据，该函数生成了指定灯光的所有wholesceneshadows的<font color = #FFFF00>FProjectedShadowInfo</font><ul><li><strong>4.1、</strong> 确认是否需要为View创建whole scene view dependent shadow</li><li><strong>4.2、</strong> <font color = #5555FF>GetNumViewDependentWholeSceneShadows</font> 函数确认级联的数量</li><li><strong>4.3、</strong> 根据级联数量开始对每一个级联进行处理<ul><li><strong>4.3.1、</strong> 声明<font color = #FFFF00>FWholeSceneProjectedShadowInitializer</font>类型的一个变量</li><li><strong>4.3.2、</strong> 通过<font color = #5555FF>GetViewDependentWholeSceneProjectedShadowInitializer</font>函数对上面那个变量填充其成员<ul><li><strong>4.3.2.1、</strong> <font color = #5555FF>GetShadowSplitBounds</font>计算该级联部分的视锥体的包围球<ul><li><strong>4.3.2.1.1、</strong> 通过神奇的方式算出来了这个球的中心和半径，得到了包围球</li><li><strong>4.3.2.1.2、</strong> 计算阴影裁剪体<font color = #5555FF>ComputeShadowCullingVolume</font><ul><li><strong>4.3.2.1.2.1、</strong> 计算出了一个凸多面体<br />该投影裁剪体在后续的<font color = #5555FF>GatherDynamicMeshElements</font> 的过程中有使用到</li></ul></li></ul></li></ul></li><li><strong>4.3.3、</strong> 创建投影阴影信息<ul><li><strong>4.3.3.1、</strong> 声明FProjectedShadowInfo变量</li><li><strong>4.3.3.2、</strong> 通过SetupWholeSceneProjection函数对上面那个变量进行成员填充，需要用到前面创建的FWholeSceneProjectedShadowInitializer<ul><li><strong>4.3.3.2.1、</strong> 填充了各种变量</li><li><strong>4.3.3.2.1、</strong> 通过神奇的方式更新了PreShadowTranslation，说是可以避免</li></ul></li></ul></li></ul></li></ul></li><li><strong>5、</strong> <font color = #5555FF>InitProjectedShadowVisibility</font>，计算投影阴影的可见性</li><li><strong>6、</strong> <font color = #5555FF>UpdatePreshadowCache</font>，清除旧的preshadows并尝试向缓存中添加新的</li><li><strong>7、</strong> <font color = #5555FF>GatherShadowPrimitives</font>，收集用于绘制各种阴影类型的图元列表</li><li><strong>8、</strong> <font color = #5555FF>AllocateShadowDepthTargets</font>，分配阴影深度渲染目标<ul><li><strong>8.1、</strong> 非移动端会在这里面调用<font color = #5555FF>AllocateCSMDepthTargets</font>，但是移动端会<font color = #FF0000>MobileWholeSceneDirectionalShadows</font>.Append(WholeSceneDirectionalShadows)延迟分配时机</li><li><strong>8.2、</strong> <font color = #5555FF>AllocateMobileCSMAndSpotLightShadowDepthTargets(RHICmdList, <font color = #FF0000>MobileWholeSceneDirectionalShadows</font>)</font>进行分配</li></ul></li><li><strong>9、</strong> <font color = #5555FF>GatherShadowDynamicMeshElements</font>，从阴影图元数组生成网格元素数组</li></ul></font><h1 id="源码学习"><a class="markdownIt-Anchor" href="#源码学习"></a> 源码学习</h1><h2 id="移动端渲染主函数"><a class="markdownIt-Anchor" href="#移动端渲染主函数"></a> 移动端渲染主函数</h2><p>那么我们首先来到移动端渲染代码的地方：FMobileSceneRenderer<br />位于SceneRendering.h文件中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// Renderer that implements simple forward shading and associated features.</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FMobileSceneRenderer</span> : <span class="hljs-keyword">public</span> FSceneRenderer<br>&#123;<br><span class="hljs-comment">// ....</span><br><br><span class="hljs-comment">//  Renders the view family. </span><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">Render</span><span class="hljs-params">(FRHICommandListImmediate&amp; RHICmdList)</span> <span class="hljs-keyword">override</span></span>;<br><br><span class="hljs-comment">// ....</span><br>&#125;<br></code></pre></td></tr></table></figure><p>那么我们直奔Render函数，看看里面都要干啥</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/** </span><br><span class="hljs-comment">* Renders the view family. </span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FMobileSceneRenderer::Render</span><span class="hljs-params">(FRHICommandListImmediate&amp; RHICmdList)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// Find the visible primitives and prepare targets and buffers for rendering</span><br><span class="hljs-built_in">InitViews</span>(RHICmdList);<br><br><span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="移动端initviews"><a class="markdownIt-Anchor" href="#移动端initviews"></a> 移动端InitViews</h2><p>别的步骤暂时略过，发现InitViews里处理了dynamic shadows：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-type">const</span> <span class="hljs-type">bool</span> bDynamicShadows = ViewFamily.EngineShowFlags.DynamicShadows;<br><br><span class="hljs-keyword">if</span> (bDynamicShadows &amp;&amp; !<span class="hljs-built_in">IsSimpleForwardShadingEnabled</span>(ShaderPlatform))<br>&#123;<br><span class="hljs-comment">// Setup dynamic shadows.</span><br><span class="hljs-built_in">InitDynamicShadows</span>(RHICmdList);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> only do this when CSM + static is required.</span><br><span class="hljs-built_in">PrepareViewVisibilityLists</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>看上面的意思就是，开启了动态阴影的选项，并且不是简单前向渲染的话，是要InitDynamicShadows的，那么本文的主要目标就出现了，着重看一下FMobileSceneRenderer::InitDynamicShadows</p><h2 id="移动端初始化动态阴影"><a class="markdownIt-Anchor" href="#移动端初始化动态阴影"></a> 移动端初始化动态阴影</h2><h3 id="移动端初始化动态阴影的函数"><a class="markdownIt-Anchor" href="#移动端初始化动态阴影的函数"></a> 移动端初始化动态阴影的函数</h3><p>FMobileSceneRenderer::InitDynamicShadows</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/** Finds the visible dynamic shadows for each view. */</span><br><span class="hljs-comment">// 查找每个视图的可见动态阴影。</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FMobileSceneRenderer::InitDynamicShadows</span><span class="hljs-params">(FRHICommandListImmediate&amp; RHICmdList)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// 这个值决定了Primitive是否可以接收CSM阴影 不等于0才可以</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span>* MyCVarMobileEnableStaticAndCSMShadowReceivers = IConsoleManager::<span class="hljs-built_in">Get</span>().<span class="hljs-built_in">FindTConsoleVariableDataInt</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;r.Mobile.EnableStaticAndCSMShadowReceivers&quot;</span>));<br><span class="hljs-type">const</span> <span class="hljs-type">bool</span> bCombinedStaticAndCSMEnabled = MyCVarMobileEnableStaticAndCSMShadowReceivers-&gt;<span class="hljs-built_in">GetValueOnRenderThread</span>()!=<span class="hljs-number">0</span>;<br><span class="hljs-comment">// 这个值，开启的时候，被可移动方向光的Primitive，只有当Primitive确定在CSM的范围里的时候，才会通过CSM Shader来进行渲染</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">auto</span>* CVarMobileEnableMovableLightCSMShaderCulling = IConsoleManager::<span class="hljs-built_in">Get</span>().<span class="hljs-built_in">FindTConsoleVariableDataInt</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;r.Mobile.EnableMovableLightCSMShaderCulling&quot;</span>));<br><span class="hljs-type">const</span> <span class="hljs-type">bool</span> bMobileEnableMovableLightCSMShaderCulling = CVarMobileEnableMovableLightCSMShaderCulling-&gt;<span class="hljs-built_in">GetValueOnRenderThread</span>() == <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">// initialize CSMVisibilityInfo for each eligible light.</span><br><span class="hljs-comment">// 为每一个符合条件的灯光初始化CSMVisibilityInfo</span><br><span class="hljs-comment">// Scene-&gt;MobileDirectionalLights 对于移动端，是每个照明通道中的第一个平行光。</span><br><span class="hljs-keyword">for</span> (FLightSceneInfo* MobileDirectionalLightSceneInfo : Scene-&gt;MobileDirectionalLights)<br>&#123;<br><span class="hljs-type">const</span> FLightSceneProxy* LightSceneProxy = MobileDirectionalLightSceneInfo ? MobileDirectionalLightSceneInfo-&gt;Proxy : <span class="hljs-literal">nullptr</span>;<br><span class="hljs-keyword">if</span> (LightSceneProxy)<br>&#123;<br><span class="hljs-comment">// UseCSMForDynamicObjects 此灯光是否应仅为动态对象创建CSM</span><br><span class="hljs-comment">// Primitive可以接收CSM阴影 且 灯光仅为动态对象创建CSM</span><br><span class="hljs-type">bool</span> bLightHasCombinedStaticAndCSMEnabled = bCombinedStaticAndCSMEnabled &amp;&amp; LightSceneProxy-&gt;<span class="hljs-built_in">UseCSMForDynamicObjects</span>();<br><span class="hljs-comment">// CSM开了剔除 且 光源是可移动的 且 需要渲染阴影（ShouldRenderViewIndependentWholeSceneShadows</span><br><span class="hljs-type">bool</span> bMovableLightUsingCSM = bMobileEnableMovableLightCSMShaderCulling &amp;&amp; LightSceneProxy-&gt;<span class="hljs-built_in">IsMovable</span>() &amp;&amp; MobileDirectionalLightSceneInfo-&gt;<span class="hljs-built_in">ShouldRenderViewIndependentWholeSceneShadows</span>();<br><br><span class="hljs-comment">// 上面两个满足一个</span><br><span class="hljs-keyword">if</span> (bLightHasCombinedStaticAndCSMEnabled || bMovableLightUsingCSM)<br>&#123;<br><span class="hljs-comment">// Scene里的图元数量</span><br>int32 PrimitiveCount = Scene-&gt;Primitives.<span class="hljs-built_in">Num</span>();<br><span class="hljs-comment">// Views 是FSceneRenderer的成员变量 正在渲染的视图</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; View : Views)<br>&#123;<br><span class="hljs-comment">// TArray&lt;FVisibleLightViewInfo&gt; VisibleLightInfos; 从灯光ID到可见性的映射</span><br><span class="hljs-comment">// FVisibleLightViewInfo 是 （可见光在其特定的可见视图里的）可见光的信息</span><br><span class="hljs-comment">// MobileDirectionalLightSceneInfo-&gt;Id // int32 Id; // 如果bVisible==true，则这是“Scene-&gt;PrimitiveOctree”中primitive的索引。</span><br>FMobileCSMSubjectPrimitives&amp; MobileCSMSubjectPrimitives = View.VisibleLightInfos[MobileDirectionalLightSceneInfo-&gt;Id].MobileCSMSubjectPrimitives;<br><span class="hljs-comment">// MobileCSMSubjectPrimitives 是FMobileCSMSubjectPrimitives</span><br><span class="hljs-comment">// FMobileCSMSubjectPrimitives 是 CSM投影体的列表 被移动端渲染器用来剔除（接受静态和CSM阴影的）图元</span><br>MobileCSMSubjectPrimitives.<span class="hljs-built_in">InitShadowSubjectPrimitives</span>(PrimitiveCount);<br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-comment">// 上面这个循环对场景中的移动端方向光进行遍历，对符合CSM条件的灯光，遍历所有View，初始化每一个view中可见灯光信息里该平行光的CSM投影体的列表，这个列表保存在View的VisibleLightInfos的对应灯光ID的对象的MobileCSMSubjectPrimitives变量里</span><br><br><span class="hljs-comment">// 调用公共的初始化动态阴影的函数，这个跳到下面去看</span><br>FSceneRenderer::<span class="hljs-built_in">InitDynamicShadows</span>(RHICmdList, DynamicIndexBuffer, DynamicVertexBuffer, DynamicReadBuffer);<br><br><span class="hljs-built_in">PrepareViewVisibilityLists</span>();<br><br><span class="hljs-type">bool</span> bAlwaysUseCSM = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">for</span> (FLightSceneInfo* MobileDirectionalLightSceneInfo : Scene-&gt;MobileDirectionalLights)<br>&#123;<br><span class="hljs-type">const</span> FLightSceneProxy* LightSceneProxy = MobileDirectionalLightSceneInfo ? MobileDirectionalLightSceneInfo-&gt;Proxy : <span class="hljs-literal">nullptr</span>;<br><span class="hljs-keyword">if</span> (LightSceneProxy)<br>&#123;<br><span class="hljs-type">bool</span> bLightHasCombinedStaticAndCSMEnabled = bCombinedStaticAndCSMEnabled &amp;&amp; LightSceneProxy-&gt;<span class="hljs-built_in">UseCSMForDynamicObjects</span>();<br><span class="hljs-type">bool</span> bMovableLightUsingCSM = bMobileEnableMovableLightCSMShaderCulling &amp;&amp; LightSceneProxy-&gt;<span class="hljs-built_in">IsMovable</span>() &amp;&amp; MobileDirectionalLightSceneInfo-&gt;<span class="hljs-built_in">ShouldRenderViewIndependentWholeSceneShadows</span>();<br><br><span class="hljs-comment">// non-csm culling movable light will force all draws to use CSM shaders.</span><br><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Cases in which a light channel uses a shadow casting non-csm culled movable light we only really need to use CSM on primitives that match the light channel.</span><br>bAlwaysUseCSM = bAlwaysUseCSM || (!bMobileEnableMovableLightCSMShaderCulling &amp;&amp; LightSceneProxy-&gt;<span class="hljs-built_in">IsMovable</span>() &amp;&amp; MobileDirectionalLightSceneInfo-&gt;<span class="hljs-built_in">ShouldRenderViewIndependentWholeSceneShadows</span>());<br><span class="hljs-keyword">if</span> (bLightHasCombinedStaticAndCSMEnabled || bMovableLightUsingCSM)<br>&#123;<br><span class="hljs-built_in">BuildCSMVisibilityState</span>(MobileDirectionalLightSceneInfo);<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; View : Views)<br>&#123;<br>FMobileCSMVisibilityInfo&amp; MobileCSMVisibilityInfo = View.MobileCSMVisibilityInfo;<br>MobileCSMVisibilityInfo.bAlwaysUseCSM = bAlwaysUseCSM;<br>&#125;<br><br>&#123;<br><span class="hljs-comment">// Check for modulated shadows. </span><br>bModulatedShadowsInUse = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">for</span> (TSparseArray&lt;FLightSceneInfoCompact&gt;::TConstIterator <span class="hljs-built_in">LightIt</span>(Scene-&gt;Lights); LightIt &amp;&amp; bModulatedShadowsInUse == <span class="hljs-literal">false</span>; ++LightIt)<br>&#123;<br><span class="hljs-type">const</span> FLightSceneInfoCompact&amp; LightSceneInfoCompact = *LightIt;<br>FLightSceneInfo* LightSceneInfo = LightSceneInfoCompact.LightSceneInfo;<br>FVisibleLightInfo&amp; VisibleLightInfo = VisibleLightInfos[LightSceneInfo-&gt;Id];<br><span class="hljs-comment">// Mobile renderer only projects modulated shadows.</span><br>bModulatedShadowsInUse = VisibleLightInfo.ShadowsToProject.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="不同scene可以共用的初始化动态阴影的部分"><a class="markdownIt-Anchor" href="#不同scene可以共用的初始化动态阴影的部分"></a> 不同Scene可以共用的初始化动态阴影的部分</h3><p>FSceneRenderer::InitDynamicShadows</p><p><span id="FSceneRenderer::InitDynamicShadows"><strong>FSceneRenderer::InitDynamicShadows</strong></span></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FSceneRenderer::InitDynamicShadows</span><span class="hljs-params">(FRHICommandListImmediate&amp; RHICmdList, FGlobalDynamicIndexBuffer&amp; DynamicIndexBuffer, FGlobalDynamicVertexBuffer&amp; DynamicVertexBuffer, FGlobalDynamicReadBuffer&amp; DynamicReadBuffer)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// ... 省略部分源码</span><br><br><span class="hljs-comment">// 确认是否为移动端</span><br><span class="hljs-type">const</span> <span class="hljs-type">bool</span> bMobile = FeatureLevel &lt; ERHIFeatureLevel::SM5;<br><br>&#123;<br><span class="hljs-comment">// ... 省略部分源码</span><br><span class="hljs-keyword">for</span> (TSparseArray&lt;FLightSceneInfoCompact&gt;::TConstIterator <span class="hljs-built_in">LightIt</span>(Scene-&gt;Lights); LightIt; ++LightIt)<br>&#123;<br><span class="hljs-comment">// ... 省略部分源码</span><br><br><span class="hljs-comment">// Only consider lights that may have shadows.</span><br><span class="hljs-comment">// 只考虑生成阴影的灯光</span><br><span class="hljs-keyword">if</span> ((LightSceneInfoCompact.bCastStaticShadow || LightSceneInfoCompact.bCastDynamicShadow) &amp;&amp; <span class="hljs-built_in">GetShadowQuality</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br><span class="hljs-comment">// see if the light is visible in any view</span><br><span class="hljs-comment">// 该灯光是不是在某一个view中可见</span><br><span class="hljs-type">bool</span> bIsVisibleInAnyView = <span class="hljs-literal">false</span>;<br><br><span class="hljs-comment">// ... 省略部分源码</span><br><span class="hljs-keyword">if</span> (bIsVisibleInAnyView)<br>&#123;<br><span class="hljs-comment">// 可以创建任何一种阴影的话</span><br><span class="hljs-comment">// 移动端运行时不存在</span><br><span class="hljs-keyword">if</span> (bCreateShadowForMovableLight || bCreateShadowToPreviewStaticLight || bCreateShadowForOverflowStaticShadowing)<br>&#123;<br><span class="hljs-comment">// Try to create a whole scene projected shadow.</span><br><span class="hljs-comment">// 试图去创建全场景投影阴影</span><br><span class="hljs-built_in">CreateWholeSceneProjectedShadow</span>(LightSceneInfo, NumPointShadowCachesUpdatedThisFrame, NumSpotShadowCachesUpdatedThisFrame);<br>&#125;<br><br><span class="hljs-comment">// Allow movable and stationary lights to create CSM, or static lights that are unbuilt</span><br><span class="hljs-comment">// 允许可移动光源和定向光源或者是没有build灯光的静态光源创建CSM</span><br><span class="hljs-comment">// 没有build灯光的静态光源创建是为了预览</span><br><span class="hljs-keyword">if</span> ((!LightSceneInfo-&gt;Proxy-&gt;<span class="hljs-built_in">HasStaticLighting</span>() &amp;&amp; LightSceneInfoCompact.bCastDynamicShadow) || bCreateShadowToPreviewStaticLight)<br>&#123;<br><span class="hljs-comment">// ...</span><br><span class="hljs-comment">// 对于移动端来讲 !bMobile肯定是false了</span><br><span class="hljs-comment">// LightSceneInfo-&gt;Proxy-&gt;UseCSMForDynamicObjects() 是true，因为要用CSM</span><br><span class="hljs-comment">// 至少有一个true 可以进入AddViewDependentWholeSceneShadowsForView</span><br><span class="hljs-keyword">if</span>( !bMobile ||<br>((LightSceneInfo-&gt;Proxy-&gt;<span class="hljs-built_in">UseCSMForDynamicObjects</span>() || LightSceneInfo-&gt;Proxy-&gt;<span class="hljs-built_in">IsMovable</span>()) <br><span class="hljs-comment">// Mobile uses the scene&#x27;s MobileDirectionalLights only for whole scene shadows.</span><br><span class="hljs-comment">// 移动端仅对整个场景阴影使用场景的MobileDirectionalLights</span><br>&amp;&amp; (LightSceneInfo == Scene-&gt;MobileDirectionalLights[<span class="hljs-number">0</span>] || LightSceneInfo == Scene-&gt;MobileDirectionalLights[<span class="hljs-number">1</span>] || LightSceneInfo == Scene-&gt;MobileDirectionalLights[<span class="hljs-number">2</span>])))<br>&#123;<br><span class="hljs-comment">// 跳下去看一下这个</span><br><span class="hljs-comment">// 收集了CSM相关的数据</span><br><span class="hljs-built_in">AddViewDependentWholeSceneShadowsForView</span>(ViewDependentWholeSceneShadows, ViewDependentWholeSceneShadowsThatNeedCulling, VisibleLightInfo, *LightSceneInfo);<br>&#125;<br><br><span class="hljs-comment">// ...</span><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// ...</span><br><span class="hljs-comment">// Calculate visibility of the projected shadows.</span><br><span class="hljs-built_in">InitProjectedShadowVisibility</span>(RHICmdList);<br>&#125;<br><br><span class="hljs-comment">// Clear old preshadows and attempt to add new ones to the cache</span><br><span class="hljs-built_in">UpdatePreshadowCache</span>(FSceneRenderTargets::<span class="hljs-built_in">Get</span>(RHICmdList));<br><br><span class="hljs-comment">// Gathers the list of primitives used to draw various shadow types</span><br><span class="hljs-built_in">GatherShadowPrimitives</span>(PreShadows, ViewDependentWholeSceneShadowsThatNeedCulling, bStaticSceneOnly);<br><br><span class="hljs-built_in">AllocateShadowDepthTargets</span>(RHICmdList);<br><br><span class="hljs-comment">// Generate mesh element arrays from shadow primitive arrays</span><br><span class="hljs-built_in">GatherShadowDynamicMeshElements</span>(DynamicIndexBuffer, DynamicVertexBuffer, DynamicReadBuffer);<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="为当前view添加全场景阴影信息"><a class="markdownIt-Anchor" href="#为当前view添加全场景阴影信息"></a> 为当前View添加全场景阴影信息</h3><p>FSceneRenderer::AddViewDependentWholeSceneShadowsForView<br />收集CSM相关的数据</p><ol><li>创建了ProjectedShadowInitializer</li><li>用ProjectedShadowInitializer创建了ProjectedShadowInfo</li><li>将ProjectedShadowInfo保存到了InitDynamicShadows函数里的局部变量VisibleLightInfo和ViewDependentWholeSceneShadows中</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">//</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FSceneRenderer::AddViewDependentWholeSceneShadowsForView</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">TArray&lt;FProjectedShadowInfo*, SceneRenderingAllocator&gt;&amp; ShadowInfos, </span></span><br><span class="hljs-params"><span class="hljs-function">TArray&lt;FProjectedShadowInfo*, SceneRenderingAllocator&gt;&amp; ShadowInfosThatNeedCulling,</span></span><br><span class="hljs-params"><span class="hljs-function">FVisibleLightInfo&amp; VisibleLightInfo, </span></span><br><span class="hljs-params"><span class="hljs-function">FLightSceneInfo&amp; LightSceneInfo)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// Allow each view to create a whole scene view dependent shadow</span><br><span class="hljs-comment">// 允许每一个view去创建一个 whole scene view dependent shadow（CSM是Whole Scene Shadow的一种）</span><br><span class="hljs-comment">// 我们项目的战斗场景中view数量为1</span><br><span class="hljs-keyword">for</span> (int32 ViewIndex = <span class="hljs-number">0</span>; ViewIndex &lt; Views.<span class="hljs-built_in">Num</span>(); ViewIndex++)<br>&#123;<br><span class="hljs-comment">// 取到对应ViewInfo</span><br>FViewInfo&amp; View = Views[ViewIndex];<br><br><span class="hljs-comment">// FLightSceneProxy -&gt; ShadowAmount // 控制阴影遮挡量</span><br><span class="hljs-comment">// 是1</span><br><span class="hljs-type">const</span> <span class="hljs-type">float</span> LightShadowAmount = LightSceneInfo.Proxy-&gt;<span class="hljs-built_in">GetShadowAmount</span>();<br>TArray&lt;<span class="hljs-type">float</span>, TInlineAllocator&lt;<span class="hljs-number">2</span>&gt; &gt; FadeAlphas;<br>FadeAlphas.<span class="hljs-built_in">Init</span>(<span class="hljs-number">0.0f</span>, Views.<span class="hljs-built_in">Num</span>());<br><span class="hljs-comment">// ViewIndex 0 的FadeAlphas 是 1</span><br>FadeAlphas[ViewIndex] = LightShadowAmount;<br><br><span class="hljs-comment">// 在只有一个view的时候下方循环没有意义 暂时跳过不管</span><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// If rendering in stereo mode we render shadow depths only for the left eye, but project for both eyes!</span><br><span class="hljs-comment">// 如果是在立体声模式渲染，只对左眼渲染阴影深度但是会对两只眼睛都进行投影 ？？？</span><br><span class="hljs-keyword">if</span> (IStereoRendering::<span class="hljs-built_in">IsAPrimaryView</span>(View))<br>&#123;<br><span class="hljs-comment">// 这个在我们移动端一看就是false啊</span><br><span class="hljs-type">const</span> <span class="hljs-type">bool</span> bExtraDistanceFieldCascade = LightSceneInfo.<span class="hljs-built_in">ShouldRenderLightViewIndependent</span>()<br>&amp;&amp; LightSceneInfo.Proxy-&gt;<span class="hljs-built_in">ShouldCreateRayTracedCascade</span>(View.<span class="hljs-built_in">GetFeatureLevel</span>(), LightSceneInfo.<span class="hljs-built_in">IsPrecomputedLightingValid</span>(), View.MaxShadowCascades);<br><br><span class="hljs-comment">// 这个那还是1</span><br><span class="hljs-type">const</span> int32 ProjectionCount = LightSceneInfo.Proxy-&gt;<span class="hljs-built_in">GetNumViewDependentWholeSceneShadows</span>(View, LightSceneInfo.<span class="hljs-built_in">IsPrecomputedLightingValid</span>()) + (bExtraDistanceFieldCascade?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// ...</span><br><br>FSceneRenderTargets&amp; SceneContext_ConstantsOnly = FSceneRenderTargets::<span class="hljs-built_in">Get_FrameConstantsOnly</span>();<br><br><br><span class="hljs-comment">// todo: this code can be simplified by computing all the distances in one place - avoiding some redundant work and complexity</span><br><span class="hljs-comment">// UE 还没干的事情  通过在一个地方计算所有距离，可以简化此代码 避免一些冗余工作和复杂性</span><br><span class="hljs-comment">// 看了一眼5.0还是没做 再议</span><br><span class="hljs-keyword">for</span> (int32 Index = <span class="hljs-number">0</span>; Index &lt; ProjectionCount; Index++)<br>&#123;<br><span class="hljs-comment">// 声明了一个WholeSceneProjectedShadow的初始化器</span><br>FWholeSceneProjectedShadowInitializer ProjectedShadowInitializer;<br><br><span class="hljs-comment">// 0</span><br>int32 LocalIndex = Index;<br><br><span class="hljs-comment">// Indexing like this puts the ray traced shadow cascade last (might not be needed)</span><br><span class="hljs-comment">// bExtraDistanceFieldCascade是false</span><br><span class="hljs-keyword">if</span>(bExtraDistanceFieldCascade &amp;&amp; LocalIndex + <span class="hljs-number">1</span> == ProjectionCount)<br>&#123;<br>LocalIndex = INDEX_NONE;<br>&#125;<br><br><span class="hljs-comment">// 通过GetViewDependentWholeSceneProjectedShadowInitializer去填充WholeSceneProjectedShadow的初始化器的相关成员</span><br><span class="hljs-comment">// 跳到下面看FWholeSceneProjectedShadowInitializer是什么</span><br><span class="hljs-comment">// 跳到下面看GetViewDependentWholeSceneProjectedShadowInitializer干了什么</span><br><span class="hljs-comment">// 简单总结一下这个函数里都干了什么：</span><br><span class="hljs-comment">// 1. 通过视口摄像机的远近平面的八个点创建了一个包围球</span><br><span class="hljs-comment">// 2. 填充了ProjectedShadowInitializer的各项属性，其中有些值和1里的包围球的值有关</span><br><span class="hljs-keyword">if</span> (LightSceneInfo.Proxy-&gt;<span class="hljs-built_in">GetViewDependentWholeSceneProjectedShadowInitializer</span>(View, LocalIndex, LightSceneInfo.<span class="hljs-built_in">IsPrecomputedLightingValid</span>(), ProjectedShadowInitializer))<br>&#123;<br><span class="hljs-comment">// ShadowBuffer分辨率</span><br><span class="hljs-function"><span class="hljs-type">const</span> FIntPoint <span class="hljs-title">ShadowBufferResolution</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">FMath::Clamp(GetCachedScalabilityCVars().MaxCSMShadowResolution, <span class="hljs-number">1</span>, (int32)GMaxShadowDepthBufferSizeX),</span></span><br><span class="hljs-params"><span class="hljs-function">FMath::Clamp(GetCachedScalabilityCVars().MaxCSMShadowResolution, <span class="hljs-number">1</span>, (int32)GMaxShadowDepthBufferSizeY))</span></span>;<br><br><span class="hljs-comment">// Create the projected shadow info.</span><br><span class="hljs-comment">// 创建投影阴影信息对象</span><br>FProjectedShadowInfo* ProjectedShadowInfo = <span class="hljs-built_in">new</span>(FMemStack::<span class="hljs-built_in">Get</span>(), <span class="hljs-number">1</span>, <span class="hljs-number">16</span>) FProjectedShadowInfo;<br><br><span class="hljs-comment">// ES31小于 是0</span><br>uint32 ShadowBorder = <span class="hljs-built_in">NeedsUnatlasedCSMDepthsWorkaround</span>(FeatureLevel) ? <span class="hljs-number">0</span> : SHADOW_BORDER;<br><br><span class="hljs-comment">// 给ProjectedShadowInfo对象填充信息</span><br>ProjectedShadowInfo-&gt;<span class="hljs-built_in">SetupWholeSceneProjection</span>(<br>&amp;LightSceneInfo,<br>&amp;View,<br>ProjectedShadowInitializer,<br>ShadowBufferResolution.X - ShadowBorder * <span class="hljs-number">2</span>,<br>ShadowBufferResolution.Y - ShadowBorder * <span class="hljs-number">2</span>,<br>ShadowBorder,<br><span class="hljs-literal">false</span><span class="hljs-comment">// no RSM</span><br>);<br><br><span class="hljs-comment">// 是1</span><br>ProjectedShadowInfo-&gt;FadeAlphas = FadeAlphas;<br><span class="hljs-comment">// 填充完了ProjectedShadowInfo的各种信息</span><br><br>FVisibleLightInfo&amp; LightViewInfo = VisibleLightInfos[LightSceneInfo.Id];<br><span class="hljs-comment">// 将填充完了的投影阴影信息添加到了这几个地方</span><br>VisibleLightInfo.MemStackProjectedShadows.<span class="hljs-built_in">Add</span>(ProjectedShadowInfo);<br>VisibleLightInfo.AllProjectedShadows.<span class="hljs-built_in">Add</span>(ProjectedShadowInfo);<br>ShadowInfos.<span class="hljs-built_in">Add</span>(ProjectedShadowInfo);<br><br><span class="hljs-comment">// ...</span><br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 下面这部分在移动端相当于没有，暂时略过</span><br>FSceneViewState* ViewState = (FSceneViewState*)View.State;<br><span class="hljs-keyword">if</span> (ViewState)<br>&#123;<br><span class="hljs-comment">// 移动端ES是NULL</span><br>FLightPropagationVolume* LightPropagationVolume = ViewState-&gt;<span class="hljs-built_in">GetLightPropagationVolume</span>(View.<span class="hljs-built_in">GetFeatureLevel</span>());<br><br><span class="hljs-type">float</span> LPVIntensity = <span class="hljs-number">0.f</span>;<br><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// ...</span><br>&#125;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="设置投影阴影初始化器"><a class="markdownIt-Anchor" href="#设置投影阴影初始化器"></a> 设置投影阴影初始化器</h4><ol><li>就是那个每个级联的SplitNear和SplitFar，就是分割级联，这个是在计算包围球的时候才计算的，具体计算方法是GetSplitDistance</li><li>计算了每个级联的外界包围球，具体方法是GetShadowSplitBounds</li><li>计算了这个球的内接盒</li><li>在计算包围球的同时计算了阴影裁剪体</li></ol><p><span id="GetViewDependentWholeSceneProjectedShadowInitializer"><strong>GetViewDependentWholeSceneProjectedShadowInitializer</strong></span></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * Sets up a projected shadow initializer that&#x27;s dependent on the current view for shadows from the entire scene.</span><br><span class="hljs-comment">    设置投影阴影初始化器，该初始化器依赖于整个场景中阴影的当前视图。</span><br><span class="hljs-comment">    * @param InCascadeIndex ShadowSplitIndex or INDEX_NONE for the the DistanceFieldCascade</span><br><span class="hljs-comment">    * @return True if the whole-scene projected shadow should be used.</span><br><span class="hljs-comment">    如果应使用整个场景投影阴影，则返回True。</span><br><span class="hljs-comment">    */</span><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">GetViewDependentWholeSceneProjectedShadowInitializer</span><span class="hljs-params">(<span class="hljs-type">const</span> FSceneView&amp; View, int32 InCascadeIndex, <span class="hljs-type">bool</span> bPrecomputedLightingIsValid, FWholeSceneProjectedShadowInitializer&amp; OutInitializer)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// false</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">bool</span> bRayTracedCascade = (InCascadeIndex == INDEX_NONE);<br><br>    <span class="hljs-comment">// 根据摄像机的远近平面的八个点生成了一个包围球</span><br>    FSphere Bounds = FDirectionalLightSceneProxy::<span class="hljs-built_in">GetShadowSplitBounds</span>(View, InCascadeIndex, bPrecomputedLightingIsValid, &amp;OutInitializer.CascadeSettings);<br><br>    <span class="hljs-comment">// 还没具体看</span><br>    <span class="hljs-comment">// 简单看了一下这个函数的返回值 return FMath::Min&lt;int32&gt;(NumCascades, MaxShadowCascades);</span><br>    <span class="hljs-comment">// MaxShadowCascades是View.MaxShadowCascades 要渲染的最大阴影级联数</span><br>    <span class="hljs-comment">// </span><br>    uint32 NumNearCascades = <span class="hljs-built_in">GetNumShadowMappedCascades</span>(View.MaxShadowCascades, bPrecomputedLightingIsValid);<br><br>    <span class="hljs-comment">// Last cascade is the ray traced shadow, if enabled</span><br>    <span class="hljs-comment">// ShadowSplitIndex是级联阴影分割视锥的索引，是传进来的参数，如果是ray traced shadow的话必须是上面获得的NumNearCascades，就是得是最后一个</span><br>    OutInitializer.CascadeSettings.ShadowSplitIndex = bRayTracedCascade ? NumNearCascades : InCascadeIndex;<br><br>    <span class="hljs-comment">// 虽然不知道为啥，用前面算出来的球的半径除以根号3</span><br><span class="hljs-comment">// 是Box边长的一半，是神奇的计算方法</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> ShadowExtent = Bounds.W / FMath::<span class="hljs-built_in">Sqrt</span>(<span class="hljs-number">3.0f</span>);<br><br>    <span class="hljs-comment">// 这里定义了一个FBoxSphereBounds的对象</span><br>    <span class="hljs-comment">// FBoxSphereBounds就是保存了包围球和包围盒的属性信息，原点，上面算出来的Extent，以及球的半径</span><br><span class="hljs-comment">// 往后看了一下- -这里这个FBoxSphereBounds就是存了一下算出来的包围球的Origin、半径、半径除以根号3的值组成的FVector，之后用到这三个值的地方都从这个对象取值</span><br>    <span class="hljs-function"><span class="hljs-type">const</span> FBoxSphereBounds <span class="hljs-title">SubjectBounds</span><span class="hljs-params">(Bounds.Center, FVector(ShadowExtent, ShadowExtent, ShadowExtent), Bounds.W)</span></span>;<br><br><span class="hljs-comment">// FVector</span><br>    <span class="hljs-comment">// A translation that is applied to world-space before transforming by one of the shadow matrices.</span><br>    <span class="hljs-comment">// 无情机翻：在通过一个阴影矩阵进行变换之前应用于世界空间的变换。</span><br>    <span class="hljs-comment">// 通过一个阴影矩阵进行变化之前，被应用于世界空间的，一个，translation？平移</span><br>    <span class="hljs-comment">// 为啥把包围球的中心点取了个反？</span><br>    OutInitializer.PreShadowTranslation = -Bounds.Center;<br><br><span class="hljs-comment">// FMatrix</span><br>    <span class="hljs-comment">// 世界空间转光照空间的矩阵</span><br><span class="hljs-comment">// 等价于灯光旋转矩阵的逆矩阵</span><br>    OutInitializer.WorldToLight = <span class="hljs-built_in">FInverseRotationMatrix</span>(<span class="hljs-built_in">GetDirection</span>().<span class="hljs-built_in">GetSafeNormal</span>().<span class="hljs-built_in">Rotation</span>());<br><br><span class="hljs-comment">// FVector</span><br>    <span class="hljs-comment">// Non-uniform scale to be applied after WorldToLight.</span><br>    <span class="hljs-comment">// 无情机翻：WorldToLight之后应用的非均匀比例</span><br>    OutInitializer.Scales = <span class="hljs-built_in">FVector</span>(<span class="hljs-number">1.0f</span>,<span class="hljs-number">1.0f</span> / Bounds.W,<span class="hljs-number">1.0f</span> / Bounds.W);<br><br><span class="hljs-comment">// FVector</span><br>    <span class="hljs-comment">// 注释都没有！</span><br>    OutInitializer.FaceDirection = <span class="hljs-built_in">FVector</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// FBoxSphereBounds</span><br>    <span class="hljs-comment">// 连个注释都没有！</span><br>    <span class="hljs-comment">// 原点改成0了</span><br>    OutInitializer.SubjectBounds = <span class="hljs-built_in">FBoxSphereBounds</span>(FVector::ZeroVector, SubjectBounds.BoxExtent, SubjectBounds.SphereRadius);<br><br><span class="hljs-comment">// FVector4</span><br>    <span class="hljs-comment">// 连个注释都没有！</span><br>    OutInitializer.WAxis = <span class="hljs-built_in">FVector4</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);<br><br><span class="hljs-comment">// float</span><br>    <span class="hljs-comment">// 连个注释都没有！</span><br>    <span class="hljs-comment">// Use the minimum of half the world, things further away do not cast shadows,</span><br>    <span class="hljs-comment">// However, if the cascade bounds are larger, then extend the casting distance far enough to encompass the cascade.</span><br>    <span class="hljs-comment">// 使用半个世界的最小值，更远的物体不会投射阴影，但是，如果层叠边界更大，则将投射距离延伸到足以覆盖层叠的程度。</span><br><span class="hljs-comment">// #define WORLD_MAX2097152.0/* Maximum size of the world */</span><br><span class="hljs-comment">// #define HALF_WORLD_MAX(WORLD_MAX * 0.5)/* Half the maximum size of the world */</span><br><span class="hljs-comment">// 包围球半径的负值和世界最小尺寸的一半，两者取较小的，就是不能比世界最大尺寸的一半的负值还要小，那就不在世界内了</span><br>    OutInitializer.MinLightW = FMath::<span class="hljs-built_in">Min</span>&lt;<span class="hljs-type">float</span>&gt;(-HALF_WORLD_MAX, -SubjectBounds.SphereRadius);<br><br>    <span class="hljs-comment">// Range must extend to end of cascade bounds</span><br>    <span class="hljs-comment">// 范围必须扩展到级联边界的末尾</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> MaxLightW = SubjectBounds.SphereRadius;<br><br><span class="hljs-comment">// float</span><br>    <span class="hljs-comment">// 连个注释都没有！</span><br><span class="hljs-comment">// MinLightW是负的包围球半径，MaxLightW是正的包围球半径，就是求出来一个包围球直径</span><br><span class="hljs-comment">// 如果球的半径大于了世界最大尺寸的一半的时候，这个MaxDistanceToCastInLightW是比世界尺寸要大的？</span><br>    OutInitializer.MaxDistanceToCastInLightW = MaxLightW - OutInitializer.MinLightW;<br>    <span class="hljs-comment">// 那移动端肯定是false啊</span><br>    OutInitializer.bRayTracedDistanceField = bRayTracedCascade;<br>    <span class="hljs-comment">//  When enabled, the cascade only renders objects marked with bCastFarShadows enabled (e.g. Landscape).</span><br>    <span class="hljs-comment">// 启用时，级联仅渲染标记为已启用bCastFarShadows的对象（例如，Landscape）。</span><br>    OutInitializer.CascadeSettings.bFarShadowCascade = !bRayTracedCascade &amp;&amp; OutInitializer.CascadeSettings.ShadowSplitIndex &gt;= (int32)NumNearCascades;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="生成投影阴影的信息"><a class="markdownIt-Anchor" href="#生成投影阴影的信息"></a> 生成投影阴影的信息</h4><p><span id="SetupWholeSceneProjection"><strong>SetupWholeSceneProjection</strong></span></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// ShadowSetup.cpp</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FProjectedShadowInfo::SetupWholeSceneProjection</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">FLightSceneInfo* InLightSceneInfo,</span></span><br><span class="hljs-params"><span class="hljs-function">FViewInfo* InDependentView,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">const</span> FWholeSceneProjectedShadowInitializer&amp; Initializer,</span></span><br><span class="hljs-params"><span class="hljs-function">uint32 InResolutionX,</span></span><br><span class="hljs-params"><span class="hljs-function">uint32 InResolutionY,</span></span><br><span class="hljs-params"><span class="hljs-function">uint32 InBorderSize,</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-type">bool</span> bInReflectiveShadowMap)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// 从这里开始进行了一系列的变量赋值</span><br><span class="hljs-comment">// FLightSceneInfo</span><br>LightSceneInfo = InLightSceneInfo;<br><span class="hljs-comment">// FLightSceneInfoCompact</span><br>LightSceneInfoCompact = InLightSceneInfo;<br><span class="hljs-comment">// FViewInfo</span><br>DependentView = InDependentView;<br><span class="hljs-comment">// FVector</span><br>PreShadowTranslation = Initializer.PreShadowTranslation;<br><span class="hljs-comment">// FShadowCascadeSettings</span><br>CascadeSettings = Initializer.CascadeSettings;<br><span class="hljs-comment">// </span><br>ResolutionX = InResolutionX;<br>ResolutionY = InResolutionY;<br><span class="hljs-comment">//</span><br>bDirectionalLight = InLightSceneInfo-&gt;Proxy-&gt;<span class="hljs-built_in">GetLightType</span>() == LightType_Directional;<br>bOnePassPointLightShadow = Initializer.bOnePassPointLightShadow;<br>bRayTracedDistanceField = Initializer.bRayTracedDistanceField;<br>bWholeSceneShadow = <span class="hljs-literal">true</span>;<br>bTransmission = InLightSceneInfo-&gt;Proxy-&gt;<span class="hljs-built_in">Transmission</span>();<br>bHairStrandsDeepShadow = InLightSceneInfo-&gt;Proxy-&gt;<span class="hljs-built_in">CastsHairStrandsDeepShadow</span>();<br><span class="hljs-comment">// mobile 所以 false</span><br>bReflectiveShadowmap = bInReflectiveShadowMap; <br><span class="hljs-comment">// 居然是0耶</span><br>BorderSize = InBorderSize;<br><br>FVectorXAxis, YAxis;<br>Initializer.FaceDirection.<span class="hljs-built_in">FindBestAxisVectors</span>(XAxis,YAxis);<br><span class="hljs-comment">// 从世界空间转换到灯光视图空间的矩阵</span><br><span class="hljs-comment">// 都是在FWholeSceneProjectedShadowInitializer中计算过的</span><br><span class="hljs-type">const</span> FMatrix WorldToLightScaled = Initializer.WorldToLight * <span class="hljs-built_in">FScaleMatrix</span>(Initializer.Scales);<br><span class="hljs-type">const</span> FMatrix WorldToFace = WorldToLightScaled * <span class="hljs-built_in">FBasisVectorMatrix</span>(-XAxis,YAxis,Initializer.FaceDirection.<span class="hljs-built_in">GetSafeNormal</span>(),FVector::ZeroVector);<br><br>MaxSubjectZ = WorldToFace.<span class="hljs-built_in">TransformPosition</span>(Initializer.SubjectBounds.Origin).Z + Initializer.SubjectBounds.SphereRadius;<br>MinSubjectZ = FMath::<span class="hljs-built_in">Max</span>(MaxSubjectZ - Initializer.SubjectBounds.SphereRadius * <span class="hljs-number">2</span>,Initializer.MinLightW);<br><br><span class="hljs-comment">// 这次看的是从Mobile管线过来的 这个是false 没有RSM</span><br><span class="hljs-keyword">if</span>(bInReflectiveShadowMap)<br>&#123;<br><span class="hljs-comment">// 因为mobile没有RSM我把这里跳过啦！</span><br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-comment">// 是方向光！</span><br><span class="hljs-keyword">if</span>(bDirectionalLight)<br>&#123;<br><span class="hljs-comment">// Limit how small the depth range can be for smaller cascades</span><br><span class="hljs-comment">// 对于比较小的级联，限制最小的depth，不能太小</span><br><span class="hljs-comment">// This is needed for shadow modes like subsurface shadows which need depth information outside of the smaller cascade depth range</span><br><span class="hljs-comment">// 对于某些阴影模式是必须要的（比如 subsurface阴影（需要在很小的级联depth范围之外的depth信息），这又是啥？</span><br><span class="hljs-comment">//@todo - expose this value to the ini</span><br><span class="hljs-comment">// 是一个限制范围数字，为什么是5000 不重要</span><br><span class="hljs-type">const</span> <span class="hljs-type">float</span> DepthRangeClamp = <span class="hljs-number">5000</span>;<br><span class="hljs-comment">// 最大值不能小于5000</span><br>MaxSubjectZ = FMath::<span class="hljs-built_in">Max</span>(MaxSubjectZ, DepthRangeClamp);<br><span class="hljs-comment">// 最小值不能小于-5000</span><br>MinSubjectZ = FMath::<span class="hljs-built_in">Min</span>(MinSubjectZ, -DepthRangeClamp);<br><br><span class="hljs-comment">// Transform the shadow&#x27;s position into shadowmap space</span><br><span class="hljs-comment">// 将阴影的位置变换为shadowmap空间</span><br><span class="hljs-comment">// 这个PreShadowTranslation是计算出的包围球的origin取反，这里再次取反，这不又回去了吗</span><br><span class="hljs-type">const</span> FVector TransformedPosition = WorldToFace.<span class="hljs-built_in">TransformPosition</span>(-PreShadowTranslation);<br><br><span class="hljs-comment">// Largest amount that the shadowmap will be downsampled to during sampling</span><br><span class="hljs-comment">// shadowmap将会被降采样到所允许的最大数量</span><br><span class="hljs-comment">// We need to take this into account when snapping to get a stable result</span><br><span class="hljs-comment">// </span><br><span class="hljs-comment">// This corresponds to the maximum kernel filter size used by subsurface shadows in ShadowProjectionPixelShader.usf</span><br><span class="hljs-type">const</span> int32 MaxDownsampleFactor = <span class="hljs-number">4</span>;<br><span class="hljs-comment">// Determine the distance necessary to snap the shadow&#x27;s position to the nearest texel</span><br><span class="hljs-comment">// 确定将阴影位置捕捉到最近的纹理所需的距离</span><br><span class="hljs-type">const</span> <span class="hljs-type">float</span> SnapX = FMath::<span class="hljs-built_in">Fmod</span>(TransformedPosition.X, <span class="hljs-number">2.0f</span> * MaxDownsampleFactor / InResolutionX);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> SnapY = FMath::<span class="hljs-built_in">Fmod</span>(TransformedPosition.Y, <span class="hljs-number">2.0f</span> * MaxDownsampleFactor / InResolutionY);<br><span class="hljs-comment">// Snap the shadow&#x27;s position and transform it back into world space</span><br><span class="hljs-comment">// This snapping prevents sub-texel camera movements which removes view dependent aliasing from the final shadow result</span><br><span class="hljs-comment">// This only maintains stable shadows under camera translation and rotation</span><br><span class="hljs-comment">// 捕捉阴影的位置并将其转换回世界空间</span><br><span class="hljs-comment">// 此捕捉可防止sub-texel摄影机移动，从而从最终阴影结果中移除与视图相关的锯齿</span><br><span class="hljs-comment">// 这只会在摄影机平移和旋转下保持稳定的阴影</span><br><span class="hljs-comment">// 意思是为了避免摄像机移动的造成的锯齿或者抖动，重新计算了PreShadowTranslation</span><br><span class="hljs-type">const</span> FVector SnappedWorldPosition = WorldToFace.<span class="hljs-built_in">InverseFast</span>().<span class="hljs-built_in">TransformPosition</span>(TransformedPosition - <span class="hljs-built_in">FVector</span>(SnapX, SnapY, <span class="hljs-number">0.0f</span>));<br><br><span class="hljs-comment">//上面做的就是 按照某种规则重新计算了PreShadowTranslation，也就是包围球的origin，通过这个计算可以避免摄像机移动造成的锯齿和抖动</span><br>PreShadowTranslation = -SnappedWorldPosition;<br>&#125;<br><br><span class="hljs-keyword">if</span> (CascadeSettings.ShadowSplitIndex &gt;= <span class="hljs-number">0</span> &amp;&amp; bDirectionalLight)<br>&#123;<br><span class="hljs-built_in">checkSlow</span>(InDependentView);<br><span class="hljs-comment">// 计算FProjectedShadowInfo的ShadowBound</span><br>ShadowBounds = InLightSceneInfo-&gt;Proxy-&gt;<span class="hljs-built_in">GetShadowSplitBounds</span>(<br>*InDependentView, <br>bRayTracedDistanceField ? INDEX_NONE : CascadeSettings.ShadowSplitIndex, <br>InLightSceneInfo-&gt;<span class="hljs-built_in">IsPrecomputedLightingValid</span>(), <br><span class="hljs-number">0</span>);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>ShadowBounds = <span class="hljs-built_in">FSphere</span>(-Initializer.PreShadowTranslation, Initializer.SubjectBounds.SphereRadius);<br>&#125;<br><br><span class="hljs-comment">// Any meshes between the light and the subject can cast shadows, also any meshes inside the subject region</span><br><span class="hljs-comment">// 灯光和对象之间的任何网格都可以投射阴影，也可以投射对象区域内的任何网格</span><br><span class="hljs-comment">// CasterMatrix？？是什么？？</span><br><span class="hljs-comment">// 阴影投射矩阵，肯定是用来处理变换的，但是不知道是处理什么变换</span><br><span class="hljs-type">const</span> FMatrix CasterMatrix = WorldToFace * <span class="hljs-built_in">FShadowProjectionMatrix</span>(Initializer.MinLightW, MaxSubjectZ, Initializer.WAxis);<br><span class="hljs-comment">// 获取投射阴影的视锥体</span><br><span class="hljs-comment">// Frustum containing all potential shadow casters. </span><br><span class="hljs-comment">// 包含所有潜在阴影投射者的平截头体，是FProjectedShadowInfo的成员变量</span><br><span class="hljs-comment">// 根据函数的参数变量名，const FMatrix&amp; ViewProjectionMatrix，是一个视图投影矩阵</span><br><span class="hljs-comment">// 该函数通过CasterMatrix，生成了CasterFrustum的六个Planes</span><br>、<span class="hljs-built_in">GetViewFrustumBounds</span>(CasterFrustum, CasterMatrix, <span class="hljs-literal">true</span>);<br>&#125;<br><br><span class="hljs-built_in">checkf</span>(MaxSubjectZ &gt; MinSubjectZ, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;MaxSubjectZ %f MinSubjectZ %f SubjectBounds.SphereRadius %f&quot;</span>), MaxSubjectZ, MinSubjectZ, Initializer.SubjectBounds.SphereRadius);<br><br>MinPreSubjectZ = Initializer.MinLightW;<br><br>SubjectAndReceiverMatrix = WorldToFace * <span class="hljs-built_in">FShadowProjectionMatrix</span>(MinSubjectZ, MaxSubjectZ, Initializer.WAxis);<br><span class="hljs-comment">// For CSM the subject is the same as the receiver (i.e., the cascade bounds)</span><br>ReceiverMatrix = SubjectAndReceiverMatrix;<br><br><span class="hljs-type">float</span> MaxSubjectDepth = SubjectAndReceiverMatrix.<span class="hljs-built_in">TransformPosition</span>(<br>Initializer.SubjectBounds.Origin<br>+ WorldToLightScaled.<span class="hljs-built_in">InverseFast</span>().<span class="hljs-built_in">TransformVector</span>(Initializer.FaceDirection) * Initializer.SubjectBounds.SphereRadius<br>).Z;<br><br><span class="hljs-keyword">if</span> (bOnePassPointLightShadow)<br>&#123;<br>MaxSubjectDepth = Initializer.SubjectBounds.SphereRadius;<br>&#125;<br><br>InvMaxSubjectDepth = <span class="hljs-number">1.0f</span> / MaxSubjectDepth;<br><br><span class="hljs-comment">// Store the view matrix</span><br><span class="hljs-comment">// Reorder the vectors to match the main view, since ShadowViewMatrix will be used to override the main view&#x27;s view matrix during shadow depth rendering</span><br>ShadowViewMatrix = Initializer.WorldToLight * <br><span class="hljs-built_in">FMatrix</span>(<br><span class="hljs-built_in">FPlane</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),<br><span class="hljs-built_in">FPlane</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),<br><span class="hljs-built_in">FPlane</span>(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),<br><span class="hljs-built_in">FPlane</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>));<br><br>InvReceiverMatrix = ReceiverMatrix.<span class="hljs-built_in">InverseFast</span>();<br><br><span class="hljs-comment">// ReceiverFrustum 接收阴影的视锥体</span><br><span class="hljs-built_in">GetViewFrustumBounds</span>(ReceiverFrustum, ReceiverMatrix, <span class="hljs-literal">true</span>);<br><br><span class="hljs-built_in">UpdateShaderDepthBias</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="相关结构体"><a class="markdownIt-Anchor" href="#相关结构体"></a> 相关结构体</h2><h3 id="fwholesceneprojectedshadowinitializer"><a class="markdownIt-Anchor" href="#fwholesceneprojectedshadowinitializer"></a> FWholeSceneProjectedShadowInitializer</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/** Information needed to create a whole scene projected shadow. */</span><br><span class="hljs-comment">// 创建整个场景投影阴影所需的信息</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ENGINE_API</span> FWholeSceneProjectedShadowInitializer : <span class="hljs-keyword">public</span> FProjectedShadowInitializer<br>&#123;<br><span class="hljs-keyword">public</span>:<br>FShadowCascadeSettings CascadeSettings;<br><span class="hljs-type">bool</span> bOnePassPointLightShadow;<br><span class="hljs-type">bool</span> bRayTracedDistanceField;<br><br><span class="hljs-built_in">FWholeSceneProjectedShadowInitializer</span>() :<br><span class="hljs-built_in">bOnePassPointLightShadow</span>(<span class="hljs-literal">false</span>),<br><span class="hljs-built_in">bRayTracedDistanceField</span>(<span class="hljs-literal">false</span>)<br>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">IsCachedShadowValid</span><span class="hljs-params">(<span class="hljs-type">const</span> FWholeSceneProjectedShadowInitializer&amp; CachedShadow)</span> <span class="hljs-type">const</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> FProjectedShadowInitializer::<span class="hljs-built_in">IsCachedShadowValid</span>((<span class="hljs-type">const</span> FProjectedShadowInitializer&amp;)CachedShadow)<br>&amp;&amp; bOnePassPointLightShadow == CachedShadow.bOnePassPointLightShadow<br>&amp;&amp; bRayTracedDistanceField == CachedShadow.bRayTracedDistanceField;<br>&#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="fprojectedshadowinitializer"><a class="markdownIt-Anchor" href="#fprojectedshadowinitializer"></a> FProjectedShadowInitializer</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/** A projected shadow transform. */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ENGINE_API</span> FProjectedShadowInitializer<br>&#123;<br><span class="hljs-keyword">public</span>:<br><br><span class="hljs-comment">/** A translation that is applied to world-space before transforming by one of the shadow matrices. */</span><br><span class="hljs-comment">// 通过一个阴影矩阵进行变化之前的，被应用于世界空间的，一个，translation ？平移</span><br>FVector PreShadowTranslation;<br><br>FMatrix WorldToLight;<br><span class="hljs-comment">/** Non-uniform scale to be applied after WorldToLight. */</span><br>FVector Scales;<br><br>FVector FaceDirection;<br>FBoxSphereBounds SubjectBounds;<br>FVector4 WAxis;<br><span class="hljs-type">float</span> MinLightW;<br><span class="hljs-type">float</span> MaxDistanceToCastInLightW;<br><br><span class="hljs-comment">/** Default constructor. */</span><br><span class="hljs-built_in">FProjectedShadowInitializer</span>()<br>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">IsCachedShadowValid</span><span class="hljs-params">(<span class="hljs-type">const</span> FProjectedShadowInitializer&amp; CachedShadow)</span> <span class="hljs-type">const</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> PreShadowTranslation == CachedShadow.PreShadowTranslation<br>&amp;&amp; WorldToLight == CachedShadow.WorldToLight<br>&amp;&amp; Scales == CachedShadow.Scales<br>&amp;&amp; FaceDirection == CachedShadow.FaceDirection<br>&amp;&amp; SubjectBounds.Origin == CachedShadow.SubjectBounds.Origin<br>&amp;&amp; SubjectBounds.BoxExtent == CachedShadow.SubjectBounds.BoxExtent<br>&amp;&amp; SubjectBounds.SphereRadius == CachedShadow.SubjectBounds.SphereRadius<br>&amp;&amp; WAxis == CachedShadow.WAxis<br>&amp;&amp; MinLightW == CachedShadow.MinLightW<br>&amp;&amp; MaxDistanceToCastInLightW == CachedShadow.MaxDistanceToCastInLightW;<br>&#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="fboxspherebounds"><a class="markdownIt-Anchor" href="#fboxspherebounds"></a> FBoxSphereBounds</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Structure for a combined axis aligned bounding box and bounding sphere with the same origin. (28 bytes).</span><br><span class="hljs-comment"> 具有相同原点的组合轴对包围盒和包围球的结构。（28字节）。????</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FBoxSphereBounds</span><br>&#123;<br><span class="hljs-comment">/** Holds the origin of the bounding box and sphere. */</span><br>    <span class="hljs-comment">// 包围盒和球的原点</span><br>FVectorOrigin;<br>    <span class="hljs-comment">// 包围盒的的边长的一半</span><br><span class="hljs-comment">/** Holds the extent of the bounding box. */</span><br>FVector BoxExtent;<br><br><span class="hljs-comment">/** Holds the radius of the bounding sphere. */</span><br>    <span class="hljs-comment">// 包围球的半径</span><br><span class="hljs-type">float</span> SphereRadius;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>UE4</category>
      
    </categories>
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Rendering</tag>
      
      <tag>Mobile</tag>
      
      <tag>Shadow</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：4.27版本PSO变化</title>
    <link href="/posts/2274/"/>
    <url>/posts/2274/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>最近项目升级了4.27版本，发现PSO部分似乎又有了什么改动，于是决定去看一下ReleaseNotes，对比一下相对4.26版本的变化。</p><h1 id="releasenotes"><a class="markdownIt-Anchor" href="#releasenotes"></a> ReleaseNotes</h1><p>其中与PSO相关的几点如下：</p><h2 id="安卓"><a class="markdownIt-Anchor" href="#安卓"></a> <strong>安卓</strong></h2><h3 id="bug-fix"><a class="markdownIt-Anchor" href="#bug-fix"></a> BUG FIX</h3><ul><li>修复了在PSO缓存处理期间，如果传入的PSO在PSO缓存加载开始之前已经实例化则可能触发GLES断言的问题</li></ul><h2 id="rendering"><a class="markdownIt-Anchor" href="#rendering"></a> <strong>Rendering</strong></h2><h3 id="新特性"><a class="markdownIt-Anchor" href="#新特性"></a> 新特性</h3><ul><li>实现了可选的非阻塞光线跟踪PSO编译模式</li></ul><h3 id="bug-fix-2"><a class="markdownIt-Anchor" href="#bug-fix-2"></a> BUG FIX</h3><ul><li>修复了在CPU核数较低的计算机上光线跟踪PSO编译任务中可能出现的死锁</li></ul><h2 id="materials"><a class="markdownIt-Anchor" href="#materials"></a> <strong>Materials</strong></h2><h3 id="新特性-2"><a class="markdownIt-Anchor" href="#新特性-2"></a> 新特性</h3><ul><li>包含用于PSO缓存的 stable shader keys 的文件不再是文本（scl.csv），而是二进制文件（.shk）</li><li>PSO缓存收集过程中的“expand”步骤的性能有了很大提高</li></ul><h3 id="bug-fix-3"><a class="markdownIt-Anchor" href="#bug-fix-3"></a> BUG FIX</h3><ul><li>将PSO Cache的过滤规则改的宽松了，为了避免一些问题（？另外这条在RealeaseNotes里出现两次？）</li></ul><p>下文主要关注Materials部分的变化</p><h1 id="pso部署和使用的基本流程"><a class="markdownIt-Anchor" href="#pso部署和使用的基本流程"></a> PSO部署和使用的基本流程</h1><p>首先回顾一下4.26版本下我们生成和使用PSO的流程：</p><ol><li>打开项目的NeedsShaderStableKeys设置，在DefaultEngine.ini和相关平台的Engine.ini中添加</li></ol><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[DevOptions.Shaders]</span><br><span class="hljs-attr">NeedsShaderStableKeys</span>=<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><ol start="2"><li>打包，cook阶段生成对应的两个.scl.csv文件（4.26版本）</li><li>打开DefaultEngine中PSO的相关Log设置确认成功启用PSO</li></ol><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[ConsoleVariables]</span><br><span class="hljs-attr">r.ShaderPipelineCache.Enabled</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">r.ShaderPipelineCache.LogPSO</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">r.ShaderPipelineCache.SaveBoundPSOLog</span>=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>游戏启动后会有Log可以确认：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Log">LogConfig: Setting CVar [[r.ShaderPipelineCache.Enabled:1]]<br>LogConfig: Setting CVar [[r.ShaderPipelineCache.LogPSO:1]]<br>LogConfig: Setting CVar [[r.ShaderPipelineCache.SaveBoundPSOLog:1]]<br></code></pre></td></tr></table></figure><ol start="4"><li>正常进行游戏流程，发现Saved文件夹中出现CoolectedPSOs文件夹，生成.rec.upipelinecache文件</li><li>使用UE4Editor-Cmd.exe和相关命令生成.stablepc.csv文件，参考：</li></ol><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">Engine/Binaries/Win64/UE4Editor-Cmd.exe<br>D:<span class="hljs-string">/Client/Client.uproject</span><br>-run=ShaderPipelineCacheTools expand<br>D:<span class="hljs-string">/PSOCache/</span>*<span class="hljs-string">.rec.upipelinecache</span><br>D:<span class="hljs-string">/PSOCache/</span>*<span class="hljs-string">.scl.csv</span><br>D:<span class="hljs-string">/PSOCache/Client_GLSL_ES3_1_ANDROID.stablepc.csv</span><br></code></pre></td></tr></table></figure><ol start="6"><li>到这一步我们应该有四个文件：<ul><li>.scl.csv <strong>两个</strong> 打包时生成的文件</li><li>.rec.upipelinecache 运行时收集的文件</li><li>.stablepc.csv 第5步生成的文件</li></ul></li><li>UE4Editor-Cmd.exe命令生成.stable.upipelinecache文件，文件路径在，参考：</li></ol><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">Engine\<span class="hljs-keyword">Binaries\Win64\UE4Editor-Cmd.exe</span><br><span class="hljs-keyword"></span>D:\TestProject\TestProject.uproject<br>-run=<span class="hljs-keyword">ShaderPipelineCacheTools </span><span class="hljs-keyword">build</span><br><span class="hljs-keyword"></span><span class="hljs-string">&quot;D:\TestProject/Build/Android/PipelineCaches/*TestProject_GLSL_ES3_1_ANDROID.stablepc.csv&quot;</span><br><span class="hljs-string">&quot;D:\TestProject/Saved/Cooked/Android_ASTC/TestProject/Metadata/PipelineCaches/ShaderStableInfo-Global-GLSL_ES3_1_ANDROID.scl.csv&quot;</span><br><span class="hljs-string">&quot;D:\TestProject/Saved/Cooked/Android_ASTC/TestProject/Metadata/PipelineCaches/ShaderStableInfo-TestProject-GLSL_ES3_1_ANDROID.scl.csv&quot;</span><br><span class="hljs-string">&quot;D:\TestProject/Saved/Cooked/Android_ASTC/TestProject/Content/PipelineCaches/Android/TestProject_GLSL_ES3_1_ANDROID.stable.upipelinecache&quot;</span><br></code></pre></td></tr></table></figure><ol start="8"><li>将上一步生成的.stable.upipelinecache文件放在项目的Saved\Cooked对应平台的Content的PipelineCaches目录下，比如：<br />D:\TestProject\Saved\Cooked\Android_ASTC\TestProject\Content\PipelineCaches</li><li>再次打包，这次打包就有PSO文件了，启动游戏时查看log进行确认：</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Log">LogShaderLibrary: Display: Using ../../../TestProject/Content/ShaderArchive-TestProject-GLSL_ES3_1_ANDROID.ushaderbytecode for material shader code. Total 3053 unique shaders.<br>LogShaderLibrary: Display: Cooked Context: Using Shared Shader Library TestProject<br>LogRHI: Display: Opened pipeline cache after state change and enqueued 0 of 0 tasks for precompile.<br>LogRHI: Base name for record PSOs is ../../../TestProject/Saved/CollectedPSOs/++UE4+Release-4.25-CL-13942748-TestProject_GLSL_ES3_1_ANDROID_00087B4B08D905BBC5A827F40CA03A0C.rec.upipelinecache<br>LogRHI: FPipelineCacheFile Header Game Version: 13942748<br>LogRHI: FPipelineCacheFile Header Engine Data Version: 17<br>LogRHI: FPipelineCacheFile Header TOC Offset: 38155<br>LogRHI: FPipelineCacheFile File Size: 51011 Bytes<br>LogRHI: Opened FPipelineCacheFile: ../../../TestProject/Content/PipelineCaches/Android/TestProject_GLSL_ES3_1_ANDROID.stable.upipelinecache (GUID: 00000000000000000000000000000000) with 102 entries.<br>LogRHI: Scanning Binary program cache, using Shader Pipeline Cache version 6988202F47BA858F3F0DE483D7DB0606<br>LogRHI: AndroidEGL:SwapBuffers eglGetCompositorTimingANDROID EGL_COMPOSITE_DEADLINE_ANDROID=2718926192606265, EGL_COMPOSITE_INTERVAL_ANDROID=16559027, EGL_COMPOSITE_TO_PRESENT_LATENCY_ANDROID=14559027<br></code></pre></td></tr></table></figure><p>以上流程在4.27中，按照版本信息中显示的，变化最大的是第二步生成的.scl.csv文件变成了二进制.shk文件</p><h1 id="sclcsv文件"><a class="markdownIt-Anchor" href="#sclcsv文件"></a> SCL.CSV文件</h1><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220612203906.png" alt="20220612203906" /><br />文件里包含了材质类名与Shader类型、特性级别、目标平台、顶点工厂类型和Hash相关信息<br />在4.27版本中，生成的文件为.shk：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220612205018.png" alt="20220612205018" /></p><h1 id="文件的生成"><a class="markdownIt-Anchor" href="#文件的生成"></a> 文件的生成</h1><p>4.26中源码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// ShaderCodeLibrary.cpp</span><br><span class="hljs-comment">// 忽略了部分无关代码</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Finalize</span><span class="hljs-params">(FString OutputDir, <span class="hljs-type">bool</span> bNativeFormat, FString&amp; OutSCLCSVPath)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// Shader library</span><br><span class="hljs-keyword">if</span> (bSuccess &amp;&amp; StableMap.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br><span class="hljs-comment">// Write to a intermediate file</span><br>            <span class="hljs-comment">// 这里生成了.scl.csv的文件路径</span><br>FString IntermediateFormatPath = <span class="hljs-built_in">GetStableInfoArchiveFilename</span>(FPaths::<span class="hljs-built_in">ProjectSavedDir</span>() / <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Shaders&quot;</span>) / FormatName.<span class="hljs-built_in">ToString</span>(), LibraryName, FormatName);<br><br><span class="hljs-comment">// Write directly to the file</span><br>&#123;<br><span class="hljs-function">TUniquePtr&lt;FArchive&gt; <span class="hljs-title">IntermediateFormatAr</span><span class="hljs-params">(IFileManager::Get().CreateFileWriter(*IntermediateFormatPath))</span></span>;<br><br>                <span class="hljs-comment">// 这一行是在打表，生成了csv文件的表头</span><br>FString HeaderText = FStableShaderKeyAndValue::<span class="hljs-built_in">HeaderLine</span>();<br>HeaderText += <span class="hljs-built_in">TCHAR</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);<br><span class="hljs-keyword">auto</span> HeaderSrc = <span class="hljs-built_in">StringCast</span>&lt;ANSICHAR&gt;(*HeaderText, HeaderText.<span class="hljs-built_in">Len</span>());<br>                <span class="hljs-comment">// 写入文件第一行</span><br>IntermediateFormatAr-&gt;<span class="hljs-built_in">Serialize</span>((ANSICHAR*)HeaderSrc.<span class="hljs-built_in">Get</span>(), HeaderSrc.<span class="hljs-built_in">Length</span>() * <span class="hljs-built_in">sizeof</span>(ANSICHAR));<br><br>TAnsiStringBuilder&lt;<span class="hljs-number">512</span>&gt; LineBuffer;<br><br>                <span class="hljs-comment">// TSet&lt;FStableShaderKeyAndValue&gt; StableMap;</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> FStableShaderKeyAndValue&amp; Item : StableMap)<br>&#123;<br>LineBuffer.<span class="hljs-built_in">Reset</span>();<br>                    <span class="hljs-comment">// 将FStableShaderKeyAndValue的相关信息写入LineBuffer</span><br>Item.<span class="hljs-built_in">AppendString</span>(LineBuffer);<br>LineBuffer &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;<br>                    <span class="hljs-comment">// 将一个FStableShaderKeyAndValue的信息写入文件</span><br>IntermediateFormatAr-&gt;<span class="hljs-built_in">Serialize</span>(<span class="hljs-built_in">const_cast</span>&lt;ANSICHAR*&gt;(LineBuffer.<span class="hljs-built_in">ToString</span>()), LineBuffer.<span class="hljs-built_in">Len</span>() * <span class="hljs-built_in">sizeof</span>(ANSICHAR));<br>&#125;<br>&#125;<br><br>            <span class="hljs-comment">// ...</span><br><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看出在4.26版本中是直接将每一个FStableShaderKeyAndValue的信息直接转成文本写入到文本文件中的<br />再看一下4.27版本：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Finalize</span><span class="hljs-params">(FString OutputDir, FString&amp; OutSCLCSVPath)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-comment">// Shader library</span><br><span class="hljs-keyword">if</span> (bSuccess &amp;&amp; StableMap.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br><span class="hljs-comment">// Write to a intermediate file</span><br>FString IntermediateFormatPath = <span class="hljs-built_in">GetStableInfoArchiveFilename</span>(FPaths::<span class="hljs-built_in">ProjectSavedDir</span>() / <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Shaders&quot;</span>) / FormatName.<span class="hljs-built_in">ToString</span>(), LibraryName, FormatName);<br><br><span class="hljs-comment">// Write directly to the file</span><br>&#123;<br>                <span class="hljs-comment">// PipelineCacheUtilities 用这里的方法去保存文件了</span><br><span class="hljs-keyword">if</span> (!UE::PipelineCacheUtilities::<span class="hljs-built_in">SaveStableKeysFile</span>(IntermediateFormatPath, StableMap))<br>&#123;<br><span class="hljs-built_in">UE_LOG</span>(LogShaderLibrary, Error, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Could not save stable map to file &#x27;%s&#x27;&quot;</span>), *IntermediateFormatPath);<br>&#125;<br><br><span class="hljs-comment">// ...</span><br>&#125;<br><br>            <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-keyword">return</span> bSuccess;<br>&#125;<br></code></pre></td></tr></table></figure><p>那么去看一下UE::PipelineCacheUtilities::SaveStableKeysFile</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// PipelineCacheUtilities.h</span><br><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * Saves stable shader keys file (using a proprietary format). Stable key is a way to identify a shader independently of its output hash</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * @param Filename filename (with path if needed)</span><br><span class="hljs-comment"> * @param Values values to be saved</span><br><span class="hljs-comment"> * @return true if successful</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function">RENDERCORE_API <span class="hljs-type">bool</span> <span class="hljs-title">SaveStableKeysFile</span><span class="hljs-params">(<span class="hljs-type">const</span> FStringView&amp; Filename, <span class="hljs-type">const</span> TSet&lt;FStableShaderKeyAndValue&gt;&amp; Values)</span></span>;<br><br><span class="hljs-comment">// ... </span><br><br><span class="hljs-comment">// PipelineCacheUtilities.cpp</span><br><span class="hljs-type">bool</span> UE::PipelineCacheUtilities::<span class="hljs-built_in">SaveStableKeysFile</span>(<span class="hljs-type">const</span> FStringView&amp; Filename, <span class="hljs-type">const</span> TSet&lt;FStableShaderKeyAndValue&gt;&amp; Values)<br>&#123;<br><span class="hljs-function">TUniquePtr&lt;FArchive&gt; <span class="hljs-title">FileArchiveInner</span><span class="hljs-params">(IFileManager::Get().CreateFileWriter(*FString(Filename.Len(), Filename.GetData())))</span></span>;<br><span class="hljs-keyword">if</span> (!FileArchiveInner)<br>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-function">TUniquePtr&lt;FArchive&gt; <span class="hljs-title">Archive</span><span class="hljs-params">(<span class="hljs-keyword">new</span> FNameAsStringIndexProxyArchive(*FileArchiveInner.Get()))</span></span>;<br><br>    <span class="hljs-comment">// 处理文件头，已经不是表头了，只取了TSet的Num</span><br>UE::PipelineCacheUtilities::Private::FStableKeysSerializedHeader Header;<br>Header.NumEntries = Values.<span class="hljs-built_in">Num</span>();<br><br>*Archive &lt;&lt; Header;<br><br><span class="hljs-comment">// go through all the hashes and index them</span><br>    <span class="hljs-comment">// 这里要拿所有的ShaderHash和对应的Index</span><br>TArray&lt;FSHAHash&gt; Hashes;<br>TMap&lt;FSHAHash, int32&gt; HashToIndex;<br>    <span class="hljs-comment">// 填充HashToIndex的Map的方法（感觉lambda流行了起来……</span><br><span class="hljs-keyword">auto</span> IndexHash = [&amp;Hashes, &amp;HashToIndex](<span class="hljs-type">const</span> FSHAHash&amp; Hash)<br>&#123;<br><span class="hljs-keyword">if</span> (HashToIndex.<span class="hljs-built_in">Find</span>(Hash) == <span class="hljs-literal">nullptr</span>)<br>&#123;<br>Hashes.<span class="hljs-built_in">Add</span>(Hash);<br>HashToIndex.<span class="hljs-built_in">Add</span>(Hash, Hashes.<span class="hljs-built_in">Num</span>() - <span class="hljs-number">1</span>);<br>&#125;<br>&#125;;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> FStableShaderKeyAndValue&amp; Item : Values)<br>&#123;<br>        <span class="hljs-comment">// PipelineHash和OutputHash都需要，在原来的csv文件中也是两个</span><br><span class="hljs-built_in">IndexHash</span>(Item.PipelineHash);<br><span class="hljs-built_in">IndexHash</span>(Item.OutputHash);<br>&#125;<br><br>int32 NumHashes = Hashes.<span class="hljs-built_in">Num</span>();<br>*Archive &lt;&lt; NumHashes;<br><span class="hljs-keyword">for</span> (int32 IdxHash = <span class="hljs-number">0</span>; IdxHash &lt; NumHashes; ++IdxHash)<br>&#123;<br>*Archive &lt;&lt; Hashes[IdxHash];<br>&#125;<br><br><span class="hljs-comment">// save the rest of the properties</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> FStableShaderKeyAndValue&amp; ConstItem : Values)<br>&#123;<br><span class="hljs-comment">// serialization unfortunately needs non-const and this is easier than const-casting every field</span><br>FStableShaderKeyAndValue&amp; Item = <span class="hljs-built_in">const_cast</span>&lt;FStableShaderKeyAndValue&amp;&gt;(ConstItem);<br><br>int8 CompactNamesNum = <span class="hljs-built_in">static_cast</span>&lt;int8&gt;(Item.ClassNameAndObjectPath.ObjectClassAndPath.<span class="hljs-built_in">Num</span>());<br><span class="hljs-built_in">ensure</span>(Item.ClassNameAndObjectPath.ObjectClassAndPath.<span class="hljs-built_in">Num</span>() &lt; <span class="hljs-number">256</span>);<br>*Archive &lt;&lt; CompactNamesNum;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> Idx = <span class="hljs-number">0</span>; Idx &lt; (<span class="hljs-type">int</span>)CompactNamesNum; ++Idx)<br>&#123;<br>*Archive &lt;&lt; Item.ClassNameAndObjectPath.ObjectClassAndPath[Idx];<br>&#125;<br><br>*Archive &lt;&lt; Item.ShaderType;<br>*Archive &lt;&lt; Item.ShaderClass;<br>*Archive &lt;&lt; Item.MaterialDomain;<br>*Archive &lt;&lt; Item.FeatureLevel;<br>*Archive &lt;&lt; Item.QualityLevel;<br>*Archive &lt;&lt; Item.TargetFrequency;<br>*Archive &lt;&lt; Item.TargetPlatform;<br>*Archive &lt;&lt; Item.VFType;<br>*Archive &lt;&lt; Item.PermutationId;<br><br>uint64 PipelineHashIdx = <span class="hljs-built_in">static_cast</span>&lt;uint64&gt;(*HashToIndex.<span class="hljs-built_in">Find</span>(Item.PipelineHash));<br><span class="hljs-built_in">WriteVarUIntToArchive</span>(*Archive, PipelineHashIdx);<br>uint64 OutputHashIdx = <span class="hljs-built_in">static_cast</span>&lt;uint64&gt;(*HashToIndex.<span class="hljs-built_in">Find</span>(Item.OutputHash));<br><span class="hljs-built_in">WriteVarUIntToArchive</span>(*Archive, OutputHashIdx);<br>&#125;<br><br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>当然，在保存的文件格式变化之后，读取的方法相应的也变了，namespace PipelineCacheUtilities只有两个行数，一个是LoadStableKeysFile，一个是SaveStableKeysFile<br />从csv文件变成二进制文件后直接打开文件查看信息是不能了，这么改的目的应该就是更新日志里提到的对PSO build的expand过程的性能提升，可以看流程中的第5条的命令<br />在ShaderPipelineCacheToolsCommandlet.cpp文件中相关的有变化的方法：</p><table><thead><tr><th>4.26</th><th>4.27</th></tr></thead><tbody><tr><td>LoadStableSCL</td><td>LoadStableShaderKeys</td></tr><tr><td>LoadStableSCLs</td><td>LoadStableShaderKeysMultiple</td></tr><tr><td>If you can find the old .scl.csv file</td><td>If you can find the old %s file</td></tr><tr><td>GeneratePermuations</td><td>GeneratePermutations（他们甚至改了单词的拼写错误</td></tr><tr><td>ExpandPSOSC</td><td>ExpandPSOSC（函数体中关于文件类型的修改，这里就是关于更新日志中关于expand性能提升的部分）</td></tr></tbody></table><h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1><p>在Material方面：</p><ol><li>4.26 使用csv文件作为ShaderAssetInfo文件<br />4.27 使用.shk的二进制文件作为ShaderAssetInfo文件</li><li>4.27 对应新增了.shk文件的读写方法</li><li>4.27 将PSOExpand中的一个for循环优化为ParallelFor提升性能</li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：AnimSequence曲线和Tracks复制</title>
    <link href="/posts/10235/"/>
    <url>/posts/10235/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>本文在4.27版本下完成<br />在编辑AnimSequence的时候，不同的动画可能需要服用Curves和AdditiveLayerTracks，为了提高效率，增加了一下原本编辑器不存在的复制粘贴方法</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220525205853.png" alt="20220525205853" /></p><h1 id="curves"><a class="markdownIt-Anchor" href="#curves"></a> Curves</h1><h2 id="查看方法"><a class="markdownIt-Anchor" href="#查看方法"></a> 查看方法</h2><p>在AnimSequenceBase.h文件中UAnimSequenceBase类有一个成员变量：RawCurveData</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Raw uncompressed float curve data </span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">UPROPERTY</span>()<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FRawCurveTracks</span> RawCurveData;<br></code></pre></td></tr></table></figure><p>RawCurveData中的FloatCurves保存了Curves</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">USTRUCT</span>()<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FRawCurveTracks</span><br>&#123;<br><span class="hljs-built_in">GENERATED_USTRUCT_BODY</span>()<br><br><span class="hljs-built_in">UPROPERTY</span>()<br>TArray&lt;FFloatCurve&gt;FloatCurves;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> WITH_EDITORONLY_DATA</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @note : Currently VectorCurves are not evaluated or used for anything else but transient data for modifying bone track</span><br><span class="hljs-comment"> *Note that it doesn&#x27;t have UPROPERTY tag yet. In the future, we&#x27;d like this to be serialized, but not for now</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-built_in">UPROPERTY</span>(transient)<br>TArray&lt;FVectorCurve&gt;VectorCurves;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @note : TransformCurves are used to edit additive animation in editor. </span><br><span class="hljs-comment"> **/</span><br><span class="hljs-built_in">UPROPERTY</span>()<br>TArray&lt;FTransformCurve&gt;TransformCurves;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// #if WITH_EDITORONLY_DATA</span></span><br>    &#123;...&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>看一下FFloatCurve：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">USTRUCT</span>()<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FFloatCurve</span> : <span class="hljs-keyword">public</span> FAnimCurveBase<br>&#123;<br><span class="hljs-built_in">GENERATED_USTRUCT_BODY</span>()<br><br><span class="hljs-comment">/** Curve data for float. */</span><br><span class="hljs-built_in">UPROPERTY</span>()<br>FRichCurveFloatCurve;<br><br><span class="hljs-built_in">FFloatCurve</span>()&#123;&#125;<br><br><span class="hljs-built_in">FFloatCurve</span>(FSmartName InName, int32 InCurveTypeFlags)<br>: <span class="hljs-built_in">FAnimCurveBase</span>(InName, InCurveTypeFlags)<br>&#123;<br>&#125;<br><br><span class="hljs-comment">// we don&#x27;t want to have = operator. This only copies curves, but leaving naming and everything else intact. </span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CopyCurve</span><span class="hljs-params">(FFloatCurve&amp; SourceCurve)</span></span>;<br><span class="hljs-function">ENGINE_API <span class="hljs-type">float</span> <span class="hljs-title">Evaluate</span><span class="hljs-params">(<span class="hljs-type">float</span> CurrentTime)</span> <span class="hljs-type">const</span></span>;<br><span class="hljs-function">ENGINE_API <span class="hljs-type">void</span> <span class="hljs-title">UpdateOrAddKey</span><span class="hljs-params">(<span class="hljs-type">float</span> NewKey, <span class="hljs-type">float</span> CurrentTime)</span></span>;<br><span class="hljs-function">ENGINE_API <span class="hljs-type">void</span> <span class="hljs-title">GetKeys</span><span class="hljs-params">(TArray&lt;<span class="hljs-type">float</span>&gt;&amp; OutTimes, TArray&lt;<span class="hljs-type">float</span>&gt;&amp; OutValues)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Resize</span><span class="hljs-params">(<span class="hljs-type">float</span> NewLength, <span class="hljs-type">bool</span> bInsert<span class="hljs-comment">/* whether insert or remove*/</span>, <span class="hljs-type">float</span> OldStartTime, <span class="hljs-type">float</span> OldEndTime)</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p>对Curves的复制就是要把实例A的RawCurveData.FloatCurves复制后添加到实例B的RawCurveData.FloatCurves中</p><h2 id="添加ui和方法"><a class="markdownIt-Anchor" href="#添加ui和方法"></a> 添加UI和方法</h2><p>定位到这个编辑器按钮布局相关的地方：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// AnimTimeLineTrack_Curves.cpp</span><br><span class="hljs-comment">// 这个函数是生成途中Curves那个按钮的子菜单的地方，可以在这里面增加复制粘贴的选项</span><br><span class="hljs-function">TSharedRef&lt;SWidget&gt; <span class="hljs-title">FAnimTimelineTrack_Curves::BuildCurvesSubMenu</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// 省略一些源码</span><br>    &#123;...&#125;<br>    <span class="hljs-comment">// 对于没有Curves的对象可以直接隐藏掉对应的选项</span><br>    <span class="hljs-keyword">if</span> (AnimSequenceBase-&gt;RawCurveData.FloatCurves.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br>MenuBuilder.<span class="hljs-built_in">AddMenuEntry</span>(<br><span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;CopyAllCurves&quot;</span>, <span class="hljs-string">&quot;Copy All Curves&quot;</span>),<br><span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;CopyAllCurves_ToolTip&quot;</span>, <span class="hljs-string">&quot;Copy All Curves&quot;</span>),<br><span class="hljs-built_in">FSlateIcon</span>(),<br>                <span class="hljs-comment">// 绑定复制方法</span><br><span class="hljs-built_in">FUIAction</span>(FExecuteAction::<span class="hljs-built_in">CreateSP</span>(<span class="hljs-keyword">this</span>, &amp;FAnimTimelineTrack_Curves::CopyAllCurves))<br>);<br>&#125;<br>        <span class="hljs-comment">// 定义一个静态变量来存储我们复制的数据</span><br><span class="hljs-keyword">if</span> (CurveNameKeyValueContainer.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br>MenuBuilder.<span class="hljs-built_in">AddMenuEntry</span>(<br><span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;PasteAllCurves&quot;</span>, <span class="hljs-string">&quot;Paste All Curves&quot;</span>),<br><span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;PasteAllCurves_ToolTip&quot;</span>, <span class="hljs-string">&quot;Paste All Curves&quot;</span>),<br><span class="hljs-built_in">FSlateIcon</span>(),<br>                <span class="hljs-comment">// 绑定粘贴方法</span><br><span class="hljs-built_in">FUIAction</span>(FExecuteAction::<span class="hljs-built_in">CreateSP</span>(<span class="hljs-keyword">this</span>, &amp;FAnimTimelineTrack_Curves::PasteAllCurves))<br>);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后实现一下两个方法:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs C++">TMap&lt; FName, TArray&lt;FRichCurveKey&gt; &gt; FAnimTimelineTrack_Curves::CurveContainer;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FAnimTimelineTrack_Curves::CopyAllCurves</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>CurveContainer.<span class="hljs-built_in">Empty</span>();<br><br><span class="hljs-function"><span class="hljs-type">const</span> FScopedTransaction <span class="hljs-title">Transaction</span><span class="hljs-params">(LOCTEXT(<span class="hljs-string">&quot;AnimCurve_CopyAllCurves&quot;</span>, <span class="hljs-string">&quot;Copy All Curves&quot;</span>))</span></span>;<br><br>UAnimSequenceBase* AnimSequenceBase = <span class="hljs-built_in">GetModel</span>()-&gt;<span class="hljs-built_in">GetAnimSequenceBase</span>();<br><span class="hljs-keyword">for</span> (FFloatCurve&amp; Curve : AnimSequenceBase-&gt;RawCurveData.FloatCurves)<br>&#123;<br>CurveContainer.<span class="hljs-built_in">Add</span>(Curve.Name.DisplayName, Curve.FloatCurve.<span class="hljs-built_in">GetCopyOfKeys</span>());<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FAnimTimelineTrack_Curves::PasteAllCurves</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-function"><span class="hljs-type">const</span> FScopedTransaction <span class="hljs-title">Transaction</span><span class="hljs-params">(LOCTEXT(<span class="hljs-string">&quot;AnimCurve_PasteAllCurves&quot;</span>, <span class="hljs-string">&quot;Paste All Curves&quot;</span>))</span></span>;<br><br>UAnimSequenceBase* AnimSequenceBase = <span class="hljs-built_in">GetModel</span>()-&gt;<span class="hljs-built_in">GetAnimSequenceBase</span>();<br>AnimSequenceBase-&gt;<span class="hljs-built_in">Modify</span>();<br>USkeleton* Skeleton = AnimSequenceBase-&gt;<span class="hljs-built_in">GetSkeleton</span>();<br>FSmartName NewName;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; T : CurveContainer) &#123;<br><span class="hljs-type">const</span> FSmartNameMapping* NameMapping = Skeleton-&gt;<span class="hljs-built_in">GetSmartNameContainer</span>(USkeleton::AnimCurveMappingName);<br>SmartName::UID_Type CurveUid = NameMapping-&gt;<span class="hljs-built_in">FindUID</span>(T.Key);<br><span class="hljs-built_in">ensureAlways</span>(Skeleton-&gt;<span class="hljs-built_in">GetSmartNameByUID</span>(USkeleton::AnimCurveMappingName, CurveUid, NewName));<br><span class="hljs-keyword">if</span> (!(AnimSequenceBase-&gt;RawCurveData.<span class="hljs-built_in">GetCurveData</span>(NewName.UID) == <span class="hljs-literal">NULL</span>)) <br>        &#123;<br>AnimSequenceBase-&gt;RawCurveData.<span class="hljs-built_in">DeleteCurveData</span>(NewName);<br>&#125;<br>AnimSequenceBase-&gt;RawCurveData.<span class="hljs-built_in">AddCurveData</span>(NewName);<br>AnimSequenceBase-&gt;<span class="hljs-built_in">MarkRawDataAsModified</span>();<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; KV : T.Value) <br>        &#123;<br>AnimSequenceBase-&gt;RawCurveData.<span class="hljs-built_in">AddFloatCurveKey</span>(NewName, AACF_Editable, KV.Time, KV.Value);<br>&#125;<br>&#125;<br><br><span class="hljs-built_in">GetModel</span>()-&gt;<span class="hljs-built_in">RefreshTracks</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>其实就是简单的将原曲线的数据存下来之后，通过RawCurveData的AddCurveData方法将数据添加给新曲线</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022!%5B20220525213823%5D(httpscdn.jsdelivr.netghmuchenhenMuImageStore@mainBlogs202220220525213823.png).png" alt="20220525213823" /></p><h1 id="tracks"><a class="markdownIt-Anchor" href="#tracks"></a> Tracks</h1><p>Additive Layer Tracks的复制需要注意Bone，不同角色骨骼不同的时候要注意丢弃不可用数据</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// AnimTimelineTrack.cpp</span><br><span class="hljs-comment">// 存储数据用</span><br>TMap&lt; FName, FTransformCurve&gt; FAnimTimelineTrack::TracksFTransformCurveContainer;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FAnimTimelineTrack::CopyAllAdditiveLayerTracks</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>TracksFTransformCurveContainer.<span class="hljs-built_in">Empty</span>();<br><br><span class="hljs-function"><span class="hljs-type">const</span> FScopedTransaction <span class="hljs-title">Transaction</span><span class="hljs-params">(LOCTEXT(<span class="hljs-string">&quot;AnimTracks_CopyAllTracks&quot;</span>, <span class="hljs-string">&quot;Copy All Tracks&quot;</span>))</span></span>;<br><br>UAnimSequenceBase* SequenceBase = <span class="hljs-built_in">GetModel</span>()-&gt;<span class="hljs-built_in">GetAnimSequenceBase</span>();<br><span class="hljs-comment">// 按照名字和Curve存储数据</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; Curve : SequenceBase-&gt;RawCurveData.TransformCurves)<br>&#123;<br>TracksFTransformCurveContainer.<span class="hljs-built_in">Add</span>(Curve.Name.DisplayName, Curve);<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FAnimTimelineTrack::PasteAdditiveLayerTracks</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-function"><span class="hljs-type">const</span> FScopedTransaction <span class="hljs-title">Transaction</span><span class="hljs-params">(LOCTEXT(<span class="hljs-string">&quot;AnimTracks_PasteAllTracks&quot;</span>, <span class="hljs-string">&quot;Paste All Tracks&quot;</span>))</span></span>;<br><br>UAnimSequenceBase* AnimSequenceBase = <span class="hljs-built_in">GetModel</span>()-&gt;<span class="hljs-built_in">GetAnimSequenceBase</span>();<br><span class="hljs-type">const</span> UAnimSequence* AnimSequence = <span class="hljs-built_in">Cast</span>&lt;UAnimSequence&gt;(AnimSequenceBase);<br><span class="hljs-keyword">if</span>(AnimSequence)<br>&#123;<br><span class="hljs-built_in">UE_LOG</span>(LogAnimation, Display, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Cast AnimSequence Success&quot;</span>));<br>AnimSequenceBase-&gt;<span class="hljs-built_in">Modify</span>();<br>TArray&lt;FTransformCurve&gt; NewTransformCurvesContainer;<br>TArray&lt;FName&gt; AnimationTrackNames = AnimSequence-&gt;<span class="hljs-built_in">GetAnimationTrackNames</span>();<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span>&amp;  T: TracksFTransformCurveContainer)<br>&#123;<br><span class="hljs-type">const</span> FName TrackName = T.Key;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; Name : AnimationTrackNames)<br>&#123;<br><span class="hljs-comment">// 只能把相同名称的赋值，不同的无法成功应用，会造成Crash，可以自己看看为什么</span><br><span class="hljs-keyword">if</span>(Name == TrackName)<br>&#123;<br><span class="hljs-built_in">UE_LOG</span>(LogAnimation, Display, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Animation track :  %s .&quot;</span>), *TrackName.<span class="hljs-built_in">ToString</span>());<br>NewTransformCurvesContainer.<span class="hljs-built_in">Add</span>(T.Value);<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 直接赋值 刷新就行了</span><br>AnimSequenceBase-&gt;RawCurveData.TransformCurves.<span class="hljs-built_in">Empty</span>();<br>AnimSequenceBase-&gt;RawCurveData.TransformCurves = NewTransformCurvesContainer;<br>AnimSequenceBase-&gt;<span class="hljs-built_in">RefreshCurveData</span>();<br><span class="hljs-built_in">GetModel</span>()-&gt;<span class="hljs-built_in">RefreshTracks</span>();<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// 这个地方原本是没有SubMenue的需要我们自己写个函数来生成</span><br><span class="hljs-function">TSharedRef&lt;SWidget&gt; <span class="hljs-title">FAnimTimelineTrack::BuildCurvesSubMenu</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-function">FMenuBuilder <span class="hljs-title">MenuBuilder</span><span class="hljs-params">(<span class="hljs-literal">true</span>, GetModel()-&gt;GetCommandList())</span></span>;<br>UAnimSequenceBase* AnimSequenceBase = <span class="hljs-built_in">GetModel</span>()-&gt;<span class="hljs-built_in">GetAnimSequenceBase</span>();<br><br>MenuBuilder.<span class="hljs-built_in">BeginSection</span>(<span class="hljs-string">&quot;Tracks&quot;</span>, <span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;AdditiveLayerTracksSection&quot;</span>, <span class="hljs-string">&quot;Tracks&quot;</span>));<br>&#123;<br><span class="hljs-keyword">if</span> (AnimSequenceBase-&gt;RawCurveData.TransformCurves.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br>MenuBuilder.<span class="hljs-built_in">AddMenuEntry</span>(<br><span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;CopyAllAdditiveLayerTracks&quot;</span>, <span class="hljs-string">&quot;Copy All Additive Layer Tracks&quot;</span>),<br><span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;CopyAllAdditiveLayerTracks_ToolTip&quot;</span>, <span class="hljs-string">&quot;Copy All Additive Layer Tracks&quot;</span>),<br><span class="hljs-built_in">FSlateIcon</span>(),<br><span class="hljs-built_in">FUIAction</span>(FExecuteAction::<span class="hljs-built_in">CreateSP</span>(<span class="hljs-keyword">this</span>, &amp;FAnimTimelineTrack::CopyAllAdditiveLayerTracks))<br>);<br>&#125;<br><span class="hljs-keyword">if</span> (TracksFTransformCurveContainer.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>&#123;<br>MenuBuilder.<span class="hljs-built_in">AddMenuEntry</span>(<br><span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;PasteAdditiveLayerTracks&quot;</span>, <span class="hljs-string">&quot;Paste Additive Layer Tracks&quot;</span>),<br><span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;PasteAdditiveLayerTracks_ToolTip&quot;</span>, <span class="hljs-string">&quot;Paste Additive Layer Tracks&quot;</span>),<br><span class="hljs-built_in">FSlateIcon</span>(),<br><span class="hljs-built_in">FUIAction</span>(FExecuteAction::<span class="hljs-built_in">CreateSP</span>(<span class="hljs-keyword">this</span>, &amp;FAnimTimelineTrack::PasteAdditiveLayerTracks))<br>);<br>&#125;<br>&#125;<br>MenuBuilder.<span class="hljs-built_in">EndSection</span>();<br><span class="hljs-keyword">return</span> MenuBuilder.<span class="hljs-built_in">MakeWidget</span>();<br>&#125;<br><br><span class="hljs-comment">// 上面那个生成子菜单的函数在这个里面调用</span><br><span class="hljs-function">TSharedRef&lt;SWidget&gt; <span class="hljs-title">FAnimTimelineTrack::GenerateContainerWidgetForOutliner</span><span class="hljs-params">(<span class="hljs-type">const</span> TSharedRef&lt;SAnimOutlinerItem&gt;&amp; InRow)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// ...</span><br><br>InnerHorizontalBox-&gt;<span class="hljs-built_in">AddSlot</span>()<br>.<span class="hljs-built_in">AutoWidth</span>()<br>.<span class="hljs-built_in">HAlign</span>(HAlign_Right)<br>.<span class="hljs-built_in">VAlign</span>(VAlign_Center)<br>.<span class="hljs-built_in">Padding</span>(OutlinerRightPadding, <span class="hljs-number">1.0f</span>)<br>[<br>PersonaUtils::<span class="hljs-built_in">MakeTrackButton</span>(<span class="hljs-built_in">LOCTEXT</span>(<span class="hljs-string">&quot;EditTracksButtonText&quot;</span>, <span class="hljs-string">&quot;Tracks&quot;</span>), FOnGetContent::<span class="hljs-built_in">CreateSP</span>(<span class="hljs-keyword">this</span>, &amp;FAnimTimelineTrack::BuildCurvesSubMenu), <span class="hljs-built_in">MakeAttributeSP</span>(<span class="hljs-keyword">this</span>, &amp;FAnimTimelineTrack::IsHovered))<br>];<br><br><span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>C++</tag>
      
      <tag>UE4 Editor</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：ShadecodeLibrary拆分</title>
    <link href="/posts/60086/"/>
    <url>/posts/60086/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>UE4的项目设置的Packaging中提供了Share Material Shader Code，开启选项后会把ShaderCode从每一个材质中拿出单独的放在一个.ushaderbytecode文件中，目的是减少包体大小，该文件会在游戏启动时加载。<br />如果是用UE4的Pak分包机制，那么打包过程会处理掉每个Pak中需要的Shader，不用自己去关心ShaderArchive的生成。如果是更新包的话，也有对应的方法去生成ShadeArchive文件的Patch。<br />由于目前的情况是并没有使用UE4的分包机制，这造成虽然启用了Share Material Shader Code，但是由于UE4的材质机制，单个材质会编译出多个Shader，每次只要涉及到Material改动都会让整个.ushaderbytecode文件变掉，再加上安卓端的Vulkan格式的ShaderArchive比较庞大，每次更新都需要将Global和Project两个ShaderArchive文件进行更新，很浪费资源，所以希望找到将ShaderArchive拆开。<br />期望的结果是，将Project的.ushaderbytecode文件分成几个，且不会同时需要更新，大小趋近。这样在美术更新了材质的时候，更新量不会很大。<br /><strong>如果是用UE的Pak机制，那么是完全不需要用到的</strong></p><h1 id="注意"><a class="markdownIt-Anchor" href="#注意"></a> 注意</h1><p>4.26中ShaderLibrary与4.27之后的差异较大，不过不同点是类的设计，具体方法是一致的，下文是在4.26的版本中完成的。</p><h1 id="shaderarchive生成过程"><a class="markdownIt-Anchor" href="#shaderarchive生成过程"></a> ShaderArchive生成过程</h1><p>首先看一下ShaderArchive文件是如何生成的<br />通过log查询源码，发现UCookOnTheFlyServer::SaveShaderLibrary方法<br />FShaderCodeLibrary结构体，是在cook阶段生成的Unique ShaderCode的集合，最后会保存为后缀.ushaderbytecode的文件。<br />在4.26中，在FShaderCodeLibraryImpl中，有一个数组EditorShaderCodeArchive，数组中的数据类型是FEditorShaderCodeArchive，FShaderCodeLibrary通过方法调用FShaderCodeLibrary::SaveShaderCode最后生成了ShaderArchive文件：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220510161437.png" alt="20220510161437" /><br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220510161455.png" alt="20220510161455" /><br />大致看一下该函数都做了什么</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * @description: </span><br><span class="hljs-comment"> * @param &#123;FString&amp;&#125; ShaderCodeDir</span><br><span class="hljs-comment"> * @param &#123;FString&amp;&#125; MetaOutputDir</span><br><span class="hljs-comment"> * @param &#123;TArray&lt;FName&gt;&amp;&#125; ShaderFormats    从目标平台获取到所有支持的shader格式</span><br><span class="hljs-comment"> *                                          TArray&lt;FName&gt; ShaderFormats;</span><br><span class="hljs-comment">                                            TargetPlatform-&gt;GetAllTargetedShaderFormats(ShaderFormats);</span><br><span class="hljs-comment"> * @return &#123;*&#125;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">SaveShaderCode</span><span class="hljs-params">(<span class="hljs-type">const</span> FString&amp; ShaderCodeDir, <span class="hljs-type">const</span> FString&amp; MetaOutputDir, <span class="hljs-type">const</span> TArray&lt;FName&gt;&amp; ShaderFormats, TArray&lt;FString&gt;&amp; OutSCLCSVPath, <span class="hljs-type">const</span> TArray&lt;TSet&lt;FName&gt;&gt;* ChunkAssignments)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">bool</span> bOk = ShaderFormats.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>;<br>    <span class="hljs-function">FScopeLock <span class="hljs-title">ScopeLock</span><span class="hljs-params">(&amp;ShaderCodeCS)</span></span>;<br>    <span class="hljs-keyword">for</span> (int32 i = <span class="hljs-number">0</span>; i &lt; ShaderFormats.<span class="hljs-built_in">Num</span>(); ++i)<br>    &#123;<br>        FName ShaderFormatName = ShaderFormats[i];<br>        EShaderPlatform SPlatform = <span class="hljs-built_in">ShaderFormatToLegacyShaderPlatform</span>(ShaderFormatName);<br>        &#123;<br>            <span class="hljs-comment">// EditorShaderCodeArchive 是在cook阶段每一个shader平台的shadercode的集合</span><br>            <span class="hljs-comment">// CodeArchive是SPlatform对应的FEditorShaderCodeArchive</span><br>            <span class="hljs-comment">// FEditorShaderCodeArchive是一个WITH_EDITOR的结构体 用来操作ShaderArchive</span><br>            FEditorShaderCodeArchive* CodeArchive = EditorShaderCodeArchive[SPlatform];<br>            <span class="hljs-keyword">if</span> (CodeArchive)<br>            &#123;<br>                <span class="hljs-comment">// Finalize进行了.ushaderbytecode文件的生成和保存</span><br>                bOk &amp;= CodeArchive-&gt;<span class="hljs-built_in">Finalize</span>(ShaderCodeDir, MetaOutputDir, bNativeFormat);<br>            &#125;<br>        &#125;<br>        &#123;<br>            <span class="hljs-comment">// StableArchive是对应的.scl.csv文件</span><br>            FEditorShaderStableInfo* StableArchive = EditorShaderStableInfo[SPlatform];<br>            <span class="hljs-keyword">if</span> (StableArchive)<br>            &#123;<br>                FString SCLCSVPath;<br>                <span class="hljs-comment">// Finalize是.scl.csv文件的生成和保存方法</span><br>                bOk &amp;= StableArchive-&gt;<span class="hljs-built_in">Finalize</span>(MetaOutputDir, bNativeFormat, SCLCSVPath);<br>                OutSCLCSVPath.<span class="hljs-built_in">Add</span>(SCLCSVPath);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> bOk;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以得知.ushaderbytecode文件其实是FShaderCodeLibrary中的数组EditorShaderCodeArchive中保存的数据类型FEditorShaderCodeArchive生成的。</p><h1 id="拆分方法"><a class="markdownIt-Anchor" href="#拆分方法"></a> 拆分方法</h1><p>那么再去看一下FEditorShaderCodeArchive这个结构体<br />首先发现一些看名字就知道干什么的，已经很可能已经满足我们拆分文件的需求的成员函数：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220510161643.png" alt="20220510161643" /></p><p>圈起来的函数的参数都直接写了 一个是int型的OtherShaderMapIndex，一个是OtherArchive，看起来就是从另一个Archive中通过一个index来给自己添加ShaderCode，看一下这个函数的实现：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">int32 <span class="hljs-title">AddShaderCode</span><span class="hljs-params">(int32 OtherShaderMapIndex, <span class="hljs-type">const</span> FEditorShaderCodeArchive &amp;OtherArchive)</span></span><br><span class="hljs-function"></span>&#123;<br>    int32 ShaderMapIndex = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (SerializedShaders.<span class="hljs-built_in">FindOrAddShaderMap</span>(OtherArchive.SerializedShaders.ShaderMapHashes[OtherShaderMapIndex], ShaderMapIndex,<br>                                             OtherArchive.SerializedShaders.ShaderCodeToAssets.<span class="hljs-built_in">Find</span>(OtherArchive.SerializedShaders.ShaderMapHashes[OtherShaderMapIndex])))<br>    &#123;<br>        <span class="hljs-comment">//通过OtherShaderMapIndex拿了另一个Ar的FShaderMapEntry</span><br>        <span class="hljs-type">const</span> FShaderMapEntry &amp;PrevShaderMapEntry = OtherArchive.SerializedShaders.ShaderMapEntries[OtherShaderMapIndex];<br>        FShaderMapEntry &amp;ShaderMapEntry = SerializedShaders.ShaderMapEntries[ShaderMapIndex];<br>        ShaderMapEntry.NumShaders = PrevShaderMapEntry.NumShaders;<br>        <span class="hljs-comment">// ShaderIndicesOffset 着色器索引偏移</span><br>        <span class="hljs-comment">// ShaderIndices 所有着色器贴图引用的着色器的平面数组。每个shadermap在此数组中都有一个范围，其开头存储为shadermap描述符（fshaderMapPentry）中的ShaderIndiesOffset</span><br>        <span class="hljs-comment">// 可以在没有任何参数的情况下增加元素。AddZeroed是直接用Memzero函数将内存置为0</span><br>        ShaderMapEntry.ShaderIndicesOffset = SerializedShaders.ShaderIndices.<span class="hljs-built_in">AddZeroed</span>(ShaderMapEntry.NumShaders);<br>        <span class="hljs-keyword">for</span> (uint32 i = <span class="hljs-number">0</span>; i &lt; ShaderMapEntry.NumShaders; ++i)<br>        &#123;<br>            <span class="hljs-type">const</span> int32 OtherShaderIndex = OtherArchive.SerializedShaders.ShaderIndices[PrevShaderMapEntry.ShaderIndicesOffset + i];<br>            int32 ShaderIndex = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">if</span> (SerializedShaders.<span class="hljs-built_in">FindOrAddShader</span>(OtherArchive.SerializedShaders.ShaderHashes[OtherShaderIndex], ShaderIndex))<br>            &#123;<br>                <span class="hljs-type">const</span> FShaderCodeEntry &amp;OtherShaderEntry = OtherArchive.SerializedShaders.ShaderEntries[OtherShaderIndex];<br>                SerializedShaders.ShaderEntries[ShaderIndex] = OtherShaderEntry;<br>                ShaderCode.<span class="hljs-built_in">Add</span>(OtherArchive.ShaderCode[OtherShaderIndex]);<br>                <span class="hljs-built_in">check</span>(ShaderCode.<span class="hljs-built_in">Num</span>() == SerializedShaders.ShaderEntries.<span class="hljs-built_in">Num</span>());<br>            &#125;<br>            SerializedShaders.ShaderIndices[ShaderMapEntry.ShaderIndicesOffset + i] = ShaderIndex;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> ShaderMapIndex;<br>&#125;<br></code></pre></td></tr></table></figure><p>发现果然是这样的，相当于我们可以创建一个新的FEditorShaderCodeArchive，命名为NewShaderArchive1，此时他是一个完全的空的对象。<br />再创建一个空的FEditorShaderCodeArchive，名字叫OldShaderArchive，我们把Cook生成的Project的通过Open方法读取进来。<br />我们的目的是把OldShaderArchive拆分成若干个新的，那么可以再继续创建需要的FEditorShaderCodeArchive。<br />现在我们已经有了Cook生成的.ushaderbytecode文件，也就是AddShaderCode方法的第二个参数，也有了要调用这个方法的NewShaderArchive1，那么第一个参数OtherShaderMapIndex是什么？<br />看一下在函数中这个int32是干什么的<br />OtherArchive.SerializedShaders.ShaderMapHashes[OtherShaderMapIndex]<br />OtherArchive是FEditorShaderCodeArchive<br />SerializedShaders是：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220510161811.png" alt="20220510161811" /></p><p>那么ShaderMapHashes是：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220510161837.png" alt="20220510161837" /></p><p>是这个数组的索引<br />那么最简单的拆分思路就是，假设这个数组一共有100个元素，那么可以每10个就创建一个新的FEditorShaderCodeArchive进行AddShaderCode操作，满十个就保存，就可以把一个巨大的ShaderArchive文件拆开了。<br />但这并不能满足我们的根本目的，我们的最终目的是减少更新量，希望美术在修改了一些材质实例的时候，尽可能影响到少数的ShaderArchive<br />那么就需要知道Material和MaterialInstance和FSerializedShaderArchive的关系了。</p><p>再看一下FSerializedShaderArchive这个结构体的内容<br />该结构体的注释写的是，序列化到磁盘的着色器代码存档部分（无情机翻）<br />成员变量ShaderMapHashes是一个FSHAHash的数组，注释为，所有shadermaps的Hash<br />下一个成员变量ShaderHashes也是一个FSHAHash数组，但是和ShaderMapHashes区别是，这是一个所有的shader的Hash的数组<br />那么shadermap是一个什么，在ShaderMapEntries的注释中看到，每一个shadermap可以引用（查询？）到任意数量的shader<br />这个引用关系是通过FShaderMapEntry建立的，暂不深究。<br />通过对ShaderMapHashes的所有引用发现，在UE的Pak机制下生成Patch的时候有这么一个方法：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220510161928.png" alt="20220510161928" /></p><p>可以看出，UE在生成ShaderArchive的Patch的时候，是将一个新的ShaderArchive文件和若干个旧的进行对比，对比的内容就是ShaderMapHash，差异部分通过AddShadercode<br />添加到新的ShaderArchive中。</p><p>其中 FEditorShaderCodeArchive的Finalize方法是ShaderArchive文件的二进制保存方法，在添加完毕Sahdercode之后可以调用该方法进行保存。</p><p>到了这里，已经有了将ShaderArchive拆开的基本方法，接下来需要考虑的是拆分的规则。</p><h1 id="拆分思路"><a class="markdownIt-Anchor" href="#拆分思路"></a> 拆分思路</h1><p>众所周知，Cook阶段生成ShaderArchive的同时还会生成ShaderAssetInfo文件：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220510161957.png" alt="20220510161957" /></p><p>该文件内是ShaderMapHash和起映射到的Assets，如图：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/202220220510162010.png" alt="20220510162010" /></p><p>通过Json文件可以获取到ShaderMapHash到Material（以及MaterialInstance）的映射，将映射反过来就是Asset到ShaderMapHash的关系。<br />通过ShaderMapHash可以获取到在ShaderArchive中对应的Index<br />对以上进行处理就得到了Asset——ShaderMapHash——Index<br />在项目中我们的材质和材质实例一般是这样的：</p><ul><li>Material_A<ul><li>MaterialInstance_A_01</li><li>MaterialInstance_A_02<ul><li>MTI_A_02_01</li></ul></li></ul></li><li>Material_B<ul><li>MaterialInstance_B_01</li></ul></li></ul><p>当一个Material被修改后，UE会去寻找被Material使用的.ush/.usf文件，把这些Material Graph转换成HLSL代码，开始编译shader，相关的MaterialInstance都会变动。<br />如果我们把上表中的Material_A和它的子类们放在一个ShaderArchive_A里，把Material_B放到ShaderArchive_B里，那么当A材质修改的时候，ShaderArchive_B是不会受到影响的。</p><p>这样看来，只需要获取材质和材质实例的父子关系，将同一个Material相关的所有Asset的ShaderHashMap都Add到同一个ShaderArchive中，就可以在美术更新的时候只影响到对应的ShaderArchive</p><p>只需要建立两张表：<br />Material——MaterialInstance<br />Asset——ShaderMapHash——Index</p><p>那么在分开Material的时候，就要根据具体项目的情况来考虑了，这个和美术资源的存放规则有关系，可以根据频繁修改的情况按照某一路径下来拆分，也可以考虑将某一个拥有大量子类的Material单独拆分，如果一个Material有大量的Material实例，最后编译出的shader体积是很大的，完全可以单独拆分出一个ShaderArchive</p><p>最后，在游戏启动的时候将所有的ShaderArchive进行加载，游戏就可以正常使用Shared Shader Code</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Rendering</tag>
      
      <tag>Material</tag>
      
      <tag>Shader</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：运行时获取UFont相关数据</title>
    <link href="/posts/26550/"/>
    <url>/posts/26550/</url>
    
    <content type="html"><![CDATA[<p>最近项目中要排查运行时字体的使用和内存占用情况，稍微看了一下相关的东西，简单整理一下，目测没啥用</p><h2 id="ufont相关类"><a class="markdownIt-Anchor" href="#ufont相关类"></a> UFont相关类</h2><p>去官网查了一些得知，UFont在运行时和非运行时有不同的缓存，运行时缓存包含了一些TTF文件，这些文件组合成了一个复合字体。<br />然后发现UFont有一个成员函数GetResourceSizeEx，继承自Uobject，大概看一下这个函数：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Get the size of the object/resource for use in memory tools or to display to artists/LDs in the Editor</span><br><span class="hljs-comment"> * This is the extended version which separates up the used memory into different memory regions (the actual definition of which may be platform specific).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @paramCumulativeResourceSizeStruct used to count up the cumulative size of the resource as to be displayed to artists/LDs in the Editor.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">GetResourceSizeEx</span><span class="hljs-params">(FResourceSizeEx&amp; CumulativeResourceSize)</span></span>;<br></code></pre></td></tr></table></figure><p>可以获得对象或者资源的内存使用情况，需要传入一个结构体FResourceSizeEx，那再去看一下这个结构体</p><div align=center><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220312220154.png"></div>就是专门给这个函数使用的用来计算资源内存使用情况的结构体  <p>= =emmm，还得继续看下这个结构体的具体情况，一个一个看</p><ul><li>ResourceSizeMode，资源占用内存情况的类型<br />可以看出这个是枚举，我们去看一下这个枚举EResourceSizeMode，只有两个值<ul><li>Exclusive，只显示这个UObject直接拥有的非UObject类型资源的内存使用情况，通常在runtime用</li><li>EstimatedTotal，包括本身和所有子UObject的独占资源和UObject序列化内存，但不包括外部引用或仅编辑器成员的内存。通常用在editor模式下。</li></ul></li><li>DedicatedSystemMemoryBytes<br />字面意思，系统专用内存，从系统专用内存（或者在一些统一内存类型的平台上交首选内存）分配给CPU资源的内存大小，单位是byte</li><li>SharedSystemMemoryBytes<br />共享系统内存，从非系统专用内存（非首选内存）分配给CPU的</li><li>DedicatedVideoMemoryBytes<br />视频专用内存，从专用视频内存（首选内存）分配的GPU资源的内存</li><li>SharedVideoMemoryBytes<br />共享视频内存，非系统专用内存（非首选内存）分配给GPU的</li><li>UnknownMemoryBytes<br />该资源所使用的内存是一个没有特别指定的内存区域</li></ul><p>看到这里大概了解了，我们构建一个结构体FResourceSizeEx，第一个参数是内存使用情况模式，会影响到子UObject占用内存是否统计，后面是将具体的内存占用在哪个区域给分开了，分成了五个指定的内存区。</p><p>回到GetResourceSizeEx()函数，看一下结构体传进去会干点什么0.0<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220312220207.png" alt="20220312220207" /><br />先判断了一下我们要查看的资源占用情况的类型，只有EstimatedTotal才会继续<br />= =但是在枚举中建议在运行时用Exclusive，行吧EstimatedTotal也不是不行，先继续看<br />创建了一个FArchiveCountMem，把自己传进去，通过GetMax方法拿到内存占用，添加到了结构体的系统专用内存的计数上<br />然后创建了子UObject的数组，获取所有的子UObject，在非编辑器模式下跳过检查分别再去调用他们的GetResourceSizeEx，全部放进传进来的FResourceSizeEx结构体中，这样子最后结构体里面的系统专用内存的值就是这个UObject占用的内存值了</p><p>再继续看UFont重载的对应方法<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220312220240.png" alt="20220312220240" /><br />在调用了基类方法之后，注释说嵌套的Texture和FontFace是包含在subobject里的，需要用EstimatedTotal，看来UFont是得这么操作了<br />接下来判断了了字体缓存的类型，确定是RunTime，然后判断资源占用情况的类型<br />然后是一个lambda函数GetTypefaceResourceSize，先看一下这个函数的参数和作用。<br />参数类型是FTypeface，函数内遍历Typeface的Fonts（类型是FTypefaceEntry），获取到每一个Fontface<br />接下来这个if判断十分迷惑，条件是非FontFace并且加载方式是LazyLoad，那么会去获取Font的文件名，在通过FileManager的FileSize方法去获取一个FileSize，如果大于0加到系统专用内存里。那我要是成功获取了FontFace不是反而不会走进去吗，到时候return出来ResourceSize里面不都是0吗？<br />对默认的Typeface和子Typeface都做了上述操作。</p><p>Font.h中可以看到UFont的成员变量：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220312220321.png" alt="20220312220321" /><br />看一下FCompositeFont这个结构体有哪些东西，发现在非仅限编辑器模式下有三个变量<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022/20220312220328.png" alt="20220312220328" /></p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>C++</tag>
      
      <tag>Program</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：Log综合</title>
    <link href="/posts/19416/"/>
    <url>/posts/19416/</url>
    
    <content type="html"><![CDATA[<h2 id="基本使用"><a class="markdownIt-Anchor" href="#基本使用"></a> 基本使用</h2><p>UE的log相关的一些tips，用于索引，部分细节忘记的时候快速查阅用</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">UE_LOG</span>(LogTemp, Warning, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Your message&quot;</span>));<br></code></pre></td></tr></table></figure><p>LogTemp是Log的Category，可以自定义<br />Warning是Log的显示级别，常用的有Display、Warning、Error<br />后面是Log的内容</p><h2 id="log显示级别"><a class="markdownIt-Anchor" href="#log显示级别"></a> Log显示级别</h2><p><a href="https://muchenhen.com/2022/02/18/UE4-Log%E6%98%BE%E7%A4%BA%E7%BA%A7%E5%88%AB/">显示级别</a></p><h2 id="shipping模式打印log"><a class="markdownIt-Anchor" href="#shipping模式打印log"></a> Shipping模式打印Log</h2><p><a href="https://muchenhen.com/2022/02/23/UE4%EF%BC%9AShipping%E6%A8%A1%E5%BC%8F%E6%89%93%E5%8D%B0Log/#ue4shipping%E6%A8%A1%E5%BC%8F%E6%89%93%E5%8D%B0log">Shipping模式打印Log</a></p><h2 id="log不同的数据类型"><a class="markdownIt-Anchor" href="#log不同的数据类型"></a> Log不同的数据类型</h2><p><a href="https://muchenhen.com/2022/03/12/UE4%EF%BC%9ALog%E4%B8%8D%E5%90%8C%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/">Log不同的数据类型</a></p><h2 id="log自定义category"><a class="markdownIt-Anchor" href="#log自定义category"></a> Log自定义Category</h2><p><a href="https://muchenhen.com/2022/03/12/UE4%EF%BC%9ALog%E8%87%AA%E5%AE%9A%E4%B9%89Category/">Log自定义Category</a></p><h2 id="log控制台相关"><a class="markdownIt-Anchor" href="#log控制台相关"></a> Log控制台相关</h2><p><a href="https://muchenhen.com/2022/03/12/UE4%EF%BC%9ALog%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%9B%B8%E5%85%B3/">Log控制台相关</a></p><h2 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考：</h2><ol><li><a href="https://unrealcommunity.wiki/logs-printing-messages-to-yourself-during-runtime-n5ifosqc">log综述</a></li><li><a href="https://forums.unrealengine.com/t/how-to-configure-logging-in-packaged-build/338009">How to configure logging in packaged build?</a></li><li><a href="https://docs.unrealengine.com/4.27/en-US/API/Runtime/Core/Logging/ELogVerbosity__Type/">ELogVerbosity::Type</a></li></ol>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Program</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：Log控制台相关</title>
    <link href="/posts/1051/"/>
    <url>/posts/1051/</url>
    
    <content type="html"><![CDATA[<h2 id="运行时控制台指令"><a class="markdownIt-Anchor" href="#运行时控制台指令"></a> 运行时控制台指令</h2><ul><li>Log list - 列出所有日志类别</li><li>Log list [string] - 列出包含string字符串的所有Category</li><li>Log reset - 将所有日志类别重置为其启动时默认值</li><li>Log [cat] off - 关闭Category的输出</li><li>Log [cat] on - 打开Category的输出</li><li>Log [cat] [level] - 设置Category的显示级别</li></ul><h2 id="ue-command-line"><a class="markdownIt-Anchor" href="#ue-command-line"></a> UE Command Line</h2><p>-LogCmds=“LogFirst verbose, LogSecond off”<br />把LogFirst可见性设置为verbose，把LogSecond可见性设置为off</p><h2 id="配置文件"><a class="markdownIt-Anchor" href="#配置文件"></a> 配置文件</h2><p>DefaultEngine.ini 或者项目的 Engine.ini:<br />[Core.Log]<br />global=Display  //将所有的Category设置为Display<br />LogFirst =verbose  //然后把LogFirst设置为verbose</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Program</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：Log自定义Category</title>
    <link href="/posts/4362/"/>
    <url>/posts/4362/</url>
    
    <content type="html"><![CDATA[<h1 id="自定义category"><a class="markdownIt-Anchor" href="#自定义category"></a> 自定义Category</h1><p>头文件中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">DECLARE_LOG_CATEGORY_EXTERN</span>(CategoryName, DefaultVerbosity, CompileTimeVerbosity);<br></code></pre></td></tr></table></figure><p>CategoryName就是Category名字<br />DefaultVerbosity是Log的默认显示级别，比如Display<br />CompileTimeVerbosity，编译器的Log级别<br />Log级别详见另一篇</p><p>源文件中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">DEFINE_LOG_CATEGORY</span>(CategoryName);<br></code></pre></td></tr></table></figure><h2 id="示例代码"><a class="markdownIt-Anchor" href="#示例代码"></a> 示例代码</h2><p>ObjectToLuaParser.h中：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">DECLARE_LOG_CATEGORY_EXTERN</span>(LogObjectToLua, Log, All);<br></code></pre></td></tr></table></figure><p>ObjectToLuaParser.cpp中：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">DEFINE_LOG_CATEGORY</span>(LogObjectToLua);<br><br><span class="hljs-built_in">UE_LOG</span>(LogObjectToLua, Warning, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Unrecognized Struct Property: %s&quot;</span>), *Property-&gt;<span class="hljs-built_in">GetName</span>());<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Program</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：Log不同的数据类型</title>
    <link href="/posts/7723/"/>
    <url>/posts/7723/</url>
    
    <content type="html"><![CDATA[<h1 id="log不同的数据类型"><a class="markdownIt-Anchor" href="#log不同的数据类型"></a> Log不同的数据类型</h1><h2 id="直接log"><a class="markdownIt-Anchor" href="#直接log"></a> 直接Log</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">UE_LOG</span>(YourLog,Warning,<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;This is a message to yourself during runtime!&quot;</span>));<br></code></pre></td></tr></table></figure><h2 id="fstring"><a class="markdownIt-Anchor" href="#fstring"></a> FString</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">UE_LOG</span>(YourLog,Warning,<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;MyCharacter&#x27;s Name is %s&quot;</span>), *MyCharacter-&gt;<span class="hljs-built_in">GetName</span>() );<br></code></pre></td></tr></table></figure><h2 id="bool"><a class="markdownIt-Anchor" href="#bool"></a> Bool</h2><p><strong>bool值不能直接b%</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">UE_LOG</span>(YourLog,Warning,<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;MyCharacter&#x27;s Bool is %s&quot;</span>), (MyCharacter-&gt;MyBool ? <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;True&quot;</span>) : <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;False&quot;</span>)));<br></code></pre></td></tr></table></figure><h2 id="float"><a class="markdownIt-Anchor" href="#float"></a> Float</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">UE_LOG</span>(YourLog,Warning,<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;MyCharacter&#x27;s Health is %f&quot;</span>), MyCharacter-&gt;Health );<br></code></pre></td></tr></table></figure><h2 id="fvector"><a class="markdownIt-Anchor" href="#fvector"></a> FVector</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">UE_LOG</span>(YourLog,Warning,<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;MyCharacter&#x27;s Location is %s&quot;</span>),  *MyCharacter-&gt;<span class="hljs-built_in">GetActorLocation</span>().<span class="hljs-built_in">ToString</span>());<br></code></pre></td></tr></table></figure><h2 id="fname"><a class="markdownIt-Anchor" href="#fname"></a> FName</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">UE_LOG</span>(YourLog,Warning,<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;MyCharacter&#x27;s FName is %s&quot;</span>), *MyCharacter-&gt;<span class="hljs-built_in">GetFName</span>().<span class="hljs-built_in">ToString</span>());<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Program</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：Shipping模式打印Log</title>
    <link href="/posts/11726/"/>
    <url>/posts/11726/</url>
    
    <content type="html"><![CDATA[<h1 id="ue4shipping模式打印log"><a class="markdownIt-Anchor" href="#ue4shipping模式打印log"></a> UE4：Shipping模式打印Log</h1><p>需要在Game.Target.cs中添加</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++">bUseLoggingInShipping = <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure><p>即可打开shipping版本的log。</p><p>在LogSuppressionInterface.cpp文件中，</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20220223204517.png" alt="20220223204517" /></p><p>-LogCmds的处理在Shipping版本被干掉了，需要Shipping版本的log参数控制就需要修改源码重新编译引擎<br />Android可以在Game目录下的UE4CommandLine.txt文件中填写控制台命令参数。</p><p>shipping版本在打包后的Enging.ini文件中依然可以通过<font color=FF7700>[Core.Log]</font>来对log进行显示级别控制，如果打开了LogCmds并且设置了参数则会被命令行覆盖。通过ini文件修改Log级别不需要对源码进行修改。<br />Android可以在\UE4Game\GameName\GameName\Saved\Config\Android路径下的Engine.ini来进行修改。</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Program</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：Log显示级别</title>
    <link href="/posts/12189/"/>
    <url>/posts/12189/</url>
    
    <content type="html"><![CDATA[<h1 id="ue4log显示级别"><a class="markdownIt-Anchor" href="#ue4log显示级别"></a> UE4：Log显示级别</h1><p>Log Verbosity Levels</p><p>Log的输出级别有四个地方控制</p><ol><li>CompileTime verbosity</li><li>Default verbosity</li><li>ini verbosity</li><li>Runtime verbosity</li></ol><p>CompileTime Verbosity和Default Verbosity指的就是</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">DECLARE_LOG_CATEGORY_EXTERN</span>(CategoryName, DefaultVerbosity, CompileTimeVerbosity)<br></code></pre></td></tr></table></figure><p>的参数<br />在源码里定义如下</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * A macro to declare a logging category as a C++ &quot;extern&quot;, usually declared in the header and paired with DEFINE_LOG_CATEGORY in the source. Accessible by all files that include the header.</span><br><span class="hljs-comment"> * @param CategoryName, category to declare</span><br><span class="hljs-comment"> * @param DefaultVerbosity, default run time verbosity</span><br><span class="hljs-comment"> * @param CompileTimeVerbosity, maximum verbosity to compile into the code</span><br><span class="hljs-comment"> **/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DECLARE_LOG_CATEGORY_EXTERN(CategoryName, DefaultVerbosity, CompileTimeVerbosity) \</span><br><span class="hljs-meta">extern struct FLogCategory##CategoryName : public FLogCategory<span class="hljs-string">&lt;ELogVerbosity::DefaultVerbosity, ELogVerbosity::CompileTimeVerbosity&gt;</span> \</span><br><span class="hljs-meta">&#123; \</span><br><span class="hljs-meta">FORCEINLINE FLogCategory##CategoryName() : FLogCategory(TEXT(#CategoryName)) &#123;&#125; \</span><br><span class="hljs-meta">&#125; CategoryName;</span><br></code></pre></td></tr></table></figure><p>编译时如果Default Verbosity甚至大于CompileTime Verbosity，这个log就不会被编译进代码，运行时就不存在这个log<br />Default Verbosity就是运行时默认的log级别<br />Ini verbosity是在DefaultEngine.ini添加配置来控制对应的log级别。在DefaultEngine.ini中添加section ：[Core.log]，可以控制log的显示级别.<br /><font color=FFFF00>eg:</font><br />log使用的时候是<br /><font color=FF7700>UE_LOG(CategoryName, Verbosity, Format, …)</font><br />在配置文件中加上log的section<br /><font color=FF7700>[Core.Log]<br />global=Log<br />LogAnimMontage = VeryVerbose</font><br />在ini中配置的级别会覆盖DefaultVerbosity<br />用控制台启动游戏时可以通过参数来调整log级别<br />比如: <font color=FF7700>-LogCmds=“foo verbose, bar off”</font><br />在游戏运行时还可以通过控制台命令修改显示级别<br />比如：<font color=FF7700>Log [cat] [level]</font><br />会覆盖ini中的配置</p><p>LogAnimMontage 是CategoryName，那么这个Category的log的输出级别控制就会被改为VeryVerbose<br />global则是其他没有单独指定的Category的输出级别<br />log的显示级别定义在LogVerbosity.h中，log输出的时候，只会输出小于等于设置的最高级别的log</p><p>eg:<br />我在一个函数里写了一堆log：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AMyCharacter::BeginPlay</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>Super::<span class="hljs-built_in">BeginPlay</span>();<br><span class="hljs-built_in">UE_LOG</span>(LogMylog, VeryVerbose, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Display Log.&quot;</span>));<br><span class="hljs-built_in">UE_LOG</span>(LogMylog, Verbose, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Display Log.&quot;</span>));<br><span class="hljs-built_in">UE_LOG</span>(LogMylog, Display, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Display Log.&quot;</span>));<br><span class="hljs-built_in">UE_LOG</span>(LogMylog, Warning, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Display Log.&quot;</span>));<br><span class="hljs-built_in">UE_LOG</span>(LogMylog, Error, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Display Log.&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>默认情况下打印出来的是这样：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20220222225351.png" alt="20220222225351" /></p><p>然后修改ini配置<br /><font color=FF7700>[Core.Log]<br />global= Error<br />LogMylog = VeryVerbose</font><br />启动后的log：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20220222231254.png" alt="20220222231254" /></p><p>官方文档<a href="https://docs.unrealengine.com/4.27/en-US/API/Runtime/Core/Logging/ELogVerbosity__Type/">ELogVerbosity</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">namespace</span> ELogVerbosity<br>&#123;<br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Type</span> : uint8<br>&#123;<br><span class="hljs-comment">/** Not used */</span><br>NoLogging= <span class="hljs-number">0</span>,<br><br><span class="hljs-comment">/** Always prints a fatal error to console (and log file) and crashes (even if logging is disabled) */</span><br>Fatal,<br><br><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * Prints an error to console (and log file). </span><br><span class="hljs-comment"> * Commandlets and the editor collect and report errors. Error messages result in commandlet failure.</span><br><span class="hljs-comment"> */</span><br>Error,<br><br><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * Prints a warning to console (and log file).</span><br><span class="hljs-comment"> * Commandlets and the editor collect and report warnings. Warnings can be treated as an error.</span><br><span class="hljs-comment"> */</span><br>Warning,<br><br><span class="hljs-comment">/** Prints a message to console (and log file) */</span><br>Display,<br><br><span class="hljs-comment">/** Prints a message to a log file (does not print to console) */</span><br>Log,<br><br><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * Prints a verbose message to a log file (if Verbose logging is enabled for the given category, </span><br><span class="hljs-comment"> * usually used for detailed logging) </span><br><span class="hljs-comment"> */</span><br>Verbose,<br><br><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * Prints a verbose message to a log file (if VeryVerbose logging is enabled, </span><br><span class="hljs-comment"> * usually used for detailed logging that would otherwise spam output) </span><br><span class="hljs-comment"> */</span><br>VeryVerbose,<br><br><span class="hljs-comment">// Log masks and special Enum values</span><br><br>All= VeryVerbose,<br>NumVerbosity,<br>VerbosityMask= <span class="hljs-number">0xf</span>,<br>SetColor= <span class="hljs-number">0x40</span>, <span class="hljs-comment">// not actually a verbosity, used to set the color of an output device </span><br>BreakOnLog= <span class="hljs-number">0x80</span><br>&#125;;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Program</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TinyRenderer 1：Bresenham画线算法</title>
    <link href="/posts/17627/"/>
    <url>/posts/17627/</url>
    
    <content type="html"><![CDATA[<p>先是直接把书上看过的实现了一下，然后看了一下这节原作者写的内容，感觉标题可以改下，但是这里用原文的</p><h2 id="书上看的"><a class="markdownIt-Anchor" href="#书上看的"></a> 书上看的</h2><p>直线段的扫描转换总结在这里：</p><p><a href="https://muchenhen.com/2021/12/26/%E7%9B%B4%E7%BA%BF%E6%AE%B5%E6%89%AB%E6%8F%8F%E8%BD%AC%E6%8D%A2%E7%AE%97%E6%B3%95/">直线段扫描转换</a></p><p>结合本课程实现的算法源码</p><p>DDA直线算法</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">//数值微分画线算法</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawLineDDA</span><span class="hljs-params">(<span class="hljs-type">const</span> Point&amp; P1, <span class="hljs-type">const</span> Point&amp; P2, TGAImage&amp; Image, <span class="hljs-type">const</span> TGAColor&amp; Color)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">if</span> (P1.x == P2.x)<br><span class="hljs-keyword">return</span>;<br><span class="hljs-type">float</span> k = <span class="hljs-built_in">fabs</span>((P2.y - P1.y) / P2.x - P1.x);<br><br><span class="hljs-type">float</span> x = P1.x;<br><span class="hljs-type">float</span> y = P1.y;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> &lt; k &lt;= <span class="hljs-number">1</span>)<br>&#123;<br>k = k;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>k = <span class="hljs-number">1</span> / k;<br><span class="hljs-built_in">Swap</span>(x, y);<br>&#125;<br><br><span class="hljs-keyword">for</span> (; x &lt;= P2.x; x++)<br>&#123;<br><span class="hljs-keyword">auto</span> realY = <span class="hljs-built_in">floor</span>(y + <span class="hljs-number">0.5</span>);<br>Image.<span class="hljs-built_in">set</span>(x, realY, Color);<br>std::cout &lt;&lt; x &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; realY &lt;&lt; std::endl;<br>y = y + k;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后是中点画线算法的实现：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">//中点画线算法</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawLineMidPoint</span><span class="hljs-params">(<span class="hljs-type">const</span> Point&amp; P1, <span class="hljs-type">const</span> Point&amp; P2, TGAImage&amp; Image, <span class="hljs-type">const</span> TGAColor&amp; Color)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> A = P1.y - P2.y;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> B = P2.x - P1.x;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> C = P2.x * P1.y - P1.x * P2.y;<br><span class="hljs-type">int</span> d = A + A + B;<br><br><span class="hljs-type">int</span> x = <span class="hljs-built_in">floor</span>(P1.x);<br><span class="hljs-type">int</span> y = <span class="hljs-built_in">floor</span>(P1.y);<br><br><span class="hljs-type">float</span> deltaD;<br><br><span class="hljs-keyword">for</span> (; x &lt;= P2.x; x++)<br>&#123;<br>Image.<span class="hljs-built_in">set</span>(x, y, Color);<br>std::cout &lt;&lt; <span class="hljs-string">&quot;x: &quot;</span> &lt;&lt; x &lt;&lt; <span class="hljs-string">&quot; ,y: &quot;</span> &lt;&lt; y &lt;&lt; <span class="hljs-string">&quot; ,d: &quot;</span> &lt;&lt; d &lt;&lt; std::endl;<br><br><span class="hljs-keyword">if</span> (d &lt; <span class="hljs-number">0</span>)<br>&#123;<br>deltaD = A + B;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>deltaD = A;<br>&#125;<br>d += deltaD;<br><br><span class="hljs-keyword">if</span> (d &lt; <span class="hljs-number">0</span>)<br>&#123;<br>y++;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>y = y;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Bresenham画线算法的实现：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// Bresenham画线算法</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DrawLineBresenham</span><span class="hljs-params">(<span class="hljs-type">const</span> Point&amp; P1, <span class="hljs-type">const</span> Point&amp; P2, TGAImage&amp; Image, <span class="hljs-type">const</span> TGAColor&amp; Color)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> dx = P2.x - P1.x;<br><span class="hljs-type">const</span> <span class="hljs-type">int</span> dy = P2.y - P1.y;<br><span class="hljs-type">int</span> g = -dx;<br><span class="hljs-type">int</span> x = P1.x;<br><span class="hljs-type">int</span> y = P1.y;<br><span class="hljs-keyword">for</span> (; x &lt;= P2.x; x++)<br>&#123;<br>Image.<span class="hljs-built_in">set</span>(x, y, Color);<br>std::cout &lt;&lt; <span class="hljs-string">&quot;x: &quot;</span> &lt;&lt; x &lt;&lt; <span class="hljs-string">&quot; ,y: &quot;</span> &lt;&lt; y &lt;&lt; std::endl;<br>g = g + dy + dy;<br><span class="hljs-keyword">if</span> (g &gt;= <span class="hljs-number">0</span>)<br>&#123;<br>y++;<br>g = g - dx - dx;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>然后看一下这节的原文主要想干什么</p><h2 id="课程原文"><a class="markdownIt-Anchor" href="#课程原文"></a> 课程原文</h2><h3 id="首次尝试"><a class="markdownIt-Anchor" href="#首次尝试"></a> 首次尝试</h3><p>这一节的目标是渲染线框出来，画线框先得会画线，那么最简单的画线要怎么画，像这样：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">line</span><span class="hljs-params">(<span class="hljs-type">int</span> x0, <span class="hljs-type">int</span> y0, <span class="hljs-type">int</span> x1, <span class="hljs-type">int</span> y1, TGAImage &amp;image, TGAColor color)</span> </span>&#123; <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">float</span> t=<span class="hljs-number">0.</span>; t&lt;<span class="hljs-number">1.</span>; t+=<span class="hljs-number">.01</span>) <br>&#123; <br>        <span class="hljs-type">int</span> x = x0 + (x1-x0)*t; <br>        <span class="hljs-type">int</span> y = y0 + (y1-y0)*t; <br>        image.<span class="hljs-built_in">set</span>(x, y, color); <br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure><p>emmm，这个就是直接从第一个点开始，x和y按照参数方程的形式，按照0.01的进度增加x和y，参数范围0到1</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20220101203306.png" alt="20220101203306" /></p><p>画出来长上面这个样子</p><h3 id="第二次尝试"><a class="markdownIt-Anchor" href="#第二次尝试"></a> 第二次尝试</h3><p>第一次尝试的代码除了效率低，还有个问题就是递增的大小如果变成0.1的话就会画成这样：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20220101203503.png" alt="20220101203503" /></p><p>最简单的改进就是，我们只计算我们要画的像素，少算一些完全没法画出来的浮点：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">line</span><span class="hljs-params">(<span class="hljs-type">int</span> x0, <span class="hljs-type">int</span> y0, <span class="hljs-type">int</span> x1, <span class="hljs-type">int</span> y1, TGAImage &amp;image, TGAColor color)</span> </span><br><span class="hljs-function"></span>&#123; <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x=x0; x&lt;=x1; x++) &#123; <br>        <span class="hljs-type">float</span> t = (x-x0)/(<span class="hljs-type">float</span>)(x1-x0); <br>        <span class="hljs-type">int</span> y = y0*(<span class="hljs-number">1.</span>-t) + y1*t; <br>        image.<span class="hljs-built_in">set</span>(x, y, color); <br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure><p>众所周知像素点是整的，不是浮点的，那每次就用x算出当前的参数，再去求y，反正一定是整数，下一个x一定是上一个x+1（如果是x递增的话）</p><p>然而上面那个代码有问题的</p><p>试图画三条线出来：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-built_in">line</span>(<span class="hljs-number">13</span>, <span class="hljs-number">20</span>, <span class="hljs-number">80</span>, <span class="hljs-number">40</span>, image, white); <br><span class="hljs-built_in">line</span>(<span class="hljs-number">20</span>, <span class="hljs-number">13</span>, <span class="hljs-number">40</span>, <span class="hljs-number">80</span>, image, red); <br><span class="hljs-built_in">line</span>(<span class="hljs-number">80</span>, <span class="hljs-number">40</span>, <span class="hljs-number">13</span>, <span class="hljs-number">20</span>, image, red);<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20220101204100.png" alt="20220101204100" /></p><p>第一条线正常</p><p>第二条线稀稀拉拉的</p><p>第三条线无了……但是理论上第三条线和第一条线画出来应该是一模一样的，只是颜色变成红色</p><p>原因就是循环根本进不去：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20220101205140.png" alt="20220101205140" /></p><h3 id="第三次尝试"><a class="markdownIt-Anchor" href="#第三次尝试"></a> 第三次尝试</h3><p>像前面第二根线，交换一下起点和终点就可以了</p><p>修改之后的代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">line</span><span class="hljs-params">(<span class="hljs-type">int</span> x0, <span class="hljs-type">int</span> y0, <span class="hljs-type">int</span> x1, <span class="hljs-type">int</span> y1, TGAImage &amp;image, TGAColor color)</span> </span>&#123; <br>    <span class="hljs-type">bool</span> steep = <span class="hljs-literal">false</span>; <br>    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">abs</span>(x0-x1)&lt;std::<span class="hljs-built_in">abs</span>(y0-y1)) &#123; <span class="hljs-comment">// if the line is steep, we transpose the image </span><br>        std::<span class="hljs-built_in">swap</span>(x0, y0); <br>        std::<span class="hljs-built_in">swap</span>(x1, y1); <br>        steep = <span class="hljs-literal">true</span>; <br>    &#125; <br>    <span class="hljs-keyword">if</span> (x0&gt;x1) &#123; <span class="hljs-comment">// make it left−to−right </span><br>        std::<span class="hljs-built_in">swap</span>(x0, x1); <br>        std::<span class="hljs-built_in">swap</span>(y0, y1); <br>    &#125; <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x=x0; x&lt;=x1; x++) &#123; <br>        <span class="hljs-type">float</span> t = (x-x0)/(<span class="hljs-type">float</span>)(x1-x0); <br>        <span class="hljs-type">int</span> y = y0*(<span class="hljs-number">1.</span>-t) + y1*t; <br>        <span class="hljs-keyword">if</span> (steep) &#123; <br>            image.<span class="hljs-built_in">set</span>(y, x, color); <span class="hljs-comment">// if transposed, de−transpose </span><br>        &#125; <span class="hljs-keyword">else</span> &#123; <br>            image.<span class="hljs-built_in">set</span>(x, y, color); <br>        &#125; <br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure><p>能正常画出来</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20220101205948.png" alt="20220101205948" /></p><h3 id="第四次"><a class="markdownIt-Anchor" href="#第四次"></a> 第四次</h3><p>这里原作者贴上了前面几个的效率比较情况：</p><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs zephir">%   cumulative   <span class="hljs-keyword">self</span>              <span class="hljs-keyword">self</span>     total <br> time   seconds   seconds    calls  ms/call  ms/call  name <br> <span class="hljs-number">69.16</span>      <span class="hljs-number">2.95</span>     <span class="hljs-number">2.95</span>  <span class="hljs-number">3000000</span>     <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span>  line(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, TGAImage&amp;, TGAColor) <br> <span class="hljs-number">19.46</span>      <span class="hljs-number">3.78</span>     <span class="hljs-number">0.83</span> <span class="hljs-number">204000000</span>     <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span>  TGAImage::set(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, TGAColor) <br>  <span class="hljs-number">8.91</span>      <span class="hljs-number">4.16</span>     <span class="hljs-number">0.38</span> <span class="hljs-number">207000000</span>     <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span>  TGAColor::TGAColor(TGAColor <span class="hljs-keyword">const</span>&amp;) <br>  <span class="hljs-number">1.64</span>      <span class="hljs-number">4.23</span>     <span class="hljs-number">0.07</span>        <span class="hljs-number">2</span>    <span class="hljs-number">35.04</span>    <span class="hljs-number">35.04</span>  TGAColor::TGAColor(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>) <br>  <span class="hljs-number">0.94</span>      <span class="hljs-number">4.27</span>     <span class="hljs-number">0.04</span>                             TGAImage::get(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>)<br></code></pre></td></tr></table></figure><p><strong>无情机翻</strong><br />我们应该注意，每个除法都有相同的除数。让我们把它从循环中去掉。误差变量给出了从当前（x，y）像素到最佳直线的距离。每次误差大于一个像素时，我们将y增加（或减少）一个，并将误差减少一个。</p><p>建议直接去看总结的直线段扫描转换……</p><p>改完后这样：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">line</span><span class="hljs-params">(<span class="hljs-type">int</span> x0, <span class="hljs-type">int</span> y0, <span class="hljs-type">int</span> x1, <span class="hljs-type">int</span> y1, TGAImage &amp;image, TGAColor color)</span> </span>&#123; <br>    <span class="hljs-type">bool</span> steep = <span class="hljs-literal">false</span>; <br>    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">abs</span>(x0-x1)&lt;std::<span class="hljs-built_in">abs</span>(y0-y1)) &#123; <br>        std::<span class="hljs-built_in">swap</span>(x0, y0); <br>        std::<span class="hljs-built_in">swap</span>(x1, y1); <br>        steep = <span class="hljs-literal">true</span>; <br>    &#125; <br>    <span class="hljs-keyword">if</span> (x0&gt;x1) &#123; <br>        std::<span class="hljs-built_in">swap</span>(x0, x1); <br>        std::<span class="hljs-built_in">swap</span>(y0, y1); <br>    &#125; <br>    <span class="hljs-type">int</span> dx = x1-x0; <br>    <span class="hljs-type">int</span> dy = y1-y0; <br>    <span class="hljs-type">float</span> derror = std::<span class="hljs-built_in">abs</span>(dy/<span class="hljs-built_in">float</span>(dx)); <br>    <span class="hljs-type">float</span> error = <span class="hljs-number">0</span>; <br>    <span class="hljs-type">int</span> y = y0; <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x=x0; x&lt;=x1; x++) &#123; <br>        <span class="hljs-keyword">if</span> (steep) &#123; <br>            image.<span class="hljs-built_in">set</span>(y, x, color); <br>        &#125; <span class="hljs-keyword">else</span> &#123; <br>            image.<span class="hljs-built_in">set</span>(x, y, color); <br>        &#125; <br>        error += derror; <br>        <span class="hljs-keyword">if</span> (error&gt;<span class="hljs-number">.5</span>) &#123; <br>            y += (y1&gt;y0?<span class="hljs-number">1</span>:<span class="hljs-number">-1</span>); <br>            error -= <span class="hljs-number">1.</span>; <br>        &#125; <br>    &#125; <br>&#125; <br></code></pre></td></tr></table></figure><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs zephir">%   cumulative   <span class="hljs-keyword">self</span>              <span class="hljs-keyword">self</span>     total <br> time   seconds   seconds    calls  ms/call  ms/call  name <br> <span class="hljs-number">42.77</span>      <span class="hljs-number">0.91</span>     <span class="hljs-number">0.91</span> <span class="hljs-number">204000000</span>     <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span>  TGAImage::set(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, TGAColor) <br> <span class="hljs-number">30.08</span>      <span class="hljs-number">1.55</span>     <span class="hljs-number">0.64</span>  <span class="hljs-number">3000000</span>     <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span>  line(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, TGAImage&amp;, TGAColor) <br> <span class="hljs-number">21.62</span>      <span class="hljs-number">2.01</span>     <span class="hljs-number">0.46</span> <span class="hljs-number">204000000</span>     <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span>  TGAColor::TGAColor(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>) <br>  <span class="hljs-number">1.88</span>      <span class="hljs-number">2.05</span>     <span class="hljs-number">0.04</span>        <span class="hljs-number">2</span>    <span class="hljs-number">20.02</span>    <span class="hljs-number">20.02</span>  TGAColor::TGAColor(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>) <br></code></pre></td></tr></table></figure><h3 id="第五次"><a class="markdownIt-Anchor" href="#第五次"></a> 第五次</h3><p><strong>无情机翻</strong></p><p>为什么我们需要浮点数？唯一的原因是在循环体中用dx进行一次除法并与.5进行比较。我们可以通过用另一个变量替换错误变量来消除浮点。我们称之为error2，假设它等于error<em>dx</em>2。以下是等效代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">line</span><span class="hljs-params">(<span class="hljs-type">int</span> x0, <span class="hljs-type">int</span> y0, <span class="hljs-type">int</span> x1, <span class="hljs-type">int</span> y1, TGAImage &amp;image, TGAColor color)</span> </span>&#123; <br>    <span class="hljs-type">bool</span> steep = <span class="hljs-literal">false</span>; <br>    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">abs</span>(x0-x1)&lt;std::<span class="hljs-built_in">abs</span>(y0-y1)) &#123; <br>        std::<span class="hljs-built_in">swap</span>(x0, y0); <br>        std::<span class="hljs-built_in">swap</span>(x1, y1); <br>        steep = <span class="hljs-literal">true</span>; <br>    &#125; <br>    <span class="hljs-keyword">if</span> (x0&gt;x1) &#123; <br>        std::<span class="hljs-built_in">swap</span>(x0, x1); <br>        std::<span class="hljs-built_in">swap</span>(y0, y1); <br>    &#125; <br>    <span class="hljs-type">int</span> dx = x1-x0; <br>    <span class="hljs-type">int</span> dy = y1-y0; <br>    <span class="hljs-type">int</span> derror2 = std::<span class="hljs-built_in">abs</span>(dy)*<span class="hljs-number">2</span>; <br>    <span class="hljs-type">int</span> error2 = <span class="hljs-number">0</span>; <br>    <span class="hljs-type">int</span> y = y0; <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x=x0; x&lt;=x1; x++) &#123; <br>        <span class="hljs-keyword">if</span> (steep) &#123; <br>            image.<span class="hljs-built_in">set</span>(y, x, color); <br>        &#125; <span class="hljs-keyword">else</span> &#123; <br>            image.<span class="hljs-built_in">set</span>(x, y, color); <br>        &#125; <br>        error2 += derror2; <br>        <span class="hljs-keyword">if</span> (error2 &gt; dx) &#123; <br>            y += (y1&gt;y0?<span class="hljs-number">1</span>:<span class="hljs-number">-1</span>); <br>            error2 -= dx*<span class="hljs-number">2</span>; <br>        &#125; <br>    &#125; <br>&#125; <br></code></pre></td></tr></table></figure><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs zephir">%   cumulative   <span class="hljs-keyword">self</span>              <span class="hljs-keyword">self</span>     total <br> time   seconds   seconds    calls  ms/call  ms/call  name <br> <span class="hljs-number">42.77</span>      <span class="hljs-number">0.91</span>     <span class="hljs-number">0.91</span> <span class="hljs-number">204000000</span>     <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span>  TGAImage::set(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, TGAColor) <br> <span class="hljs-number">30.08</span>      <span class="hljs-number">1.55</span>     <span class="hljs-number">0.64</span>  <span class="hljs-number">3000000</span>     <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span>  line(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, TGAImage&amp;, TGAColor) <br> <span class="hljs-number">21.62</span>      <span class="hljs-number">2.01</span>     <span class="hljs-number">0.46</span> <span class="hljs-number">204000000</span>     <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span>  TGAColor::TGAColor(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>) <br>  <span class="hljs-number">1.88</span>      <span class="hljs-number">2.05</span>     <span class="hljs-number">0.04</span>        <span class="hljs-number">2</span>    <span class="hljs-number">20.02</span>    <span class="hljs-number">20.02</span>  TGAColor::TGAColor(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span>) <br></code></pre></td></tr></table></figure><p>现在，通过引用传递颜色(或者只是启用编译标志-O3)，就可以在函数调用过程中删除不必要的副本，这就完成了。在代码中不是单个的乘法或除法。执行时间从2.95秒减少到0.64秒。</p><h2 id="星际战甲不是-线框渲染"><a class="markdownIt-Anchor" href="#星际战甲不是-线框渲染"></a> <s>星际战甲（不是）</s> 线框渲染</h2><p>这里采用了obJ文件来读取模型</p><p>obj文件格式很简单，这里先不提了，回头再水篇（不是</p><p>这里是还没写的obj模型文件的链接占坑</p><p>这里需要自己想办法弄一下模型读取和相关的数学库，可以直接考虑用原作者写的：</p><p><a href="https://github.com/ssloy/tinyrenderer/tree/f6fecb7ad493264ecd15e230411bfb1cca539a12">原作者的代码</a></p><p>我这里自己弄了一下，回头obj文章的里面</p><p>这节完成后会画出来这个：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20220101211621.png" alt="20220101211621" /></p>]]></content>
    
    
    
    <tags>
      
      <tag>Renderer</tag>
      
      <tag>CG</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>直线段扫描转换算法</title>
    <link href="/posts/51990/"/>
    <url>/posts/51990/</url>
    
    <content type="html"><![CDATA[<p>本文内容总结自孙家广《计算机图形学》</p><p>直线段绘制算法的发展基本是从<a href="https://en.wikipedia.org/wiki/Digital_differential_analyzer_(graphics_algorithm)">数值微分法</a></p><p>到中点画线法</p><p>再到<a href="https://zh.wikipedia.org/wiki/%E5%B8%83%E9%9B%B7%E6%A3%AE%E6%BC%A2%E5%A7%86%E7%9B%B4%E7%B7%9A%E6%BC%94%E7%AE%97%E6%B3%95">Bresenham画线算法</a></p><p>目前流行的渲染器使用的都是Bresenham画线算法，前两个也可以了解一下</p><h1 id="数值微分直线算法"><a class="markdownIt-Anchor" href="#数值微分直线算法"></a> 数值微分直线算法</h1><p>众所周知我们生活的现实世界的一切都是离散的（我胡说的），DDA直线算法就是用离散像素点去逼近直线段的一种算法。</p><p>我们先来看一下直线的函数表达，最常用的斜截式（顺便练练Markdown的数学公式= =）</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>y</mi><mo>=</mo><mi>k</mi><mi>x</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">y=kx+b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi><mo>=</mo><mfrac><mrow><mi mathvariant="normal">Δ</mi><mi>y</mi></mrow><mrow><mi mathvariant="normal">Δ</mi><mi>x</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">k=\frac{\Delta y}{\Delta x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.0463299999999998em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603299999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathdefault">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>显示屏幕无论分辨率有多少总之还是一个一个点，在画线段的时候，已知两个端点，就是要把中间的点画出来，我们假设起点<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mi>x</mi><mn>1</mn><mo separator="true">,</mo><mi>y</mi><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x1,y1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>，终点<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mi>x</mi><mn>2</mn><mo separator="true">,</mo><mi>y</mi><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x2,y2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mord">2</span><span class="mclose">)</span></span></span></span>，画线段时我们从x1开始，再怎么样x轴的增量也得是整数，1的整数倍，那么很自然的可以得出以下结论：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>=</mo><mi>k</mi><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">y_i=kx_i+b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><mi>k</mi><msub><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">y_{i+1}=kx_{i+1}+b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.638891em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.902771em;vertical-align:-0.208331em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span></span></span></span></span></p><p>由于步长一定是1的倍数</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>k</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>+</mo><mi>b</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>k</mi><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mi>k</mi><mo>+</mo><mi>b</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>k</mi><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mi>b</mi><mo>+</mo><mi>k</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>y</mi><mi>i</mi></msub><mo>+</mo><mi>k</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>y</mi><mi>i</mi></msub><mo>+</mo><mi>k</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}  y_{i+1}&amp;=k(x_i+1)+b\\  &amp;=kx_i+k+b\\  &amp;=kx_i+b+k\\  &amp;=y_i+k\\  y_{i+1}&amp;=y_i+k\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.500000000000002em;vertical-align:-3.5000000000000018em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4em;"><span style="top:-6.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.659999999999999em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-3.1599999999999984em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-1.6599999999999984em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-0.15999999999999837em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.5000000000000018em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4em;"><span style="top:-6.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">b</span></span></span><span style="top:-4.659999999999999em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">b</span></span></span><span style="top:-3.1599999999999984em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span><span style="top:-1.6599999999999984em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span><span style="top:-0.15999999999999837em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.5000000000000018em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>可以发现<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>的步长增量是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span></p><p>举个例子：</p><p>我们要画出<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mn>0</mn></msub><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_0(0,0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span>到<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mn>5</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_1(5,3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mclose">)</span></span></span></span>的直线段。</p><p>用PS随便画了一下，长这个样子：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20211226172334.png" alt="20211226172334" /></p><p>推算过程如下：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20211226172421.png" alt="20211226172421" /></p><p>加0.5是为了向下取整的时候减少误差，比如<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mn>1.7</mn><mo separator="true">,</mo><mn>0.8</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(1.7,0.8)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord">1</span><span class="mord">.</span><span class="mord">7</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mclose">)</span></span></span></span>这个点更接近的整数点应该是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>2</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(2,1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>，直接向下取整会变成<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1,0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span></p><p><strong>那为啥不四舍五入呢</strong></p><p>四舍五入也是加0.5再向下取整</p><p>DDA算法有比较明显的缺点，斜率大于1的线段取点会不正常：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>y</mi><mo>=</mo><mn>1.5</mn><mi>x</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y=1.5x+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span></p><p>我们画一个<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(0,0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span>到<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mn>5</mn><mo separator="true">,</mo><mn>8.5</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(5,8.5)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">8</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span></span></span></span></p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20211226211219.png" alt="20211226211219" /></p><p>已经很难说这是个线了……取点太稀疏，中间直接断掉了</p><h1 id="中点画线算法"><a class="markdownIt-Anchor" href="#中点画线算法"></a> 中点画线算法</h1><p>这个算法在数值微分算法上改进，数值微分法步进增量一般情况下都是小数，中点画线可以改进为整数。</p><p>我们知道直线的一般式方程是这样的：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mi>x</mi><mo>+</mo><mi>B</mi><mi>y</mi><mo>+</mo><mi>C</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">Ax+By+C=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">A</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mo>=</mo><mo>−</mo><mo stretchy="false">(</mo><mi mathvariant="normal">Δ</mi><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A=-(\Delta y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">−</span><span class="mopen">(</span><span class="mord">Δ</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>B</mi><mo>=</mo><mi mathvariant="normal">Δ</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">B=\Delta x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Δ</span><span class="mord mathdefault">x</span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mo>=</mo><mo>−</mo><mi>B</mi><mo stretchy="false">(</mo><mi mathvariant="normal">Δ</mi><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C=-B(\Delta x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mopen">(</span><span class="mord">Δ</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span></span></p><p>对于直线<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>F</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">F(x,y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>，点有三种情况</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>F</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0</mn><mspace width="1em"/><mi mathvariant="normal">点</mi><mi mathvariant="normal">在</mi><mi mathvariant="normal">直</mi><mi mathvariant="normal">线</mi><mi mathvariant="normal">上</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>F</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>&gt;</mo><mn>0</mn><mspace width="1em"/><mi mathvariant="normal">点</mi><mi mathvariant="normal">在</mi><mi mathvariant="normal">直</mi><mi mathvariant="normal">线</mi><mi mathvariant="normal">上</mi><mi mathvariant="normal">方</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>F</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>&lt;</mo><mn>0</mn><mspace width="1em"/><mi mathvariant="normal">点</mi><mi mathvariant="normal">在</mi><mi mathvariant="normal">直</mi><mi mathvariant="normal">线</mi><mi mathvariant="normal">下</mi><mi mathvariant="normal">方</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}F(x,y)&amp;=0\quad点在直线上\\F(x,y)&amp;&gt;0\quad点在直线上方\\F(x,y)&amp;&lt;0\quad点在直线下方\\\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.500000000000002em;vertical-align:-2.000000000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:1em;"></span><span class="mord cjk_fallback">点</span><span class="mord cjk_fallback">在</span><span class="mord cjk_fallback">直</span><span class="mord cjk_fallback">线</span><span class="mord cjk_fallback">上</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:1em;"></span><span class="mord cjk_fallback">点</span><span class="mord cjk_fallback">在</span><span class="mord cjk_fallback">直</span><span class="mord cjk_fallback">线</span><span class="mord cjk_fallback">上</span><span class="mord cjk_fallback">方</span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:1em;"></span><span class="mord cjk_fallback">点</span><span class="mord cjk_fallback">在</span><span class="mord cjk_fallback">直</span><span class="mord cjk_fallback">线</span><span class="mord cjk_fallback">下</span><span class="mord cjk_fallback">方</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>每次在最大位移方向上走一步，另一个方向上走不走取决于中点误差</p><p>假定<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mo>⩽</mo><mi mathvariant="normal">∣</mi><mi>k</mi><mi mathvariant="normal">∣</mi><mo>⩽</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0\leqslant\vert k \vert \leqslant 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.78111em;vertical-align:-0.13667em;"></span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⩽</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⩽</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，每次在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span></span></span></span>方向上加1，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>方向上只有两种情况，加1或者不加1，也就是说<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_i,y_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>的下一个点有可能是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mi>u</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_u(x_{i+1},y_{i+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>或者是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mi>d</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_d(x_{i+1},y_{i})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20211226215524.png" alt="20211226215524" /></p><p>如图所示，Q是直线的理想点，M是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">P_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mi>d</mi></msub></mrow><annotation encoding="application/x-tex">P_d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的中点<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>0.5</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">M(x_{i+1},y_{i+0.5})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">0</span><span class="mord mtight">.</span><span class="mord mtight">5</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></p><p>如果<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>Q</mi><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">Q_y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>大于<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>M</mi><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">M_y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>说明<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">P_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>距离理想直线更近，否则是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mi>d</mi></msub></mrow><annotation encoding="application/x-tex">P_d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>更理想</p><p>那么问题就变成了怎么判断Q与M的关系</p><p>假设我们有点<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>0</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_0,y_0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>,那么我么下一个点<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">P_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>虽然不确认y值，但是下一个理想的中点<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>M</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><mn>1</mn><mo separator="true">,</mo><msub><mi>y</mi><mn>1</mn></msub><mo>+</mo><mn>0.5</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">M_1(x_1+1,y_1+0.5)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span></span></span></span>是确定的，那么我们就有步进增量：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>d</mi><mn>0</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>F</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mn>1</mn><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo>+</mo><mn>0.5</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>A</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>+</mo><mi>B</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>+</mo><mn>0.5</mn><mo stretchy="false">)</mo><mo>+</mo><mi>C</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>A</mi><mo>+</mo><mn>0.5</mn><mi>B</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}d_{0}&amp;=F(x_{i}+1,y_{i}+0.5) \\&amp;= A(x_{i}+1)+B(y_{i}+0.5)+C\\&amp;=A+0.5B\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.500000000000002em;vertical-align:-2.000000000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>d</mi><mn>1</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>F</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mn>2</mn><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo>+</mo><mn>1.5</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>A</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mn>2</mn><mo stretchy="false">)</mo><mo>+</mo><mi>B</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>+</mo><mn>1.5</mn><mo stretchy="false">)</mo><mo>+</mo><mi>C</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>A</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>+</mo><mi>B</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>+</mo><mn>0.5</mn><mo stretchy="false">)</mo><mo>+</mo><mi>C</mi><mo>+</mo><mi>A</mi><mo>+</mo><mi>B</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi>d</mi><mn>0</mn></msub><mo>+</mo><mi>A</mi><mo>+</mo><mi>B</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}d_{1} &amp;= F(x_{i}+2,y_{i}+1.5)\\&amp;=A(x_{i}+2)+B(y_{i}+1.5)+C \\&amp;= A(x_{i}+1)+B(y_{i}+0.5)+C+A+B\\&amp;=d_{0}+A+B\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6em;vertical-align:-2.7500000000000004em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em;"><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-2.4099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-0.9099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.25em;"><span style="top:-5.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span></span></span><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span><span style="top:-2.4099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span><span style="top:-0.9099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>实际上起点是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(0,0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span>，所以有：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>d</mi><mi>i</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>F</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mn>1</mn><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo>+</mo><mn>0.5</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>A</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>+</mo><mi>B</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>+</mo><mn>0.5</mn><mo stretchy="false">)</mo><mo>+</mo><mi>C</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>A</mi><mo>+</mo><mn>0.5</mn><mi>B</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}d_{i}&amp;=F(x_{i}+1,y_{i}+0.5)\\ &amp;= A(x_{i}+1)+B(y_{i}+0.5)+C\\ &amp;=A+0.5B\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.500000000000002em;vertical-align:-2.000000000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>d</mi><mn>0</mn></msub><mo>=</mo><mi>A</mi><mo>+</mo><mn>0.5</mn><mi>B</mi></mrow><annotation encoding="application/x-tex">d_0 = A+0.5B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span></span></p><p>若<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">d&lt;0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>则取点<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">P_u</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p><p>若<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">d&gt;0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>则取点<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mi>d</mi></msub></mrow><annotation encoding="application/x-tex">P_d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p><p>等于0随便取一个</p><p>然后就能得到关于d的步进：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>d</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.24999999999999992em" columnalign="right" columnspacing=""><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>d</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub><mo>+</mo><mi>A</mi><mo>+</mo><mi>B</mi><mspace width="1em"/><mo separator="true">,</mo><mi>d</mi><mo>&lt;</mo><mn>0</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>d</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub><mo>+</mo><mi>A</mi><mspace width="1em"/><mo separator="true">,</mo><mi>d</mi><mo>⩾</mo><mn>0</mn></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">d_{new}=\left\{\begin{aligned}d_{old}+A+B \quad ,d&lt;0\\d_{old}+A \quad ,d\geqslant0\end{aligned}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.00003em;vertical-align:-1.25003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:1em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:1em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⩾</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p>当然，为了提高效率，避免浮点数加法，一般把d扩大一倍，就得到<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn><msub><mi>d</mi><mn>0</mn></msub><mo>=</mo><mn>2</mn><mi>A</mi><mo>+</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">2d_0=2A+B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord">2</span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span></p><p>这样就是，每到下一步，先计算<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>d</mi><mrow><mi>n</mi><mi>e</mi><mi>w</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d_{new}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，然后就可以判断选<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>还是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>y</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">y_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.638891em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span></p><p>接下来画一个中点画线法的直线：</p><p>从<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(0,0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span>到<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mn>5</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(5,2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">)</span></span></span></span></p><table><thead><tr><th style="text-align:left">x</th><th style="text-align:left">y</th><th style="text-align:left">d</th></tr></thead><tbody><tr><td style="text-align:left">0</td><td style="text-align:left">0</td><td style="text-align:left">1(初始值)</td></tr><tr><td style="text-align:left">1</td><td style="text-align:left">0</td><td style="text-align:left">-3</td></tr><tr><td style="text-align:left">2</td><td style="text-align:left">1</td><td style="text-align:left">3</td></tr><tr><td style="text-align:left">3</td><td style="text-align:left">1</td><td style="text-align:left">-1</td></tr><tr><td style="text-align:left">4</td><td style="text-align:left">2</td><td style="text-align:left">5</td></tr><tr><td style="text-align:left">5</td><td style="text-align:left">2</td><td style="text-align:left">1</td></tr></tbody></table><h1 id="bresenham画线算法"><a class="markdownIt-Anchor" href="#bresenham画线算法"></a> Bresenham画线算法</h1><p>这个算法描述起来很简单。</p><p>我们计算机画点都得是整数，第一个点直接四舍五入是一定可以确认的，那么下一个点的话，用<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span></span></span></span>增量的话下一个必定是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，我们需要确定<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span></p><p>Bresenham画线算法计算y的误差，就是斜率k，第一个点画完后画第二个点，y的增量是k，x每增加1，误差增加k，假设误差为d，那么递增直线的误差<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi><mo>=</mo><mi>d</mi><mo>+</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">d = d+k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span>，当<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi><mo>⩾</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">d \geqslant 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83111em;vertical-align:-0.13667em;"></span><span class="mord mathdefault">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel amsrm">⩾</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>的时候就需要减去1，始终保证d在0和1之间，这样在d小于0.5的时候，y不变，否则y增加1</p><p>思路就是这个思路，当然书上对该算法进行硬件实现的时候用整数改进了除法</p><p>既然是判断d和0.5的关系，那么就是判断d减去0.5之后与0的关系，但这样开始要计算k</p><p>我们用e来表示d减去0.5</p><p>比较e和0的关系其实就只是关注e的正负号而已</p><p>代码实现的时候<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>e</mi><mo>=</mo><mo>−</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">e = - 0.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span></span></span></span>（初始值），递增k，大于等于0的时候减1</p><p>首先乘2，浮点数没了，还要想一下怎么把k弄掉，k还是需要一个浮点数除法</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>e</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>e</mi><mo>+</mo><mi>k</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mn>2</mn><mi>e</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>2</mn><mi>e</mi><mo>+</mo><mn>2</mn><mfrac><mrow><mi mathvariant="normal">Δ</mi><mi>y</mi></mrow><mrow><mi mathvariant="normal">Δ</mi><mi>x</mi></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="normal">Δ</mi><mi>x</mi><mo>∗</mo><mn>2</mn><mi>e</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi mathvariant="normal">Δ</mi><mi>x</mi><mo>∗</mo><mn>2</mn><mi>e</mi><mo>+</mo><mi mathvariant="normal">Δ</mi><mi>y</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}e &amp;= e+k\\2e &amp;= 2e + 2\frac{\Delta y}{\Delta x}\\\Delta x * 2e &amp;= \Delta x * 2e + \Delta y\\\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.34633em;vertical-align:-2.4231650000000005em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.923165em;"><span style="top:-5.443495em;"><span class="pstrut" style="height:3.36033em;"></span><span class="mord"><span class="mord mathdefault">e</span></span></span><span style="top:-3.423165em;"><span class="pstrut" style="height:3.36033em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault">e</span></span></span><span style="top:-1.5971649999999995em;"><span class="pstrut" style="height:3.36033em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mord mathdefault">e</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4231650000000005em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.923165em;"><span style="top:-5.443495em;"><span class="pstrut" style="height:3.36033em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.423165em;"><span class="pstrut" style="height:3.36033em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">2</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603299999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathdefault">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">Δ</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-1.5971649999999995em;"><span class="pstrut" style="height:3.36033em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">Δ</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">Δ</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4231650000000005em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>也就是说我们定义一个<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>g</mi><mo>=</mo><mn>2</mn><mi>e</mi><mo>∗</mo><mi mathvariant="normal">Δ</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">g = 2e * \Delta x </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Δ</span><span class="mord mathdefault">x</span></span></span></span></span></p><p>那么就有了新的递增计算：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>g</mi><mo>=</mo><mi>g</mi><mo>+</mo><mn>2</mn><mo>∗</mo><mi mathvariant="normal">Δ</mi><mi>y</mi></mrow><annotation encoding="application/x-tex">g = g + 2* \Delta y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord">Δ</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span></span></p><p>新的初始值：</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>e</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>−</mo><mn>0.5</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mn>2</mn><mi>e</mi><mo>∗</mo><mi mathvariant="normal">Δ</mi><mi>x</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>−</mo><mi mathvariant="normal">Δ</mi><mi>x</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi>g</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>−</mo><mi mathvariant="normal">Δ</mi><mi>x</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}e &amp;= -0.5\\2e*\Delta x &amp;= - \Delta x\\g &amp;= - \Delta x\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.500000000000002em;vertical-align:-2.000000000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">e</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">Δ</span><span class="mord mathdefault">x</span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord">Δ</span><span class="mord mathdefault">x</span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord">Δ</span><span class="mord mathdefault">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p><p>到这里就完成了整数算法</p>]]></content>
    
    
    
    <tags>
      
      <tag>CG</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TinyRenderer 0：准备开始</title>
    <link href="/posts/60170/"/>
    <url>/posts/60170/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>本文是对开源项目 <a href="https://github.com/ssloy/tinyrenderer">TinyRenderer</a> 的学习记录。</p><p>这个项目的作者试图教会我渲染API的工作原理，原因是很多人学OpenGL和DX的时候都止步于初始化了……= =希望一个不依赖第三方的卫星软渲染器可以帮助理解。</p><p>预计最终代码在500行左右。</p><p>输入多边形信息和贴图图片的测试文件，会输出一个模型。</p><p>这个程序不会有图形界面，只有输入输出。</p><p>为了尽量减少第三方以来，只会用到TGA类来输出图片。</p><p>线段绘制算法和三角形绘制算法需要我们自己写，当然作者提供了源码。</p><h1 id="正文"><a class="markdownIt-Anchor" href="#正文"></a> 正文</h1><p>TGA类在这儿：</p><p><a href="https://github.com/ssloy/tinyrenderer/blob/master/tgaimage.cpp">TGAImage.CPP</a></p><p><a href="https://github.com/ssloy/tinyrenderer/blob/master/tgaimage.h">TGAImage.h</a></p><p>然后可以用下面这个简单的测试例子输出一张测试用图片：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C++"><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;TGAImage.h&quot;</span></span><br><br><span class="hljs-comment">// 定义TGA颜色 白色</span><br><span class="hljs-type">const</span> TGAColor white = <span class="hljs-built_in">TGAColor</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>);<br><span class="hljs-comment">// 定义TGA颜色 红色</span><br><span class="hljs-type">const</span> TGAColor red = <span class="hljs-built_in">TGAColor</span>(<span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>);<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>** argv)</span> </span>&#123;<br>    <span class="hljs-comment">// 创建一个新的TGA对象，长100宽100的RGB格式图像</span><br>    <span class="hljs-function">TGAImage <span class="hljs-title">image</span><span class="hljs-params">(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, TGAImage::RGB)</span></span>;<br>    <span class="hljs-comment">// 设置52,41坐标的点颜色为红色</span><br>    image.<span class="hljs-built_in">set</span>(<span class="hljs-number">52</span>, <span class="hljs-number">41</span>, red);<br>    <span class="hljs-comment">// 将图片垂直翻转，这样子原点会变成左下角</span><br>    image.<span class="hljs-built_in">flip_vertically</span>();<br>    <span class="hljs-comment">// 将image写入文件output.tga</span><br>    image.<span class="hljs-built_in">write_tga_file</span>(<span class="hljs-string">&quot;output.tga&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>输出的图片文件长这样：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20211223220625.png" alt="20211223220625" /></p>]]></content>
    
    
    
    <tags>
      
      <tag>Renderer</tag>
      
      <tag>CG</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：使用UnrealInsights对Android真机进行性能分析</title>
    <link href="/posts/350/"/>
    <url>/posts/350/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h1><p>一般情况下，前期开发时是不会照顾到性能优化相关的事情的，在中后期才会开始对一些性能瓶颈进行分析和改进。本文仅仅介绍了怎么连接安卓机来进行UnrealInsights的数据收集工作。</p><p>有一些必要的但是本文没有介绍到的知识：</p><ol><li>UnrealInsights如何使用</li><li>adb如何安装</li></ol><h1 id="真机收集数据"><a class="markdownIt-Anchor" href="#真机收集数据"></a> 真机收集数据</h1><p>准备Android Debug Bridge (adb)工具:</p><p><a href="https://developer.android.com/studio/command-line/adb">Android Debug Bridge (adb)</a></p><p>一般情况下，既然已经到了要调试安卓版本的时候，那肯定打过安卓包了，那肯定装过安卓SDK配置过各种环境了，那直接打开everything搜一下adb.exe，就可以找到了。</p><p>开始调试前需要确定几件事情：</p><ol><li>安卓设备开启USB调试</li><li>PC打开UnrealInsights</li><li>安卓设备连接PC</li></ol><p>接下来需要执行几个小步骤：</p><p>将下面这行写入一个文本文档，将文本文件命名为 UE4CommandLine.txt</p><p>-tracehost=127.0.0.1</p><p>将这个文件放进手机的项目目录中，比如：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20211222205836.png" alt="20211222205836" /></p><p>然后在cmd中进入到adb所在的目录：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20211222205911.png" alt="20211222205911" /></p><p>首先确认设备有没有正常连接，使用如下命令：</p><p>adb.exe devices</p><p>设备连接正常的时候会打印信息：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20211222210009.png" alt="20211222210009" /></p><p>如图所示说明设备连接成功</p><p>接下来输入下面这个命令，指示adb经由设备上通过USB建立的TCP连接传递：</p><p>adb.exe reverse tcp:1980 tcp:1980</p><p>这个命令正常情况下不会有任何反馈</p><p>最后启动游戏就可以在面板上看到数据收集进行中了：<br /><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/20211222210057.png" alt="20211222210057" /></p><p>完毕~</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>Optimization</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GitHub白嫖图床</title>
    <link href="/posts/18954/"/>
    <url>/posts/18954/</url>
    
    <content type="html"><![CDATA[<h1 id="文章概览"><a class="markdownIt-Anchor" href="#文章概览"></a> 文章概览</h1><p>本文主要是本人用hexo以来踩坑的一个路径总结，感觉是一些比较有用的东西。</p><p>在最早的时候我是用的是WordPress，但是后来服务器到期续费太贵了，选择了可以白嫖的github.io搭配自己的域名和hexo来继续搭建博客，当时没有第一时间使用图床（因为没有好用的免费图床又不想花钱- -），一直都是用相对路径保存图片，在文章中也是按照相对路径插入图片，然后修改hexo的include把图片也发布出去的方式写文章的，一方面不是特别方便（不能截图后直接插入），另一方面是github图片加载速度十分感人，所以又在网上寻找别的方案，最终使用了现在的办法，vscode+picgo插件+github私有仓库的方式白嫖图床。</p><h1 id="方案特点"><a class="markdownIt-Anchor" href="#方案特点"></a> 方案特点</h1><ol><li><strong>不要钱</strong></li><li>vscode编辑Markdown，适合喜欢all in one的人士</li><li>插入图片就直接上传，不用自己考虑路径</li><li>cdn加速后国内直连打开图片速度也很快</li></ol><h1 id="本文相关但是并没有提到的"><a class="markdownIt-Anchor" href="#本文相关但是并没有提到的"></a> 本文相关但是并没有提到的</h1><ol><li>github仓库的创建和token的创建</li><li>hexo配置</li><li>vscode的Markdown编写配置</li></ol><h1 id="配置步骤"><a class="markdownIt-Anchor" href="#配置步骤"></a> 配置步骤</h1><h2 id="创建仓库并设置token"><a class="markdownIt-Anchor" href="#创建仓库并设置token"></a> 创建仓库并设置token</h2><p>第一步需要创建github仓库，注意必须是public，毕竟图片是要公开给别人看的，除此之外还需要一个token用于repo</p><h2 id="安装并配置插件"><a class="markdownIt-Anchor" href="#安装并配置插件"></a> 安装并配置插件</h2><p>在vscode中搜索picgo插件并安装，然后需要配置几个参数</p><ol><li>将图床设置为github</li></ol><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs20211221205238.png" alt="20211221205238" /></p><ol start="2"><li>确认需要使用的分支</li></ol><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs20211221205338.png" alt="20211221205338" /></p><ol start="3"><li>输入链接格式，jdr加速的格式如下</li></ol><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs20211221205441.png" alt="20211221205441" /></p><ol start="4"><li>输入仓库中的图片存放的路径</li></ol><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs20211221205643.png" alt="20211221205643" /></p><ol start="5"><li>输入用户名和仓库名</li></ol><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs20211221205712.png" alt="20211221205712" /></p><ol start="6"><li>输入刚才生成的token</li></ol><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs20211221205747.png" alt="20211221205747" /></p><p>到这里vscode + picgo + github的免费白嫖图床就设置好了。</p><p>picgo的两个常用快捷键：</p><p>ctrl + alt + U 直接插入剪贴板的图片</p><p>ctrl + alt + E 选择插入本地的图片</p>]]></content>
    
    
    
    <tags>
      
      <tag>GitHub</tag>
      
      <tag>Program</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：自定义带参数的命令行</title>
    <link href="/posts/24325/"/>
    <url>/posts/24325/</url>
    
    <content type="html"><![CDATA[<p>昨天写了一下自定义命令行命令</p><p><a href="https://muchenhen.com/2021/12/06/UE4%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/">UE4：自定义命令行调试命令</a></p><p>但是并没有写的很详细，之后找机会慢慢补全，这里再简单记一下如何带参数</p><p>如果需要在命令行中接收参数，在绑定委托时需要使用另一个函数：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">namespace</span> Test<br>&#123;<br><span class="hljs-comment">//命令行要调用的函数，接受一个FString的数组，函数内部可以用这个参数做一些功能</span><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">ConsoleCommand_Test1</span><span class="hljs-params">(<span class="hljs-type">const</span> TArray&lt;FString&gt;&amp;Args)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">if</span>(Args.<span class="hljs-built_in">Num</span>()&gt;<span class="hljs-number">0</span>)<br>&#123;<br><span class="hljs-keyword">if</span>(Args[<span class="hljs-number">0</span>] == <span class="hljs-string">&quot;0&quot;</span>)<br>&#123;<br><span class="hljs-built_in">UE_LOG</span>(LogTemp, Display, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Command test 1&quot;</span>));<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">//在绑定的时候用FConsoleCommandWithArgsDelegate</span><br><span class="hljs-function"><span class="hljs-type">static</span> FAutoConsoleCommand <span class="hljs-title">ConsoleCommandTest1</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">TEXT(<span class="hljs-string">&quot;ts.command&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">TEXT(<span class="hljs-string">&quot;this is command help.&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function">FConsoleCommandWithArgsDelegate::CreateStatic(ConsoleCommand_Test1),</span></span><br><span class="hljs-params"><span class="hljs-function">EConsoleVariableFlags::ECVF_Default)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这样上面这个命令在使用的时候，可以在后面跟上参数，比如：</p><p>ts.command 1</p><p>数组Args[0]就会存下FString类型“1”</p><p>如果多个参数就用空格隔开</p><p>ts.command 1 2 3</p><p>都会存入数组Args中</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>C++</tag>
      
      <tag>Program</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4：自定义命令行调试命令</title>
    <link href="/posts/10435/"/>
    <url>/posts/10435/</url>
    
    <content type="html"><![CDATA[<p>对游戏进行调试的时候，偶尔会有搭建临时测试用UI才能方便的情况，比如之前我有个功能为了方便QA测试给他们做了个按钮，点击后会打印服务器的UTC时间，其实只是需要一个方法调用到我们写的测试函数，这种情况可以考虑不用再临时拼个UI了</p><p>本次先简单写一下如何在C++中添加自定义命令行命令</p><p>下面是一个实例，我创建了一个game controller类，并在里面写了一个用于测试的函数，我希望可以不用创建测试UI就调用到这个函数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// Fill out your copyright notice in the Description page of Project Settings.</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;CoreMinimal.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;GameFramework/PlayerController.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;MyPlayerController.generated.h&quot;</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> */</span><br><span class="hljs-built_in">UCLASS</span>()<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">UETESTPROJECT_API</span> AMyPlayerController : <span class="hljs-keyword">public</span> APlayerController<br>&#123;<br><span class="hljs-built_in">GENERATED_BODY</span>()<br><br><br><span class="hljs-keyword">public</span>:<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">TestConsoleCommandFirst</span><span class="hljs-params">()</span></span>;<br>&#125;;<br><br><span class="hljs-keyword">namespace</span> TEST<br>&#123;<br><span class="hljs-function"><span class="hljs-type">static</span> FAutoConsoleCommand <span class="hljs-title">CMDFirst</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-comment">//CMD 名字，在控制台输入这个调用</span></span></span><br><span class="hljs-params"><span class="hljs-function">TEXT(<span class="hljs-string">&quot;TS.cmdtestFirst&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-comment">//控制台帮助信息，选择这个命令的时候会看到</span></span></span><br><span class="hljs-params"><span class="hljs-function">TEXT(<span class="hljs-string">&quot;this is a CMD test.&quot;</span>),</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-comment">//创建静态委托，输入上面的命令后会调用到后面的函数</span></span></span><br><span class="hljs-params"><span class="hljs-function">FConsoleCommandDelegate::CreateStatic(&amp;AMyPlayerController::TestConsoleCommandFirst),</span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-comment">//可选标志位掩码</span></span></span><br><span class="hljs-params"><span class="hljs-function">EConsoleVariableFlags::ECVF_Default</span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>build项目，然后运行，可以在CMD里看到定义的新命令<br /><img src="images/2021/12/cmdtest.png" alt="CMD" /><br />可以看到有输出<br /><img src="images/2021/12/cmdtestprint.png" alt="CMDLog" /></p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>C++</tag>
      
      <tag>Program</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GitHub自动部署HEXO个人博客</title>
    <link href="/posts/58254/"/>
    <url>/posts/58254/</url>
    
    <content type="html"><![CDATA[<p>使用GitHub白嫖搭建一个个人博客，并且使用GitHub Action自动的部署，省去自己hexo clean | hexo g | hexo d等繁琐操作，直接提交git即可<br />Note:本教程在Windows下使用</p><h1 id="建立仓库"><a class="markdownIt-Anchor" href="#建立仓库"></a> 建立仓库</h1><p>我这里分了两个仓库，一个 <a href="http://username.github.io">username.github.io</a>，用来部署自己的个人博客，这里是hexo生成的，且需要是一个public仓库<br />另一个仓库MyBlogSource，用来存放hexo init出来的博客源码，可以是private的<br />也可以在一个仓库里用不同分支来做<br /><strong>GitHub仓库SSH密钥配置这里不赘述，属于git配置的范畴</strong></p><h1 id="hexo安装和配置"><a class="markdownIt-Anchor" href="#hexo安装和配置"></a> HEXO安装和配置</h1><p><strong>如果已经有自己配置过HEXO可以直接跳过这部分</strong><br /><strong>此处默认git已安装</strong></p><h3 id="下载安装nodejs"><a class="markdownIt-Anchor" href="#下载安装nodejs"></a> 下载安装node.js</h3><p><a href="https://nodejs.org/en/">https://nodejs.org/en/</a></p><h3 id="安装hexo"><a class="markdownIt-Anchor" href="#安装hexo"></a> 安装HEXO</h3><p>假设已经创建好了上一步的两个仓库并clone到了本地</p><p>设<strong>源码存放的仓库路径</strong>为：C:/Users/Documents/GitHub/MyBlogSource</p><p>设<strong>hexo部署仓库本地路径</strong>为：C:/Users/Documents/GitHub/username.github.io</p><p>打开git bash并把路径定位到源码仓库</p><p>这个语句用来安装HEXO<br />npm install -g hexo-cli</p><p>这个语句在这个文件夹下初始化HEXO<br />hexo init</p><p>下面这个语句install一些依赖<br />npm install</p><p>到这里就初始化完成HEXO了</p><p>HEXO配置可以参考官网修改配置文件_config.yml，官网文档是 <a href="https://hexo.io/zh-cn/docs/configuration">https://hexo.io/zh-cn/docs/configuration</a></p><p>此处不介绍如何修改主题，需要的话推荐一个本站使用的开源主题项目Melody</p><p>网址：<a href="https://molunerfinn.com/hexo-theme-melody-doc/zh-Hans/#%E7%89%B9%E6%80%A7">hexo-theme-melody</a></p><p>此时的文件夹结构应该大致是如下情况：</p><ul><li>MyBlogSource<ul><li>Source<ul><li>_posts 文章在这个文件夹下<ul><li><a href="http://HelloWorld.md">HelloWorld.md</a></li></ul></li></ul></li><li>_config.yml 配置文件</li></ul></li></ul><h3 id="hexo推送配置"><a class="markdownIt-Anchor" href="#hexo推送配置"></a> HEXO推送配置</h3><p>将推送配置单独说一下</p><p><img src="images/2021/12/hexoDepolySetting.png" alt="hexoDepolySetting" /></p><p>这里会使用gitconfig全局设置的ssh key</p><h3 id="使用hexo部署"><a class="markdownIt-Anchor" href="#使用hexo部署"></a> 使用HEXO部署</h3><p>在hexo init时候的根目录下可以使用命令来生成博客</p><p>hexo clean – 会清除掉生成的public文件夹</p><p>hexo g – 重新生成public文件夹</p><p>hexo d – 将仓库推送到配置的路径</p><p>hexo s – 本地localhost:4000 查看部署出来的网站</p><p>推送到git后就可以访问username.github.io查看自己的网站了</p><h3 id="使用个人域名"><a class="markdownIt-Anchor" href="#使用个人域名"></a> 使用个人域名</h3><p><strong>不需要使用个人域名的可以跳过</strong></p><p><strong>域名注册申请备案和DNS解析购买这里不介绍</strong></p><p>在网页上打开GitHub的 <a href="http://username.github.io">username.github.io</a></p><p>选择Settings，选择Pages，填上自己的域名</p><p>然后到DNS解析服务商添加解析规则，我用的阿里云</p><p>红框里面的四个都加上</p><p>最后一个加上后，需要在博客源码仓库本地路径的Source文件夹里添加一个CNAME文件，不要任何后缀，用记事本打开添加上网址，比如我的就是 <a href="http://muchenhen.com">muchenhen.com</a></p><p>然后重新部署，等待dns解析生效之后就可以通过域名访问自己的博客</p><h1 id="用github-action自动部署"><a class="markdownIt-Anchor" href="#用github-action自动部署"></a> 用GitHub Action自动部署</h1><p>因为每次写完之后都要手动部署很烦</p><p>而且更烦的是多设备同步问题，都要重新弄hexo的环境，不如干脆买个轻量应用服务器一键搭建WordPress随便哪个设备都能写博客……（不是</p><p>用HEXO+GitHub主要是想白嫖（不是</p><p>所以用GitHub Action减少上述的麻烦</p><p>这里不介绍GitHub Action相关的知识，直接写如何使用来自动化部署hexo</p><p>前往本地的博客源码仓库C:/Users/Documents/GitHub/MyBlogSource</p><h3 id="添加推送用的key"><a class="markdownIt-Anchor" href="#添加推送用的key"></a> 添加推送用的key</h3><p>在本地用git bash生成一堆新的密钥，我这里取的名字是github-deploy-key</p><p>将pub的key添加到HEXO部署仓库，在网页上打开 <a href="http://username.github.io">username.github.io</a>，来到settings，打开Deploy keys，添加一个新的key，将刚生成的pub复制粘贴进来</p><p>然后到博客源码仓库，在网页上打开，settings，secrets，将私钥复制粘贴到这里面，<strong>记住你添加的这个secret的名字</strong></p><h3 id="配置action"><a class="markdownIt-Anchor" href="#配置action"></a> 配置Action</h3><p>在.github文件夹下添加一个文件夹workflows，在这个文件夹里添加一个文件HEXO_CI.yml<br />这里可以参考我的来改一下，我把源码贴在这里并写上注释，<strong>注意需要修改的地方：git设置，secret名</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span><br><br><span class="hljs-attr">on:</span> [<span class="hljs-string">push</span>]<br><br><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">build:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">A</span> <span class="hljs-string">job</span> <span class="hljs-string">to</span> <span class="hljs-string">deploy</span> <span class="hljs-string">blog.</span><br>    <span class="hljs-attr">steps:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span><br>      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span><br>      <span class="hljs-attr">with:</span><br>        <span class="hljs-attr">submodules:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># Checkout private submodules(themes or something else).</span><br>  <br>    <span class="hljs-comment"># Caching dependencies to speed up workflows. (GitHub will remove any cache entries that have not been accessed in over 7 days.)</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Node.js</span><br>      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v1</span><br>      <span class="hljs-attr">with:</span><br>        <span class="hljs-attr">node-version:</span> <span class="hljs-string">&#x27;12&#x27;</span> <span class="hljs-comment">#超过12的版本有几个warning，我不想处理</span><br>  <br>    <span class="hljs-comment"># Deploy hexo blog website.</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Hexo</span><br>      <span class="hljs-attr">env:</span><br>        <span class="hljs-comment"># 定义了一个变量 secrets里面添加的名字</span><br>        <span class="hljs-attr">ACTION_DEPLOY_KEY:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.DEPLOY_KEY</span> <span class="hljs-string">&#125;&#125;</span> <br>      <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          # 创建了一个ssh文件夹</span><br><span class="hljs-string">          mkdir -p ~/.ssh/</span><br><span class="hljs-string">          # 把key复制进去</span><br><span class="hljs-string">          echo &quot;$ACTION_DEPLOY_KEY&quot; &gt; ~/.ssh/id_rsa</span><br><span class="hljs-string">          chmod 700 ~/.ssh</span><br><span class="hljs-string">          chmod 600 ~/.ssh/id_rsa</span><br><span class="hljs-string">          ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts</span><br><span class="hljs-string">          # 配置git</span><br><span class="hljs-string">          git config --global user.email &quot;muchenhen@gmail.com&quot;</span><br><span class="hljs-string">          git config --global user.name &quot;muchenhen&quot;</span><br><span class="hljs-string">          # 安装hexo</span><br><span class="hljs-string">          npm install hexo-cli -g</span><br><span class="hljs-string">          npm install</span><br><span class="hljs-string"></span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        hexo clean</span><br><span class="hljs-string">        hexo deploy</span><br></code></pre></td></tr></table></figure><p>这样就会在每次push的时候触发这个Action，自己生成并部署hexo了~</p>]]></content>
    
    
    
    <tags>
      
      <tag>GitHub</tag>
      
      <tag>Program</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>测试CI</title>
    <link href="/posts/64469/"/>
    <url>/posts/64469/</url>
    
    <content type="html"><![CDATA[<p>图片文件路径测试<br /><img src="images/ue4-pso-1.png" alt="ue4-pso-1" /></p><p><img src="_post/../../../images/ue4-pso-1.png" alt="ue4-pso-1" /></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>UE4：UObjectToLua插件简介</title>
    <link href="/posts/42260/"/>
    <url>/posts/42260/</url>
    
    <content type="html"><![CDATA[<h5 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h5><p>该插件继承UBlueprintFunctionLibrary，提供了一些静态函数，可以对UObject类及其子类的对象进行Get和Set操作获取或者修改对应的UPROPERTY的名称或值。</p><p><strong>更新</strong></p><p>添加了UEnum和TSet的UPROPERTY的独写</p><h5 id="提供的函数"><a class="markdownIt-Anchor" href="#提供的函数"></a> 提供的函数</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;UTL&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> FString <span class="hljs-title">UObjectToLuaString</span><span class="hljs-params">(UObject* Object)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;UTL&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> FString <span class="hljs-title">UObjectToLuaStringWithIgnore</span><span class="hljs-params">(UObject* Object, FString ignore)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;UTL&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> FString <span class="hljs-title">UObjectToCSV</span><span class="hljs-params">(UObject* Object)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;UTL&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> FString <span class="hljs-title">UObjectToCSVwithIgnore</span><span class="hljs-params">(UObject* Object, FString ignore)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;UTL&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> FString <span class="hljs-title">GetAimValue</span><span class="hljs-params">(UObject* Object, FString Aim)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;UTL&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> UObject* <span class="hljs-title">SetAimValue</span><span class="hljs-params">(UClass* classNAme, FString Aim, FString nameAndValue)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;UTL&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> UObject* <span class="hljs-title">LuaStringToUObject</span><span class="hljs-params">(UClass* className, FString nameAndValue)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;UTL&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> UObject* <span class="hljs-title">LuaStringToSetUObject</span><span class="hljs-params">(UObject* objcet, FString nameAndValue)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;UTL&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> UObject* <span class="hljs-title">CSVToUObject</span><span class="hljs-params">(UClass* className, FString nameAndValue)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;UTL&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> UObject* <span class="hljs-title">CSVToSetUObject</span><span class="hljs-params">(UObject* objcet, FString nameAndValue)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;UTL&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> UObject* <span class="hljs-title">CreateObject</span><span class="hljs-params">(UClass* className)</span></span>;<br><br><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable, Category = <span class="hljs-string">&quot;UTL&quot;</span>)<br><span class="hljs-function"><span class="hljs-type">static</span> FString <span class="hljs-title">LuaStringToCSV</span><span class="hljs-params">(FString LuaString)</span></span>;<br></code></pre></td></tr></table></figure><h5 id="使用举例"><a class="markdownIt-Anchor" href="#使用举例"></a> 使用举例</h5><p>用第一个函数举例，该函数需要一个UObject的对象，或者子类的对象，最后返回一个FString变量，该变量是该Object的所有UPROPERTY的名称和值，字符串格式符合Lua的Table格式。</p><p>比如我有如下几个Object类类型</p><p>MyObject类</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">UCLASS</span>(BlueprintType, Blueprintable)<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">GAMETEST_API</span> UMyObject : <span class="hljs-keyword">public</span> UObject<br>&#123;<br><span class="hljs-built_in">GENERATED_BODY</span>()<br><br><span class="hljs-keyword">public</span>:<br><br><span class="hljs-built_in">UMyObject</span>();<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = GamePlay)<br><span class="hljs-type">bool</span> baseBool;<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = Gameplay)<br>int32 baseInt;<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = Gameplay)<br><span class="hljs-type">float</span> baseFloat;<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = Gameplay)<br>FString baseString;<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = Gameplay)<br>TArray&lt;FString&gt; baseArray;<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = Gameplay)<br>TMap&lt;int32, <span class="hljs-type">bool</span>&gt; baseMap;<br>&#125;;<br></code></pre></td></tr></table></figure><p>MyObjectChild类，继承自MyObject类</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">UCLASS</span>(BlueprintType, Blueprintable)<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">GAMETEST_API</span> UMyObjectChild : <span class="hljs-keyword">public</span> UMyObject<br>&#123;<br><span class="hljs-built_in">GENERATED_BODY</span>()<br><br><span class="hljs-keyword">public</span>:<br><br><span class="hljs-built_in">UMyObjectChild</span>();<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = GamePlay)<br><span class="hljs-type">bool</span> childBool;<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = Gameplay)<br>int32 childInt;<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = Gameplay)<br><span class="hljs-type">float</span> childFloat;<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = Gameplay)<br>FString childString;<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = Gameplay)<br>TArray&lt;<span class="hljs-type">bool</span>&gt; childArray;<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = Gameplay)<br>TMap&lt;int32, int32&gt; childMap;<br>&#125;;<br></code></pre></td></tr></table></figure><p>MyAnother类，其中成员变量有一个MyObject类和一个MyObjectChild类</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">UCLASS</span>(BlueprintType, Blueprintable)<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">GAMETEST_API</span> UMyAnotherObject : <span class="hljs-keyword">public</span> UObject<br>&#123;<br><span class="hljs-built_in">GENERATED_BODY</span>()<br><br><span class="hljs-keyword">public</span>:<br><br><span class="hljs-built_in">UMyAnotherObject</span>();<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = GamePlay)<br>UMyObject* a;<br>    <br>    <span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = GamePlay)<br>UMyObjectChild* b;<br><br><span class="hljs-built_in">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, Category = GamePlay)<br><span class="hljs-type">bool</span> anotherbool;<br>&#125;;<br></code></pre></td></tr></table></figure><p>那么假如以上所有类的成员变量在构造函数中有初始化（应该是必须有），我实例化一个MyAnotherObject的对象，将其传给此函数：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml">UMyAnotherObject* another = NewObject<span class="hljs-tag">&lt;<span class="hljs-name">UMyAnotherObject</span>&gt;</span>();<br>FString getObjectProperties = UObjectToLuaParser::UObjectToLuaString(another);<br></code></pre></td></tr></table></figure><p>最后得到的getObjectProperties应该是如下的字符串：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">return</span>&#123;a=&#123;baseBool=<span class="hljs-literal">false</span>,baseInt=<span class="hljs-number">1</span>,baseFloat=<span class="hljs-number">1.0</span>,baseString=<span class="hljs-string">&#x27;base string&#x27;</span>,baseArray=&#123;<span class="hljs-string">&#x27;basearray01&#x27;</span>,<span class="hljs-string">&#x27;basearray02&#x27;</span>,<span class="hljs-string">&#x27;basearray03&#x27;</span>,&#125;,baseMap=&#123;[<span class="hljs-number">1</span>]=<span class="hljs-literal">true</span>,[<span class="hljs-number">2</span>]=<span class="hljs-literal">false</span>,[<span class="hljs-number">3</span>]=<span class="hljs-literal">true</span>,&#125;,&#125;,b=&#123;childBool=<span class="hljs-literal">true</span>,childInt=<span class="hljs-number">2</span>,childFloat=<span class="hljs-number">2.0</span>,childString=<span class="hljs-string">&#x27;child string&#x27;</span>,childArray=&#123;<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">true</span>,<span class="hljs-literal">false</span>,<span class="hljs-literal">true</span>,&#125;,childMap=&#123;[<span class="hljs-number">1</span>]=<span class="hljs-number">111</span>,[<span class="hljs-number">2</span>]=<span class="hljs-number">222</span>,[<span class="hljs-number">3</span>]=<span class="hljs-number">333</span>,&#125;,rotate=&#123;Pitch=<span class="hljs-number">1.0</span>,Yaw=<span class="hljs-number">1.1</span>,Roll=<span class="hljs-number">1.2</span>,&#125;,vector=&#123;X=<span class="hljs-number">111.0</span>,Y=<span class="hljs-number">222.0</span>,Z=<span class="hljs-number">333.0</span>,&#125;,baseBool=<span class="hljs-literal">false</span>,baseInt=<span class="hljs-number">1</span>,baseFloat=<span class="hljs-number">1.0</span>,baseString=<span class="hljs-string">&#x27;base string&#x27;</span>,baseArray=&#123;<span class="hljs-string">&#x27;basearray01&#x27;</span>,<span class="hljs-string">&#x27;basearray02&#x27;</span>,<span class="hljs-string">&#x27;basearray03&#x27;</span>,&#125;,baseMap=&#123;[<span class="hljs-number">1</span>]=<span class="hljs-literal">true</span>,[<span class="hljs-number">2</span>]=<span class="hljs-literal">false</span>,[<span class="hljs-number">3</span>]=<span class="hljs-literal">true</span>,&#125;,&#125;,anotherbool=<span class="hljs-literal">false</span>,&#125;<br></code></pre></td></tr></table></figure><p>注意这里是没有任何空格和换行符的，最外层的大括号和return是为了Lua拿到后直接就可以dump为table进行处理，此处也可以修改最后输出的地方进行修改。下面是处理过格式的，方便对比：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">return</span>&#123;<br>    a=&#123;<br>        baseBool=<span class="hljs-literal">false</span>,<br>        baseInt=<span class="hljs-number">1</span>,<br>        baseFloat=<span class="hljs-number">1.0</span>,<br>        baseString=<span class="hljs-string">&#x27;base string&#x27;</span>,<br>        baseArray=&#123;<br>            <span class="hljs-string">&#x27;basearray01&#x27;</span>,<br>            <span class="hljs-string">&#x27;basearray02&#x27;</span>,<br>            <span class="hljs-string">&#x27;basearray03&#x27;</span>,<br>        &#125;,<br>        baseMap=&#123;<br>            [<span class="hljs-number">1</span>]=<span class="hljs-literal">true</span>,<br>            [<span class="hljs-number">2</span>]=<span class="hljs-literal">false</span>,<br>            [<span class="hljs-number">3</span>]=<span class="hljs-literal">true</span>,<br>        &#125;,<br>    &#125;,<br>    b=&#123;<br>        childBool=<span class="hljs-literal">true</span>,<br>        childInt=<span class="hljs-number">2</span>,<br>        childFloat=<span class="hljs-number">2.0</span>,<br>        childString=<span class="hljs-string">&#x27;child string&#x27;</span>,<br>        childArray=&#123;<br>            <span class="hljs-literal">true</span>,<br>            <span class="hljs-literal">false</span>,<br>            <span class="hljs-literal">true</span>,<br>            <span class="hljs-literal">false</span>,<br>            <span class="hljs-literal">true</span>,<br>        &#125;,<br>        childMap=&#123;<br>            [<span class="hljs-number">1</span>]=<span class="hljs-number">111</span>,<br>            [<span class="hljs-number">2</span>]=<span class="hljs-number">222</span>,<br>            [<span class="hljs-number">3</span>]=<span class="hljs-number">333</span>,<br>        &#125;,<br>        rotate=&#123;<br>            Pitch=<span class="hljs-number">1.0</span>,<br>            Yaw=<span class="hljs-number">1.1</span>,<br>            Roll=<span class="hljs-number">1.2</span>,<br>        &#125;,<br>        vector=&#123;<br>            X=<span class="hljs-number">111.0</span>,<br>            Y=<span class="hljs-number">222.0</span>,<br>            Z=<span class="hljs-number">333.0</span>,<br>        &#125;,<br>        baseBool=<span class="hljs-literal">false</span>,<br>        baseInt=<span class="hljs-number">1</span>,<br>        baseFloat=<span class="hljs-number">1.0</span>,<br>        baseString=<span class="hljs-string">&#x27;base string&#x27;</span>,<br>        baseArray=&#123;<br>            <span class="hljs-string">&#x27;basearray01&#x27;</span>,<br>            <span class="hljs-string">&#x27;basearray02&#x27;</span>,<br>            <span class="hljs-string">&#x27;basearray03&#x27;</span>,<br>        &#125;,<br>        baseMap=&#123;<br>            [<span class="hljs-number">1</span>]=<span class="hljs-literal">true</span>,<br>            [<span class="hljs-number">2</span>]=<span class="hljs-literal">false</span>,<br>            [<span class="hljs-number">3</span>]=<span class="hljs-literal">true</span>,&#125;,<br>        &#125;,<br>    &#125;<br>    anotherbool=<span class="hljs-literal">false</span>,<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>需要指出的是目前**仅支持基本数据类型，TArray，TMap，FVector，FRotator，不支持不支持不支持自定义结构体。**具体原因可以参考大致原理部分。</p><h5 id="函数简介"><a class="markdownIt-Anchor" href="#函数简介"></a> 函数简介</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">static</span> FString <span class="hljs-title">UObjectToLuaString</span><span class="hljs-params">(UObject* Object)</span></span>;<br></code></pre></td></tr></table></figure><p>上文已经举例，不再赘述。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> FString <span class="hljs-title">UObjectToLuaStringWithIgnore</span><span class="hljs-params">(UObject* Object, FString ignore)</span></span>;<br></code></pre></td></tr></table></figure><p>ignore参数中是用逗号分隔的不需要的UPROPERTY的name，最后一个后面也要有逗号，做成字符串是为了可以直接用Lua调用方便，ignore中的UPROPERTY会在Get信息的过程中跳过</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> FString <span class="hljs-title">UObjectToCSV</span><span class="hljs-params">(UObject* Object)</span></span>;<br></code></pre></td></tr></table></figure><p>该函数会最后将字符串修改为符合CSV文件要求的格式，在收集信息到表格的过程中可以使用</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> FString <span class="hljs-title">UObjectToCSVwithIgnore</span><span class="hljs-params">(UObject* Object, FString ignore)</span></span>;<br></code></pre></td></tr></table></figure><p>ignore和上面第二个一样，最后的字符串和上面第三个一样符合CSV格式</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> FString <span class="hljs-title">GetAimValue</span><span class="hljs-params">(UObject* Object, FString Aim)</span></span>;<br></code></pre></td></tr></table></figure><p>Aim和上文的ignore不同，只能存放一个UPROPERTY的name，不会进一步处理，最后返回的字符串只有这一个UPROPERTY的信息</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> UObject* <span class="hljs-title">SetAimValue</span><span class="hljs-params">(UClass* classNAme, FString Aim, FString nameAndValue)</span></span>;<br></code></pre></td></tr></table></figure><p>第一个参数是UCLass*类，函数内部会新建一个该UClass对应的对象实例，Aim依然是一个UPROPERTY的name，会将该UPROPERTY的value设置为第三个参数中的值。注意第三个参数要求写成name=value的形式</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> UObject* <span class="hljs-title">LuaStringToUObject</span><span class="hljs-params">(UClass* className, FString nameAndValue)</span></span>;<br></code></pre></td></tr></table></figure><p>这里注意第二个参数，第二个参数的形式和上面第一个函数最后输出的形式相同，但不需要最外层的return和大括号</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> UObject* <span class="hljs-title">LuaStringToSetUObject</span><span class="hljs-params">(UObject* objcet, FString nameAndValue)</span></span>;<br></code></pre></td></tr></table></figure><p>和上一个函数的区别在于第一个参数，这个可以理解为给已存在的实例对象的Set方法</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> UObject* <span class="hljs-title">CSVToUObject</span><span class="hljs-params">(UClass* className, FString nameAndValue)</span></span>;<br></code></pre></td></tr></table></figure><p>从csv字符串新建一个对象并使用第二个参数进行赋值</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> UObject* <span class="hljs-title">CSVToSetUObject</span><span class="hljs-params">(UObject* objcet, FString nameAndValue)</span></span>;<br></code></pre></td></tr></table></figure><p>用csv字符串设置一个已存在的对象</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> UObject* <span class="hljs-title">CreateObject</span><span class="hljs-params">(UClass* className)</span></span>;<br></code></pre></td></tr></table></figure><p>自己封装的一个从UClass创建对应对象的函数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> FString <span class="hljs-title">LuaStringToCSV</span><span class="hljs-params">(FString LuaString)</span></span>;<br></code></pre></td></tr></table></figure><p>一个将Lua风格的字符串改为CSV风格的函数</p><h5 id="下载和使用"><a class="markdownIt-Anchor" href="#下载和使用"></a> 下载和使用</h5><p>项目地址：<a href="https://github.com/muchenhen/UObjectToLua">https://github.com/muchenhen/UObjectToLua</a></p><p>Git： <a href="mailto:git@github.com">git@github.com</a>:muchenhen/UObjectToLua.git</p><p>将UObjectToLua文件夹复制进项目或者引擎的Plungins文件夹，重新生成项目的解决方案，重新编译项目</p><p>在其他插件中使用的话在对应的插件的.build.cs文件包含UObjectToLua模块，运行时使用的话在项目的.build.cs中包含。在要使用的地方包含对应的头文件。</p><p>欢迎交流和捉虫，毕竟作者只是一个菜鸡……</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>C++</tag>
      
      <tag>Plugin</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4:PSO使用指南</title>
    <link href="/posts/47560/"/>
    <url>/posts/47560/</url>
    
    <content type="html"><![CDATA[<h5 id="完整流程"><a class="markdownIt-Anchor" href="#完整流程"></a> 完整流程</h5><p>请按照以下文章的顺序顺序执行。</p><p>先来一个一图流指南：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022!%5Bue4-pso-1%5D(imagesue4-pso-1.png).png" alt="ue4-pso-1" /></p><h5 id="启用pso"><a class="markdownIt-Anchor" href="#启用pso"></a> 启用PSO</h5><p>编辑（Edit） &gt; 项目设置（Project Settings） &gt; 打包（Packaging） &gt; 打包（Packaging），按照下图打开选项：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022!%5Bue4-pso-2.jpg%5D(imagesue4-pso-2.jpg).jpg" alt="ue4-pso-2.jpg" /></p><p>窗口（Window） &gt; 开发者工具（Developer Tools） &gt; 设备描述（Device Profiles）</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022!%5Bue4-pso-3.jpg%5D(imagesue4-pso-3.jpg).jpg" alt="ue4-pso-3.jpg" /></p><p>Existing Device Profiles 输入中找到 Android 选项，点击其命名旁边的 省略号 将该设备描述打开：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022!%5Bue4-pso-4.jpg%5D(imagesue4-pso-4.jpg).jpg" alt="ue4-pso-4.jpg" /></p><p>控制台变量（Console Variables） 部分中查找 渲染（Rendering），按下 加号 图标公开 Search 输入：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022!%5Bue4-pso-5.jpg%5D(imagesue4-pso-5.jpg).jpg" alt="ue4-pso-5.jpg" /></p><p>r.ShaderPipelineCache.Enabled设为1：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022!%5Bue4-pso-6.jpg%5D(imagesue4-pso-6.jpg).jpg" alt="ue4-pso-6.jpg" /></p><p>此时完成了PSO收集的启用，判断是否启用可以在游戏启动的log中进行查看，如下图所示则为启动成功：</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022!%5Bue4-pso-7.jpg%5D(imagesue4-pso-7.png).png" alt="ue4-pso-7.jpg" /></p><p>可以看到图中r.ShaderPipelineCache.Enabled:1</p><h5 id="收集pso"><a class="markdownIt-Anchor" href="#收集pso"></a> 收集PSO</h5><p>打包并在目标设备中安装，多次运行游戏的各个流程</p><p>请注意结束游戏的时候请使用游戏的退出方式，不要直接用手机结束进程。如果非得用手机杀死进程，请先转到后台片刻，不要在PSO收集过程中强行结束，会导致收集到的PSO信息无法使用</p><p>收集到的文件在：</p><p>UE4Game\NameOfProject\NameOfProject\Saved\CollectedPSOs</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022!%5Bue4-pso-8.jpg%5D(imagesue4-pso-8.jpg).jpg" alt="ue4-pso-8.jpg" /></p><p>这里的所有文件下文都用，全部复制走</p><h5 id="编译pso"><a class="markdownIt-Anchor" href="#编译pso"></a> 编译PSO</h5><p>在C盘根目录创建文件夹名为PSOCaching</p><p>然后去这个路径找到两个csv文件：ProjectName\Saved\Cooked\PlatfourmYouCookedFor\ProjectName\Metadata\PipelineCaches</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022!%5Bue4-pso-9.jpg%5D(imagesue4-pso-9.jpg).jpg" alt="ue4-pso-9.jpg" /></p><p>复制到我们刚创建的文件夹</p><p>还有前面提到过后文要用的文件，也粘贴到这个文件夹里</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022!%5Bue4-pso-10.jpg%5D(imagesue4-pso-10.jpg).jpg" alt="ue4-pso-10.jpg" /></p><p>接下来去打包用的引擎文件夹里Engine\Binaries\Win64找到UE4Editor-Cmd.exe</p><p>右键创建该文件的快捷方式，复制走，到上文提到的文件夹里</p><p>然后在这个快捷方式邮件属性，目标这一栏里面后面加上：YourGameName -run=ShaderPipelineCacheTools expand C:\PSOCaching*.rec.upipelinecache C:\PSOCaching*.scl.csv YourGameName_GLSL_ES3_1_ANDROID.stablepc.csv</p><p>确认关闭</p><p>然后直接执行，或者用cmd执行，有错的话可以看到报错</p><p>然后在Engine\Binaries\Win64文件夹中寻找这个csv</p><p><img src="https://cdn.jsdelivr.net/gh/muchenhen/MuImageStore@main/Blogs/2022!%5Bue4-pso-11.jpg%5D(imagesue4-pso-11.jpg).jpg" alt="ue4-pso-11.jpg" /></p><h5 id="使用pso"><a class="markdownIt-Anchor" href="#使用pso"></a> 使用PSO</h5><p>将该文将放置到</p><p>项目的 Build &gt; Platform Name &gt; PipelineCaches 文件夹，将stablepc.csv文件复制到Pipeline Caches文件夹。</p><p>再次进行打包</p><p>PSO成功启用的话，设备上第一次启动游戏会有明显的较长的编译shader的时间</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>C++</tag>
      
      <tag>Optimization</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4:UE_LOG的使用</title>
    <link href="/posts/14397/"/>
    <url>/posts/14397/</url>
    
    <content type="html"><![CDATA[<h5 id="宏相关参数"><a class="markdownIt-Anchor" href="#宏相关参数"></a> 宏相关参数</h5><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">UE_LOG(LogTemp, <span class="hljs-built_in">Log</span>, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;I am a log&quot;</span>));<br></code></pre></td></tr></table></figure><p>第一个参数是Log的分类Category，可以通过宏进行自定义，不需要的话直接LogTemp即可</p><p>第二个参数有三种，Log打出来是灰色，Warning是黄色，Error是红色，可以用来区分不同的消息显示</p><p>第三个参数类似于C风格的printf，双引号中是字符串，或者是%d,%s,%f等内容，后续跟第四个参数，比如：</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs excel"><span class="hljs-built_in">int</span> a = <span class="hljs-number">10</span>;<br>UE_LOG(LogTemp, <span class="hljs-built_in">Log</span>, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot; a = %d&quot;</span>), a);<br>FString b = <span class="hljs-string">&quot;i am log&quot;</span>;<br>UE_LOG(LogTemp, <span class="hljs-built_in">Log</span>, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;%s&quot;</span>), *b);<br></code></pre></td></tr></table></figure><h5 id="category自定义方法"><a class="markdownIt-Anchor" href="#category自定义方法"></a> Category自定义方法</h5><p>简单的自定义宏的方法：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">DEFINE_LOG_CATEGORY_STATIC(LogMyCategory, <span class="hljs-built_in">Warning</span>, <span class="hljs-keyword">All</span>);<br></code></pre></td></tr></table></figure><p>将这个宏放在要是用这个宏的头文件里即可。</p><p>或者可以使用如下方法：</p><p>在头文件里：</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">DECLARE_LOG_CATEGORY_EXTERN(YourLog, <span class="hljs-built_in">Log</span>, <span class="hljs-built_in">All</span>);<br></code></pre></td></tr></table></figure><p>在对应的源文件中：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">DEFINE_LOG_CATEGORY</span>(YourLog);<br></code></pre></td></tr></table></figure><h5 id="命令行显示"><a class="markdownIt-Anchor" href="#命令行显示"></a> 命令行显示</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[cat] = a category <span class="hljs-keyword">for</span> the command <span class="hljs-keyword">to</span> operate <span class="hljs-keyword">on</span>, <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;global&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-keyword">all</span> categories.<br>标签，没有设置就显示所有的<span class="hljs-keyword">Log</span><br>[<span class="hljs-keyword">level</span>] = verbosity <span class="hljs-keyword">level</span>, one <span class="hljs-keyword">of</span>: <span class="hljs-keyword">none</span>, error, <span class="hljs-built_in">warning</span>, display, <span class="hljs-keyword">log</span>, <span class="hljs-keyword">verbose</span>, <span class="hljs-keyword">all</span>, <span class="hljs-keyword">default</span><br>关卡，显示某某关卡的<span class="hljs-keyword">Log</span><br></code></pre></td></tr></table></figure><h5 id="在当前游戏窗口上打印日志"><a class="markdownIt-Anchor" href="#在当前游戏窗口上打印日志"></a> 在当前游戏窗口上打印日志</h5><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">GEngine</span>-&gt;AddOnScreenDebugMessage(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>.<span class="hljs-number">0</span>f, FColor::Red, TEXT(<span class="hljs-string">&quot;OK&quot;</span>));<br></code></pre></td></tr></table></figure><p>第一个参数是为了防止同一个消息被多次添加的key</p><p>第二个参数是消息显示的时间，单位是秒</p><p>第三个参数是消息的颜色，只接受FColor类型的参数</p><p>第四个参数是要显示的消息，使用方法与UE_LOG中相同</p><p>还可以有第五个参数，bool值，true的时候最新的显示在最上面，false最新的显示在最下面，可以缺省</p><p>第六个参数也可以缺省，是该消息的面积大小，参数类型是FVector2D</p>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>C++</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4:常用FString类型转换方法</title>
    <link href="/posts/50255/"/>
    <url>/posts/50255/</url>
    
    <content type="html"><![CDATA[<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c++">FString string = <span class="hljs-string">&quot;string&quot;</span>;<br>FName fname = <span class="hljs-built_in">FName</span>(*string);<span class="hljs-comment">// FString 转 FName</span><br>TCHAR tchar = *string;<span class="hljs-comment">//FString 转 TChar*</span><br>FText ftext = FText::<span class="hljs-built_in">FromString</span>(string);<span class="hljs-comment">//FString 转 FText</span><br><span class="hljs-function">std::string <span class="hljs-title">cstring</span><span class="hljs-params">(TCHAR_TO_UTF8(*string))</span></span>;<span class="hljs-comment">//FString 转 C++ string</span><br>FString numberString = <span class="hljs-string">&quot;1234.123&quot;</span>;<br>int32 strint = FCString::<span class="hljs-built_in">Atoi</span>(*numberString);<span class="hljs-comment">//FString 转 int32</span><br><span class="hljs-type">float</span> strfloat = FCString::<span class="hljs-built_in">Atof</span>(*numberString);<span class="hljs-comment">//FString 转 float</span><br><span class="hljs-type">bool</span> strBool = string.<span class="hljs-built_in">ToBool</span>();<span class="hljs-comment">//转bool</span><br><br><span class="hljs-comment">//FString 转 TArray&lt;uint8&gt; </span><br>TArray&lt;uint8&gt; uint8Array;<br>uint8Array.<span class="hljs-built_in">SetNum</span>(string.<span class="hljs-built_in">len</span>());<br><span class="hljs-built_in">memcpy</span>(uint8Array.<span class="hljs-built_in">GetData</span>(), <span class="hljs-built_in">TCHAR_TO_ANSI</span>(*string), string.<span class="hljs-built_in">Len</span>());<br><br><span class="hljs-comment">//TArray&lt;uint8&gt; 转 FString</span><br>TArray&lt;uint8&gt; content;<br><span class="hljs-function"><span class="hljs-type">const</span> std::string <span class="hljs-title">cstr</span><span class="hljs-params">(<span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-type">const</span> <span class="hljs-type">char</span>*&gt;(content.GetData()), content.Num())</span></span>;<br>FString frameAsFString = cstr.<span class="hljs-built_in">c_str</span>();<br><br><span class="hljs-comment">//C++ string 转 FString</span><br>std::string cstring = <span class="hljs-string">&quot;cstring&quot;</span>;<br><span class="hljs-function">FString <span class="hljs-title">fromCstring</span><span class="hljs-params">(cstring.c_str())</span></span>;<br><br>FString fromFText = ftext.<span class="hljs-built_in">ToString</span>();<span class="hljs-comment">//FText 转 FString</span><br>FStirng fromFName = fname.<span class="hljs-built_in">ToString</span>();<span class="hljs-comment">//FName 转 FString</span><br>Fstring fromfloat = FString::<span class="hljs-built_in">SanitizeFloat</span>(strfloat);<span class="hljs-comment">//float 转</span><br>FString fromint = FString::<span class="hljs-built_in">FromInt</span>(IntVariable);<span class="hljs-comment">//int</span><br>FString frombool = InBool ? <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;true&quot;</span>) : <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;false&quot;</span>);<span class="hljs-comment">//bool</span><br>FString fromFVector = VectorVariable.<span class="hljs-built_in">ToString</span>();<span class="hljs-comment">//Vector</span><br>FString fromFVector2D = Vector2DVariable.<span class="hljs-built_in">ToString</span>();<span class="hljs-comment">//Vector2D</span><br>FString fromFRotator = RotatorVariable.<span class="hljs-built_in">ToString</span>();<span class="hljs-comment">//FRotator</span><br>FString fromFLinerColor = LinearColorVariable.<span class="hljs-built_in">ToString</span>();<span class="hljs-comment">//FLinerColor</span><br>FString fromUObject = (InObj != <span class="hljs-literal">NULL</span>) ? InObj-&gt;<span class="hljs-built_in">GetName</span>() : <span class="hljs-built_in">FString</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;None&quot;</span>));<span class="hljs-comment">//UObject</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>C++</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UE4:反射系统获取UPROPERTY</title>
    <link href="/posts/36675/"/>
    <url>/posts/36675/</url>
    
    <content type="html"><![CDATA[<h3 id="读取方法"><a class="markdownIt-Anchor" href="#读取方法"></a> 读取方法</h3><p>读取UPROPERTY标记的UObject类类型的属性</p><p>UE4提供一个迭代器进行字段遍历</p><p><code>TFieldIterator&lt;T&gt;</code></p><p><code>for (TFieldIterator&lt;UProperty&gt; i ( GetClass() ); i; ++i)</code></p><p><code>&#123;</code></p><p><code>// 进行相关操作</code></p><p><code>UProperty* prop=*i; //i指向一个UProperty</code></p><p><code>&#125;</code></p><p>获得了UProperty，如果需要进一步访问该属性的Name和Value</p><p><code>Name = prop.GetName();</code></p><p><img src="data:image/png;base64,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" alt="UProperty* Property  FString PropertyName  *Propertylterator;  Property- &gt;GetName ( ) " /></p><p>获取属性的值则需要ContainerPtrToValuePtr</p><p>该函数有很多重载</p><p><a href="https://docs.unrealengine.com/en-US/API/Runtime/CoreUObject/UObject/FProperty/ContainerPtrToValuePtr/index.html">https://docs.unrealengine.com/en-US/API/Runtime/CoreUObject/UObject/FProperty/ContainerPtrToValuePtr/index.html</a></p><p>如果是要获取一个UObject类类型的一个Uproperty的值，则</p><p>假设该对象为Object，该Uproperty为Property，对应类型为float</p><p><code>float* sourceAddr = Proerty-&gt;ContainerPtrToValuePtr&lt;float&gt;(Object);</code></p><p>就可以得到对应的value</p><p>也可以考虑封装成模板</p><p><img src="data:image/png;base64,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" alt="template   EVa1ueType GetPropertyVa1ue(UProperty* Property, void* Object)  ValueType* SourceAddr = Property- ;  if (SourceAddr)  return *SourceAddr;  return *SourceAddr; " /></p><h3 id="类型判断"><a class="markdownIt-Anchor" href="#类型判断"></a> 类型判断</h3><p>如果不清楚UProperty对应的类型，可以使用Cast进行判断</p><p><img src="data:image/png;base64,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" alt="template &lt;typename To, typename From&gt;  3FORCEINLINE To* src)  return TCastImp1&lt;From, To&gt;: : DoCast(Src) ; " /></p><p>比如</p><p><img src="data:image/png;base64,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" alt="img" /></p><p>如果该Property是bool类型，那么返回值是true</p><p>在使用时需要注意想要获取的目标Property的指针非空，不然会直接触发异常中断，UE4直接崩掉。</p>]]></content>
    
    
    <categories>
      
      <category>UE4</category>
      
    </categories>
    
    
    <tags>
      
      <tag>UE4</tag>
      
      <tag>C++</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
